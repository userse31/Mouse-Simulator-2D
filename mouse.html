<!-- Utilizes GNU GENERAL PUBLIC LICENSE 3. See "LICENSE" file for details 
This program is free software! This means you may redistribute and/or modify this program under the terms of the GNU General Public License. Why you would want to redistribute/modify my horrible coding, who knows! But you can!!!
The GNU General Public License is published by the "Free Software Foundation, Inc" at 675 Mass Ave, Cambridge MA 02139, USA
-->
<html>
<head>
<!-- sound effects -->
<audio id="sfx" oncanplay="sfx_play()"></audio>
<title>Mouse Simulator 2D</title>
</head>
<body>
    <center>
    <canvas id="cga" width="320" height="200" style="border:2px solid #777777;width:320;height:200;image-rendering:pixelated;image-rendering:crisp-edges;"></canvas>
    <p id="player"></p>
    <p id="status"></p>
    <p id="demonic_announcer">Welcome!</p>
    <button onclick="_new()">New</button>
    <button onclick="_load()">Load</button>
    <button onclick="_save()">Save</button>
    <button onclick="_delete()">Delete</button>
    <button onclick="_import()">Import</button>
    <button onclick="_export()">Export</button>
    <button onclick="config()">Config</button>
    <button onclick="achieve()">Achievements</button>
    </br>
	<a href="./help.html">Help</a>
	</br>
    <!--<button onclick="alert(JSON.stringify(eval(prompt('Code?'))))">eval()</button>-->
    </center>
</body>
<script id="lzutf8" src="./lzutf8.min.js"></script>
<script src="./defines.js"></script>
<script src="./hashmap.js"></script>
<script src="./resources.js"></script>
<script>
//Mouse Simulator 2D v0.56
/*
Achievements! Well... more a statistics thing... but still!
Url "?" thing used for passing agruments and data between the game and sub pages!
"Proper" gui for config options.
*/
//autoconfig
var saves=window.localStorage;
var cga=document.getElementById("cga");
var dem_ann=document.getElementById("demonic_announcer");
var CUR_RAND=0;
var SHOW_DOTS_ON=0;
function srand32(x){
	CUR_RAND=x;
}
function rand32(){
	CUR_RAND=(CUR_RAND*1609+1)%0xffffffff;
	return CUR_RAND;
}
function autoconfig(){
	saves.getItem("_bigger")=="t" ? set_scaling(3) : set_scaling(2);
}
autoconfig();

function get_switches(){
	var switches=window.location.toString().split("?");
	if(switches.length==2){//check if "?" thing in url exists
		switches=switches[1].split("&");
		args(switches.length,switches);
	}else{
		0;//no args
	}
}
get_switches();
function args(argc,argv){
	//console.log("argc:"+argc);
	//console.log("argv:"+argv);
	for(var i=0;i<argc;i++){
		//console.log(argv[i]);
		switch(argv[i]){
			case "--trans":
				alert("Trans!");
				break;
			case "--show-dots-on":
				if(argc>=i+1){
					SHOW_DOTS_ON=Number.parseInt(argv[i+1]);
					i++;
				}
				break;
			case "--bigger-screen-size":
				if(argc>=i+1){
					console.log(argv[i+1]);
					if(argv[i+1]=="1"){
						set_config(1);
					}else{
						set_config(0);
					}
					i++;
				}
				break;
			default:
				//alert("Invalid switch.");
		}
	}
}

function achieve(){
	var cmd="./achieve.html?";
	cmd+=player.steps+"&"+player.days+"&"+pages.length+"&"+player.total_pain+"&"+player.total_heal +"&"+player.total_placed +"&"+player.total_removed +"&"+player.total_dropped +"&"+player.total_picked +"&"+player.total_used +"&"+player.total_wielded +"&"+player.total_crafted +"&"+player.times_laid +"&"+player.total_death;
	window.open(cmd);
}

function config(){
	if(confirm("This will end your session.")){
		window.location="./config.html";
	}
}

function set_config(bigger=-1){
	var bigger;
	/*if(bigger==-1){
		if(confirm("Increase canvas size? (Hard of sight)")){
			set_scaling(3);
			bigger
	}else{*/
		if(bigger==1){
			set_scaling(3);
			bigger="t";
		}else{
			set_scaling(2);
			bigger="f";
		}
	//}
	saves.setItem("_bigger",bigger);
}
function set_scaling(scale){
	cga.style.width=320*scale+"px";
	cga.style.height=200*scale+"px";
}
var _sfx=document.getElementById("sfx");
function sfx_play(){
	_sfx.play();
}
function sfx(sound){
if(_sfx.paused==false){
	_sfx.pause();
	return;
}
	switch(sound){
		case "raygun_bang":
			_sfx.src="./sounds/raygun_bang.wav";
			break;
		case "raygun_cooldown":
			_sfx.src="./sounds/raygun_cooldown.wav";
			break;
		case "player_damaged":
			switch(Math.floor(Math.random()*65535)%2){
				case 0:
					_sfx.src="./sounds/squeak0.wav";
					break;
				case 1:
					_sfx.src="./sounds/squeak1.wav";
					break;
			}
			break;
		case "magnatron_warmup":
			_sfx.src="./sounds/magnatron_warmup.wav";
			break;
		case "magnatron_conduct":
			_sfx.src="./sounds/magnatron_conducting.wav";
			break;
		case "emi":
			switch(Math.floor(Math.random()*65535)%4){
				case 0:
					_sfx.src="./sounds/emi0.wav";
					break;
				case 1:
					_sfx.src="./sounds/emi1.wav";
					break;
				case 2:
					_sfx.src="./sounds/emi2.wav";
					break;
				case 3:
					_sfx.src="./sounds/emi3.wav";
					break;
			}
			break;
	}
}

var ctx=cga.getContext("2d");
var char=ctx.getImageData(0,0,8,8);
function write_1bit(pos,val,id,mix_r,mix_g,mix_b){
	char.data[4*pos+3]=255;
	switch(val){
		case "0":
			char.data[4*pos]=Math.floor(font[id].c[0]*mix_r);
			char.data[4*pos+1]=Math.floor(font[id].c[1]*mix_g);
			char.data[4*pos+2]=Math.floor(font[id].c[2]*mix_b);
			break;
		case "1":
			char.data[4*pos]=Math.floor(font[id].c[3]*mix_r);
			char.data[4*pos+1]=Math.floor(font[id].c[4]*mix_g);
			char.data[4*pos+2]=Math.floor(font[id].c[5]*mix_b);
			break;
		case "2":
			char.data[4*pos]=Math.floor(font[id].c[6]*mix_r);
			char.data[4*pos+1]=Math.floor(font[id].c[7]*mix_g);
			char.data[4*pos+2]=Math.floor(font[id].c[8]*mix_b);
			break;
		case "3":
			char.data[4*pos]=Math.floor(font[id].c[9]*mix_r);
			char.data[4*pos+1]=Math.floor(font[id].c[10]*mix_g);
			char.data[4*pos+2]=Math.floor(font[id].c[11]*mix_b);
			break;
		case "4":
			char.data[4*pos]=Math.floor(font[id].c[12]*mix_r);
			char.data[4*pos+1]=Math.floor(font[id].c[13]*mix_g);
			char.data[4*pos+2]=Math.floor(font[id].c[14]*mix_b);
			break;
		case "5":
			char.data[4*pos]=Math.floor(font[id].c[15]*mix_r);
			char.data[4*pos+1]=Math.floor(font[id].c[16]*mix_g);
			char.data[4*pos+2]=Math.floor(font[id].c[17]*mix_b);
			break;
		case "6":
			char.data[4*pos]=Math.floor(font[id].c[18]*mix_r);
			char.data[4*pos+1]=Math.floor(font[id].c[19]*mix_g);
			char.data[4*pos+2]=Math.floor(font[id].c[20]*mix_b);
			break;
		case "7":
			char.data[4*pos]=Math.floor(font[id].c[21]*mix_r);
			char.data[4*pos+1]=Math.floor(font[id].c[22]*mix_g);
			char.data[4*pos+2]=Math.floor(font[id].c[23]*mix_b);
			break;
	}
}

var rain_ctr=0;

function get_font(val,x,y){
	if(!((FORCE_RAIN||player.weather_type!=W_CLEAR)&&pages[cur_page].metadata.layer==0&&val==0)){
		for(var i=0;i<64;i++){
			//alert(font[val].b[i]);
			if(hit_bounds(x,y)){
				return;
			}
			write_1bit(i,font[val].b[i],val,light_map[y][x][0],light_map[y][x][1],light_map[y][x][2]);
		}
	}else{
		for(var i=0;i<64;i++){
			if(hit_bounds(x,y)){
				return;
			}
			write_1bit(i,font[T_RAIN0+rain_ctr].b[i],T_RAIN0+rain_ctr,light_map[y][x][0],light_map[y][x][1],light_map[y][x][2]);
		}	
	}
	return val;
}

function light_levels(){
	//blank light map
	var def_rgb;
	switch(pages[cur_page].metadata.layer){
		case -1:
			def_rgb=NEST_RGB;
			break;
		case 0:
			if(!(tick_hour()>=NIGHT_START_HOUR && tick_hour()<=NIGHT_END_HOUR)){//is night time
				def_rgb=NIGHT_RGB;
			}else{
				def_rgb=DAY_RGB;
			}
			break;
		case 1:
			def_rgb=SLIP_RGB;
			break;
	}
	for(var i=0;i<25;i++){
		for(var j=0;j<40;j++){
			light_map[i][j]=def_rgb;
		}
	}
	//light source spreading
	for(var i=0;i<25;i++){
		for(var j=0;j<40;j++){
			switch(pages[cur_page].map[i][j]){
				case T_CLOCK_RADIO:
					light_spread(L_CLOCK_RADIO_STR,L_CLOCK_RADIO_RGB,i,j);
					break;
				case T_BORDER:
					light_spread(L_BORDER_STR,L_BORDER_RGB,i,j);
					break;
				case T_CAMP_FIRE:
					light_spread(L_CAMP_FIRE_STR,L_CAMP_FIRE_RGB,i,j);
					break;
				case T_FIRE0:
					light_spread(L_FIRE0_STR,L_FIRE0_RGB,i,j);
					break;
				case T_FIRE1:
					light_spread(L_FIRE1_STR,L_FIRE1_RGB,i,j);
					break;
				case T_FIRE2:
					light_spread(L_FIRE2_STR,L_FIRE2_RGB,i,j);
					break;
				case T_BROWN_MUSHROOM:
					light_spread(L_BMUSH_STR,L_BMUSH_RGB,i,j);
					break;
				case T_LAMP:
					light_spread(L_LAMP_STR,L_LAMP_RGB,i,j);
					break;

			}
		}
	}
}

function light_spread(strength,_rgb,_x,_y){
	for(var i=_x-strength;i<1+_x+strength;i++){
		for(var j=_y-strength;j<1+_y+strength;j++){
			if(i<0 || i>25){
				continue;
			}
			if(j<0 || j>40){
				continue;
			}
			mix_rgb(i,j,_rgb);
			
		}
	}
}

function max_min_lighting(x){
	if(x>=LARGEST_LIGHT_LEVEL){
		return LARGEST_LIGHT_LEVEL;
	}
	if(x<=LOWEST_LIGHT_LEVEL){
		return LOWEST_LIGHT_LEVEL;
	}
	return x;
}

function saturation_rgb(_rgb,sat){
	for(var i=0;i<3;i++){
		_rgb[i]*=sat;
	}
	return _rgb;
}

function mix_rgb(i,j,_rgb){
	//dem_ann.textContent=JSON.stringify(light_map[i]);
	//Eat shit JavaScript.
	try{
		light_map[i][j]=[max_min_lighting((light_map[i][j][0]+_rgb[0])/2),max_min_lighting((light_map[i][j][1]+_rgb[1])/2),max_min_lighting((light_map[i][j][2]+_rgb[2])/2)];
	}catch(FUCK){
		0;
	}
}

function draw_map(){
	//light levels
	light_levels();
	//block map
	for(var x=0;x<40;x++){
		for(var y=0;y<25;y++){
			get_font(pages[cur_page].map[y][x],x,y);
			ctx.putImageData(char,x*8,y*8);
		}
	}
	//entity map
	//entity drawing priorities.
	var e_item=[];
	var e_npc=[];
	var e_proj=[];
	var e_plasma=[];
	var e_bobber=[];
	for(var i=0;i<pages[cur_page].entities.length;i++){
		switch(pages[cur_page].entities[i].id){
			case 1://npc
				e_npc.push(i);
				break;
			case 2://dropped item
				e_item.push(i);
				break;
			case 3://projectile
				e_proj.push(i);
				break;
			case 4://plasma
				e_plasma.push(i);
				break;
			case 5://bobber
				e_bobber.push(i);
				break;
		}
	}
	var e_ordered=e_item.concat(e_npc,e_proj,e_plasma,e_bobber);
	for(var i=0;i<e_ordered.length;i++){
		get_font(pages[cur_page].entities[e_ordered[i]].char,pages[cur_page].entities[e_ordered[i]].x,pages[cur_page].entities[e_ordered[i]].y);
		if(pages[cur_page].entities[e_ordered[i]].fire_tick!==undefined){
			get_font(T_FIRE0,pages[cur_page].entities[e_ordered[i]].x,pages[cur_page].entities[e_ordered[i]].y);
		}
		ctx.putImageData(char,
		pages[cur_page].entities[e_ordered[i]].x*8,
		pages[cur_page].entities[e_ordered[i]].y*8);
	}
	//player
	if(player.fire_tick===undefined){
	get_font(3,player.x,player.y);
	}else{
	get_font(T_FIRE0,player.x,player.y);
	}
	ctx.putImageData(char,player.x*8,player.y*8);
}

function clear_canvas(){
	ctx.clearRect(0,0,320,200);
}

/*var craft_cur_x=0;
var craft_cur_y=0;
function draw_crafting(){
	var craft_input=[-1,-1,-1,-1,-1,-1];
	var craft_output=[0,0,0];
	ctx.fillText("Crafting:",2,10);
	get_font(T_CRAFT_SPACE);
	//input
	ctx.putImageData(char,1*8,2*8);//craft_input[0]
	ctx.putImageData(char,2*8,2*8);//craft_input[1]
	ctx.putImageData(char,1*8,3*8);//craft_input[2]
	ctx.putImageData(char,2*8,3*8);//craft_input[3]
	ctx.putImageData(char,1*8,4*8);//craft_input[4]
	ctx.putImageData(char,2*8,4*8);//craft_input[5]
	//output
	ctx.putImageData(char,4*8,2*8);//craft_output[0]
	ctx.putImageData(char,4*8,3*8);//craft_output[1]
	ctx.putImageData(char,4*8,4*8);//craft_output[2]
	//arrow
	get_font(T_CRAFT_ARROW);
	ctx.putImageData(char,3*8,3*8);
	//inventory
	ctx.fillText("Inventory:",2,60);
	get_font(item_char[player.inv[0][0]]);//inventory slot 0;
	ctx.putImageData(char,1*8,8*8);
	get_font(item_char[player.inv[0][0]]);//inventory slot 0;
	ctx.putImageData(char,1*8,8*8);
	get_font(item_char[player.inv[0][0]]);//inventory slot 0;
	ctx.putImageData(char,1*8,8*8);
	get_font(item_char[player.inv[0][0]]);//inventory slot 0;
	ctx.putImageData(char,1*8,8*8);
	get_font(item_char[player.inv[0][0]]);//inventory slot 0;
	ctx.putImageData(char,1*8,8*8);
	get_font(item_char[player.inv[0][0]]);//inventory slot 0;
	ctx.putImageData(char,1*8,8*8);
	get_font(item_char[player.inv[0][0]]);//inventory slot 0;
	ctx.putImageData(char,1*8,8*8);
}

function crafting_mouse_action(x,y){
	//alert([x,y]);
}*/

function rtc(days=player.days){
	return {year:Math.floor(days/YEAR_LEN),month:Math.floor(days/MONTH_LEN)%MONTH_MOD,monthlets:days%MONTHLET_MOD,weekday:days%WEEK_MOD};
}

function seasons(m=rtc().month){
	switch(m){
		case 0:
		case 1:
		case 2:
		case 3://summer
			//grass
			font[13].c[3]=0;
			font[13].c[4]=255;
			font[13].c[5]=0;
			//tree leaves
			font[14].c[3]=0;
			font[14].c[4]=255;
			font[14].c[5]=0;
			//walnut leaves
			for(var i=0;i<6;i++){
				font[46+i].c[3]=0;
				font[46+i].c[4]=215;
				font[46+i].c[5]=0;
			}
			break;
		case 4:
		case 5:
		case 6:
		case 7://fall
			//grass
			font[13].c[3]=224;
			font[13].c[4]=204;
			font[13].c[5]=119;
			//tree leaves
			font[14].c[3]=224;
			font[14].c[4]=204;
			font[14].c[5]=119;
			//walnut leaves
			for(var i=0;i<6;i++){
				font[46+i].c[3]=0x224;
				font[46+i].c[4]=0x204;
				font[46+i].c[5]=119;
			}
			break;
		case 8:
		case 9:
		case 10:
		case 11://winter
			//grass
			font[13].c[3]=160;
			font[13].c[4]=140;
			font[13].c[5]=55;
			//tree leaves
			font[14].c[3]=255;
			font[14].c[4]=255;
			font[14].c[5]=255;
			//walnut leaves
			for(var i=0;i<6;i++){
				font[46+i].c[3]=255;
				font[46+i].c[4]=255;
				font[46+i].c[5]=255;
			}
			break;
		case 12:
		case 13:
		case 14:
		case 15://spring
			//grass
			font[13].c[3]=160;
			font[13].c[4]=255;
			font[13].c[5]=160;
			//tree leaves
			font[14].c[3]=160;
			font[14].c[4]=255;
			font[14].c[5]=160;
			//walnut leaves
			for(var i=0;i<6;i++){
				font[46+i].c[3]=0;
				font[46+i].c[4]=255;
				font[46+i].c[5]=0;
			}
			break
	}
}

function map_search(tile){
	var coords=[];
	var cur_index=-1;
	for(var i=0;i<25;i++){//y
		do{
			cur_index=pages[cur_page].map[i].indexOf(tile,cur_index+1);
			cur_index!=-1 ? coords.push({x:cur_index,y:i}) : 0;
		} while(cur_index!=-1)
	}
	return coords;
}

function item_id_from_name(str){
	str=str.toLowerCase();
	for(var i=0;i<item_names.length;i++){
		if(str==item_names[i].toLowerCase()){
			return i;
		}
	}
	return -1;
}

function damage_player(amount){
	player.creative==1 ? 0 : player.health-=amount;
	sfx("player_damaged");
	player.total_pain+=amount;
}
function heal_player(amount){
	player.creative==1?0:player.health-=amount;
	player.total_heal+=amount;
}

function pagexy_to_ptr(page_x,page_y,page_layer){
	for(var i=0;i<pages.length;i++){
		if(pages[i].metadata.x==page_x && pages[i].metadata.y==page_y && pages[i].metadata.layer==page_layer){
			return i;
		}
	}
	return -1;
}

function item_roulette(drop_list,_x,_y){
for(var i=0;i<drop_list.length;i++){
	//alert(drop_list.length);
	if(Math.random()<=drop_list[i].chance){
		pages[cur_page].entities.push({id:2,
		x:_x,
		y:_y,
		char:item_char[drop_list[i].item_id],
		item:
			[drop_list[i].item_id,
			(Math.floor(Math.random()*65535)%drop_list[i].item_max)+drop_list[i].item_min
			]
		});
		combine_items(_x,_y,drop_list[i].item_id);
	}
}
}

function drop_set_selection(set,x,y){
switch(set){
	case "enemy":
		item_roulette(item_drops.enemy,x,y);
		break;
	case "enemy_slip":
		item_roulette(item_drops.enemy_slip,x,y);
		break;
	case "cat":
		item_roulette(item_drops.cat,x,y);
		break;
}
}

function npc_drops(ptr){//items to drop after npc death.
//id=1
switch(pages[cur_page].entities[ptr].char){
	case 4://enemy
		switch(pages[cur_page].metadata.layer){
			case 0://Surface
				drop_set_selection("enemy",pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y);
				break;
			case 1://Slip
				drop_set_selection("enemy_slip",pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y);
				break;
			}
		break;
	case T_CAT://cat
		drop_set_selection("cat",pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y);
		break;
	default:
		break;
}
}

function combine_items(_x,_y,item_id){//Reduce memory usage and improve the user experience by combining dropped items of the same type together.
	var ptrs=[];
	for(var i=0;i<pages[cur_page].entities.length;i++){
		if(pages[cur_page].entities[i].id==2){
			if(pages[cur_page].entities[i].x==_x && pages[cur_page].entities[i].y==_y && pages[cur_page].entities[i].item[0]==item_id){
				ptrs.push(i);
			}
		}
	}
	var total_amount=0;
	for(var i=0;i<ptrs.length;i++){
		total_amount+=pages[cur_page].entities[ptrs[i]].item[1];
		pages[cur_page].entities[ptrs[i]].id=-1;
	}
	pages[cur_page].entities.push({id:2, x:_x, y:_y, char:item_char[item_id], item: [item_id,total_amount]});
}

function new_npc(_x,_y,_home_x,_home_y){
	var new_boi={id:1,char:3,x:_x,y:_y,brain:{no_ai:0,hostile:0,identity:{gender:0,dysphoria:0},home_x:_home_x,home_y:_home_y},health:20,strength:1,attack_cooldown:0,dest_x:_x, dest_y:_y};
new_boi.brain.identity.gender=Math.floor(Math.random()*100)%2;
new_boi.brain.identity.dysphoria=(Math.floor(Math.random()*100)%100)<10;
pages[cur_page].entities.push(new_boi);
return pages[cur_page].entities.length-1;
}

function struct_copy(struct_id,offset_x,offset_y,fill_nonzero=1){
	for(var y=0;y<structures[struct_id].length;y++){
		for(var x=0;x<structures[struct_id][y].length;x++){
			if(hit_bounds(offset_x+x,offset_y+y)){
				continue;
			}
			if(char_value(offset_x+x,offset_y+y)!=0 && fill_nonzero==0){
				continue;
			}
			pages[cur_page].map[offset_y+y][offset_x+x]=structures[struct_id][y][x]==-1 ? pages[cur_page].map[offset_y+y][offset_x+x] : structures[struct_id][y][x];
		}
	}
}

function generate_stuff(layer=0){
	var rand_x=0;
	var rand_y=0;
	var rand_action=0;
	//structures
	srand32((player.seed+HASHMAP[pages[cur_page].metadata.y+64][pages[cur_page].metadata.x+64])%0xffffffff);
	for(var i=0;i<struct.length;i++){
		for(var j=0;j<struct[i].tries;j++){
		if(struct.weight==-1){
			continue;
		}
		rand_x=rand32()%(40-struct[i].sub[0]);
		rand_y=rand32()%(25-struct[i].sub[1]);
		if(char_value(rand_x,rand_y)==0){
			if((rand32()/0xffffffff)<struct[i].weight){
				struct_copy(struct[i].id,rand_x,rand_y);
				if(struct[i].entity!=undefined){//entities
					new_npc(rand_x+struct[i].entity.offset_x,rand_y+struct[i].entity.offset_y,rand_x+struct[i].entity.offset_x,rand_y+struct[i].entity.offset_y);
				}
			}
		}
		}
	}
}

function struct_copy_slip(struct_id,offset_x,offset_y,do_decay,decay_rate=-1){
	for(var y=0;y<structures_slip[struct_id].length;y++){
		for(var x=0;x<structures_slip[struct_id][y].length;x++){
			if(hit_bounds(offset_x+x,offset_y+y)){
				continue;
			}
			//alert(typeof structures_slip[struct_id].special);
			/*if((typeof structures_slip[struct_id].special)=="Function"){
				alert(0);
			}*/
			/*if(char_value(offset_x+x,offset_y+y)!=0 && fill_nonzero==0){
				continue;
			}*/
			if(do_decay&&(rand32()/0xffffffff)<decay_rate){
				continue;
			}
			pages[cur_page].map[offset_y+y][offset_x+x]=structures_slip[struct_id][y][x]==-1 ? pages[cur_page].map[offset_y+y][offset_x+x] : structures_slip[struct_id][y][x];
		}
	}
}

function generate_slip(){
	var rand_x=0;
	var rand_y=0;
	var rand_action=0;
	//structures
	srand32((player.seed+HASHMAP[pages[cur_page].metadata.y+64][pages[cur_page].metadata.x+64])%0xffffffff);
	for(var y=0;y<25;y++){//the slip has carpet.
		for(var x=0;x<40;x++){
			if((rand32()/0xffffffff)<SLIP_CARPET_DECAY){
				continue;
			}
			pages[cur_page].map[y][x]=SLIP_CARPET_TILE;
		}
	}
	for(var i=0;i<struct_slip.length;i++){
		for(var j=0;j<struct[i].tries;j++){
		if(struct_slip.weight==-1){
			continue;
		}
		rand_x=rand32()%(40-struct_slip[i].sub[0]);
		rand_y=rand32()%(25-struct_slip[i].sub[1]);
		if(char_value(rand_x,rand_y)==0){
			if((rand32()/0xffffffff)<struct_slip[i].weight){
				struct_copy_slip(struct_slip[i].id,rand_x,rand_y,struct_slip[i].decay,struct_slip[i].decay_rate);
				if(struct_slip[i].entity!=undefined){//entities
					new_npc(rand_x+struct[i].entity.offset_x,rand_y+struct[i].entity.offset_y,rand_x+struct[i].entity.offset_x,rand_y+struct[i].entity.offset_y);
				}
			}
		}
		}
	}
}

function map_border(){
	if(pages[cur_page].metadata.x>=MAX_MAP_SIZE_POS){
		for(var i=0;i<25;i++){
			pages[cur_page].map[i][39]=8;
		}
	}
	if(pages[cur_page].metadata.x<=MAX_MAP_SIZE_NEG){
		for(var i=0;i<25;i++){
			pages[cur_page].map[i][0]=8;
		}
	}
	if(pages[cur_page].metadata.y<=MAX_MAP_SIZE_NEG){
		for(var i=0;i<40;i++){
			pages[cur_page].map[0][i]=8;
		}
	}
	if(pages[cur_page].metadata.y>=MAX_MAP_SIZE_POS){
		for(var i=0;i<40;i++){
			pages[cur_page].map[24][i]=8;
		}
	}
}

function get_ptr_from_page_xy(x,y,layer){
	for(var i=0;i<pages.length;i++){
		if(pages[i].metadata.x==x && pages[i].metadata.y==y && pages[i].metadata.layer==layer){
			return i;
		}
	}
	return -1;
}

function new_page(context="",direction="none",hole_ptr){
	var old_cur_page=cur_page;
	var n_page={
	map:new Array(25),
	entities:[],
	holes:[],
	metadata:{
	safety:0,
	north_goto:true,
	south_goto:true,
	west_goto:true,
	east_goto:true,
	x:pages[cur_page].metadata.x,
	y:pages[cur_page].metadata.y,
	layer:pages[cur_page].metadata.layer
	}
	}
	for(var i=0;i<25;i++){
		n_page.map[i]=new Array(40);
	}
	for(var j=0;j<25;j++){
		for(var i=0;i<40;i++){
			n_page.map[j][i]=0;
		}
	}
	switch(context){
		case "surface_hole":
			var og_points=[pages[cur_page].metadata.x,pages[cur_page].metadata.y,pages[cur_page].metadata.layer];
			//pages[cur_page].holes[0].dest_page=[0,0,0];
			n_page.holes.push({
			x:19,
			y:12,
			dest_page:[og_points[0],og_points[1],og_points[2]],
			next_x:pages[cur_page].holes[hole_ptr].x,
			next_y:pages[cur_page].holes[hole_ptr].x
			});
			n_page.metadata.layer=0;
			player.x=19;
			player.y=12;
			pages.push(JSON.parse(JSON.stringify(n_page)));
			cur_page=pages.length-1;
			generate_stuff();
			pages[cur_page].map[12][19]=6;
			pages[cur_page].map[12][18]=2;
			pages[cur_page].map[12][20]=2;
			pages[cur_page].map[11][19]=2;
			pages[cur_page].map[13][19]=2;
			break;
		case "cross_edge":
			switch(direction){
				case "up":
					n_page.metadata.y--;
					break;
				case "down":
					n_page.metadata.y++;
					break;
				case "left":
					n_page.metadata.x--;
					break;
				case "right":
					n_page.metadata.x++;
					break;
			}
			pages.push(JSON.parse(JSON.stringify(n_page)));
			cur_page=pages.length-1;
			switch(pages[cur_page].metadata.layer){
				case 0://surface
					generate_stuff();
					break;
				case 1://slip
					generate_slip();
					break;
			}
			break;
		case "npc_hole":
			break;
		case "slip_enter":
			var og_points=[pages[cur_page].metadata.x,pages[cur_page].metadata.y,pages[cur_page].metadata.layer];
			//pages[cur_page].holes[hole_ptr].dest_page=[og_points[0],og_points[1],1];
			n_page.holes.push({
			x:19,
			y:12,
			dest_page:[og_points[0],og_points[1],og_points[2]],
			next_x:pages[cur_page].holes[hole_ptr].x,
			next_y:pages[cur_page].holes[hole_ptr].y,
			});
			n_page.metadata.layer=1;
			n_page.metadata.x=og_points[0];
			n_page.metadata.y=og_points[1];
			pages.push(JSON.parse(JSON.stringify(n_page)));
			cur_page=pages.length-1;
			generate_slip();
			pages[cur_page].map[12][19]=6;
			pages[cur_page].map[12][18]=2;
			pages[cur_page].map[12][20]=2;
			pages[cur_page].map[11][19]=2;
			pages[cur_page].map[13][19]=2;
			break;
	}
		if(pages[cur_page].metadata.x<=MAX_MAP_SIZE_NEG){
			for(var i=0;i<25;i++){
				pages[cur_page].map[i][0]=8;
			}
		}
		if(pages[cur_page].metadata.y<=MAX_MAP_SIZE_NEG){
			for(var i=0;i<40;i++){
				pages[cur_page].map[0][i]=8;
			}
		}
		if(pages[cur_page].metadata.x>=MAX_MAP_SIZE_POS){
			for(var i=0;i<25;i++){
				pages[cur_page].map[i][39]=8;
			}
		}
		if(pages[cur_page].metadata.y>=MAX_MAP_SIZE_POS){
			for(var i=0;i<40;i++){
				pages[cur_page].map[24][i]=8;
			}
		}
}

function teleport(){
	
for(var i=0;i<pages[cur_page].holes.length;i++){
	if(pages[cur_page].holes[i].x==player.x && pages[cur_page].holes[i].y==player.y){
		if(get_ptr_from_page_xy(pages[cur_page].holes[i].dest_page[0],pages[cur_page].holes[i].dest_page[1],pages[cur_page].holes[i].dest_page[2])==-1){//gen new page
			player.x=pages[cur_page].holes[i].next_x;
			player.y=pages[cur_page].holes[i].next_y;
			switch(pages[cur_page].holes[i].dest_page[2]){
				case 0://Surface
		    		new_page("surface_hole","",i);
					break;
				case 1://The Slip
					new_page("slip_enter","",i);
					break;
			}
			return;
		}
		player.x=pages[cur_page].holes[i].next_x;
		player.y=pages[cur_page].holes[i].next_y;
		cur_page=pagexy_to_ptr(
		pages[cur_page].holes[i].dest_page[0],
		pages[cur_page].holes[i].dest_page[1],
		pages[cur_page].holes[i].dest_page[2]);
	    break;
	}
}
}

function off_edge(direction){//generate new page when walking off map and page edge metadata = -2
var next_page=-1;
var next_x=player.x;
var next_y=player.y;
switch(direction){
	case "up":
			if(pages[cur_page].metadata.y<=MAX_MAP_SIZE_NEG){
				return;
			}
	   		if(!pages[cur_page].metadata.north_goto){
				return;
			}
			next_page=get_ptr_from_page_xy(pages[cur_page].metadata.x,
			pages[cur_page].metadata.y-1,
			pages[cur_page].metadata.layer);
			next_y=24;
	    	break;
	case "down":
			if(pages[cur_page].metadata.y>=MAX_MAP_SIZE_POS){
				return;
			}
			if(!pages[cur_page].metadata.south_goto){
				return;
			}
			next_page=get_ptr_from_page_xy(pages[cur_page].metadata.x,
			pages[cur_page].metadata.y+1,
			pages[cur_page].metadata.layer);
			next_y=0;
	    	break;
	case "left":
			if(pages[cur_page].metadata.x<=MAX_MAP_SIZE_NEG){
				return;
			}
			if(!pages[cur_page].metadata.west_goto){
				return;
			}
			next_page=get_ptr_from_page_xy(pages[cur_page].metadata.x-1,
			pages[cur_page].metadata.y,
			pages[cur_page].metadata.layer);
			next_x=39;
	    	break;
	case "right":
			if(pages[cur_page].metadata.x>=MAX_MAP_SIZE_POS){
				return;
			}
			if(!pages[cur_page].metadata.east_goto){
				return;
			}
			next_page=get_ptr_from_page_xy(pages[cur_page].metadata.x+1,
			pages[cur_page].metadata.y,
			pages[cur_page].metadata.layer);
			next_x=0;
	    	break;
}
if(next_page==-1){//new page!
	new_page("cross_edge",direction)
}else{
	cur_page=next_page;
}
player.x=next_x;
player.y=next_y;
}

function inv_cleanup(){//resolve item slots with count of 0 or less to id 0
	if(player.creative==1){
		return;
	}
    for(var i=0;i<10;i++){
        if(player.inv[i][1]<1){
            player.inv[i][0]=0;
            player.inv[i][1]=0;
        }
    }
}

function entity_cleanup(){
//remove free`ed entities and condense list
var new_entity_list=[];
for(var i=0;i<pages[cur_page].entities.length;i++){
	if(pages[cur_page].entities[i].id!=-1){
	new_entity_list.push(JSON.parse(JSON.stringify(pages[cur_page].entities[i])));
	}
}
pages[cur_page].entities=new_entity_list;
}

function compare_array(x,y){
if(x.length!=y.length){
    return false;
}
for(var i=0;i<x.length;i++){
    if(x[i]!=y[i]){
        return false;
    }
}
return true;
}

function pick_up_tile(item_id){
	player.creative==1 ? pages[cur_page].map[player.y][player.x]=0 : 0;
	if(player.inv[player.inv[10]][0]==0){
			player.inv[player.inv[10]]=[item_id,1];
			pages[cur_page].map[player.y][player.x]=0;
			player.total_removed++;
			return;
	}
	if(player.inv[player.inv[10]][0]==item_id){
		player.inv[player.inv[10]][1]++;
		pages[cur_page].map[player.y][player.x]=0;
		player.total_removed++;
    		return;
	}
}

function single_item_craft(recipe_id,input){
	var item=0;
	var zeros=0;
	for(var i=0;i<recipe_id.length;i++){
		if(recipe_id[i]==0){
			zeros++;
		}else{
			item=recipe_id[i];
		}
	}
	if(zeros==5 && item==input[0]){
		return true;
	}
	return false;
}

function enter_button(){
var standing_on=pages[cur_page].map[player.y][player.x];
var on_entity=0;
//check entity
for(var i=0;i<pages[cur_page].entities.length;i++){
	if(pages[cur_page].entities[i].x==player.x && pages[cur_page].entities[i].y==player.y){
		on_entity=pages[cur_page].entities[i];
		if(on_entity.id==2){//Pick items up.
			if(player.creative==1){
				pages[cur_page].entities[i].id=-1;
				player.total_picked++;
				return;
			}
			if(on_entity.item[0]==player.inv[player.inv[10]][0] || player.inv[player.inv[10]][0]==0){
				player.inv[player.inv[10]][0]=on_entity.item[0];
				player.inv[player.inv[10]][1]+=on_entity.item[1];
				pages[cur_page].entities[i].id=-1;
				player.total_picked++;
			}
		}
	}
}
//check block
switch(standing_on){
	case 6://teleport/goto next map
		teleport();
		break;
	case 7://bedding
	case 8:
		if(!(tick_hour()>=NIGHT_START_HOUR && tick_hour()<=NIGHT_END_HOUR)){
			dem_ann.textContent="You can only sleep at day.";
		}else{
			tick1=12*(256*16);
			dem_ann.textContent="Slept and skipped to night."
			player.strength=1;//Player strength reset after sleeping.
		}
		break;
	case 13://grass
		pick_up_tile(3);
		break;
	case 16://brown mushroom
		pick_up_tile(4);
		break;
	case 17://red mushroom
		pick_up_tile(5);
		break;
	case 24://sapling
		pick_up_tile(9);
		break;
	case 28://carpet
		pick_up_tile(13);
		break;
	case 38://raygun
		pick_up_tile(19);
		break;
	case 40://Cyan Thing
		pick_up_tile(21);
		break;
	case 43://Open Door
		pick_up_tile(22);
		break;
	case 2://Dither, Stone
		pick_up_tile(23);
		break;
	case 12://Hay Bail
		pick_up_tile(24);
		break;
	case 52://Walnut Fruit
		pick_up_tile(25);
		break;
	case 54://Walnut peels
		pick_up_tile(27);
		break;
	case 68://Camp Fire
		pick_up_tile(41);
		break;
	case 73://Camp Fire
		pick_up_tile(46);
		break;
	case 77://Copper wire (off)
		pick_up_tile(67);
		break;
	case 78://Copper wire (off)
		pick_up_tile(67);
		break;
	case 79://Copper wire (off)
		pick_up_tile(67);
		break;
	case 80://Copper wire (off)
		pick_up_tile(67);
		break;
	case 81://Copper wire (on)
		pick_up_tile(67);
		break;
	case 82://Copper wire (on)
		pick_up_tile(67);
		break;
	case 83://Copper wire (on)
		pick_up_tile(67);
		break;
	case 84://Copper wire (on)
		pick_up_tile(67);
		break;
	case 86://Switch (off)
		pick_up_tile(68);
		break;
	case 87://switch (on)
		pick_up_tile(68);
		break;
	case 88://Not Gate (off)
		pick_up_tile(69);//nice
		break;
	case 89://Not Gate (on)
		pick_up_tile(69);
		break;
	case 90://Gate (off)
		pick_up_tile(70);
		break;
	case 91://Gate (on)
		pick_up_tile(70);
		break;
	case 92://Wire Jumper
		pick_up_tile(71);
		break;
	case 93://Pump
		pick_up_tile(72);
		break;
	case 100://Pump
		pick_up_tile(52);
		break;
	case T_CAP4://capacitor
	case T_CAP3:
	case T_CAP2:
	case T_CAP1:
	case T_CAP0:
		pick_up_tile(I_CAPACITOR);
		break;
	case T_CLOCK_RADIO://Clock Radio
		pick_up_tile(I_CLOCK_RADIO);
		break;
	case T_COMPOSTER://Composter
		pick_up_tile(I_COMPOSTER);
		break;
	case T_T_GATE_OFF://T Gate
	case T_T_GATE_ON:
		pick_up_tile(I_T_GATE);
		break;
	case 29://water
		if(player.inv[player.inv[10]][0]==11){//Bowl
			pages[cur_page].entities.push({
			id:2,
			x:player.x,
			y:player.y,
			char:item_char[39],
			item:[39,1]
			});//Bowl of water.
			combine_items(player.x,player.y,39);
			player.inv[player.inv[10]][1]--;
		}
		if(player.inv[player.inv[10]][1]<=0){
			player.inv[player.inv[10]][0]=0;
			player.inv[player.inv[10]][1]=0;
		}
		break;
	default:
		if(player.creative==1){
			for(var i=0;i<properties.creative_noremove.length;i++){
				if(standing_on==properties.creative_noremove[i]){
					return;
				}
			}
			pages[cur_page].map[player.y][player.x]=0;
		}
		break;
}
if(standing_on==11){//crafting arrow
    var input=[
    -1,-1,//(35,1),(36,1)
    -1,-1,//(35,2),(36,2)
    -1,-1//(35,3),(36,3)
    ];
    var recipe_id=[0,0,0,0,0,0];
    for(var i=0;i<pages[cur_page].entities.length;i++){
        if(pages[cur_page].entities[i].id!=2){//item
            continue;
        }
        if(pages[cur_page].entities[i].x==35 && pages[cur_page].entities[i].y==1){
            input[0]=i;
			recipe_id[0]=pages[cur_page].entities[i].item[0];
        }
        if(pages[cur_page].entities[i].x==36 && pages[cur_page].entities[i].y==1){
            input[1]=i;
			recipe_id[1]=pages[cur_page].entities[i].item[0];
        }
        if(pages[cur_page].entities[i].x==35 && pages[cur_page].entities[i].y==2){
            input[2]=i;
			recipe_id[2]=pages[cur_page].entities[i].item[0];
        }
        if(pages[cur_page].entities[i].x==36 && pages[cur_page].entities[i].y==2){
            input[3]=i;
			recipe_id[3]=pages[cur_page].entities[i].item[0];
        }
        if(pages[cur_page].entities[i].x==35 && pages[cur_page].entities[i].y==3){
            input[4]=i;
			recipe_id[4]=pages[cur_page].entities[i].item[0];
        }
        if(pages[cur_page].entities[i].x==36 && pages[cur_page].entities[i].y==3){
            input[5]=i;
			recipe_id[5]=pages[cur_page].entities[i].item[0];
        }
    }
	var selected=-1;
	for(var i=0;i<recipies.length;i++){
		if(recipies[i].input_id.length==1){
			if(single_item_craft(recipe_id,recipies[i].input_id)){
				selected=i;
			}
		}else{
			if(compare_array(recipe_id,recipies[i].input_id)){
				selected=i;
				break;
			}
		}
	}
	if(selected==-1){
		return;
	}
	for(var i=0;i<input.length;i++){
		if(input[i]!=-1){
			pages[cur_page].entities[input[i]].item[1]--;
			if(pages[cur_page].entities[input[i]].item[1]<=0){
				pages[cur_page].entities[input[i]].id=-1
			}
		}
	}
	for(var i=0;i<recipies[selected].output.length;i++){
		pages[cur_page].entities.push({id:2, char:item_char[recipies[selected].output[i][0]], x:38, y:1+i, item: recipies[selected].output[i]});
		combine_items(38,1+i,recipies[selected].output[i][0]);
		player.total_crafted++;
	}
}
}

function drop_item(x){
if(player.inv[player.inv[10]][0]==0){//Don't want to be creating dropped items with item id of zero...
	return;
}
var _id=player.inv[player.inv[10]][0];
if(x==0){//drop all
	pages[cur_page].entities.push(
	    {
	    id:2,
	    char:item_char[player.inv[player.inv[10]][0]],
	    x:player.x,
	    y:player.y,
	    item:player.inv[player.inv[10]]
	    });
		if(player.creative!=1){
	    player.inv[player.inv[10]]=[0,0];
		}
		combine_items(player.x,player.y,_id);
}
if(x==1){//drop one
	pages[cur_page].entities.push(
	    {
	    id:2,
	    char:item_char[player.inv[player.inv[10]][0]],
	    x:player.x,
	    y:player.y,
	    item:[player.inv[player.inv[10]][0],1]
	    });
		if(player.creative!=1){
	    player.inv[player.inv[10]]=[player.inv[player.inv[10]][0],player.inv[player.inv[10]][1]-1];
	    if(player.inv[player.inv[10]][1]<1){
		player.inv[player.inv[10]]=[0,0];
	    }
		}
		combine_items(player.x,player.y,_id);
}
if(x=="half"){
	var half_amount=Math.floor(player.inv[player.inv[10]][1]/2);
	if(half_amount<=0){
		return;
	}
	if(player.creative!=1){
	player.inv[player.inv[10]][1]-=half_amount;
	pages[cur_page].entities.push(
	    {
	    id:2,
	    char:item_char[player.inv[player.inv[10]][0]],
	    x:player.x,
	    y:player.y,
	    item:[player.inv[player.inv[10]][0],half_amount]
	    });
	inv_cleanup();
	}
	combine_items(player.x,player.y,_id);
}
player.total_dropped++;
}

function entity_player_collide(ptr){
	if(player.x==pages[cur_page].entities[ptr].x && player.y==pages[cur_page].entities[ptr].y){
		return true;
	}
	return false;
}

function projectile_entity_collide(ptr){//find if specified entity shares same coords as another one.
    for(var i=0;i<pages[cur_page].entities.length;i++){
        if(i==ptr){continue;}
        if(pages[cur_page].entities[ptr].x==pages[cur_page].entities[i].x && pages[cur_page].entities[ptr].y==pages[cur_page].entities[i].y && pages[cur_page].entities[i].id==1){
            return i;
        }
    }
    return -1;
}

function entity_collide_xy_id(x,y,id){//find if specified entity exists on x y axis
	//alert([x,y]);
    for(var i=0;i<pages[cur_page].entities.length;i++){
        if(pages[cur_page].entities[i].x==x && pages[cur_page].entities[i].y==y&&pages[cur_page].entities[i].id==id){
            return i;
        }
    }
    return -1;
}

function hit_bounds(x,y){//bounds check for screen edge.
    return (x<0 || x>39 || y<0 || y>24);
}

function char_entity_on(ptr){//what type of character is the selected entity on?
    return pages[cur_page].map[pages[cur_page].entities[ptr].y][pages[cur_page].entities[ptr].x];
}

function char_value(x,y){
	if(hit_bounds(x,y)){
		return -1;
	}
    return pages[cur_page].map[y][x];
}

function is_walkable(x){
    for(var i=0;i<properties.walkable.length;i++){
        if(properties.walkable[i]==x){
            return true;
        }
    }
    return false;
}

function hitscan_damage(x,y,damage,tmp_entity_ptr,_char,mode=""){
	switch(mode){
		case "sq_inv":
			//dem_ann.textContent=Math.ceil(damage*square_inverse(player.x,player.y,x,y)*player.strength);
			pages[cur_page].entities[tmp_entity_ptr].health-=Math.ceil(damage*square_inverse(player.x,player.y,x,y)*player.strength);
			//actual damage
			if(pages[cur_page].entities[tmp_entity_ptr]<=0){
				pages[cur_page].entities[tmp_entity_ptr].id=-1;
			}
			pages[cur_page].entities.push({id:3, x:x,
			y:y,char:_char,direction:-1,damage:0,decay:0,from_player:1});//for show
			break;
			break;
		default:
			pages[cur_page].entities[tmp_entity_ptr].health-=(damage*player.strength);//actual damage
			if(pages[cur_page].entities[tmp_entity_ptr]<=0){
				pages[cur_page].entities[tmp_entity_ptr].id=-1;
			}
			pages[cur_page].entities.push({id:3, x:x,
			y:y,char:_char,direction:-1,damage:0,decay:0,from_player:1});//for show
			break;
	}
}

function hitscan_effect_debug(x,y){
	if(SHOW_HITSCAN_EFFECT){
		pages[cur_page].entities.push({
			id:PROJ_ID,
			x:x,
			y:y,
			char:T_HITSCAN_DEBUG,
			damage:0,
			direction:P_NONE,
			decay:0,
			from_player:1
		});
	}
}

function microwave_cannon_effect(x,y){
	switch(char_value(x,y)){
		case T_C_W_DOWN_OFF:
		case T_C_W_UP_OFF:
		case T_C_W_LEFT_OFF:
		case T_C_W_RIGHT_OFF:
		case T_C_W_DOWN_ON:
		case T_C_W_UP_ON:
		case T_C_W_LEFT_ON:
		case T_C_W_RIGHT_ON:
		case T_ELECTRODES_ON:
		case T_ELECTRODES_OFF:
		case T_GATE_ON:
		case T_GATE_OFF:
		case T_NOT_GATE_OFF:
		case T_NOT_GATE_ON:
		case T_T_GATE_OFF:
		case T_T_GATE_ON:
		case T_IRON_WALL:
		case T_COPPER_WALL:
			hitscan_effect_debug(x,y);
			//plasma!
			pages[cur_page].entities.push({
			id:PLASMA_ID,
			x:x,
			y:y,
			char:T_PLASMA,
			damage:PLASMA_DAMAGE,
			direction:P_NONE,
			decay:1,
			from_player:0
			});
			return true;//plasma stops hitscan.
		default:
			return !is_walkable(char_value(x,y));
	}
}

function hitscan_effect(x,y,char,mode=""){
	switch(char){
			case T_FIRE0://Microwave cannon
				return microwave_cannon_effect(x,y);
				break;
	}
	return !is_walkable(char_value(x,y));//continue if walkable
}

function hitscan(_x,_y,dir,damage,_char=19,penetration=-1,damage_mode=""){//penetration:number of entities until scanning stops.
	var tmp_entity_ptr;
	if(hit_bounds(_x,_y)){
		return;
	}
	switch(dir){
		case "u"://up
			for(var y=player.y;y>-1;y--){
				if(!hit_bounds(_x,y)){
					if(hitscan_effect(_x,y,_char)){//stop if encounters nonwalkable.
						return;
					}
				}
				tmp_entity_ptr=entity_collide_xy_id(_x,y,1);
				if(SHOW_HITSCAN){
					pages[cur_page].entities.push({
						id:PROJ_ID,
						x:_x,
						y:y,
						char:T_HITSCAN_DEBUG,
						damage:0,
						direction:P_NONE,
						decay:0,
						from_player:1
					});
				}
				if(tmp_entity_ptr==-1){
					continue;
				}
				if(pages[cur_page].entities[tmp_entity_ptr].id==1){//npcs,enemys.
					hitscan_damage(_x,y,damage,tmp_entity_ptr,_char,damage_mode);
				}
			}
			
			break;
		case "d"://down
			for(var y=player.y;y<25;y++){
				if(!hit_bounds(_x,y)){
					if(hitscan_effect(_x,y,_char)){
						return;
					}
				}
				tmp_entity_ptr=entity_collide_xy_id(_x,y,1);
				if(SHOW_HITSCAN){
					pages[cur_page].entities.push({
						id:PROJ_ID,
						x:_x,
						y:y,
						char:T_HITSCAN_DEBUG,
						damage:0,
						direction:P_NONE,
						decay:0,
						from_player:1
					});
				}
				if(tmp_entity_ptr==-1){
					continue;
				}
				if(pages[cur_page].entities[tmp_entity_ptr].id==1){//npcs,enemys.
					hitscan_damage(_x,y,damage,tmp_entity_ptr,_char,damage_mode);
				}
			}
			break;
		case "l"://left
			for(var x=_x;x>-1;x--){
				if(!hit_bounds(x,_y)){
					if(hitscan_effect(x,_y,_char)){
						return;
					}
				}
				tmp_entity_ptr=entity_collide_xy_id(x,_y,1);
				if(SHOW_HITSCAN){
					pages[cur_page].entities.push({
						id:PROJ_ID,
						x:x,
						y:_y,
						char:T_HITSCAN_DEBUG,
						damage:0,
						direction:P_NONE,
						decay:0,
						from_player:1
					});
				}
				if(tmp_entity_ptr==-1){
					continue;
				}
				if(pages[cur_page].entities[tmp_entity_ptr].id==1){//npcs,enemys.
					hitscan_damage(x,_y,damage,tmp_entity_ptr,_char,damage_mode);
				}
			}
			break;
		case "r"://right
			for(var x=player.x;x<40;x++){
				if(!hit_bounds(x,_y)){
					if(hitscan_effect(x,_y,_char)){
						return;
					}
				}
				tmp_entity_ptr=entity_collide_xy_id(x,_y,1);
				if(SHOW_HITSCAN){
					pages[cur_page].entities.push({
						id:PROJ_ID,
						x:x,
						y:_y,
						char:T_HITSCAN_DEBUG,
						damage:0,
						direction:P_NONE,
						decay:0,
						from_player:1
					});
				}
				if(tmp_entity_ptr==-1){
					continue;
				}
				if(pages[cur_page].entities[tmp_entity_ptr].id==1){//npcs,enemys.
					hitscan_damage(x,_y,damage,tmp_entity_ptr,_char,damage_mode);
				}
			}
			break;
	}
}

function can_bang(x){
	for(var i=0;i<properties.bangable.length;i++){
		if(properties.bangable[i]==x){
			return true;
		}
	}
	return false;
}

function do_bang(_x,_y){
	pages[cur_page].entities.push({id:3, x:_x, y:_y, char:19, direction:-1, damage:7, decay:3});//Center Bang
	if(!hit_bounds(_x-1,_y)){
	pages[cur_page].entities.push({id:3, x:_x-1, y:_y, char:19, direction:-1, damage:7, decay:3});//Left
	}
	if(!hit_bounds(_x+1,_y)){
	pages[cur_page].entities.push({id:3, x:_x+1, y:_y, char:19, direction:-1, damage:7, decay:3});//Right
	}
	if(!hit_bounds(_x,_y-1)){
	pages[cur_page].entities.push({id:3, x:_x, y:_y-1, char:19, direction:-1, damage:7, decay:3});//Up
	}
	if(!hit_bounds(_x,_y+1)){
	pages[cur_page].entities.push({id:3, x:_x, y:_y+1, char:19, direction:-1, damage:7, decay:3});//Down
	}
}

function projectile_effect(ptr,collided=-1){
if(pages[cur_page].entities[ptr]==undefined){
	return;
}
switch(pages[cur_page].entities[ptr].char){
	case 35://Amber, bow
		if(collided!=-1){
			pages[cur_page].entities[collided].fire_tick=ON_FIRE_COUNT;
		}
		if(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)==0 || is_burnable(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y))){
			pages[cur_page].map[pages[cur_page].entities[ptr].y][pages[cur_page].entities[ptr].x]=30;
		}
		break;
	case T_FIRE0://microwave cannon
		if(collided!=-1){
			pages[cur_page].entities[collided].fire_tick=ON_FIRE_COUNT;
		}
		if(is_burnable(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y))){
			pages[cur_page].map[pages[cur_page].entities[ptr].y][pages[cur_page].entities[ptr].x]=30;
		}
		break;
	case 20://raygun ring
		switch(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)){
			case 64://Iron Wall, hole to "the slip"
				if(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y-1)==40 &&
				char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y+1)==40 &&
				char_value(pages[cur_page].entities[ptr].x-1,pages[cur_page].entities[ptr].y)==40 &&
				char_value(pages[cur_page].entities[ptr].x+1,pages[cur_page].entities[ptr].y)==40 &&
				char_value(pages[cur_page].entities[ptr].x-1,pages[cur_page].entities[ptr].y-2)==58 &&
				char_value(pages[cur_page].entities[ptr].x+1,pages[cur_page].entities[ptr].y-2)==58 &&
				char_value(pages[cur_page].entities[ptr].x-1,pages[cur_page].entities[ptr].y+2)==58 &&
				char_value(pages[cur_page].entities[ptr].x+1,pages[cur_page].entities[ptr].y+2)==58 &&
				char_value(pages[cur_page].entities[ptr].x-2,pages[cur_page].entities[ptr].y+1)==58 &&
				char_value(pages[cur_page].entities[ptr].x-2,pages[cur_page].entities[ptr].y-1)==58 &&
				char_value(pages[cur_page].entities[ptr].x+2,pages[cur_page].entities[ptr].y+1)==58 &&
				char_value(pages[cur_page].entities[ptr].x+2,pages[cur_page].entities[ptr].y-1)==58){
					pages[cur_page].holes.push({
					x:pages[cur_page].entities[ptr].x,
					y:pages[cur_page].entities[ptr].y,
					dest_page:[pages[cur_page].metadata.x,
					pages[cur_page].metadata.y,0],
					next_x:19,
					next_y:12
					});
				var hole_ptr=pages[cur_page].holes.length-1;
				switch(pages[cur_page].metadata.layer){
					case -1:
						pages[cur_page].holes[hole_ptr].dest_page[2]=1;
						break;
					case 0:
						pages[cur_page].holes[hole_ptr].dest_page[2]=1;
						break;
					case 1:
						pages[cur_page].holes[hole_ptr].dest_page[2]=0;
						break;
				}
				pages[cur_page].map[pages[cur_page].entities[ptr].y][pages[cur_page].entities[ptr].x]=6;
				pages[cur_page].map[pages[cur_page].entities[ptr].y][pages[cur_page].entities[ptr].x-1]=2
				pages[cur_page].map[pages[cur_page].entities[ptr].y][pages[cur_page].entities[ptr].x+1]=2;
				pages[cur_page].map[pages[cur_page].entities[ptr].y-1][pages[cur_page].entities[ptr].x]=2;
				pages[cur_page].map[pages[cur_page].entities[ptr].y+1][pages[cur_page].entities[ptr].x]=2;
				}
				break;
		}
		do_bang(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y);
		if(can_bang(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y))){
			switch(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)){
				case 5://Black stone?
					pages[cur_page].map[pages[cur_page].entities[ptr].y][pages[cur_page].entities[ptr].x]=2;
					break;
				case 97://statue
					pages[cur_page].map[pages[cur_page].entities[ptr].y][pages[cur_page].entities[ptr].x]=2;
					break;
				default:
					pages[cur_page].map[pages[cur_page].entities[ptr].y][pages[cur_page].entities[ptr].x]=0;
			}
		}
		sfx("raygun_bang");
		break;
	case T_PLASMA://plasma
		if(is_burnable(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y))){
			//dem_ann.textContent=[pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y];
			pages[cur_page].map[pages[cur_page].entities[ptr].y][pages[cur_page].entities[ptr].x]=30;
			return;
		}
		switch(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)){
			case T_C_W_UP_OFF:
			case T_C_W_DOWN_OFF:
			case T_C_W_LEFT_OFF:
			case T_C_W_RIGHT_OFF:
			case T_C_W_UP_ON:
			case T_C_W_DOWN_ON:
			case T_C_W_LEFT_ON:
			case T_C_W_RIGHT_ON:
				pages[cur_page].map[pages[cur_page].entities[ptr].y][pages[cur_page].entities[ptr].x]=0;
		}
		break;
	default:
		0;
}
}

function projectile_step(ptr){
if(pages[cur_page].entities[ptr]==undefined){
	return;
}
    switch(pages[cur_page].entities[ptr].direction){
        case -1:
            break;
        case 0://up
            pages[cur_page].entities[ptr].y--;
            break;
        case 1://down
            pages[cur_page].entities[ptr].y++;
            break;
        case 2://left
            pages[cur_page].entities[ptr].x--;
            break;
        case 3://right
            pages[cur_page].entities[ptr].x++;
            break;
    }
	if(pages[cur_page].entities[ptr].decay!=-1){
    pages[cur_page].entities[ptr].decay--;
	}
}

function projectile_check(ptr){
	var cur_x=pages[cur_page].entities[ptr].x;
	var cur_y=pages[cur_page].entities[ptr].y;
	var next_x=cur_x;
	var next_y=cur_y;
	switch(pages[cur_page].entities[ptr].direction){
        case -1:
            break;
        case 0://up
            next_y--;
            break;
        case 1://down
			next_y++;
            break;
        case 2://left
			next_x--;
            break;
        case 3://right
			next_x++;
            break;
    }
	if(pages[cur_page].entities[ptr]==undefined){
		return;
	}
    if(pages[cur_page].entities[ptr].decay==0){
		projectile_effect(ptr);
		pages[cur_page].entities[ptr].id=-1;
        return;
    }
	if(hit_bounds(cur_x,cur_y)){//move entity to next page when hit edges if possible
		var next_page=-1;
		var dir="";
		if(pages[cur_page].entities[ptr].x<0){//left edge, west_goto
			next_page=get_ptr_from_page_xy(pages[cur_page].metadata.x-1,
			pages[cur_page].metadata.y,
			pages[cur_page].metadata.layer);
			dir="left";
		}
		if(pages[cur_page].entities[ptr].x>39){//right edge, east_goto
			next_page=get_ptr_from_page_xy(pages[cur_page].metadata.x+1,
			pages[cur_page].metadata.y,
			pages[cur_page].metadata.layer);
			dir="right";
		}
		if(pages[cur_page].entities[ptr].y<0){//top edge, north_goto
			next_page=get_ptr_from_page_xy(pages[cur_page].metadata.x,
			pages[cur_page].metadata.y-1,
			pages[cur_page].metadata.layer);
			dir="up";
		}
		if(pages[cur_page].entities[ptr].y>24){//bottom edge, south_goto
			next_page=get_ptr_from_page_xy(pages[cur_page].metadata.x,
			pages[cur_page].metadata.y+1,
			pages[cur_page].metadata.layer);
			dir="down";
		}
		if(next_page==-1){
			projectile_effect(ptr);
        	pages[cur_page].entities[ptr].id=-1;
        	entity_cleanup();
        	return;
		}else{
		switch(dir){
			case "up":
				pages[cur_page].entities[ptr].y=24;
				break;
			case "down":
				pages[cur_page].entities[ptr].y=0;
				break;
			case "left":
				pages[cur_page].entities[ptr].x=39;
				break;
			case "right":
				pages[cur_page].entities[ptr].x=0;
				break;
		}
		move_entity(ptr,next_page);
		return;
		}
	}
    //var collided=projectile_entity_collide(ptr);
	var collided=entity_collide_xy_id(cur_x,cur_y,NPC_ID);
	collided=(collided==-1)?entity_collide_xy_id(next_x,next_y,NPC_ID):collided;
	//entity_collide_xy_id(x,y,id)
    if(collided!=-1){//hits entity
        if(pages[cur_page].entities[collided].health!=undefined){
			projectile_effect(ptr,collided);
            pages[cur_page].entities[collided].health-=pages[cur_page].entities[ptr].damage;//inflict damage on target entity
            pages[cur_page].entities[ptr].id=-1;//Mark projectile for deletion.
	    	//return;
        }
    }
    //collided=entity_player_collide();
    if(entity_player_collide(ptr)){//hits player
		if(pages[cur_page].entities[ptr].from_player==1){//don't inflict damage on oneself.
			return;
		}
		projectile_effect(ptr);
		damage_player(pages[cur_page].entities[ptr].damage);
        pages[cur_page].entities[ptr].id=-1;
		return;
    }
    if(!is_walkable(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y))){//encounters non walkable block
		projectile_effect(ptr);
        pages[cur_page].entities[ptr].id=-1;
        return;
    }
	if(is_burnable(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)) && pages[cur_page].entities[ptr].char==35){//amber encounters burnable block
		projectile_effect(ptr);
        pages[cur_page].entities[ptr].id=-1;
        return;
    }
}
function projectile(ptr){//Code for making projectiles move and interact with ThInGs
	projectile_check(ptr);
	projectile_step(ptr);
	//projectile_check(ptr);
}

function item_pickup_dropoff(item_id,x,y){
	if(player.creative==1){
		if(holding_attack_item()){
			return;
		}
		pages[cur_page].map[y][x]=0;
		player.total_removed++;
		return true;
	}
	if(player.inv[player.inv[10]][0]==0){
            player.inv[player.inv[10]][0]=item_id;
            pages[cur_page].map[y][x]=0;
		player.total_removed++;
    }
    if(player.inv[player.inv[10]][0]==item_id){
        player.inv[player.inv[10]][1]++;
        pages[cur_page].map[y][x]=0;
    }
player.total_removed++;
return true;
}

function remove_char(x,y){
if(player.inv[player.inv[10]][0]==67){
	return;
}
switch(char_value(x,y)){
    case 18://fence
		return item_pickup_dropoff(6,x,y);
	case 12://Hay
		return item_pickup_dropoff(24,x,y);
	case 54://peels
		return item_pickup_dropoff(27,x,y);
	case 58://Bookshelf
		return item_pickup_dropoff(31,x,y);
	case 64://Iron wall
		return item_pickup_dropoff(37,x,y);
	case 65://Copper wall
		return item_pickup_dropoff(38,x,y);
	case 72://MDF
		return item_pickup_dropoff(45,x,y);
	case 74://Green Stained MDF
		return item_pickup_dropoff(47,x,y);
	case 75://Red Stained MDF
		return item_pickup_dropoff(48,x,y);
	case 76://Cyan Stained MDF
		return item_pickup_dropoff(49,x,y);
	case 90://Gate, off
		return item_pickup_dropoff(70,x,y);
	case 91://Gate, on
		return item_pickup_dropoff(70,x,y);
	case 93://pump
		return item_pickup_dropoff(72,x,y);
	case 7://Bedding
		return item_pickup_dropoff(51,x,y);
	case 101://Glass
		return item_pickup_dropoff(78,x,y);
	case T_CAP4://capacitor
	case T_CAP3:
	case T_CAP2:
	case T_CAP1:
	case T_CAP0:
		return item_pickup_dropoff(I_CAPACITOR,x,y);
	case T_COMPOSTER:
		return item_pickup_dropoff(I_COMPOSTER,x,y);
	case 42://closed door
		pages[cur_page].map[y][x]=43;
		return true;
	case 43://open door
		pages[cur_page].map[y][x]=42;
		return true;
	case 30://fire 0
	case 31://fire 1
	case 32://fire 2
		pages[cur_page].map[y][x]=0;
		return true;
	case 86://switch off
		pages[cur_page].map[y][x]=87;
		radio_interference(x,y);
		return true;
	case 87://switch on
		pages[cur_page].map[y][x]=86;
		radio_interference(x,y)
		return true;
	case 94://Fan
		return item_pickup_dropoff(73,x,y);
	case T_CLOCK_RADIO://Clock Radio
		clock_radio_interact();
		return true;
	case T_BUTTON_OFF:
	case T_BUTTON_ON:
		pages[cur_page].map[y][x]=T_BUTTON_ON;
		return true;
	default:
		if(player.creative==1){
			if(holding_attack_item()){
				return;
			}
			var _char=char_value(x,y);//Performance optimization.
			for(var i=0;i<properties.creative_noremove.length;i++){
				if(_char==properties.creative_noremove[i]){
					return false;
				}
			}
			pages[cur_page].map[y][x]=0;
			player.total_removed++;
			return false;
		}
		break;
}
}

function holding_attack_item(){
	for(var i=0;i<properties.attack_items.length;i++){
		if(properties.attack_items[i]==player.inv[player.inv[10]][0]){
			return true;
		}
	}
	return false;
}

function attack(x){
var is_entity=-1;//does an entity exist at that place?
switch(x){
    case "up":
        is_entity=entity_collide_xy_id(player.x,player.y-1,DROPPED_ITEM_ID);
        break;
    case "down":
	is_entity=entity_collide_xy_id(player.x,player.y+1,DROPPED_ITEM_ID);
        break;
    case "left":
	is_entity=entity_collide_xy_id(player.x-1,player.y,DROPPED_ITEM_ID);
        break;
    case "right":
	is_entity=entity_collide_xy_id(player.x+1,player.y,DROPPED_ITEM_ID);
        break;
}
if(is_entity==-1){//no entity
switch(x){
    case "up":
        if(remove_char(player.x,player.y-1)){return;}
        break;
    case "down":
        if(remove_char(player.x,player.y+1)){return;};
        break;
    case "left":
        if(remove_char(player.x-1,player.y)){return;};
        break;
    case "right":
        if(remove_char(player.x+1,player.y)){return;};
        break;
}
}
switch(player.inv[player.inv[10]][0]){
	case I_FISH_ROD:
		var reeled=false;
		for(var i=0;i<pages[cur_page].entities.length;i++){
			if(pages[cur_page].entities[i].id==BOBBER_ID){//is there already a bobber?
				pages[cur_page].entities[i].id=-1;//reel it in (delete)
				reeled=true;
			}
		}
		if(reeled){
			break;
		}
		var bobber_time=MIN_CATCH_TIME+(Math.floor(Math.random()*65535)%CATCH_TIME_ADD_MAX);
		switch(x){//direction to cast
			case "up":
				if(!hit_bounds(player.x,player.y-1)){
					if(pages[cur_page].map[player.y-1][player.x]==T_WATER){
						pages[cur_page].entities.push({id:BOBBER_ID,x:player.x,y:player.y-1,char:T_FISH_BOBBER,delay:bobber_time});
					}
				}
				break;
			case "down":
				if(!hit_bounds(player.x,player.y+1)){
					if(pages[cur_page].map[player.y+1][player.x]==T_WATER){
						pages[cur_page].entities.push({id:BOBBER_ID,x:player.x,y:player.y+1,char:T_FISH_BOBBER,delay:bobber_time});
					}
				}
				break;
			case "left":
				if(!hit_bounds(player.x-1,player.y)){
					if(pages[cur_page].map[player.y][player.x-1]==T_WATER){
						pages[cur_page].entities.push({id:BOBBER_ID,x:player.x-1,y:player.y,char:T_FISH_BOBBER,delay:bobber_time});
					}
				}
				break;
			case "right":
				if(!hit_bounds(player.x+1,player.y)){
					if(pages[cur_page].map[player.y][player.x+1]==T_WATER){
						pages[cur_page].entities.push({id:BOBBER_ID,x:player.x+1,y:player.y,char:T_FISH_BOBBER,delay:bobber_time});
					}
				}
				break;
		}
		break;
	case I_BOW:
		//check for ambers in inventory.
		var proj_ptr=-1;
		for(var i=0;i<player.inv.length;i++){
			switch(player.inv[i][0]){
				case I_AMBER:
					proj_ptr=i;
					break;
				case I_ARROW:
					proj_ptr=i;
					break;
			}
		}
		switch(player.inv[proj_ptr][0]){
			case I_AMBER:
			switch(x){
				case "up":
					pages[cur_page].entities.push({id:3, x:player.x, y:player.y-1, char:35, direction:0, damage:player.strength*AMBER_PROJ_STRENGTH, decay:AMBER_PROJ_DECAY, from_player:1});
					pages[cur_page].entities.push({id:3, x:player.x-1, y:player.y-1, char:35, direction:0, damage:player.strength*AMBER_PROJ_STRENGTH, decay:AMBER_PROJ_DECAY, from_player:1});
					pages[cur_page].entities.push({id:3, x:player.x+1, y:player.y-1, char:35, direction:0, damage:player.strength*AMBER_PROJ_STRENGTH, decay:AMBER_PROJ_DECAY, from_player:1});player.total_wielded++;
					break;
				case "down":
					pages[cur_page].entities.push({id:3, x:player.x, y:player.y+1, char:35, direction:1, damage:player.strength*AMBER_PROJ_STRENGTH, decay:AMBER_PROJ_DECAY, from_player:1});
					pages[cur_page].entities.push({id:3, x:player.x-1, y:player.y+1, char:35, direction:1, damage:player.strength*AMBER_PROJ_STRENGTH, decay:AMBER_PROJ_DECAY, from_player:1});
					pages[cur_page].entities.push({id:3, x:player.x+1, y:player.y+1, char:35, direction:1, damage:player.strength*AMBER_PROJ_STRENGTH, decay:AMBER_PROJ_DECAY, from_player:1});player.total_wielded++;
					break;
				case "left":
					pages[cur_page].entities.push({id:3, x:player.x-1, y:player.y, char:35, direction:2, damage:player.strength*AMBER_PROJ_STRENGTH, decay:AMBER_PROJ_DECAY, from_player:1});
					pages[cur_page].entities.push({id:3, x:player.x-1, y:player.y+1, char:35, direction:2, damage:player.strength*AMBER_PROJ_STRENGTH, decay:AMBER_PROJ_DECAY, from_player:1});
					pages[cur_page].entities.push({id:3, x:player.x-1, y:player.y-1, char:35, direction:2, damage:player.strength*AMBER_PROJ_STRENGTH, decay:AMBER_PROJ_DECAY, from_player:1});player.total_wielded++;
					break;
				case "right":
					pages[cur_page].entities.push({id:3, x:player.x+1, y:player.y, char:35, direction:3, damage:player.strength*AMBER_PROJ_STRENGTH, decay:AMBER_PROJ_DECAY, from_player:1});
					pages[cur_page].entities.push({id:3, x:player.x+1, y:player.y+1, char:35, direction:3, damage:player.strength*AMBER_PROJ_STRENGTH, decay:AMBER_PROJ_DECAY, from_player:1});
					pages[cur_page].entities.push({id:3, x:player.x+1, y:player.y-1, char:35, direction:3, damage:player.strength*AMBER_PROJ_STRENGTH, decay:AMBER_PROJ_DECAY, from_player:1});player.total_wielded++;
					break;
			}
			break;
		case I_ARROW:
			switch(x){
				case "up":
					pages[cur_page].entities.push({id:3, x:player.x, y:player.y-1, char:T_ARROW, direction:0, damage:player.strength*ARROW_STRENGTH, decay:ARROW_DECAY, from_player:1});player.total_wielded++;
					break;
				case "down":
					pages[cur_page].entities.push({id:3, x:player.x, y:player.y+1, char:T_ARROW, direction:1, damage:player.strength*ARROW_STRENGTH, decay:ARROW_DECAY, from_player:1});player.total_wielded++;
					break;
				case "left":
					pages[cur_page].entities.push({id:3, x:player.x-1, y:player.y, char:T_ARROW, direction:2, damage:player.strength*ARROW_STRENGTH, decay:ARROW_DECAY, from_player:1});player.total_wielded++;
					break;
				case "right":
					pages[cur_page].entities.push({id:3, x:player.x+1, y:player.y, char:T_ARROW, direction:3, damage:player.strength*ARROW_STRENGTH, decay:ARROW_DECAY, from_player:1});player.total_wielded++;
					break;
			}
			break;
		}
		if(proj_ptr!=-1&&player.creative!=1){
			player.inv[proj_ptr][1]--;
			if(player.inv[proj_ptr][1]<=0){
				player.inv[proj_ptr][0]=0;
				player.inv[proj_ptr][1]=0;
			}
		}else{
			break;
		}
		break;
	case I_SPEAR://spear
	switch(x){
	    case "up":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y-1, char:37, direction:P_UP, damage:player.strength*SPEAR_STRENGTH, decay:SPEAR_DECAY, from_player:1});player.total_wielded++;
 	       break;
 	   case "down":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y+1, char:37, direction:P_DOWN, damage:player.strength*SPEAR_STRENGTH, decay:SPEAR_DECAY, from_player:1});player.total_wielded++;
 	       break;
 	   case "left":
  	       pages[cur_page].entities.push({id:3, x:player.x-1, y:player.y, char:37, direction:P_LEFT, damage:player.strength*SPEAR_STRENGTH, decay:SPEAR_DECAY, from_player:1});player.total_wielded++;
  	       break;
  	   case "right":
   	       pages[cur_page].entities.push({id:3, x:player.x+1, y:player.y, char:37, direction:P_RIGHT, damage:player.strength*SPEAR_STRENGTH, decay:SPEAR_DECAY, from_player:1});player.total_wielded++;
   	       break;
	}
	inv_cleanup();
    break;
	case 19://Raygun
	switch(x){
	    case "up":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y-1, char:20, direction:0, damage:player.strength*1000, decay:50, from_player:1});
		   sfx("raygun_cooldown");player.total_wielded++;
 	       break;
 	   case "down":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y+1, char:20, direction:1, damage:player.strength*1000, decay:50, from_player:1});
		   sfx("raygun_cooldown");player.total_wielded++;
 	       break;
 	   case "left":
  	       pages[cur_page].entities.push({id:3, x:player.x-1, y:player.y, char:20, direction:2, damage:player.strength*1000, decay:50, from_player:1});
		   sfx("raygun_cooldown");player.total_wielded++;
  	       break;
  	   case "right":
   	       pages[cur_page].entities.push({id:3, x:player.x+1, y:player.y, char:20, direction:3, damage:player.strength*1000, decay:50, from_player:1});
		   sfx("raygun_cooldown");player.total_wielded++;
   	       break;
	}
	inv_cleanup();
	break;39
	/*case 20://Poisonous Spear
	switch(x){
	    case "up":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y-1, char:39, direction:-1, damage:player.strength*30, decay:3, from_player:1});
 	       player.total_wielded++;
		break;
 	   case "down":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y+1, char:39, direction:-1, damage:player.strength*30, decay:3, from_player:1});
 	       player.total_wielded++;
		break;
 	   case "left":
  	       pages[cur_page].entities.push({id:3, x:player.x-1, y:player.y, char:39, direction:-1, damage:player.strength*30, decay:3, from_player:1});
  	       player.total_wielded++;
		break;
  	   case "right":
   	       pages[cur_page].entities.push({id:3, x:player.x+1, y:player.y, char:39, direction:-1, damage:player.strength*30, decay:3, from_player:1});
   	       player.total_wielded++;
		break;
	}
	break;*/
	case 67://copper wire
		if(char_value(player.x,player.y)!=0){
			break;
		}
		switch(x){
			case "up":
				pages[cur_page].map[player.y][player.x]=77;
				break;
			case "down":
				pages[cur_page].map[player.y][player.x]=78;
				break;
			case "left":
				pages[cur_page].map[player.y][player.x]=79;
				break;
			case "right":
				pages[cur_page].map[player.y][player.x]=80;
				break;
		}
		player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
		if(player.inv[player.inv[10]][1]<=0){
			player.inv[player.inv[10]][0]=0;
		}
		break;
	case 79://microwave cannon
		last_filament=player.filament;
		player.filament=(player.filament+FILAMENT_THERMAL_WARMUP<FILAMENT_THERMAL_MASS)?player.filament+FILAMENT_THERMAL_WARMUP:FILAMENT_THERMAL_MASS;
		magnatron_sounds();
		if(player.filament<FILAMENT_THERMAL_ENOUGH){
			return;
		}
		switch(x){
			case "up":
				for(var i=-7;i<8;i++){
				hitscan(player.x+i,player.y,'u',MICROWAVE_PWM,30,-1,"sq_inv");
				}
				player.total_wielded++;
				break;
			case "down":
				for(var i=-7;i<8;i++){
				hitscan(player.x+i,player.y,'d',MICROWAVE_PWM,30,-1,"sq_inv");
				}player.total_wielded++;
				break;
			case "left":
				for(var i=-7;i<8;i++){
				hitscan(player.x,player.y+i,'l',MICROWAVE_PWM,30,-1,"sq_inv");
				}player.total_wielded++;
				break;
			case "right":
				for(var i=-7;i<8;i++){
				hitscan(player.x,player.y+i,'r',MICROWAVE_PWM,30,-1,"sq_inv");
				}player.total_wielded++;
				break;
		}
		break;
	case I_RING:
		var mate=-1;
		switch(x){
			case "up":
				mate=entity_collide_xy_id(player.x,player.y-1,NPC_ID);
				break;
			case "down":
				mate=entity_collide_xy_id(player.x,player.y+1,NPC_ID);
				break;
			case "left":
				mate=entity_collide_xy_id(player.x-1,player.y,NPC_ID);
				break;
			case "right":
				mate=entity_collide_xy_id(player.x+1,player.y,NPC_ID);
				break;
		}
		if(mate==-1){
			return;
		}
		if(pages[cur_page].entities[mate].brain.hostile==0){
			new_npc(player.x,player.y,player.x,player.y);
			player.inv[player.inv[10]][1]--;
			if(player.inv[player.inv[10]][1]<=0){
				player.inv[player.inv[10]][0]=0;
				player.inv[player.inv[10]][1]=0;
			}
			player.times_laid++;
		}
		break;
	default:
		switch(x){
 		 	case "up":
      	  pages[cur_page].entities.push({id:3, x:player.x, y:player.y-1, char:19, direction:-1, damage:player.strength, decay:3, from_player:1});
 	       break;
   		 case "down":
   		     pages[cur_page].entities.push({id:3, x:player.x, y:player.y+1, char:19, direction:-1, damage:player.strength, decay:3, from_player:1});
   		     break;
   		 case "left":
    	    pages[cur_page].entities.push({id:3, x:player.x-1, y:player.y, char:19, direction:-1, damage:player.strength, decay:3, from_player:1});
    	    break;
  		  case "right":
   		     pages[cur_page].entities.push({id:3, x:player.x+1, y:player.y, char:19, direction:-1, damage:player.strength, decay:3, from_player:1});
    	    break;
}
}
}

function is_bonemealable(x){
	for(var i=0;i<properties.bonemealable.length;i++){
		if(properties.bonemealable[i]==x){
			return true;
		}
	}
	return false;
}

function use_item(){
if(char_value(player.x,player.y)==0){
for(var i=0;i<properties.placeable_breakable.length;i++){
	if(player.inv[player.inv[10]][0]==properties.placeable_breakable[i]){
		pages[cur_page].map[player.y][player.x]=item_char[player.inv[player.inv[10]][0]];//place_item
		player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
		inv_cleanup();
		player.total_placed++;
		return;
	}
}
}
switch(player.inv[player.inv[10]][0]){//item id
    case 12: //Mushroom Stew
        if(player.health>=20){
            break;
        }
	heal_player(5);
        if(player.health>20 && player.creative==0){
            player.health=20;
        }
		
	player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
	pages[cur_page].entities.push({
		id:2,
		x:player.x,
		y:player.y,
		char:item_char[11],
		item:[11,1]
		});//drop bowl
		combine_items(player.x,player.y,11);
	player.total_used++;
	break;
	case 16://amber
		if(char_value(player.x,player.y)==0){
			pages[cur_page].map[player.y][player.x]=30;
			player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
		}
		player.total_placed++;
		break;
	case 23://stone
		if(char_value(player.x,player.y)==0){
			pages[cur_page].map[player.y][player.x]=2;
			player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
		}
		player.total_placed++;
		break;
    case 26://walnut stone
        if(player.health>=20){
            break;
        }
		heal_player(10);
        if(player.health>20 && player.creative==0){
            player.health=20;
        }
		player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
		player.total_used++;
		break;
	case 28://bone meal
		if(!is_bonemealable(char_value(player.x,player.y))){
			return;
		}
		random_tick(player.x,player.y,1);
		player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
		inv_cleanup();
		player.total_used++;
		break;
	case 34: //Meat
        if(player.health>=20){
            break;
        }
		heal_player(2);
        if(player.health>20 && player.creative==0){
            player.health=20;
        }
		player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
		player.total_used++;
		break;
	case 36: //Cooked Meat
        if(player.health>=20){
            break;
        }
		heal_player(10);
        if(player.health>20 && player.creative==0){
            player.health=20;
        }
		player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
		player.total_used++;
		break;
	case 40: //Suspicious Stew
		player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
		heal_player(20);
        if(player.health>20 && player.creative==0){
            player.health=20;
        }
		pages[cur_page].entities.push({
		id:2,
		x:player.x,
		y:player.y,
		char:item_char[11],
		item:[11,1]
		});//drop bowl
		player.total_used++;
		combine_items(player.x,player.y,11);
		var choice=Math.floor(Math.random()*65535)%3;
        switch(choice){
			case 0://strength boost
				player.strength=1.5;
				break;
			case 1://Health boost
				player.health=40;
				break;
			case 2://Nothing
				break;
		}
	case 50://black wall
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[50] : 0;
		player.total_removed++;
		break;
	/*case 51://bedding 1
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[51] : 0;
		break;*/
	/*case 52://bedding 2
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[52] : 0;
		break;*/
	case 53://tree leaves
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[53] : 0;
		player.total_removed++;
		break;
	case 54://tree trunk
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[54] : 0;
		player.total_removed++;
		break;
	case 55://water
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[55] : 0;player.total_removed++;
		break;
	case 56://fire 0
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[56] : 0;player.total_removed++;
		break;
	case 57://fire 1
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[57] : 0;player.total_removed++;
		break;
	case 58://fire 2
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[58] : 0;player.total_removed++;
		break;
	case 59://NPC Hole
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[59] : 0;player.total_removed++;
		break;
	case 60://Walnut Trunk
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[60] : 0;player.total_removed++;
		break;
	case 61://Walnut Leaves 1
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[61] : 0;player.total_removed++;
		break;
	case 62://Walnut Leaves 2
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[62] : 0;player.total_removed++;
		break;
	case 63://Walnut Leaves 3
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[63] : 0;player.total_removed++;
		break;
	case 64://Walnut Leaves 4
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[64] : 0;player.total_removed++;
		break;
	case 65://Walnut Leaves 5
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[65] : 0;player.total_removed++;
		break;
	case 66://Walnut Leaves 6
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[66] : 0;player.total_removed++;
		break;
	case I_MOUSE_EGG://Mouse Spawn Egg
		if(player.creative==1){
			new_npc(player.x,player.y,player.x,player.y);
			player.total_used++;
		}
		break;
	case I_ENEMY_EGG://Enemy Spawn Egg
		if(player.creative==1){
			pages[cur_page].entities.push({
					id:NPC_ID,
					char:4,
					x:player.x,
					y:player.y,
					brain:{
						no_ai:0,
						hostile:1,
					},
					health:ENEMY_HEALTH,
					strength:ENEMY_STRENGTH,
					attack_cooldown:0,
					random_x:0,
					random_y:0
				});
		player.total_used++;
		}
		break;
	case I_CAT_EGG://Cat Spawn Egg
		if(player.creative==1){
			new_cat(player.x,player.y,cur_page);
			player.total_used++;
		}
		break;
	case I_FISH://fish
        	if(player.health>=20){
            		break;
        	}
			heal_player(5);
		if(player.health>20 && player.creative==0){
            		player.health=20;
        	}
		player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
		player.total_used++;
		break;
	/*case 52://statue
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[52] : 0;
		break;*/
}
inv_cleanup();
}

function cheats(){
    var cheat_code=prompt("Cheat?");
    switch(cheat_code){
        case "Juggernog":
			player.tainted=1;
            player.health=20;
            break;
        case "gamemode c":
			player.tainted=1;
            player.creative=1;
			player.strength=65535;
            player.health=Infinity;
			player.inv[0]=[item_id_from_name("Grass"),255];
			player.inv[1]=[item_id_from_name("red mushroom"),255];
			player.inv[2]=[item_id_from_name("brown mushroom"),255];
			player.inv[3]=[item_id_from_name("fence"),255];
			player.inv[4]=[item_id_from_name("sapling"),255];
			player.inv[5]=[item_id_from_name("carpet"),255];
			player.inv[6]=[item_id_from_name("door"),255];
			player.inv[7]=[item_id_from_name("stone"),255];
			player.inv[8]=[item_id_from_name("hay bail"),255];
			player.inv[9]=[item_id_from_name("mdf"),255];
            break;
        case "Give me what I want!":
			player.tainted=1;
            player.inv[player.inv[10]]=JSON.parse(prompt("Item?"));
            break;
		case "Let it grow!":
			player.tainted=1;
            random_tick(player.x,player.y);
            break;
		case "?":
			player.tainted=1;
			if(player.brain.dysphoria==1){
				player.brain.gender=player.brain.gender^1;
				dem_ann.textContent="You have been blessed by the god of Gender Euphoria."
			}else{
				dem_ann.textContent="You are not one of Alex's subjects."
			}
			break;
		case "!":
			player.tainted=1;
			if(player.brain.dysphoria==1){
				dem_ann.textContent="The god of Gender Euphoria has answered your prayers."
				for(var i=0;i<pages[cur_page].entities.length;i++){
					if(pages[cur_page].entities[i].id==NPC_ID){
						if(pages[cur_page].entities[i].brain.hostile==0){
							pages[cur_page].entities[i].brain.identity.gender=pages[cur_page].entities.brain.identity.gender^1;
						}
						if(pages[cur_page].entities[i].brain.hostile==1){
						
						}
					}
				}
			}else{
				dem_ann.textContent="You are not one of Alex's subjects."
			}
			break;
	case "noclip":
		player.tainted=1;
		player.noclip=1;
		break;
        default:
            alert("No cheat for you!");
            break;
    }
}

//keys
function key_manager(key){
if(SHOW_KEYCODE){
dem_ann.textContent="keycode: "+key;
}
//Movement
last_dir="";
if(key==80){//pause, p
	switch(paused){
		case 0:
			paused=1;
			dem_ann.textContent="Paused";
			break;
		case 1:
			paused=0;
			dem_ann.textContent="Unpaused";
			break;
	}
}

if(is_dead){
	return;
}

if(paused==1){
	_sfx.pause();
	return;
}
/*switch(key){
	case 67://c,crafting
		game_state=CRAFTING;
		break;
	case 27://esc,escape
		game_state=GAMING;
		break;
}
switch(game_state){
	case GAMING:
		break;
	case CRAFTING:
		return;
		break;
}*/
switch(key){
    case 87://up,w
	last_dir="up";
	if(hit_bounds(player.x,player.y-1)){
		off_edge("up");
		player.steps++;
	}
	if(!(hit_bounds(player.x,player.y) || hit_bounds(player.x,player.y-1) || !player.noclip&&!is_walkable(char_value(player.x,player.y-1)))){
        	player.y-=1;
		player.steps++;
        }
        return;
    case 83://down, s
	last_dir="down";
	if(hit_bounds(player.x,player.y+1)){
		off_edge("down");
		player.steps++;
	}
        if(!(hit_bounds(player.x,player.y) || hit_bounds(player.x,player.y+1) || !player.noclip&&!is_walkable(char_value(player.x,player.y+1)))){
        	player.y+=1;
		player.steps++;
        }
        return;
    case 65://left, a
	last_dir="left";
	if(hit_bounds(player.x-1,player.y)){
		off_edge("left");
		player.steps++;
	}
        if(!(hit_bounds(player.x,player.y) || hit_bounds(player.x-1,player.y) || !player.noclip&&!is_walkable(char_value(player.x-1,player.y)))){
        	player.x-=1;
		player.steps++;
        }
        return;
    case 68://right, d
	last_dir="right";
	if(hit_bounds(player.x+1,player.y)){
		off_edge("right");
		player.steps++;
	}
        if(!(hit_bounds(player.x,player.y) || hit_bounds(player.x+1,player.y) || !player.noclip&&!is_walkable(char_value(player.x+1,player.y)))){
        	player.x+=1;
		player.steps++;
        }
        return;
}
//attack
switch(key){
   case 38:
        attack("up");
        break;
   case 40:
        attack("down");
        break;
   case 37:
        attack("left");
        break;
   case 39:
        attack("right");
        break;
}

if(player.creative==1){
switch(key){//creative stuff
	case 219://[
		player.inv[player.inv[10]][0]--;
		if(player.inv[player.inv[10]][0]<0){
			player.inv[player.inv[10]][0]=0;
		}
		break;
	case 221://]
		player.inv[player.inv[10]][0]++;
		if(player.inv[player.inv[10]][0]>=item_char.length){
			player.inv[player.inv[10]][0]=item_char.length-1;
		}
		break;
	case 220://\
		var _item_id=item_id_from_name(prompt("Item Name?"));
		if(_item_id==-1){
			alert("Invalid Item Name");
			return;
		}
		player.inv[player.inv[10]][0]=_item_id;
		break;
}
}

//inventory slot select
switch(key){
    case 49://1
        player.inv[10]=0;
        break;
    case 50://2
        player.inv[10]=1;
        break;
    case 51://3
        player.inv[10]=2;
        break;
    case 52://4
        player.inv[10]=3;
        break;
    case 53://5
        player.inv[10]=4;
        break;
    case 54://6
        player.inv[10]=5;
        break;
    case 55://7
        player.inv[10]=6;
        break;
    case 56://8
        player.inv[10]=7;
        break;
    case 57://9
        player.inv[10]=8;
        break;
    case 48://0
        player.inv[10]=9;
        break;
}

//drop item
switch(key){
    case 71://Drop one item
        drop_item(1);
        break;
    case 70://Drop all of the items.
        drop_item(0);
        break;
    case 86://v, Drop have of items
	drop_item("half");
	break;
}

//break/pickup, place/use, other
switch(key){
    case 13://enter
        enter_button();
        break;
    case 32://space
        use_item();
        break;
    case 192://"~" key
        dem_ann.textContent="Stop there criminal!";
        cheats();
        break;
}
}

/*function mouse_manager(e){
	var cga_wall=document.getElementById("cga").getBoundingClientRect();
	var mousex=Math.floor((e.clientX-cga_wall.left)/16);
	var mousey=Math.floor((e.clientY-cga_wall.top)/16);
	switch(game_state){
		case CRAFTING:
			crafting_mouse_action(mousex,mousey);
			break;
		case GAMING:
			break;
	}
}*/

//document.getElementById("cga").addEventListener("click", mouse_manager, false)

function death(){
	if(is_dead){
		return;
	}
    if(player.creative==1){
        //console.log("You live to see another day.");
        return;
    }
    alert("BOOM! You are DEAD!");
	is_dead=true;
    //clearInterval(interval);
    //key_manager=function(){};
}

function pathfind_step(x1,y1,x2,y2,og_x,og_y){
var nodes=[];
var dir="";
og_x==undefined ? og_x=20 : 0;
og_y==undefined ? og_y=12 : 0;
nodes.push({x:x1,y:y1,h:Math.sqrt((x2-x1)*(x2-x1)+(y2-y1)*(y2-y1))});
if(is_walkable(char_value(x1,y1-1))){//up
	nodes.push({x:x1,y:y1-1,h:Math.sqrt((x2-x1)*(x2-x1)+(y2-(y1-1))*(y2-(y1-1)))});
	dir="up";
}
if(is_walkable(char_value(x1,y1+1))){//down
	nodes.push({x:x1,y:y1+1,h:Math.sqrt((x2-x1)*(x2-x1)+(y2-(y1+1))*(y2-(y1+1)))});
	dir="down";
}
if(is_walkable(char_value(x1-1,y1))){//left
	nodes.push({x:x1-1,y:y1,h:Math.sqrt((x2-(x1-1))*(x2-(x1-1))+(y2-y1)*(y2-y1))});
	dir="left";
}
if(is_walkable(char_value(x1+1,y1))){//right
	nodes.push({x:x1+1,y:y1,h:Math.sqrt((x2-(x1+1))*(x2-(x1+1))+(y2-y1)*(y2-y1))});
	dir="right";
}
if(is_walkable(char_value(x1-1,y1-1)) && (is_walkable(char_value(x1-1,y1)) || is_walkable(char_value(x1,y1-1)))){//up left
	nodes.push({x:x1-1,y:y1-1,h:Math.sqrt((x2-(x1-1))*(x2-(x1-1))+(y2-(y1-1))*(y2-(y1-1)))});
}
if(is_walkable(char_value(x1-1,y1+1)) && (is_walkable(char_value(x1-1,y1)) || is_walkable(char_value(x1,y1+1)))){//down left
	nodes.push({x:x1-1,y:y1+1,h:Math.sqrt((x2-(x1-1))*(x2-(x1-1))+(y2-(y1+1))*(y2-(y1+1)))});
}
if(is_walkable(char_value(x1+1,y1-1)) && (is_walkable(char_value(x1+1,y1)) || is_walkable(char_value(x1,y1-1)))){//up right
	nodes.push({x:x1+1,y:y1-1,h:Math.sqrt((x2-(x1+1))*(x2-(x1+1))+(y2-(y1-1))*(y2-(y1-1)))});
}
if(is_walkable(char_value(x1+1,y1+1)) && (is_walkable(char_value(x1+1,y1)) || is_walkable(char_value(x1,y1+1)))){//down right
	nodes.push({x:x1+1,y:y1+1,h:Math.sqrt((x2-(x1+1))*(x2-(x1+1))+(y2-(y1+1))*(y2-(y1+1)))});
}
var collided;
var new_nodes=[];
if(SHOW_NODES){
	dem_ann.textContent=JSON.stringify(nodes);
}
new_nodes.push(JSON.parse(JSON.stringify(nodes[0])));
for(var i=1;i<nodes.length;i++){
	collided=entity_collide_xy_id(nodes[i].x,nodes[i].y,NPC_ID);
	if(collided==-1){
		new_nodes.push(JSON.parse(JSON.stringify(nodes[i])));
	}
}
nodes=new_nodes;
var smallest=nodes[0];
for(var i=1;i<nodes.length;i++){
	if(smallest.h>=nodes[i].h){
		smallest=nodes[i];
	}
}
return [smallest.x,smallest.y,dir];
}
function entity_attack(ptr){
    if(pages[cur_page].entities[ptr].attack_cooldown>0){
        pages[cur_page].entities[ptr].attack_cooldown--;
        return;
    }
    if(pages[cur_page].entities[ptr].x==player.x){
        if(pages[cur_page].entities[ptr].y<player.y){//Attack Down
            pages[cur_page].entities.push({id:3, x:pages[cur_page].entities[ptr].x, y:pages[cur_page].entities[ptr].y+1, char:19, direction:-1, damage:pages[cur_page].entities[ptr].strength, decay:2});
            pages[cur_page].entities[ptr].attack_cooldown=5;
        }
        if(pages[cur_page].entities[ptr].y>player.y){//Attack Up
            pages[cur_page].entities.push({id:3, x:pages[cur_page].entities[ptr].x, y:pages[cur_page].entities[ptr].y-1, char:19, direction:-1, damage:pages[cur_page].entities[ptr].strength, decay:2});
            pages[cur_page].entities[ptr].attack_cooldown=5;
        }
    }
    if(pages[cur_page].entities[ptr].y==player.y){
        if(pages[cur_page].entities[ptr].x<player.x){//Attack Right
            pages[cur_page].entities.push({id:3, x:pages[cur_page].entities[ptr].x+1, y:pages[cur_page].entities[ptr].y, char:19, direction:-1, damage:pages[cur_page].entities[ptr].strength, decay:2});
            pages[cur_page].entities[ptr].attack_cooldown=5;
        }
        if(pages[cur_page].entities[ptr].x>player.x){//Attack Left
            pages[cur_page].entities.push({id:3, x:pages[cur_page].entities[ptr].x-1, y:pages[cur_page].entities[ptr].y, char:19, direction:-1, damage:pages[cur_page].entities[ptr].strength, decay:2});
            pages[cur_page].entities[ptr].attack_cooldown=5;
        }
    }
}

function get_hole_ptr_from_xy(x,y){
	for(var i=0;i<pages[cur_page].holes.length;i++){
		if(pages[cur_page].holes[i].x==x && pages[cur_page].holes[i].y==y){
			return i;
		}
	}
	return -1;
}

function entity_teleport(hole_ptr,entity_ptr){
	if(pages[cur_page].holes[hole_ptr].dest_page==-2 || pages[cur_page].holes[hole_ptr].dest_page==-2){
		return;
	}
	pages[cur_page].entities[entity_ptr].x=pages[cur_page].holes[hole_ptr].next_x;
	pages[cur_page].entities[entity_ptr].y=pages[cur_page].holes[hole_ptr].next_y;
	pages[cur_page].entities[entity_ptr].dest_x=pages[cur_page].holes[hole_ptr].next_x;
	pages[cur_page].entities[entity_ptr].dest_y=pages[cur_page].holes[hole_ptr].next_y;
	move_entity(entity_ptr,pages[cur_page].holes[hole_ptr].dest_page);
}

function entity_slip_edge(ptr,dir){
var next_page=-1;
switch(dir){
	case "up":
		next_page=get_ptr_from_page_xy(pages[cur_page].metadata.x,pages[cur_page].metadata.y-1,pages[cur_page].metadata.layer);
		break;
	case "down":
		next_page=get_ptr_from_page_xy(pages[cur_page].metadata.x,pages[cur_page].metadata.y+1,pages[cur_page].metadata.layer);
		break;
	case "left":
		next_page=get_ptr_from_page_xy(pages[cur_page].metadata.x-1,pages[cur_page].metadata.y,pages[cur_page].metadata.layer);
		break;
	case "right":
		next_page=get_ptr_from_page_xy(pages[cur_page].metadata.x+1,pages[cur_page].metadata.y,pages[cur_page].metadata.layer);
		break;
}
//alert(next_page);
if(next_page==-1){
	return;
}
switch(dir){
	case "left":
		pages[cur_page].entities[ptr].x=39;
		pages[cur_page].entities[ptr].dest_x=39;
		break;
	case "right":
		pages[cur_page].entities[ptr].x=0;
		pages[cur_page].entities[ptr].dest_x=0;
		break;
	case "up":
		pages[cur_page].entities[ptr].y=24;
		pages[cur_page].entities[ptr].dest_y=24;
		break;
	case "down":
		pages[cur_page].entities[ptr].y=0;
		pages[cur_page].entities[ptr].dest_y=0;
		break;
}
move_entity(ptr,next_page);
}

function is_54(x,y){
	return char_value(x,y)==54;
}

function entity_slip(ptr){
switch(pages[cur_page].entities[ptr].last_dir){
	case "up":
		if(is_walkable(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y-1)) && !hit_bounds(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y-1)){
			pages[cur_page].entities[ptr].y--;
			if(!is_54(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)){
				pages[cur_page].entities[ptr].dest_x=pages[cur_page].entities[ptr].x;
				pages[cur_page].entities[ptr].dest_y=pages[cur_page].entities[ptr].y-1;
				}
		}
		if(hit_bounds(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y-1)){
			entity_slip_edge(ptr,"up");
		}
		return;
	case "down":
		if(is_walkable(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y+1)) && !hit_bounds(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y+1)){
			pages[cur_page].entities[ptr].y++;
			if(!is_54(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)){
				pages[cur_page].entities[ptr].dest_x=pages[cur_page].entities[ptr].x;
				pages[cur_page].entities[ptr].dest_y=pages[cur_page].entities[ptr].y+1;
			}
		}
		if(hit_bounds(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y+1)){
			entity_slip_edge(ptr,"down");
		}
		break;
	case "left":
		if(is_walkable(char_value(pages[cur_page].entities[ptr].x-1,pages[cur_page].entities[ptr].y)) && !hit_bounds(pages[cur_page].entities[ptr].x-1,pages[cur_page].entities[ptr].y)){
			pages[cur_page].entities[ptr].x--;
			if(!is_54(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)){
			pages[cur_page].entities[ptr].dest_x=pages[cur_page].entities[ptr].x;
			pages[cur_page].entities[ptr].dest_y=pages[cur_page].entities[ptr].y;
			}
		}
		if(hit_bounds(pages[cur_page].entities[ptr].x-1,pages[cur_page].entities[ptr].y)){
			entity_slip_edge(ptr,"left");
		}
		break;
	case "right":
		if(is_walkable(char_value(pages[cur_page].entities[ptr].x+1,pages[cur_page].entities[ptr].y)) && !hit_bounds(pages[cur_page].entities[ptr].x+1,pages[cur_page].entities[ptr].y)){
			pages[cur_page].entities[ptr].x++;
			if(!is_54(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)){
			pages[cur_page].entities[ptr].dest_x=pages[cur_page].entities[ptr].x;
			pages[cur_page].entities[ptr].dest_y=pages[cur_page].entities[ptr].y;
			}
		}
		if(hit_bounds(pages[cur_page].entities[ptr].x+1,pages[cur_page].entities[ptr].y)){
			entity_slip_edge(ptr,"right");
		}
		break;
	default:
		//pages[cur_page].entities[ptr].last_dir="up";
		return;
}
return 1;
}

function entity_standing_on(ptr){
//pages[cur_page].entities[0].dest_x=19;pages[cur_page].entities[0].dest_y=12;
switch(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)){
	case 6://hole
		if(pages[cur_page].entities[ptr].x!=pages[cur_page].entities[ptr].dest_x || pages[cur_page].entities[ptr].y!=pages[cur_page].entities[ptr].dest_y){
			break;
		}
		entity_teleport(get_hole_ptr_from_xy(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y),ptr);
		break;
	case 54://walnut peel
		entity_slip(ptr);
		return 1;
		break;
	case 30://fire
	case 31:
	case 32:
	case 68://Camp Fire
		pages[cur_page].entities[ptr].health--;
		pages[cur_page].entities[ptr].fire_tick=ON_FIRE_COUNT;
		break;
	case T_WATER://water puts fire on entity out.
		if(pages[cur_page].entities[ptr].fire_tick!==undefined){
			delete pages[cur_page].entities[ptr].fire_tick;
		}
}
}

function npc_edge(ptr){//(x<0 || x>39 || y<0 || y>24);
var next_page=-1;
var dir="";
if(pages[cur_page].entities[ptr].dest_x<0){//left
	next_page=get_ptr_from_page_xy(pages[cur_page].metadata.x-1,pages[cur_page].metadata.y,pages[cur_page].metadata.layer);
	dir="left";
}
if(pages[cur_page].entities[ptr].dest_x>39){//right
	next_page=get_ptr_from_page_xy(pages[cur_page].metadata.x+1,pages[cur_page].metadata.y,pages[cur_page].metadata.layer);
	dir="right";
}
if(pages[cur_page].entities[ptr].dest_y<0){//up
	next_page=get_ptr_from_page_xy(pages[cur_page].metadata.x,pages[cur_page].metadata.y-1,pages[cur_page].metadata.layer);
	dir="up";
}
if(pages[cur_page].entities[ptr].dest_y>24){//down
	next_page=get_ptr_from_page_xy(pages[cur_page].metadata.x,pages[cur_page].metadata.y+1,pages[cur_page].metadata.layer);
	dir="down";
}
if(next_page==-1){
	return;
}else{
switch(dir){
	case "left":
		pages[cur_page].entities[ptr].x=39;
		pages[cur_page].entities[ptr].dest_x=39;
		break;
	case "right":
		pages[cur_page].entities[ptr].x=0;
		pages[cur_page].entities[ptr].dest_x=0;
		break;
	case "up":
		pages[cur_page].entities[ptr].y=24;
		pages[cur_page].entities[ptr].dest_y=24;
		break;
	case "down":
		pages[cur_page].entities[ptr].y=0;
		pages[cur_page].entities[ptr].dest_y=0;
		break;
}
move_entity(ptr,next_page);
}
}

function entity_edge(ptr){//move entity between pages through edges.
	if(hit_bounds(pages[cur_page].entities[ptr].dest_x,pages[cur_page].entities[ptr].dest_y)){
		if(Math.sqrt(Math.pow(pages[cur_page].entities[ptr].x-pages[cur_page].entities[ptr].dest_x,2)+Math.pow(pages[cur_page].entities[ptr].y-pages[cur_page].entities[ptr].dest_y,2))==1){
			npc_edge(ptr);
		}
	}
}

/*function friendly_npc(ptr){
	//love
	for(var i=0;i<pages[cur_page].entities.length;i++){
		if(i==ptr){
			continue;
		}
		if(pages[cur_page].entities[i].id==1 && pages[cur_page].entities[i].brain.hostile==0){
			if(pages[cur_page].entities[i].x==pages[cur_page].entities[ptr].x&&
			pages[cur_page].entities[i].y==pages[cur_page].entities[ptr].y&&
			pages[cur_page].entities[i].brain.identity.love_mode==1){
				pages[cur_page].entities[i].brain.identity.love_mode=0;
				pages[cur_page].entities[ptr].brain.identity.love_mode=0;
				new_npc(pages[cur_page].entities[ptr].x,
				pages[cur_page].entities[ptr].y,
				pages[cur_page].entities[ptr].x,
				pages[cur_page].entities[ptr].y);
				return;
			}
		}
	}
}*/

function entity_onfire(ptr){
	//dem_ann.textContent=2;
	pages[cur_page].entities[ptr].fire_tick--;
	if(pages[cur_page].entities[ptr].fire_tick>0){
		pages[cur_page].entities[ptr].health-=ON_FIRE_DAMAGE;
	}else{
		delete pages[cur_page].entities[ptr].fire_tick;
	}
}

function npc(ptr){//make entity move and interact with environment.
	if(entity_standing_on(ptr)==1){return;}
	if(typeof pages[cur_page].entities[ptr].fire_tick!=="undefined"){entity_onfire(ptr);}
    if(pages[cur_page].entities[ptr].brain.no_ai==1){return;}
    var next_xy;
    switch(pages[cur_page].entities[ptr].brain.hostile){
        case 0://not hostile
            next_xy=pathfind_step(pages[cur_page].entities[ptr].x,
            pages[cur_page].entities[ptr].y,
            pages[cur_page].entities[ptr].dest_x,
            pages[cur_page].entities[ptr].dest_y,
			pages[cur_page].entities[ptr].og_x,
			pages[cur_page].entities[ptr].og_y);
			//pages[cur_page].entities[ptr].brain.identity.love_mode==1 ? friendly_npc(ptr) : 0;
            break;
        case 1://hostile
            next_xy=pathfind_step(pages[cur_page].entities[ptr].x,
            pages[cur_page].entities[ptr].y,
            player.x,
            player.y,
            pages[cur_page].entities[ptr].og_x,
            pages[cur_page].entities[ptr].og_y);
            if(next_xy[0]==player.x && next_xy[1]==player.y){
                entity_attack(ptr);
                return;
            }
            break;
    }
	pages[cur_page].entities[ptr].last_dir=next_xy[2];
	var collided=entity_collide_xy_id(next_xy[0],next_xy[1],1);
	if(collided!=-1){return;}//prevent multiple npc's from occupying the same
    pages[cur_page].entities[ptr].x=next_xy[0];
	pages[cur_page].entities[ptr].y=next_xy[1];//for slipping.
	entity_standing_on(ptr);
	entity_edge(ptr);
}

function slip(){
switch(last_dir){
	case "up":
		if(is_walkable(char_value(player.x,player.y-1)) && !hit_bounds(player.x,player.y-1)){
			player.y--;
		}
		if(hit_bounds(player.x,player.y-1)){
			off_edge("up");
		}
		return;
	case "down":
		if(is_walkable(char_value(player.x,player.y+1)) && !hit_bounds(player.x,player.y+1)){
			player.y++;
		}
		if(hit_bounds(player.x,player.y+1)){
			off_edge("down");
		}
		break;
	case "left":
		if(is_walkable(char_value(player.x-1,player.y)) && !hit_bounds(player.x-1,player.y)){
			player.x--;
		}
		if(hit_bounds(player.x-1,player.y)){
			off_edge("left");
		}
		break;
	case "right":
		if(is_walkable(char_value(player.x+1,player.y)) && !hit_bounds(player.x+1,player.y)){
			player.x++;
		}
		if(hit_bounds(player.x+1,player.y)){
			off_edge("right");
		}
		break;
	default:
		break;
}
}

function move_entity(ptr,next_page){
pages[next_page].entities.push(JSON.parse(JSON.stringify(pages[cur_page].entities[ptr])));//weird pointer shenanigans
pages[cur_page].entities[ptr].id=-1;
entity_cleanup();
}

function fire_damage(){
	damage_player(1);
	player.fire_tick=ON_FIRE_COUNT;
}

function player_onfire(){
	player.fire_tick--;
	if(player.fire_tick>0){
		damage_player(ON_FIRE_DAMAGE);
	}else{
		delete player.fire_tick;
	}
}

function plasma_step(ptr){//logic for plasma spreading
	var x=pages[cur_page].entities[ptr].x;
	var y=pages[cur_page].entities[ptr].y;
	pages[cur_page].entities[ptr].decay--;
	if(pages[cur_page].entities[ptr].decay<=0){
		pages[cur_page].entities[ptr].id=-1;
	}
	if(hit_bounds(x,y)){
		pages[cur_page].entities[ptr].id=-1;
	}
	switch(pages[cur_page].entities[ptr].direction){
		case P_NONE://initial plasma. Spread in 4 directions
			pages[cur_page].entities.push({
			id:PLASMA_ID,
			x:x,
			y:y,
			char:T_PLASMA,
			damage:PLASMA_DAMAGE,
			direction:P_UP,
			decay:PLASMA_DECAY,
			from_player:0
			});
			pages[cur_page].entities.push({
			id:PLASMA_ID,
			x:x,
			y:y,
			char:T_PLASMA,
			damage:PLASMA_DAMAGE,
			direction:P_DOWN,
			decay:PLASMA_DECAY,
			from_player:0
			});
			pages[cur_page].entities.push({
			id:PLASMA_ID,
			x:x,
			y:y,
			char:T_PLASMA,
			damage:PLASMA_DAMAGE,
			direction:P_LEFT,
			decay:PLASMA_DECAY,
			from_player:0
			});
			pages[cur_page].entities.push({
			id:PLASMA_ID,
			x:x,
			y:y,
			char:T_PLASMA,
			damage:PLASMA_DAMAGE,
			direction:P_RIGHT,
			decay:PLASMA_DECAY,
			from_player:0
			});
			pages[cur_page].entities.push({
			id:PROJ_ID,
			x:x,
			y:y,
			char:T_PLASMA,
			damage:PLASMA_DAMAGE,
			direction:P_NONE,
			decay:pages[cur_page].entities[ptr].decay,
			});
			break;
		case P_UP:
			pages[cur_page].entities[ptr].y--;
			break;
		case P_DOWN:
			pages[cur_page].entities[ptr].y++;
			break;
		case P_LEFT:
			pages[cur_page].entities.push({
			id:PROJ_ID,
			x:x,
			y:y,
			char:T_PLASMA,
			damage:PLASMA_DAMAGE,
			direction:P_UP,
			decay:pages[cur_page].entities[ptr].decay,
			});
			pages[cur_page].entities.push({
			id:PROJ_ID,
			x:x,
			y:y,
			char:T_PLASMA,
			damage:PLASMA_DAMAGE,
			direction:P_DOWN,
			decay:pages[cur_page].entities[ptr].decay,
			});
			pages[cur_page].entities[ptr].x--;
			break;
		case P_RIGHT:
			pages[cur_page].entities.push({
			id:PROJ_ID,
			x:x,
			y:y,
			char:T_PLASMA,
			damage:PLASMA_DAMAGE,
			direction:P_UP,
			decay:pages[cur_page].entities[ptr].decay,
			});
			pages[cur_page].entities.push({
			id:PROJ_ID,
			x:x,
			y:y,
			char:T_PLASMA,
			damage:PLASMA_DAMAGE,
			direction:P_DOWN,
			decay:pages[cur_page].entities[ptr].decay,
			});
			pages[cur_page].entities[ptr].x++;
			break;
	}
}

function do_plasma(ptr){
	plasma_step(ptr);
}

function tick(){
    if(player.health<=0){//Player Death
        death();
    }
	var proj_proc=0;
	var npc_proc=0;
    for(var i=0;i<pages[cur_page].entities.length;i++){
        switch(pages[cur_page].entities[i].id){
            case 3:
				if(proj_proc>=PROJ_QUOTA){
					break;
				}
                projectile(i);
				proj_proc++;
                break;
			case PLASMA_ID://plasma
				do_plasma(i);
				break;
            case 1:
				if(npc_proc>=NPC_QUOTA){
					break;
				}
                npc(i);
				npc_proc++;
                break;
        }
    }
	switch(char_value(player.x,player.y)){//player standing on.
		case 54://walnut peels
			slip();
			break;
		case 30://fire
		case 31:
		case 32:
			fire_damage();
			break;
		case T_WATER://water puts out fire.
			if(player.fire_tick!==undefined){
				delete player.fire_tick;
			}
	}
}

function can_spawn(x){
    for(var i=0;i<properties.not_spawnable.length;i++){
        if(x==properties.not_spawnable[i]){
        return false;
        }
    }
    return true;
}

function is_burnable(x){
	for(var i=0;i<properties.burnable.length;i++){
        if(properties.burnable[i]==x){
            return true;
        }
    }
    return false;
}

function adj_empty(x,y){
if(char_value(x,y-1)==0){//up
	return [x,y-1];
}
if(char_value(x+1,y)==0){//right
	return [x+1,y];
}
if(char_value(x,y+1)==0){//down
	return [x,y+1];
}
if(char_value(x-1,y)==0){//left
	return [x-1,y];
}
return [x,y];
}

function crisp_item(ptr,x,y){
switch(pages[cur_page].entities[ptr].item[0]){
	case 34://Meat
		pages[cur_page].entities[ptr].item[1]--;
		pages[cur_page].entities.push({
		id:2,
		x:adj_empty(x,y)[0],
		y:adj_empty(x,y)[1],
		char:item_char[36],
		item:[36,1]
		});//cooked meat
		combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],36);
		break;
	case 44://MDF puddy
		pages[cur_page].entities[ptr].item[1]--;
		pages[cur_page].entities.push({
		id:2,
		x:adj_empty(x,y)[0],
		y:adj_empty(x,y)[1],
		char:item_char[45],
		item:[45,1]
		});//MDF
		combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],45);
		break;
	case 36://cooked meat
		break;
	case I_MDF://burnable to amber
	case I_GREEN_MDF:
	case I_RED_MDF:
	case I_CYAN_MDF:
	case I_HOUSE_CARPET:
	case I_HAY_BAIL:
	case I_CARPET:
	case I_DOOR:
	case I_BEDDING:
	case I_STICK:
		pages[cur_page].entities[ptr].item[1]--;
		pages[cur_page].entities.push({
		id:2,
		x:adj_empty(x,y)[0],
		y:adj_empty(x,y)[1],
		char:item_char[I_AMBER],
		item:[I_AMBER,1]
		});//cooked meat
		combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],I_AMBER);
		break;
	case I_AMBER:
		break;
	case 33://iron
		break;
	case 35://Copper
		break;
	case 21://cyan thing
		break;
	default:
		pages[cur_page].entities[ptr].item[1]--;
		break;
}
}

function do_fire(x,y){
	//check for flamable objects around.
	var spread=0;
	if(!hit_bounds(x,y-1)){//up
		if(is_burnable(char_value(x,y-1))){
			pages[cur_page].map[y-1][x]=30;
			spread=1;
			if(!hit_bounds(x,y-2)){//up 2
				if(is_burnable(char_value(x,y-2))){
					pages[cur_page].map[y-2][x]=30;
				}
			}
		}
	}
	if(!hit_bounds(x,y+1)){//down
		if(is_burnable(char_value(x,y+1))){
			pages[cur_page].map[y+1][x]=30;
			spread=1;
			if(!hit_bounds(x,y+2)){//down 2
				if(is_burnable(char_value(x,y+2))){
					pages[cur_page].map[y+2][x]=30;
				}
			}
		}
	}
	if(!hit_bounds(x-1,y)){//left
		if(is_burnable(char_value(x-1,y))){
			pages[cur_page].map[y][x-1]=30;
			spread=1;
			if(!hit_bounds(x-2,y)){//left 2
				if(is_burnable(char_value(x-2,y))){
					pages[cur_page].map[y][x-2]=30;
				}
			}
		}
	}
	
	if(!hit_bounds(x+1,y)){//right
		if(is_burnable(char_value(x+1,y))){
			pages[cur_page].map[y][x+1]=30;
			spread=1;
			if(!hit_bounds(x+2,y)){//right 2
				if(is_burnable(char_value(x+2,y))){
					pages[cur_page].map[y][x+2]=30;
				}
			}
		}
	}
	if(!hit_bounds(x-1,y-1)){//up left
		if(is_burnable(char_value(x-1,y-1))){
			pages[cur_page].map[y-1][x-1]=30;
			spread=1;
		}
	}
	if(!hit_bounds(x-1,y+1)){//down left
		if(is_burnable(char_value(x-1,y+1))){
			pages[cur_page].map[y+1][x-1]=30;
			spread=1;
		}
	}
	if(!hit_bounds(x+1,y-1)){//up right
		if(is_burnable(char_value(x+1,y-1))){
			pages[cur_page].map[y-1][x+1]=30;
			spread=1;
		}
	}
	if(!hit_bounds(x+1,y+1)){//down right
		if(is_burnable(char_value(x+1,y+1))){
			pages[cur_page].map[y+1][x+1]=30;
			spread=1;
		}
	}
	if(spread==0){
		if(char_value(x,y)==68){
			0;
		}else{
		pages[cur_page].map[y][x]++;
		if(char_value(x,y)>=33){
			pages[cur_page].map[y][x]=0;
		}
		}
	}
	//check for entities
	var collided=entity_collide_xy_id(x,y,DROPPED_ITEM_ID);
	if(collided!=-1){
		crisp_item(collided,x,y);
	}
}

function enemy_chance(){
	return Math.floor(ENEMY_CHANCE_A+
		ENEMY_CHANCE_B*tick1+
		ENEMY_CHANCE_C*(tick1*tick1)
		)+(pages[cur_page].metadata.layer>0 ? 10 : 0);
}

function new_cat(x,y,page){
	pages[page].entities.push({
		id:NPC_ID,
		char:T_CAT,
		x:x,
		y:y,
		brain:{
			no_ai:0,
			hostile:1,
		},
		health:CAT_HEALTH,
		strength:CAT_STRENGTH,
		attack_cooldown:0,
		random_x:0,
		random_y:0
	});
}

function spawn_cat(random_x=Math.floor((Math.random()*65535))%40,
				   random_y=Math.floor((Math.random()*65535))%25){
	if(pages[cur_page].metadata.layer!=1){//Cats only spawn in the slip!
		return;
	}
	var tmp_page=-1;
	switch(Math.floor(Math.random()*65535)%4){
		case 0:
			tmp_page=get_ptr_from_page_xy(pages[cur_page].metadata.x,pages[cur_page].metadata.y-1,1);//page above
			break;
		case 1:
			tmp_page=get_ptr_from_page_xy(pages[cur_page].metadata.x,pages[cur_page].metadata.y+1,1);//page below
			break;
		case 2:
			tmp_page=get_ptr_from_page_xy(pages[cur_page].metadata.x-1,pages[cur_page].metadata.y,1);//page left
			break;
		case 3:
			tmp_page=get_ptr_from_page_xy(pages[cur_page].metadata.x+1,pages[cur_page].metadata.y,1);//page right
			break;
			
	}
	if(tmp_page!=-1){
		if(can_spawn(pages[tmp_page].map[random_y][random_x])&&Math.random()>CAT_CHANCE){
			for(var i=0;i<pages[tmp_page].entities.length;i++){//only 1 cat per ajacent page.
				if(pages[tmp_page].entities[i].id==NPC_ID){
					if(pages[tmp_page].entities[i].char==T_CAT){
						return;
					}
				}
			}
			new_cat(random_x,random_y,tmp_page);
		}
	}
}

function rgb_light_luminance(x,y){
	var rgb=light_map[y][x];
	return (rgb[0]*LUM_R_CONST)+(rgb[1]*LUM_G_CONST)+(rgb[2]*LUM_B_CONST);
}

function random_tick(random_x=Math.floor((Math.random()*65535))%40,random_y=Math.floor((Math.random()*65535))%25,bone_meal=0,action=Math.floor((Math.random()*65535))%100){
if(DEBUG_RANDOM_TICK){
pages[cur_page].entities.push({
id:PROJ_ID,
char:T_RANDOM_TICK,
x:random_x,
y:random_y,
direction:P_NONE,
decay:2,
strength:0,
});
}
var season=rtc().month;
if(!(season>3 && season<12)){//no growth in winter
if(pages[cur_page].map[random_y][random_x]==13){//grass
    if(action%2==0){//create hay
        pages[cur_page].entities.push({id:2, char:12, x:random_x, y:random_y, item: [2,1]});
		combine_items(random_x,random_y,2);
    }
    if(action%2==1){//spread
        var direction=Math.floor(Math.random()*65535)%4;
        x=random_x;
        y=random_y;
        switch(direction){
            case 0://up
                y--;
                break;
            case 1://down
                y++;
                break;
            case 2://left
                x--;
                break;
            case 3://right
                x++;
                break;
        }
        if(hit_bounds(x,y)){
            return;        
        }
        if(pages[cur_page].map[y][x]==0){
            pages[cur_page].map[y][x]=13;
        }
    }
}

if(pages[cur_page].map[random_y][random_x]==15){//tree trunk
    if(action%2==0){
        pages[cur_page].entities.push({id:2, char:9, x:random_x, y:random_y, item: [1,1]});//branch
		combine_items(random_x,random_y,1);
    }
    if(action%2==1){
        pages[cur_page].entities.push({id:2, char:24, x:random_x, y:random_y, item: [9,1]});//sapling
		combine_items(random_x,random_y,9);
    }
}
}
if(pages[cur_page].map[random_y][random_x]==16){//brown mushroom growth
    var direction=Math.floor(Math.random()*65535)%4;
        x=random_x;
        y=random_y;
        switch(direction){
            case 0://up
                y--;
                break;
            case 1://down
                y++;
                break;
            case 2://left
                x--;
                break;
            case 3://right
                x++;
                break;
        }
        if(hit_bounds(x,y)){
            return;        
        }
        if(pages[cur_page].map[y][x]==0){
            pages[cur_page].map[y][x]=16;
        }
}
if(pages[cur_page].map[random_y][random_x]==17){//red mushroom growth
    var direction=Math.floor(Math.random()*65535)%4;
        x=random_x;
        y=random_y;
        switch(direction){
            case 0://up
                y--;
                break;
            case 1://down
                y++;
                break;
            case 2://left
                x--;
                break;
            case 3://right
                x++;
                break;
        }
        if(hit_bounds(x,y)){
            return;        
        }
        if(pages[cur_page].map[y][x]==0){
            pages[cur_page].map[y][x]=17;
        }
}
if(!(season>3 && season<12)){//no growth in winter
switch(pages[cur_page].map[random_y][random_x]){
	case 46://walnut leaves
	case 47:
	case 48:
	case 49:
	case 50:
	case 51:
		pages[cur_page].entities.push({id:2, char:52, x:random_x, y:random_y, item: [25,1]});
		combine_items(random_x,random_y,25);
		break;
	case 52://walnut fruit
		if(char_value(random_x,random_y-1)==0 && char_value(random_x,random_y-2)==0 && char_value(random_x-1,random_y-1)==0 && char_value(random_x-1,random_y-2)==0 && char_value(random_x+1,random_y-1)==0 && char_value(random_x+1,random_y-2)==0){
			struct_copy(9,random_x-1,random_y-2);
		}
		break;
}
if(char_value(random_x,random_y)==24){//sapling
    if(!hit_bounds(random_x,random_y-1)){
        if(char_value(random_x,random_y-1)==0){
            pages[cur_page].map[random_y][random_x]=15;//trunk
            pages[cur_page].map[random_y-1][random_x]=14;//leaves
        }
    }
}
if(bone_meal==1){
	return;
}
}
//non hostile entity random destination
if(tick_hour()>=6 && tick_hour()<=17){//during day, hide
for(var i=0;i<pages[cur_page].entities.length;i++){
    if(pages[cur_page].entities[i].id==1){
        if(pages[cur_page].entities[i].brain.hostile==0){
            pages[cur_page].entities[i].dest_x=pages[cur_page].entities[i].brain.home_x;
            pages[cur_page].entities[i].dest_y=pages[cur_page].entities[i].brain.home_y;
        }
    }
}
}
if(action<=30 && tick_hour()<=5 || tick_hour()>=18 && action<20){
for(var i=0;i<pages[cur_page].entities.length;i++){
    if(pages[cur_page].entities[i].id==1){
        if(pages[cur_page].entities[i].brain.hostile==0 && Math.random()>0.7){
            pages[cur_page].entities[i].dest_x=(Math.floor(Math.random()*65535)%42)-1;
            pages[cur_page].entities[i].dest_y=(Math.floor(Math.random()*65535)%27)-1;
			//pages[cur_page].entities[i].brain.identity.love_mode=1;
        }
    }
}
}
if(tick_hour()>=NIGHT_START_HOUR && tick_hour()<=NIGHT_END_HOUR){
	//enemy spawning stuff
	if(pages[cur_page].metadata.safety==0){
		var cv,_x,_y;
		for(var i=0;i<(action%MAX_SPAWNS_ONCE)+1;i++){//Spawn random number of enemies.
			_x=Math.floor(Math.random()*65535)%40;
			_y=Math.floor(Math.random()*65535)%25;
			cv=char_value(_x,_y);
			if(is_walkable(cv) && can_spawn(cv) && 
			light_map[_y][_x][0]==DAY_RGB[0]&&
			light_map[_y][_x][1]==DAY_RGB[1]&&
			light_map[_y][_x][2]==DAY_RGB[2]){//Is the tile walkable _and_ spawnable? Is there any artificial light?
				pages[cur_page].entities.push({
					id:NPC_ID,
					char:4,
					x:_x,
					y:_y,
					brain:{
						no_ai:0,
						hostile:1,
					},
					health:ENEMY_HEALTH,
					strength:ENEMY_STRENGTH,
					attack_cooldown:0,
					random_x:0,
					random_y:0
				});
			}
		}
	}
}
}

function num_suffix(x){
	switch(x){
		case 1:
			return "st";
		case 2:
			return "nd";
		case 3:
			return "rd";
		default:
			return "th";
	}
}

function clock_radio_interact(){
	var dt=rtc();
	//{"year":0,"month":0,"monthlets":0,"weekday":0}
	dem_ann.textContent="$"+dt.monthlets.toString(16).toUpperCase()+num_suffix(dt.monthlets)+" day of "+MONTH_NAMES[dt.month]+" in the year $"+dt.year.toString(16).toUpperCase();
}

function grind_item(x,y){
var item_ptrs=[];
for(var i=0;i<pages[cur_page].entities.length;i++){
	if(pages[cur_page].entities[i].id==2 && pages[cur_page].entities[i].x==x && pages[cur_page].entities[i].y==y){
		item_ptrs.push(i);
	}
}
for(var i=0;i<item_ptrs.length;i++){
	switch(pages[cur_page].entities[item_ptrs[i]].item[0]){
		case 7://stick
			pages[cur_page].entities[item_ptrs[i]].item[1]--;
			pages[cur_page].entities.push({
			id:2,
			x:adj_empty(x,y)[0],
			y:adj_empty(x,y)[1],
			char:item_char[42],
			item:[42,1]
			});//Sawdust
			combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],42);
			break;
		case 11://bowl
			pages[cur_page].entities[item_ptrs[i]].item[1]--;
			pages[cur_page].entities.push({
			id:2,
			x:adj_empty(x,y)[0],
			y:adj_empty(x,y)[1],
			char:item_char[42],
			item:[42,1]
			});
			combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],42);
			break;
		case 22://door
			pages[cur_page].entities[item_ptrs[i]].item[1]--;
			pages[cur_page].entities.push({
			id:2,
			x:adj_empty(x,y)[0],
			y:adj_empty(x,y)[1],
			char:item_char[42],
			item:[42,1]
			});
			combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],42);
			break;
		case 26://walnut stone
			pages[cur_page].entities[item_ptrs[i]].item[1]--;
			pages[cur_page].entities.push({
			id:2,
			x:adj_empty(x,y)[0],
			y:adj_empty(x,y)[1],
			char:item_char[42],
			item:[42,1]
			});
			combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],42);
			break;
		case 6://fence
			pages[cur_page].entities[item_ptrs[i]].item[1]--;
			pages[cur_page].entities.push({
			id:2,
			x:adj_empty(x,y)[0],
			y:adj_empty(x,y)[1],
			char:item_char[42],
			item:[42,1]
			});
			combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],42);
			break;
		case 10://leaves
			pages[cur_page].entities[item_ptrs[i]].item[1]--;
			pages[cur_page].entities.push({
			id:2,
			x:adj_empty(x,y)[0],
			y:adj_empty(x,y)[1],
			char:item_char[29],
			item:[29,1]
			});//Fibers
			combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],42);
			break;
		case 27://Walnut Peels
			pages[cur_page].entities[item_ptrs[i]].item[1]--;
			pages[cur_page].entities.push({
			id:2,
			x:adj_empty(x,y)[0],
			y:adj_empty(x,y)[1],
			char:item_char[29],
			item:[29,1]
			});
			combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],42);
			break;
		case I_GRASS://Grass
			pages[cur_page].entities[item_ptrs[i]].item[1]--;
			pages[cur_page].entities.push({
			id:2,
			x:adj_empty(x,y)[0],
			y:adj_empty(x,y)[1],
			char:item_char[I_FIBERS],
			item:[I_FIBERS,1]
			});
			combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],42);
			break;
	}
}
}

/*
Not Gates (old):
On top-bottom:
Read gates. Ignore not gates.
On left-right:
Read not gates. Ignore gates.

*/

function not_gate(x,y){
	pages[cur_page].map[y][x]=(
	//left and right, check not gates
	char_value(x+1,y)==T_C_W_LEFT_ON||
	char_value(x+1,y)==T_C_W_UP_ON||
	char_value(x+1,y)==T_C_W_DOWN_ON||
	char_value(x+1,y)==T_SWITCH_ON||
	char_value(x+1,y)==T_ELECTRODES_ON||
	char_value(x+1,y)==T_NOT_GATE_ON||
	char_value(x-1,y)==T_C_W_RIGHT_ON||
	char_value(x-1,y)==T_C_W_UP_ON||
	char_value(x-1,y)==T_C_W_DOWN_ON||
	char_value(x-1,y)==T_NOT_GATE_ON||
	char_value(x-1,y)==T_ELECTRODES_ON||
	char_value(x-1,y)==T_SWITCH_ON||
	//up and down, check gates
	char_value(x,y-1)==T_C_W_DOWN_ON||
	char_value(x,y-1)==T_C_W_LEFT_ON||
	char_value(x,y-1)==T_C_W_RIGHT_ON||
	char_value(x,y-1)==T_GATE_ON||
	char_value(x,y-1)==T_SWITCH_ON||
	char_value(x,y-1)==T_ELECTRODES_ON||
	char_value(x,y+1)==T_C_W_UP_ON||
	char_value(x,y+1)==T_C_W_LEFT_ON||
	char_value(x,y+1)==T_C_W_RIGHT_ON||
	char_value(x,y+1)==T_SWITCH_ON||
	char_value(x,y+1)==T_ELECTRODES_ON||
	char_value(x,y+1)==T_GATE_ON
	? T_NOT_GATE_OFF : T_NOT_GATE_ON);
}

/*
Gates (old):
On top-bottom:
Read gates. Ignore not gates.
On left-right:
Read not gates. Ignore gates.
Gates (new):
On top-bottom:
Ignore gates. Ignore not gates.
On left-right:
Read not gates. Ignore gates.
*/

function gate(x,y){
	pages[cur_page].map[y][x]=(
	//left and right, check not gates
	char_value(x+1,y)==T_C_W_LEFT_ON||
	char_value(x+1,y)==T_C_W_UP_ON||
	char_value(x+1,y)==T_C_W_DOWN_ON||
	char_value(x+1,y)==T_SWITCH_ON||
	char_value(x+1,y)==T_ELECTRODES_ON||
	char_value(x+1,y)==T_NOT_GATE_ON||
	char_value(x-1,y)==T_C_W_RIGHT_ON||
	char_value(x-1,y)==T_C_W_UP_ON||
	char_value(x-1,y)==T_C_W_DOWN_ON||
	char_value(x-1,y)==T_NOT_GATE_ON||
	char_value(x-1,y)==T_ELECTRODES_ON||
	char_value(x-1,y)==T_SWITCH_ON||
	//up and down, check gates
	char_value(x,y-1)==T_C_W_DOWN_ON||
	char_value(x,y-1)==T_C_W_LEFT_ON||
	char_value(x,y-1)==T_C_W_RIGHT_ON||
	char_value(x,y-1)==T_SWITCH_ON||
	char_value(x,y-1)==T_ELECTRODES_ON||
	char_value(x,y+1)==T_C_W_UP_ON||
	char_value(x,y+1)==T_C_W_LEFT_ON||
	char_value(x,y+1)==T_C_W_RIGHT_ON||
	char_value(x,y+1)==T_SWITCH_ON||
	char_value(x,y+1)==T_ELECTRODES_ON
	? T_GATE_ON : T_GATE_OFF);
}

/*T gate:
left-right:toggle
up:on
down:off
*/
function t_gate(x,y){
	if(char_value(x+1,y)==T_C_W_LEFT_ON||
	char_value(x+1,y)==T_C_W_UP_ON||
	char_value(x+1,y)==T_C_W_DOWN_ON||
	char_value(x+1,y)==T_SWITCH_ON||
	char_value(x+1,y)==T_ELECTRODES_ON||
	char_value(x-1,y)==T_C_W_RIGHT_ON||
	char_value(x-1,y)==T_C_W_UP_ON||
	char_value(x-1,y)==T_C_W_DOWN_ON||
	char_value(x-1,y)==T_ELECTRODES_ON||
	char_value(x-1,y)==T_SWITCH_ON){//left right
		pages[cur_page].map[y][x]=(pages[cur_page].map[y][x]==T_T_GATE_ON)?T_T_GATE_OFF:T_T_GATE_ON;
	}
	
	if(char_value(x,y-1)==T_C_W_DOWN_ON||
	char_value(x,y-1)==T_C_W_LEFT_ON||
	char_value(x,y-1)==T_C_W_RIGHT_ON||
	char_value(x,y-1)==T_SWITCH_ON||
	char_value(x,y-1)==T_ELECTRODES_ON){//up
		pages[cur_page].map[y][x]=T_T_GATE_ON;
	}
	if(char_value(x,y+1)==T_C_W_UP_ON||
	char_value(x,y+1)==T_C_W_LEFT_ON||
	char_value(x,y+1)==T_C_W_RIGHT_ON||
	char_value(x,y+1)==T_SWITCH_ON||
	char_value(x,y+1)==T_ELECTRODES_ON){//down
		pages[cur_page].map[y][x]=T_T_GATE_OFF;
	}
}


function electrodes(x,y){
	pages[cur_page].map[y][x]=(char_value(x+1,y)==29||char_value(x-1,y)==29||char_value(x,y-1)==29||char_value(x,y+1)==29 ? 96 : 95);
}

function wire_jumper(x,y){
	//up, wire down
	if(char_value(x,y-1)==78&&char_value(x,y+1)==82){
		pages[cur_page].map[y+1][x]=78;
	}
	if(char_value(x,y-1)==82&&char_value(x,y+1)==78){
		pages[cur_page].map[y+1][x]=82;
	}
	//down, wire up
	if(char_value(x,y+1)==77&&char_value(x,y-1)==81){
		pages[cur_page].map[y-1][x]=77;
	}
	if(char_value(x,y+1)==81&&char_value(x,y-1)==77){
			pages[cur_page].map[y-1][x]=81;
	}
	//left, wire right
	if(char_value(x-1,y)==80&&char_value(x+1,y)==84){
		pages[cur_page].map[y][x+1]=80;
	}
	if(char_value(x-1,y)==84&&char_value(x+1,y)==80){
		pages[cur_page].map[y][x+1]=84;
	}
	//right, wire left
	if(char_value(x+1,y)==79&&char_value(x-1,y)==83){
		pages[cur_page].map[y][x-1]=79;
	}
	if(char_value(x+1,y)==83&&char_value(x-1,y)==79){
		pages[cur_page].map[y][x-1]=83;
	}
}

function pump(x,y){//water: 29
	var page_ptr;
	if(char_value(x,y-1)==29){
		if(char_value(x,y+1)==0){
			pages[cur_page].map[y-1][x]=0;
			pages[cur_page].map[y+1][x]=29;
			return;
		}
		if(hit_bounds(x,y+1)){//map edge, south
			page_ptr=get_ptr_from_page_xy(pages[cur_page].metadata.x,pages[cur_page].metadata.y+1,pages[cur_page].metadata.layer);
			if(page_ptr!=-1){
				if(pages[page_ptr].map[0][x]==0){
					pages[cur_page].map[y-1][x]=0;
					pages[page_ptr].map[0][x]=29;
					return;
				}
			}
		}
	}else{
	if(hit_bounds(x,y+1)){
		page_ptr=get_ptr_from_page_xy(pages[cur_page].metadata.x,pages[cur_page].metadata.y+1,pages[cur_page].metadata.layer);
		if(page_ptr!=-1){
			if(pages[page_ptr].map[0][x]==29&&char_value(x,y-1)==0){
				pages[page_ptr].map[0][x]=0;
				pages[cur_page].map[y-1][x]=29;
				return;
			}
		}
	}
	}
	if(char_value(x,y+1)==29){
		if(char_value(x,y-1)==0){
		pages[cur_page].map[y+1][x]=0;
		pages[cur_page].map[y-1][x]=29;
		return;
		}
		if(hit_bounds(x,y-1)){//map edge, north
			page_ptr=get_ptr_from_page_xy(pages[cur_page].metadata.x,pages[cur_page].metadata.y-1,pages[cur_page].metadata.layer);
			if(page_ptr!=-1){
				if(pages[page_ptr].map[24][x]==0){
					pages[cur_page].map[y+1][x]=0;
					pages[page_ptr].map[24][x]=29;
					return;
				}
			}
		}
	}else{
	if(hit_bounds(x,y-1)){
		page_ptr=get_ptr_from_page_xy(pages[cur_page].metadata.x,pages[cur_page].metadata.y-1,pages[cur_page].metadata.layer);
		if(page_ptr!=-1){
			if(pages[page_ptr].map[24][x]==29&&char_value(x,y+1)==0){
				pages[page_ptr].map[24][x]=0;
				pages[cur_page].map[y+1][x]=29;
				return;
			}
		}
	}
	}
	if(char_value(x-1,y)==29){
		if(char_value(x+1,y)==0){
		pages[cur_page].map[y][x-1]=0;
		pages[cur_page].map[y][x+1]=29;
		return;
		}
		if(hit_bounds(x+1,y)){//map edge, east
			page_ptr=get_ptr_from_page_xy(pages[cur_page].metadata.x+1,pages[cur_page].metadata.y,pages[cur_page].metadata.layer);
			if(page_ptr!=-1){
				if(pages[page_ptr].map[y][0]==0){
					pages[cur_page].map[y][x-1]=0;
					pages[page_ptr].map[y][0]=29;
					return;
				}
			}
		}
	}else{
	if(hit_bounds(x+1,y)){
		page_ptr=get_ptr_from_page_xy(pages[cur_page].metadata.x+1,pages[cur_page].metadata.y,pages[cur_page].metadata.layer);
		if(page_ptr!=-1){
			if(pages[page_ptr].map[y][0]==29&&char_value(x-1,y)==0){
				pages[page_ptr].map[y][0]=0;
				pages[cur_page].map[y][x-1]=29;
				return;
			}
		}
	}
	}
	if(char_value(x+1,y)==29){
		if(char_value(x-1,y)==0){
		pages[cur_page].map[y][x+1]=0;
		pages[cur_page].map[y][x-1]=29;
		return;
		}
		if(hit_bounds(x-1,y)){//map edge, west
			page_ptr=get_ptr_from_page_xy(pages[cur_page].metadata.x-1,pages[cur_page].metadata.y,pages[cur_page].metadata.layer);
			if(page_ptr!=-1){
				if(pages[page_ptr].map[y][39]==0){
					pages[cur_page].map[y][x+1]=0;
					pages[page_ptr].map[y][39]=29;
					return;
				}
			}
		}
	}else{
	if(hit_bounds(x-1,y)){
		page_ptr=get_ptr_from_page_xy(pages[cur_page].metadata.x-1,pages[cur_page].metadata.y,pages[cur_page].metadata.layer);
		if(page_ptr!=-1){
			if(pages[page_ptr].map[y][39]==29&&char_value(x+1,y)==0){
				pages[page_ptr].map[y][39]=0;
				pages[cur_page].map[y][x+1]=29;
				return;
			}
		}
	}
	}
}

function fan(x,y){//water: 29
	var j=0;
	if(char_value(x,y-1)==29 && char_value(x,y-2)==0){
		j=y-2;
		while(char_value(x,j)==0){
			j--;
		}
		j++;
		pages[cur_page].map[y-1][x]=0;
		pages[cur_page].map[j][x]=29;
	}
	if(char_value(x,y+1)==29 && char_value(x,y+2)==0){
		j=y+2;
		while(char_value(x,j)==0){
			j++;
		}
		j--;
		pages[cur_page].map[y+1][x]=0;
		pages[cur_page].map[j][x]=29;
	}
	if(char_value(x-1,y)==29 && char_value(x-2,y)==0){
		j=x-2;
		while(char_value(j,y)==0){
			j--;
		}
		j++;
		pages[cur_page].map[y][x-1]=0;
		pages[cur_page].map[y][j]=29;
	}
	if(char_value(x+1,y)==29 && char_value(x+2,y)==0){
		j=x+2;
		while(char_value(j,y)==0){
			j++;
		}
		j--;
		pages[cur_page].map[y][x+1]=0;
		pages[cur_page].map[y][j]=29;
	}
}

function capacitor(x,y){
	var _above=char_value(x,y-1);
	var _below=char_value(x,y+1);
	var _left=char_value(x-1,y);
	var _right=char_value(x+1,y);
	if(_above==T_C_W_DOWN_ON || _below==T_C_W_UP_ON || _left==T_C_W_RIGHT_ON || _right==T_C_W_LEFT_ON){
		pages[cur_page].map[y][x]=T_CAP4;
		return;
	}
	switch(char_value(x,y)){
		case T_CAP4:
			pages[cur_page].map[y][x]=T_CAP3;
			break;
		case T_CAP3:
			pages[cur_page].map[y][x]=T_CAP2;
			break;
		case T_CAP2:
			pages[cur_page].map[y][x]=T_CAP1;
			break;
		case T_CAP1:
			pages[cur_page].map[y][x]=T_CAP0;
			break;
		case T_CAP0:
			break;
	}
}

function elec_misc(tile,x,y,value){
	switch(tile){
		case 88://not gate (off)
		case 89://not gate (on)
			not_gate(x,y);
			break;
		case 90://Gate (off)
		case 91://Gate (on)
			gate(x,y);
			break;
		case 92://wire jumper
			wire_jumper(x,y);
			break;
		case 42://door closed
		case 43://door open
			pages[cur_page].map[y][x]=(value==1 ? 43 : 42);
			break;
		case 93://pump
			value==1 ? pump(x,y) : 0;
			break;
		case 94://fan
			value==1 ? fan(x,y) : 0;
			break;
		case T_T_GATE_OFF:
		case T_T_GATE_ON:
			t_gate(x,y);
			break;
		case T_CAP4:
		case T_CAP3:
		case T_CAP2:
		case T_CAP1:
		case T_CAP0:
			capacitor(x,y);
			break;
		default:
			break;
	}
}

function is_wire(x){
	return properties.wires.indexOf(x)!=-1;
}

function is_on(x){
	return properties.elec_on.indexOf(x)!=-1;
}

function is_off(x){
	return properties.elec_off.indexOf(x)!=-1;
}

function radio_interference(x,y){
	var closestdist=1000;//closest radio.
	for(var i=0;i<40;i++){
		for(var j=0;j<25;j++){
			if(char_value(i,j)==T_CLOCK_RADIO){
				if(closestdist>Math.sqrt(Math.pow((x-i),2)+Math.pow((y-j),2))){//radio found is closer then previous one.
				closestdist=Math.sqrt(
				Math.pow((x-i),2)+
				Math.pow((y-j),2)
				);
				}
			}
		}
	}
	if(closestdist<=RADIO_INTERFERENCE_DISTANCE){
		sfx("emi");
	}
}

function compost(x,y){
var item_ptrs=[];
for(var i=0;i<pages[cur_page].entities.length;i++){
	if(pages[cur_page].entities[i].id==2 && pages[cur_page].entities[i].x==x && pages[cur_page].entities[i].y==y){
		item_ptrs.push(i);
	}
}
for(var i=0;i<item_ptrs.length;i++){
	switch(pages[cur_page].entities[item_ptrs[i]].item[0]){
		case I_LEAVES:
		case I_GRASS:
		case I_W_PEELS:
			pages[cur_page].entities[item_ptrs[i]].item[1]--;
			pages[cur_page].entities.push({
			id:2,
			x:adj_empty(x,y)[0],
			y:adj_empty(x,y)[1],
			char:item_char[I_BONE_MEAL],
			item:[I_BONE_MEAL,1]
			});//bonemeal
			combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],I_BONE_MEAL);
			break;
	}
}
}

function _button(x,y){
	pages[cur_page].map[y][x]=T_BUTTON_OFF;
}

function active_tiles(){
	var grind_stones=map_search(73);
	for(var i=0;i<grind_stones.length;i++){
		grind_item(grind_stones[i].x,grind_stones[i].y);
	}
	var composters=map_search(T_COMPOSTER);
	for(var i=0;i<composters.length;i++){
		compost(composters[i].x,composters[i].y);
	}
	//wire up
	var wires=map_search(77);//Wire up, off
	var before_tile;
	var j;
	for(var i=0;i<wires.length;i++){
		if(is_on(char_value(wires[i].x,wires[i].y+1))){
			j=wires[i].y;
			while(char_value(wires[i].x,j)==77){
				pages[cur_page].map[j][wires[i].x]=81;
				j--;
			}
			radio_interference(wires[i].x,j+1);
			elec_misc(char_value(wires[i].x,j),wires[i].x,j,1);
		}
	}
	wires=map_search(81);//wire up,on
	for(var i=0;i<wires.length;i++){
		if(is_off(char_value(wires[i].x,wires[i].y+1))){
			j=wires[i].y;
			while(char_value(wires[i].x,j)==81){
				pages[cur_page].map[j][wires[i].x]=77;
				j--;
			}
			radio_interference(wires[i].x,j+1);
			elec_misc(char_value(wires[i].x,j),wires[i].x,j,0);
		}
	}
	//wire down
	wires=map_search(78);//wire down,off
	for(var i=0;i<wires.length;i++){
		if(is_on(char_value(wires[i].x,wires[i].y-1))){
			j=wires[i].y;
			while(char_value(wires[i].x,j)==78){
				pages[cur_page].map[j][wires[i].x]=82;
				j++;
			}
			radio_interference(wires[i].x,j-1);
			elec_misc(char_value(wires[i].x,j),wires[i].x,j,1);
		}
	}
	wires=map_search(82);//wire down,on
	for(var i=0;i<wires.length;i++){
		if(is_off(char_value(wires[i].x,wires[i].y-1))){
			j=wires[i].y;
			while(char_value(wires[i].x,j)==82){
				pages[cur_page].map[j][wires[i].x]=78;
				j++;
			}
			radio_interference(wires[i].x,j-1);
			elec_misc(char_value(wires[i].x,j),wires[i].x,j,0);
		}
	}
	//wire left
	wires=map_search(79);//wire left,off
	for(var i=0;i<wires.length;i++){
		if(is_on(char_value(wires[i].x+1,wires[i].y))){
			j=wires[i].x;
			while(char_value(j,wires[i].y)==79){
				pages[cur_page].map[wires[i].y][j]=83;
				j--;
			}
			radio_interference(j+1,wires[i].y);
			elec_misc(char_value(j,wires[i].y),j,wires[i].y,1);
		}
	}
	wires=map_search(83);//wire left,on
	for(var i=0;i<wires.length;i++){
		if(is_off(char_value(wires[i].x+1,wires[i].y))){
			j=wires[i].x;
			while(char_value(j,wires[i].y)==83){
				pages[cur_page].map[wires[i].y][j]=79;
				j--;
			}
			radio_interference(j+1,wires[i].y);
			elec_misc(char_value(j,wires[i].y),j,wires[i].y,0);
		}
	}
	//wire right
	wires=map_search(80);//wire right,off
	for(var i=0;i<wires.length;i++){
		if(is_on(char_value(wires[i].x-1,wires[i].y))){
			j=wires[i].x;
			while(char_value(j,wires[i].y)==80){
				pages[cur_page].map[wires[i].y][j]=84;
				j++;
			}
			radio_interference(j+1,wires[i].y);
			elec_misc(char_value(j,wires[i].y),j,wires[i].y,1);
		}
		
	}
	wires=map_search(84);//wire right,on
	for(var i=0;i<wires.length;i++){
		if(is_off(char_value(wires[i].x-1,wires[i].y))){
			j=wires[i].x;
			while(char_value(j,wires[i].y)==84){
				pages[cur_page].map[wires[i].y][j]=80;
				j++;
			}
			radio_interference(j+1,wires[i].y);
			elec_misc(char_value(j,wires[i].y),j,wires[i].y,0);
		}
	}
	var gates=[map_search(90),map_search(91),map_search(88),map_search(89),map_search(92),map_search(95),map_search(96),map_search(T_T_GATE_OFF),map_search(T_T_GATE_ON),map_search(T_CAP4),map_search(T_CAP3),map_search(T_CAP2),map_search(T_CAP1),map_search(T_CAP0),map_search(T_BUTTON_ON)];//gate off,gate on,not gate off, not gate on, wire jumper,electrode off,electrode on
	var longest=gates[0].length;
	for(var i=0;i<gates.length;i++){
		longest=longest<gates[i].length ? gates[i].length : longest;
	}
	for(var i=0;i<longest;i++){
		i<gates[0].length ? gate(gates[0][i].x,gates[0][i].y) : 0;
		i<gates[1].length ? gate(gates[1][i].x,gates[1][i].y) : 0;
		i<gates[2].length ? not_gate(gates[2][i].x,gates[2][i].y) : 0;
		i<gates[3].length ? not_gate(gates[3][i].x,gates[3][i].y) : 0;
		i<gates[4].length ? wire_jumper(gates[4][i].x,gates[4][i].y) : 0;
		i<gates[5].length ? electrodes(gates[5][i].x,gates[5][i].y) : 0;
		i<gates[6].length ? electrodes(gates[6][i].x,gates[6][i].y) : 0;
		//i<gates[7].length ? t_gate(gates[7][i].x,gates[7][i].y) : 0;
		//i<gates[8].length ? t_gate(gates[8][i].x,gates[8][i].y) : 0;
		i<gates[9].length ? capacitor(gates[9][i].x,gates[9][i].y) : 0;
		i<gates[10].length ? capacitor(gates[10][i].x,gates[10][i].y) : 0;
		i<gates[11].length ? capacitor(gates[11][i].x,gates[11][i].y) : 0;
		i<gates[12].length ? capacitor(gates[12][i].x,gates[12][i].y) : 0;
		i<gates[13].length ? capacitor(gates[13][i].x,gates[13][i].y) : 0;
		i<gates[14].length ? _button(gates[14][i].x,gates[14][i].y) : 0;
	}
}

function fireing(){
var snapshot=JSON.parse(JSON.stringify(pages[cur_page].map));
var tmp=0;
for(var x=0;x<40;x++){
	for(var y=0;y<25;y++){
		tmp=snapshot[y][x];
		if(tmp==30 || tmp==31 || tmp==32 || tmp==68){//Fire, Camp Fire
			do_fire(x,y);
		}
	}
}
}

function frac(x){
	return Math.round(x-Math.floor(x));
}

function leading_zeros(x){
	return (""+x).length==1 ? "0"+x : x;
}

function tick_hour(){
	return Math.floor(tick1/HOUR_DIV)%HOUR_MOD;
}

function tick_to_time(){//%02i:%02i
	var hour=Math.floor(tick1/HOUR_DIV)%HOUR_MOD;
	var minute=Math.floor(tick1/MINUTE_DIV)%MINUTE_MOD;
	return "$"+hour.toString(16).toUpperCase()+":$"+leading_zeros(minute.toString(16).toUpperCase());
}

function magnatron_sounds(){
	if((last_filament-player.filament)<0){//warmup
		if(!_sfx.paused){
			_sfx.pause();
		}
		if(player.filament<FILAMENT_THERMAL_ENOUGH){
			if(!_sfx.paused){
				var path=_sfx.src.split("/");
				path=path.pop();
				if(path=="magnatron_warmup.wav" || path=="magnatron_conducting.wav"){
					return;
				}
			}
			_sfx.src="./sounds/magnatron_warmup.wav";
			_sfx.play();
		}else{
			if(!_sfx.paused){
				return;
			}
			_sfx.src="./sounds/magnatron_conducting.wav";
			_sfx.play();
		}
		return;
	}
	if((last_filament-player.filament)>0){//cooldown
		var path=_sfx.src.split("/");
		path=path.pop();
		switch(path){
			case "":
			case "magnatron_warmup.wav":
			case "magnatron_conducting.wav":
				if(!_sfx.paused){
					_sfx.pause();
				}
			default:
				return;
		}
		return;
	}
}

function thunder_tick(random_x=Math.floor((Math.random()*65535))%40,random_y=Math.floor((Math.random()*65535))%25){
	//console.log("Thunder!");
	//add a little electricity
	pages[cur_page].entities.push({id:PROJ_ID,x:random_x,y:random_y,char:THUN_CHAR,direction:4,damage:THUN_DAMAGE,decay:THUN_DECAY,from_player:0});
	//if striking flamable tile or air, create fire.
	var strucken_tile=pages[cur_page].map[random_y][random_x];
	if(strucken_tile==0){
		pages[cur_page].map[random_y][random_x]=T_FIRE0;
	}else{
		for(var i=0;i<properties.burnable.length;i++){
			if(properties.burnable[i]==strucken_tile){
				pages[cur_page].map[random_y][random_x]=T_FIRE0;
			}
		}
	}
}

function rain_tick(r_x=Math.floor((Math.random()*65535))%40,r_y=Math.floor((Math.random()*65535))%25){
	//water spreading
	//console.log("Rain!");
	if(!hit_bounds(r_x+1,r_y)&&!hit_bounds(r_x-1,r_y)&&!hit_bounds(r_x,r_y+1)&&!hit_bounds(r_x,r_y-1)){
		if(pages[cur_page].map[r_y][r_x+1]==T_WATER&&pages[cur_page].map[r_y][r_x-1]==T_WATER&&pages[cur_page].map[r_y+1][r_x]==T_WATER&&pages[cur_page].map[r_y-1][r_x]==T_WATER&&pages[cur_page].map[r_y][r_x]==0){
			pages[cur_page].map[r_y][r_x]=T_WATER;
		}
	}
	
	
}

function filament_cooldown(){
	//last_filament=player.filament;
	player.filament=(player.filament-FILAMENT_THERMAL_COOLDOWN>0)?player.filament-FILAMENT_THERMAL_COOLDOWN:0;
}

function give_player(item_id,item_amount){
	for(var i=0;i<player.inv.length;i++){
		if(player.inv[i][0]==0 || player.inv[i][0]==item_id){
			player.inv[i][0]=item_id;
			player.inv[i][1]+=item_amount;
			return;
		}
	}
	pages[cur_page].entities.push({id:DROPPED_ITEM_ID,x:player.x,y:player.y,char:item_char[item_id],item:[item_id,item_amount]});
}

function catch_fish(rand=Math.random()){
	var sum=WEIGHT_SUM;
	var selection=-1;
	for(var i=0;i<fishing_chances.length;i++){
		rand-=fishing_chances[i];
		if(rand<fishing_chances[i]){
			selection=i;
			break;
		}
	}
	switch(selection){
		case 0://junk
			give_player(fishing_loot.junk[(Math.floor(Math.random()*65535)%fishing_loot.junk.length)],1);
			break;
		case 1://treasure
			give_player(fishing_loot.treasure[(Math.floor(Math.random()*65535)%fishing_loot.treasure.length)],1);
			break;
		case 2://fish
			give_player(fishing_loot.fish[(Math.floor(Math.random()*65535)%fishing_loot.fish.length)],1);
			break;
	}
}

function do_bobber(){
	var bobber=-1;
	for(var i=0;i<pages[cur_page].entities.length;i++){
		if(pages[cur_page].entities[i].id==BOBBER_ID){
			bobber=i;
			break;
		}
	}
	if(bobber==-1){
		return;
	}
	pages[cur_page].entities[i].delay--;
	if(pages[cur_page].entities[i].delay<=0){
		pages[cur_page].entities[i].id=-1;
		catch_fish();
	}
}

function mobile_check(){
	var agent=window.navigator.userAgent;
	console.log("Agent: "+agent);
	//var is_mobile=false;
	for(var i=0;i<key_words.length;i++){
		if(agent.indexOf(key_words[i])!=-1){//if a match is found...
			dem_ann.textContent="While Mouse Simulator 2D will run on mobile phone browsers, this is not recommended. No previsions for accepting touch input currently exist in this game. You will probably run into issues with the canvas not neatly fitting on the screen.";
		}
	}
}

var title_done=false;
function title_screen(x=Math.floor(Math.random()*65535)%splashes.length){
	if(title_done){
		return;
	}
	ctx.clearRect(0,0,320,200);
	ctx.textAlign="center";
	//ctx.font="10px sans-serif";
	ctx.font="bold 28px sans-serif";
	ctx.fillText("Mouse Simulator 2D",160,25);
	ctx.font="15px sans-serif";
	ctx.fillText("Create or load a save to begin.",160,100);
	ctx.font="10px sans-serif";
	ctx.textAlign="center";
	ctx.fillText(splashes[x],160,198,316);
	title_done=true;
	ctx.textAlign="start";
	mobile_check();
}

var tick1=0;//0 to 65535
var last_filament=0;
var game_state=TITLE;
function refresh(){//Dang it, no multiple setintervals...
if(paused==1){
	return;
}
if(TILE_MAP){
	var i=0;
	for(var x=0;x<40;x++){
		for(var y=0;y<25;y++){
			if(i<font.length){
				//asdf
				get_font(i,0,0);
				ctx.putImageData(char,8*x,8*y);
			}
			i++;
		}
	}
	return;
}
if(is_dead){
	return;
}
switch(game_state){
	case GAMING:
		break;
	case TITLE:
		title_screen();
		return;
	/*case CRAFTING:
		craft_cur_x=0;
		craft_cur_y=0;
		clear_canvas();
		draw_crafting();
		return;*/
}
//Entity and npc cleanup
for(var i=0;i<pages[cur_page].entities.length;i++){
	switch(pages[cur_page].entities[i].id){
		case 1://npc
			if(pages[cur_page].entities[i].health<=0){//npc death.
				pages[cur_page].entities[i].id=-1;
				player.total_death++;
				npc_drops(i);
			}
			break;
		case 2://dropped item
			if(pages[cur_page].entities[i].item[1]<=0){
				pages[cur_page].entities[i].id=-1;
			}
			if(pages[cur_page].entities[i].item[1]==null){
				pages[cur_page].entities[i].id=-1;
			}
			if(pages[cur_page].entities[i].item[0]<=0){
				pages[cur_page].entities[i].id=-1;
			}
			if(pages[cur_page].entities[i].item[0]>=item_char.length){
				pages[cur_page].entities[i].id=-1;
			}
			break;
		default:
			break;
	}
}
entity_cleanup();
draw_map(pages[cur_page]);
//status bar
var player_text;
switch(player.creative){
	case 0://Survival
		player_text="Name: "+player.name+" Health: "+player.health+" Strength: "+player.strength+" X: "+player.x+" Y: "+player.y+ " Text Page: "+cur_page+" Time: "+tick_to_time()+" "+pages[cur_page].metadata.x+","+pages[cur_page].metadata.y;
		break;
	case 1://Creative
		player_text="Name: "+player.name+" Creative X: "+player.x+" Y: "+player.y+ " Text Page: "+cur_page+" Time: "+tick_to_time()+" "+pages[cur_page].metadata.x+","+pages[cur_page].metadata.y;
		break;
}
document.getElementById("player").textContent=player_text;
var status_bar="Inventory: ";
switch(player.creative){
	case 0://Survival
	for(var i=0;i<10;i++){
		status_bar+=(player.inv[10]!=i ? i+": "+item_names[player.inv[i][0]]+" x "+player.inv[i][1]+" " : i+": ("+item_names[player.inv[i][0]]+" x "+player.inv[i][1]+") ");
	}
	break;
	case 1://creative
	for(var i=0;i<10;i++){
		status_bar+=(player.inv[10]!=i ? i+": "+item_names[player.inv[i][0]]+" " : i+": ("+item_names[player.inv[i][0]]+") ");
	}
	break;
}
document.getElementById("status").textContent=status_bar;
tick1=(tick1>=65536 ? 0:tick1+1);
if(tick1==0){
player.days++;
seasons();
}
tick1%2==0 ? tick():0;
tick1%40==0 ? random_tick():0;
tick1%2==0 ? do_bobber():0;
if(player.weather_type==W_THUNDER && pages[cur_page].metadata.layer==0){
	tick1%THUN_TICK_MOD==0 ? thunder_tick() : 0;
	tick1%RAIN_TICK_MOD==0 ? rain_tick() : 0;
}
if(player.weather_type==W_RAIN && pages[cur_page].metadata.layer==0){
	tick1%RAIN_TICK_MOD==0 ? rain_tick() : 0;
}
tick1%FILAMENT_THERMAL_COOLDOWN_TICK==0 ? filament_cooldown():0;
tick1%FILAMENT_THERMAL_COOLDOWN_TICK==0 ? magnatron_sounds():0;
if(tick1%7==0){//fire, Grind Stone
fireing();
active_tiles();
}
tick1%RAIN_TICK==0 ? rain_ctr=(rain_ctr+1)%2 : 0;
if(tick1%CAT_TICK==0){
	spawn_cat();
}
	if(tick1%7==0){//player on fire.
		if(typeof player.fire_tick === "undefined"){
			//dem_ann.textContent=1;
		}else{
			//dem_ann.textContent=2;
			player_onfire();
		}
	}
player.weather_count--;
if(player.weather_count<=0){
	switch(player.weather_type){
		case 0:
			player.weather_type=1+Math.floor(Math.random()*16)%2;
			player.weather_count=8192+Math.floor(Math.random()*16384);
			break;
		case 1:
		case 2:
			player.weather_type=0;
			player.weather_count=16384+Math.floor(Math.random()*65536);
			break;
	}
}

}
const interval = setInterval(function (){refresh();},67);
window.onload=function(){
	document.getElementsByTagName('body')[0].onkeydown=function (e){
		if(e.keyCode==32&&e.target==document.body){
			e.preventDefault();
		}
		key_manager(e.keyCode);
	}
};
function _load(){
	if(SHOW_DOTS_ON==666){
    		if(!confirm("Do you really want to run the program infected by the virus?")){
			return;
    		}
	}
	var compressed_save=saves.getItem("_save");
	var save_file=JSON.parse(LZUTF8.decompress(compressed_save,{outputEncoding:"String",inputEncoding:"Base64"}));
	if(save_file==null){
	return;
    	}
    	cur_page=save_file[0];
    	player=save_file[1];
    	pages=save_file[2];
	tick1=save_file[3];
	player.days=(player.days===undefined)? 0 : player.days;
	player.filament=(player.filament===undefined)? 0 : player.filament;
	player.weather_type=(player.weather_type===undefined)? 0 : player.weather_type;
	player.weather_count=(player.weather_count===undefined)? 65535 : player.weather_count;
    	player.steps=(player.steps===undefined)? 0 : player.steps;
	player.total_pain=(player.total_pain===undefined)? 0 : player.total_pain;	
	player.total_heal=(player.total_heal===undefined)? 0 : player.total_heal;
	player.total_placed=(player.total_placed===undefined)? 0 : player.total_placed;
	player.total_removed=(player.total_removed===undefined)? 0 : player.total_removed;
	player.total_dropped=(player.total_dropped===undefined)? 0 : player.total_dropped;
	player.total_picked=(player.total_picked===undefined)? 0 : player.total_picked;
	player.total_used=(player.total_used===undefined)? 0 : player.total_used;
	player.total_wielded=(player.total_wielded===undefined)? 0 : player.total_wielded;
	player.total_crafted=(player.total_crafted===undefined)? 0 : player.total_crafted;
	player.times_laid=(player.times_laid===undefined)? 0 : player.times_laid;
	player.total_death=(player.total_death===undefined)? 0 : player.total_death;
    	is_dead=false;
	game_state=GAMING;
	dem_ann.textContent="Loaded. Size:"+compressed_save.length+" bytes.";
}
function _save(){
	if(game_state==TITLE){
		dem_ann.textContent="Nothing to save.";
		return;
	}
	if(saves.getItem("_save")!="empty"){
		if(!confirm("Save already exists, overwrite?")){
			return;
		}
	}
	var compressed_save=LZUTF8.compress(JSON.stringify([cur_page,player,pages,tick1]),{outputEncoding:"Base64"});
	if(compressed_save.length>=5000000){//is the 5mb limit 5mb or 5mib?
		alert("Your savefile is too big, please use the \"import\" and \"export\" buttons instead.");
	}
	saves.setItem("_save",compressed_save);
	dem_ann.textContent="Saved. Size:"+compressed_save.length+" bytes";
}
function _delete(){
	if(confirm("Delete Save?")){
		saves.setItem("_save","empty");
	}
}
function _import(){
	var compressed_save=prompt("Save?");
    var save_file=JSON.parse(LZUTF8.decompress(compressed_save,{outputEncoding:"String",inputEncoding:"Base64"}));
    if(save_file==null){
	return;
    }
    cur_page=save_file[0];
    player=save_file[1];
    pages=save_file[2];
	tick1=save_file[3];
	player.days=(player.days===undefined)? 0 : player.days;
	player.filament=(player.filament===undefined)? 0 : player.filament;
	player.weather_type=(player.weather_type===undefined)? 0 : player.weather_type;
	player.weather_count=(player.weather_count===undefined)? 65535 : player.weather_count;
	player.steps=(player.steps===undefined)? 0 : player.steps;
	player.total_pain=(player.total_pain===undefined)? 0 : player.total_pain;	
	player.total_heal=(player.total_heal===undefined)? 0 : player.total_heal;
	player.total_placed=(player.total_placed===undefined)? 0 : player.total_placed;
	player.total_removed=(player.total_removed===undefined)? 0 : player.total_removed;
	player.total_dropped=(player.total_dropped===undefined)? 0 : player.total_dropped;
	player.total_picked=(player.total_picked===undefined)? 0 : player.total_picked;
	player.total_used=(player.total_used===undefined)? 0 : player.total_used;
	player.total_wielded=(player.total_wielded===undefined)? 0 : player.total_wielded;
	player.total_crafted=(player.total_crafted===undefined)? 0 : player.total_crafted;
	player.times_laid=(player.times_laid===undefined)? 0 : player.times_laid;
	player.total_death=(player.total_death===undefined)? 0 : player.total_death;
	is_dead=falsie;
	game_state=GAMING;
	dem_ann.textContent="Loaded. Size:"+compressed_save.length+" bytes.";
}
function _export(){
	if(game_state==TITLE){
		dem_ann.textContent="Please load a save.";
		return;
	}
	if(confirm("This will end your session.")){
		document.write(LZUTF8.compress(JSON.stringify([cur_page,player,pages,tick1]),{outputEncoding:"Base64"}));
	}
}
function _new(){
	if(!confirm("Destroy current unsaved progress?")){
		return;
	}
	is_dead=false;
	new_save();
	game_state=GAMING;
}
</script>
</html>
