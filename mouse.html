<html>
<head>
<title>Mouse Simulator 2D</title>
</head>
<body>
    <center>
    <canvas id="cga" width="320" height="200" style="border: 2px solid #777777;"></canvas>
    <p id="player"></p>
    <p id="status">This paragraph tag is left intentionally blank.</p>
    <p id="demonic_announcer">Welcome!</p>
    <button onclick="_import()">Import</button><button onclick="_export()">Export</button>
    </br>
    <button onclick="alert(eval(prompt('Code?')))">eval()</button>
    </center>
</body>
<script>
/*window.onbeforeunload = function(e) {
  return "This will end your session.";
};*/
//Mouse Simulator 2D v0.31
/*
Bangs
Poisonous Spears
Dropping have of item amounts
More structures
Better crafting system (or was that added last update?)
*/
//states
var cur_page=0;
var player={brain:{gender:0.0, attraction:0.0, dysphoria:1, mode:1}, name:"Alex", x:1, y:1, health:20, strength:1, inv:[[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],0], creative:0};
//inventory: [(item id),(item amount)]; player.inv[10]=selected pointer
//maps
var pages=[{
	//home_page
	map:[
	[1,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,10,10,0,10,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,10,10,11,10,1],//craft bench
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,10,10,0,10,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,8,8,8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,7,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,13,0,0,0,0,0,0,7,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,17,0,16,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
	],
	entities:[
        {id:2, char:9, x:4, y:10, item: [1,10]},//branch
        {id:2, char:12, x:5, y:10, item: [2,10]},//hay
        {id:2, char:27, x:5, y:11, item: [12,10]},//stew
        {id:2, char:24, x:4, y:11, item: [9,10]},
		{id:2, char:36, x:6, y:11, item: [17,255]},
		{id:2, char:38, x:4, y:12, item: [19,1]}
	],
	holes:[
		//holes
		{x:1, y:0, dest_page:1, next_x: 1, next_y: 23},
		{x:2, y:0, dest_page:-2, next_x:19, next_y:12}//gen new page
	],
	metadata:{
	safety:1,//Do enemies spawn here at night?
	north_goto:-1,//Next page to go to when leaving via north edge
	south_goto:-1,//Next page to go to when leaving via south edge
	west_goto:-1,//Next page to go to when leaving via west edge
	east_goto:-1,//Next page to go to when leaving via north edge
	x:0,
	y:0,
	underground:true,
	}
},
{
	//test page
	map:[
	[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,2,2,2,0,2,2,2,0,0,2,2,0,2,2,2,0,2,0,0,0,18,18,18,18,18,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,2,0,0,2,0,0,0,2,0,0,0,0,2,0,0,2,0,0,18,13,13,13,13,13,18,14,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,2,0,0,2,2,0,0,0,2,0,0,0,2,0,0,2,0,0,18,13,13,13,13,13,18,15,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,2,0,0,2,0,0,0,0,0,2,0,0,2,0,0,0,0,0,18,13,13,13,13,13,18,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,2,0,0,2,2,2,0,2,2,0,0,0,2,0,0,2,0,0,18,13,13,13,13,13,18,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,18,13,13,13,13,13,18,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,14,14,14,14,14,0,0,0,0,0,0,0,0,0,0,0,0,0,0,18,0,0,0,18,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,15,15,15,15,15,0,0,29,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,14,14,14,14,14,0,29,29,29,0,0,0,0,0,0,0,0,0,0,0,13,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,15,15,15,15,15,0,0,29,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
	[2,0,0,0,0,0,0,0,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
	[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,32,31,30,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
	],
	entities:[
		//entities
		{id:1, char:3, x:24,y:5, brain: {no_ai:0, hostile: 0}, health:20, strength:1, attack_cooldown:0, dest_x:24, dest_y:15},//npc,9,15
        {id:3, char:20, x:17, y:13, direction:-1, decay:20, damage:1000, item_drop:[0,0]},
        {id:3, char:20, x:18, y:13, direction:3, decay:-1, damage:1000, item_drop:[0,0]},
        {id:3, char:20, x:16, y:13, direction:2, decay:-1, damage:1000, item_drop:[0,0]},
        {id:3, char:20, x:17, y:12, direction:0, decay:-1, damage:1000, item_drop:[0,0]},
        {id:3, char:20, x:17, y:14, direction:1, decay:-1, damage:1000, item_drop:[0,0]},
        {id:1, char:4, x:1,y:1, brain: {no_ai:1, hostile: 1}, health:20, strength:1, attack_cooldown:0, dest_x:1, dest_y:1},//enemy
	],
	holes:[
		//holes
		{x:1, y:24, dest_page:0, next_x:1, next_y:1},
		{x:1, y:0, dest_page:-1, next_x:1, next_y:1},//nowhere
		
	],
	metadata:{
	safety:0,//Do enemies spawn here at night?
	north_goto:-1,//Next page to go to when leaving via north edge
	south_goto:-1,//Next page to go to when leaving via south edge
	west_goto:-1,//Next page to go to when leaving via west edge
	east_goto:-1,//Next page to go to when leaving via north edge
	x:0,
	y:0,
	underground:true,
	}
},
];

//the font/sprites
var font=[
//0, solid white
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,255,255,255
],
//1, solid black
[
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,0,0,0,255,255,255
],
//2, dither
[
0,1,0,1,0,1,0,1,
1,0,1,0,1,0,1,0,
0,1,0,1,0,1,0,1,
1,0,1,0,1,0,1,0,
0,1,0,1,0,1,0,1,
1,0,1,0,1,0,1,0,
0,1,0,1,0,1,0,1,
1,0,1,0,1,0,1,0,255,255,255,0,0,0
],
//3, Deer mouse/player
[
0,1,1,1,1,1,1,0,
1,1,1,1,1,1,1,1,
1,1,0,1,1,0,1,1,
1,1,1,1,1,1,1,1,
1,1,0,0,0,0,1,1,
1,1,1,0,0,1,1,1,
1,1,1,1,1,1,1,1,
0,1,1,1,1,1,1,0,185,122,87,255,255,255
],
//4	Enemy?
[
0,1,1,1,1,1,1,0,
1,1,1,1,1,1,1,1,
1,1,0,1,1,0,1,1,
1,1,1,1,1,1,1,1,
1,1,1,0,0,1,1,1,
1,1,0,0,0,0,1,1,
1,1,1,1,1,1,1,1,
0,1,1,1,1,1,1,0,185,122,87,255,255,255
],
//5	
[
0,1,1,1,1,1,1,0,
1,0,0,0,0,0,0,1,
1,0,0,0,0,0,0,1,
1,0,0,0,0,0,0,1,
1,0,0,0,0,0,0,1,
1,0,0,0,0,0,0,1,
1,0,0,0,0,0,0,1,
0,1,1,1,1,1,1,0,255,255,255,0,0,0
],
//6, hole	
[
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,0,0,1,1,1,
1,1,0,0,0,0,1,1,
1,1,0,0,0,0,1,1,
1,1,1,0,0,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,0,0,0,128,128,255
],
//7, bedding
[
1,0,1,0,1,0,1,0,
1,0,1,0,1,0,1,0,
0,1,0,1,0,1,0,1,
0,1,0,1,0,1,0,1,
1,0,1,0,1,0,1,0,
1,0,1,0,1,0,1,0,
0,1,0,1,0,1,0,1,
0,1,0,1,0,1,0,1,244,164,96,255,255,255
],
//8, bedding
[
0,0,1,0,0,0,0,0,
0,0,1,0,0,0,0,0,
0,0,0,1,0,0,0,1,
0,0,0,1,0,1,0,0,
0,0,1,0,1,0,1,0,
0,0,1,0,1,0,1,0,
0,1,0,1,0,1,0,1,
0,1,0,1,0,1,0,1,244,164,96,255,255,255
],
//9, Branch
[
0,0,0,0,0,0,0,0,
0,0,0,0,1,0,0,0,
0,0,1,0,1,0,1,0,
0,0,0,1,0,0,1,0,
0,0,0,0,1,1,0,0,
0,0,0,0,1,1,0,0,
0,0,1,1,0,0,1,0,
0,0,0,0,0,0,0,1,244,164,96,255,255,255
],
//10, craft_space
[
1,1,1,1,1,1,1,1,
1,0,0,0,0,0,0,1,
1,0,0,0,0,0,0,1,
1,0,0,0,0,0,0,1,
1,0,0,0,0,0,0,1,
1,0,0,0,0,0,0,1,
1,0,0,0,0,0,0,1,
1,1,1,1,1,1,1,1,0,0,0,255,255,255
],
//11, craft_arrow
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,1,0,0,
0,0,0,0,0,0,1,0,
0,1,1,1,1,1,1,1,
0,1,1,1,1,1,1,1,
0,0,0,0,0,0,1,0,
0,0,0,0,0,1,0,0,
0,0,0,0,0,0,0,0,0,0,0,255,255,255
],
//12, hay
[
0,0,0,1,1,0,0,0,
0,0,1,0,1,1,0,0,
0,1,0,1,0,1,1,0,
1,0,1,0,1,0,1,1,
1,1,0,1,0,1,0,1,
0,1,1,0,1,0,1,0,
0,0,1,0,0,1,0,0,
0,0,0,1,1,0,0,0,244,164,96,255,255,255
],
//13, Grass
[
0,1,0,1,0,1,0,1,
1,0,0,1,0,1,0,1,
1,0,0,1,0,0,1,0,
1,0,0,1,0,0,1,0,
0,1,1,0,0,1,0,1,
0,1,1,0,0,1,0,1,
1,0,0,1,0,1,0,1,
1,1,1,1,1,1,1,1,0,255,0,255,255,255
],
//14, Tree leaves
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,1,1,1,1,0,0,
0,1,1,1,1,1,1,0,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
0,1,1,1,1,1,1,0,0,255,0,255,255,255
],
//15, Tree trunk
[
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,1,1,1,1,0,0,
0,1,1,1,1,1,1,0,185,122,87,255,255,255
],
//16, brown mushroom
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,1,1,0,0,0,
0,0,1,1,1,1,0,0,
0,1,1,1,1,1,1,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,179,170,154,255,255,255
],
//17, red mushroom
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,1,1,0,0,0,
0,0,1,1,1,1,0,0,
0,1,1,1,1,1,1,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,255,0,0,255,255,255
],
//18, Fence
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
1,0,0,0,0,0,0,1,
1,0,0,0,0,0,0,1,
1,1,1,1,1,1,1,1,
1,0,0,0,0,0,0,1,
1,1,1,1,1,1,1,1,
1,0,0,0,0,0,0,1,185,122,87,255,255,255
],
//19, attack indicator/projectile
[
0,0,0,1,1,0,0,0,
0,1,0,1,1,0,1,0,
0,0,1,1,1,1,0,0,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
0,0,1,1,1,1,0,0,
0,1,0,1,1,0,1,0,
0,0,0,1,1,0,0,0,255,0,0,255,255,255
],
//20, raygun ring
[
0,0,0,0,0,0,0,0,
0,0,0,1,1,0,0,0,
0,0,1,0,0,1,0,0,
0,1,0,0,0,0,1,0,
0,1,0,0,0,0,1,0,
0,0,1,0,0,1,0,0,
0,0,0,1,1,0,0,0,
0,0,0,0,0,0,0,0,0,255,0,255,255,255
],
//21, stick
[
0,0,0,0,0,0,0,0,
0,1,1,0,0,0,0,0,
0,1,1,1,0,0,0,0,
0,0,1,1,1,0,0,0,
0,0,0,1,1,1,0,0,
0,0,0,0,1,1,1,0,
0,0,0,0,0,1,1,0,
0,0,0,0,0,0,0,0,185,122,87,255,255,255
],
//22, String
[
0,0,0,0,0,0,0,0,
0,0,0,1,1,0,0,0,
0,0,1,0,0,1,0,0,
0,1,0,0,0,0,0,0,
0,0,1,1,1,0,0,0,
0,0,0,0,0,1,0,0,
0,0,0,0,0,1,1,0,
0,0,0,0,0,0,0,0,0,0,0,255,255,255
],
//23, Bow
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,255,255,255
],
//24, Sapling.
[
0,1,0,0,1,0,1,0,
0,1,0,0,1,0,1,0,
0,0,1,1,1,1,0,0,
1,0,0,1,1,0,0,1,
0,1,1,1,1,1,1,0,
0,0,1,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,0,255,0,255,255,255
],
//25, Leaves
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,1,1,1,0,0,0,
0,0,1,1,1,1,0,0,
0,0,1,1,1,1,0,0,
0,0,0,1,1,1,0,0,
0,0,0,0,0,0,1,0,
0,0,0,0,0,0,0,0,0,255,0,255,255,255
],
//26, Bowl
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,1,0,0,0,0,1,0,
0,1,0,0,0,0,1,0,
0,0,1,0,0,1,0,0,
0,0,0,1,1,0,0,0,0,0,0,255,255,255
],
//27, Mushroom Stew
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,1,1,1,1,1,1,0,
0,1,1,1,1,1,1,0,
0,0,1,1,1,1,0,0,
0,0,0,1,1,0,0,0,0,0,0,255,255,255
],
//28, Carpet
[
1,0,1,0,1,0,1,0,
0,1,0,1,0,1,0,1,
1,0,1,0,1,0,1,0,
0,1,0,1,0,1,0,1,
1,0,1,0,1,0,1,0,
0,1,0,1,0,1,0,1,
1,0,1,0,1,0,1,0,
0,1,0,1,0,1,0,1,100,100,100,255,255,255
],
//29, water
[
1,1,0,0,1,1,1,1,
0,0,1,1,0,0,0,0,
1,1,0,0,1,1,1,1,
0,0,1,1,0,0,0,0,
1,1,0,0,1,1,1,1,
0,0,1,1,0,0,0,0,
1,1,0,0,1,1,1,1,
0,0,1,1,0,0,0,0,0,0,200,0,0,150
],
//30, fire 0
[
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,1,1,1,1,0,0,
0,0,1,1,1,1,0,0,
0,1,1,1,1,1,1,0,
0,1,1,1,1,1,1,0,
0,0,1,1,1,1,0,0,
0,0,0,1,1,0,0,0,200,0,0,255,255,255
],
//31, fire 1
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,1,1,1,1,0,0,
0,0,1,1,1,1,0,0,
0,0,1,1,1,1,0,0,
0,0,0,1,1,0,0,0,200,0,0,255,255,255
],
//32, fire 2
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,1,1,1,1,0,0,
0,0,1,1,1,1,0,0,200,0,0,255,255,255
],
//33, bow
[
0,0,0,0,0,0,0,0,
0,0,0,1,1,1,0,0,
0,0,1,0,1,0,0,0,
0,1,0,1,0,0,0,0,
0,1,1,0,0,0,0,0,
0,1,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,255,255,255
],
//34, bow and spindle
[
0,0,0,0,0,0,0,0,
0,0,0,1,1,1,0,0,
0,0,1,0,1,0,0,0,
0,1,0,1,0,0,1,0,
0,1,1,0,0,1,0,0,
0,1,0,0,1,0,0,0,
0,0,0,1,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,255,255,255
],
//35, Amber
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,1,1,1,0,0,
0,0,1,1,1,1,0,0,
0,0,1,1,1,1,0,0,
0,0,1,1,1,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,200,0,0,255,255,255
],
//36, Fire Bow
[
0,0,0,0,0,0,0,0,
0,0,0,1,1,1,0,0,
0,0,1,0,1,0,0,0,
0,1,0,1,0,0,0,0,
0,1,1,0,0,1,1,0,
0,1,0,0,1,1,1,0,
0,0,0,0,1,1,0,0,
0,0,0,0,0,0,0,0,0,0,0,255,255,255
],
//37, spear
[
0,0,0,0,0,0,0,0,
0,0,0,0,1,1,1,0,
0,0,0,0,0,1,1,0,
0,0,0,0,1,0,1,0,
0,0,0,1,0,0,0,0,
0,0,1,0,0,0,0,0,
0,1,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,185,122,87,255,255,255
],
//38, Raygun
[
0,0,0,0,0,0,0,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,1,1,1,1,0,0,
0,0,1,1,1,1,0,0,
0,0,1,1,1,1,0,0,
0,0,0,0,0,0,0,0,255,0,0,255,255,255
],
//39, Poisonous Spear
[
0,0,0,0,0,0,0,0,
0,0,0,0,1,1,1,0,
0,0,0,0,0,1,1,0,
0,0,0,0,1,0,1,0,
0,0,0,1,0,0,0,0,
0,0,1,0,0,0,0,0,
0,1,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,255,0,0,255,255,255
],
//40, 115
[
0,0,0,0,0,0,1,0,
0,1,0,0,0,0,1,0,
0,0,0,1,1,0,0,0,
0,0,0,1,0,0,0,0,
0,1,0,0,0,0,0,0,
1,1,1,0,1,1,0,0,
0,1,0,0,1,1,0,0,
0,0,0,0,0,0,0,0,0,255,255,120,120,120
],
//41, stone
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,1,1,1,0,0,
0,0,1,1,1,1,0,0,
0,0,1,1,1,1,0,0,
0,0,1,1,1,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,120,120,120,255,255,255
],
];
var properties={
walkable:[0,2,6,7,8,9,10,11,13,14,15,16,17,24,28,29,30,31,32,38,40],
not_spawnable:[2,28,29,30,31,32],
burnable:[12,13,14,15,18,24,28],
bangable:[18],
};
//items
var item_char=[
0,//Nothing,0
9,//Branch,1
12,//Hay,2
13,//Grass,3
16,//Brown Mushroom,4
17,//Red Mushroom,5
18,//Fence,6
21,//stick,7
22,//string,8
24,//Sapling,9
25,//Leaves,10
26,//Bowl,11
27,//Mushroom Stew,12
28,//Carpet,13
33,//Bow,14
34,//Bow and spindle,15
35,//Amber,16
36,//Fire bow, 17
37,//Spear,18
38,//Raygun,19
39,//Poisonous Spear, 20
40,//115, 21
];

var item_names=[
"Nothing",
"Branch",
"Hay",
"Grass",
"Brown Mushroom",
"Red Mushroom",
"Fence",
"Stick",
"String",
"Sapling",
"Leaves",
"Bowl",
"Mushroom Stew",
"Carpet",
"Bow",
"Bow and Spindle",
"Amber",
"Fire Bow",
"Spear",
"Raygun",
"Poisonous Spear",
"Cyan Thing"
];
//crafting

var recipies=[
{//branch to stick+leaves
input_id:[1,0,0,0,0,0],
output:[[7,1],[10,1]]
},
{//hay to string
input_id:[2,0,0,0,0,0],
output:[[8,1]]
},
{//2 sticks + 1 string to fence
input_id:[7,0,8,0,7,0],
output:[[6,1]]
},
{//2 string + 1 leaves to bowl
input_id:[8,0,10,0,8,0],
output:[[11,1]]
},
{//bowl + brown mushroom to mushroom stew
input_id:[0,0,4,0,11,0],
output:[[11,1]]
},
{//bowl + brown mushroom to mushroom stew
input_id:[4,0,11,0,0,0],
output:[[12,1]]
},
{//4 grass to hay
input_id:[3,3,3,3,0,0],
output:[[2,1]]
},
{//4 string + 2 hay to carpet
input_id:[8,8,2,2,8,8],
output:[[13,1]]
},
{//bow
input_id:[7,0,8,7,7,0],
output:[[14,1]]
},
{//bow
input_id:[0,7,7,8,0,7],
output:[[14,1]]
},
{//bow+stick to bow and spindle
input_id:[14,7,0,0,0,0],
output:[[15,1]]
},
{//bow and spindle+hay+stick to amber and bow and spindle
input_id:[15,2,1,0,0,0],
output:[[15,1],[16,1]]
},
{//bow + amber to fire bow
input_id:[14,16,16,16,16,16],
output:[[17,5]]
},
{//3 sticks to spear.
input_id:[7,0,7,0,7,0],
output:[[18,1]]
},
{//Spear+Red Mushroom to Poisonous Spear.
input_id:[18,5,0,0,0,0],
output:[[20,1]]
},
];

var struct_weight=[//likelyness to be generated
0.8,//tree
0.8,//grass
0.1,//115
0.2,//abandoned shed.
-1,//hole
0.1,//pond
0.1,//raygun
0.1,//Facility
];

var struct_tries=[
10,
10,
1,
1,
2,
2,
1,
1,
];

var struct_sub=[
[0,1],
[0,0],
[1,1],
[4,4],
[0,0],
[3,3],
[1,1],
[11,5],
];

var structures=[
//tree,0
[
[14],
[15]
],
//grass, 1
[
[13]
],
//115, 2
[
[40]
],
//Human_abandoned_shed, 3
[
[1,1,1,0,1],
[13,28,28,28,1],
[1,28,28,28,13],
[1,28,28,28,1],
[1,2,1,1,1],
],
//hole, 4
[
[0,2,0],
[2,6,2],
[0,2,0]
],
//pond,5
[
[0,29,29,0],
[29,29,29,29],
[29,29,29,29],
[0,29,29,0],
],
//raygun,6
[
[38]
],
//group 935
[
[1,1,1,2,1,1,1,1,1,1,1,1],
[1,13,13,30,13,13,13,13,13,13,13,1],
[1,13,13,13,13,13,13,13,14,13,13,1],
[14,13,13,13,13,13,13,13,15,13,13,1],
[1,13,13,13,13,13,13,13,13,13,13,1],
[1,1,1,1,13,1,1,1,1,1,1,1],
]
];

var ctx=document.getElementById("cga").getContext("2d");
var char=ctx.getImageData(0,0,8,8);
function write_1bit(pos,val,r1,g1,b1,r2,g2,b2){
	if(!val){
		char.data[4*pos]=r2;
		char.data[4*pos+1]=g2;
		char.data[4*pos+2]=b2;
		char.data[4*pos+3]=255;
		return 0;
	}
	if(val){
		char.data[4*pos]=r1
		char.data[4*pos+1]=g1;
		char.data[4*pos+2]=b1;
		char.data[4*pos+3]=255;
		return 0;
	}
}
function get_font(val){
for(var i=0;i<64;i++){
write_1bit(i,font[val][i],font[val][64],font[val][65],font[val][66],font[val][67],font[val][68],font[val][69]);
}
return val;
}
function draw_map(){
	//block map
	for(var x=0;x<40;x++){
		for(var y=0;y<25;y++){
			get_font(pages[cur_page].map[y][x]);
			ctx.putImageData(char,x*8,y*8);
		}
	}
	//entity map
	for(var i=0;i<pages[cur_page].entities.length;i++){
	   get_font(pages[cur_page].entities[i].char);
	   ctx.putImageData(char,pages[cur_page].entities[i].x*8,pages[cur_page].entities[i].y*8);
	}
	//player
	get_font(3);
	ctx.putImageData(char,player.x*8,player.y*8);
}

function struct_copy(struct_id,offset_x,offset_y,fill_nonzero=1){
	for(var y=0;y<structures[struct_id].length;y++){
		for(var x=0;x<structures[struct_id][y].length;x++){
			if(hit_bounds(offset_x+x,offset_y+y)){
				continue;
			}
			if(char_value(offset_x+x,offset_y+y)!=0 && fill_nonzero==0){
				continue;
			}
			pages[cur_page].map[offset_y+y][offset_x+x]=structures[struct_id][y][x];
		}
	}
}

function generate_stuff(){
	var rand_x=0;
	var rand_y=0;
	for(var i=0;i<struct_weight.length;i++){
		for(var j=0;j<struct_tries[i];j++){
		if(i==4){
			continue;
		}
		rand_x=Math.floor(Math.random()*100)%(40-struct_sub[i][0]);
		rand_y=Math.floor(Math.random()*100)%(25-struct_sub[i][1]);
		if(char_value(rand_x,rand_y)==0){
			if(Math.random()<struct_weight[i]){
				struct_copy(i,rand_x,rand_y);
			}
		}
		}
	}
}

//if two pages next to each other, link them.
function check_page_sides(){
	if(pages[cur_page].metadata.underground==true){
		return;
	}
	var x=pages[cur_page].metadata.x;
	var y=pages[cur_page].metadata.y;
	for(var i=2;i<pages.length;i++){
		//Above
		if(pages[i].metadata.x==pages[cur_page].metadata.x && pages[i].metadata.y==pages[cur_page].metadata.y-1){
			pages[cur_page].metadata.north_goto=i;
		}
		//Below
		if(pages[i].metadata.x==pages[cur_page].metadata.x && pages[i].metadata.y==pages[cur_page].metadata.y+1){
			pages[cur_page].metadata.south_goto=i;
		}
		//left
		if(pages[i].metadata.x==pages[cur_page].metadata.x-1 && pages[i].metadata.y==pages[cur_page].metadata.y){
			pages[cur_page].metadata.west_goto=i;
		}
		//right
		if(pages[i].metadata.x==pages[cur_page].metadata.x+1 && pages[i].metadata.y==pages[cur_page].metadata.y){
			pages[cur_page].metadata.east_goto=i;
		}
	}
}

function get_ptr_from_page_xy(x,y){
	for(var i=0;i<pages.length;i++){
		if(pages[i].metadata.x==x && pages[i].metadata.y==y){
			if(pages[i].underground==true){
				return -1;
			}
			return i;
		}
	}
	return -1;
}

function new_page(hole_from=-1,direction="none"){
	var old_cur_page=cur_page;
	var n_page={map:new Array(25),entities:[],holes:[],metadata:{safety:0, north_goto:-2, south_goto:-2, west_goto:-2, east_goto:-2, x:pages[cur_page].metadata.x,y:pages[cur_page].metadata.y,underground:false}};
	for(var i=0;i<25;i++){
		n_page.map[i]=new Array(40);
	}
	for(var j=0;j<25;j++){
		for(var i=0;i<40;i++){
			n_page.map[j][i]=0;
		}
	}
	pages.push(n_page);
	if(hole_from==-1){
		switch(direction){//direction _entering_ new page
	    case "none":
		struct_copy(4,18,11);
		pages[cur_page].holes.push({x:19, y:12, dest_page:old_cur_page, next_x: 2, next_y: 0});
		pages[cur_page].metadata.x=0;
		pages[cur_page].metadata.y=0;
	    	break;
	    case "up"://up
	    	pages[cur_page].metadata.north_goto=pages.length-1;
	    	break;
	    case "down"://down
	    	pages[cur_page].metadata.south_goto=pages.length-1;
	    	break;
	    case "left"://left
	    	pages[cur_page].metadata.west_goto=pages.length-1;
	    	break;
	    case "right"://right
	    	pages[cur_page].metadata.east_goto=pages.length-1;
	    	break;
	    }
	}else{
		pages[cur_page].holes[hole_from].dest_page=pages.length-1;
	}
	cur_page=pages.length-1;
	generate_stuff();
	switch(direction){//direction _entering_ new page
	    case "none":
		struct_copy(4,18,11);
		n_page.holes.push({x:19, y:12, dest_page:old_cur_page, next_x: 2, next_y: 0});
	    	break;
	    case "up"://up
	    	pages[cur_page].metadata.south_goto=old_cur_page;
		pages[cur_page].metadata.x;
		pages[cur_page].metadata.y--;
	    	break;
	    case "down"://down
	    	pages[cur_page].metadata.north_goto=old_cur_page;
		pages[cur_page].metadata.x;
		pages[cur_page].metadata.y++;
	    	break;
	    case "left"://left
	    	pages[cur_page].metadata.east_goto=old_cur_page;
		pages[cur_page].metadata.x--;
		pages[cur_page].metadata.y;
	    	break;
	    case "right"://right
	    	pages[cur_page].metadata.west_goto=old_cur_page;
		pages[cur_page].metadata.x++;
		pages[cur_page].metadata.y;
	    	break;
	}
	check_page_sides();
}

function teleport(){
for(var i=0;i<pages[cur_page].holes.length;i++){
	if(pages[cur_page].holes[i].x==player.x && pages[cur_page].holes[i].y==player.y){
		if(pages[cur_page].holes[i].dest_page==-1){//go nowhere
			return;
		}
		if(pages[cur_page].holes[i].dest_page==-2){//gen new page
			player.x=pages[cur_page].holes[i].next_x;
			player.y=pages[cur_page].holes[i].next_y;
	    		new_page(i);
			return;
		}
		player.x=pages[cur_page].holes[i].next_x;
		player.y=pages[cur_page].holes[i].next_y;
		cur_page=pages[cur_page].holes[i].dest_page;
	    	break;
	}
}
}

function off_edge(direction){//generate new page when walking off map and page edge metadata = -2
check_page_sides();
var edge_action=-3
var next_x=player.x;
var next_y=player.y
switch(direction){
	case "up":
	    edge_action=pages[cur_page].metadata.north_goto;
		next_y=24;
	    	break;
	case "down":
		edge_action=pages[cur_page].metadata.south_goto;
		next_y=0;
	    	break;
	case "left":
		edge_action=pages[cur_page].metadata.west_goto;
		next_x=39;
	    	break;
	case "right":
		edge_action=pages[cur_page].metadata.east_goto;
		next_x=0;
	    	break;
}
if(edge_action==-3 || edge_action==-1){
	return;
}
if(edge_action==-2){
	var tmp2=0;
	switch(direction){
	case "up":
			if(get_ptr_from_page_xy(pages[cur_page].metadata.x,pages[cur_page].metadata.y-1)!=-1){
				tmp2=get_ptr_from_page_xy(pages[cur_page].metadata.x,pages[cur_page].metadata.y-1);
				pages[cur_page].metadata.north_goto=tmp2;
				player.y=24;
				cur_page=tmp2;
				pages[cur_page].metadata.south_goto=tmp2;
				return;
			}
	    	new_page(-1,"up");
			player.y=24;
	    	return;
	case "down":
			if(get_ptr_from_page_xy(pages[cur_page].metadata.x,pages[cur_page].metadata.y+1)!=-1){
				tmp2=get_ptr_from_page_xy(pages[cur_page].metadata.x,pages[cur_page].metadata.y+1);
				pages[cur_page].metadata.north_goto=tmp2;
				player.y=0;
				cur_page=tmp2;
				pages[cur_page].metadata.north_goto=tmp2;
				return;
			}
			new_page(-1,"down");
			player.y=0;
	    	return;
	case "left":
			if(get_ptr_from_page_xy(pages[cur_page].metadata.x-1,pages[cur_page].metadata.y)!=-1){
				tmp2=get_ptr_from_page_xy(pages[cur_page].metadata.x-1,pages[cur_page].metadata.y);
				pages[cur_page].metadata.north_goto=tmp2;
				player.x=39;
				cur_page=tmp2;
				pages[cur_page].metadata.west_goto=tmp2;
				return;
			}
			new_page(-1,"left");
			player.x=39
	    	return;
	case "right":
			if(get_ptr_from_page_xy(pages[cur_page].metadata.x+1,pages[cur_page].metadata.y)!=-1){
				tmp2=get_ptr_from_page_xy(pages[cur_page].metadata.x+1,pages[cur_page].metadata.y);
				pages[cur_page].metadata.north_goto=tmp2;
				player.x=0;
				cur_page=tmp2;
				pages[cur_page].metadata.east_goto=tmp2;
				return;
			}
			new_page(-1,"right");
			player.x=0;
	    	return;
}
}
cur_page=edge_action;
player.x=next_x;
player.y=next_y;
}

function inv_cleanup(){//resolve item slots with count of 0 or less to id 0
    for(var i=0;i<10;i++){
        if(player.inv[i][1]<1){
            player.inv[i][0]=0;
            player.inv[i][1]=0;
        }
    }
}

function entity_cleanup(){
//remove free`ed entities and condense list
var new_entity_list=[];
for(var i=0;i<pages[cur_page].entities.length;i++){
	if(pages[cur_page].entities[i].id!=-1){
	new_entity_list.push(pages[cur_page].entities[i]);
	}
}
pages[cur_page].entities=new_entity_list;
}

function entities(on_entity,i){
if(on_entity.id==2){
    if(on_entity.item[0]==player.inv[player.inv[10]][0] || player.inv[player.inv[10]][0]==0){
        player.inv[player.inv[10]][0]=on_entity.item[0];
        player.inv[player.inv[10]][1]+=on_entity.item[1];
        pages[cur_page].entities[i].id=-1;
        entity_cleanup();
    }
}
}

function compare_array(x,y){
if(x.length!=y.length){
    return false;
}
for(var i=0;i<x.length;i++){
    if(x[i]!=y[i]){
        return false;
    }
}
return true;
}

function enter_button(){
var standing_on=pages[cur_page].map[player.y][player.x];
var on_entity=0;
//check entity
for(var i=0;i<pages[cur_page].entities.length;i++){
	if(pages[cur_page].entities[i].x==player.x && pages[cur_page].entities[i].y==player.y){
        on_entity=pages[cur_page].entities[i];
		entities(on_entity,i);
        break;
	}
}
//check block
if(standing_on==6){//teleport/go to next map
	teleport();
}
if(standing_on==7 || standing_on==8){
	if(tick1<=32768){
		document.getElementById("demonic_announcer").textContent="You can only sleep at day.";
	}else{
		tick1=100;
		document.getElementById("demonic_announcer").textContent="Slept and skipped to night."
	}
}
if(standing_on==13){//grass
	if(player.inv[player.inv[10]][0]==0){
		player.inv[player.inv[10]]=[3,1];
		pages[cur_page].map[player.y][player.x]=0;
        return;
	}
	if(player.inv[player.inv[10]][0]==3){
		player.inv[player.inv[10]][1]++;
		pages[cur_page].map[player.y][player.x]=0;
        return;
	}
}
if(standing_on==16){//brown mushroom
	if(player.inv[player.inv[10]][0]==0){
		player.inv[player.inv[10]]=[4,1];
		pages[cur_page].map[player.y][player.x]=0;
        return;
	}
	if(player.inv[player.inv[10]][0]==4){
		player.inv[player.inv[10]][1]++;
		pages[cur_page].map[player.y][player.x]=0;
        return;
	}
}
if(standing_on==17){//red mushroom
	if(player.inv[player.inv[10]][0]==0){
		player.inv[player.inv[10]]=[5,1];
		pages[cur_page].map[player.y][player.x]=0;
        return;
	}
	if(player.inv[player.inv[10]][0]==5){
		player.inv[player.inv[10]][1]++;
		pages[cur_page].map[player.y][player.x]=0;
        return;
	}
}
if(standing_on==24){//sapling
	if(player.inv[player.inv[10]][0]==0){
		player.inv[player.inv[10]]=[9,1];
		pages[cur_page].map[player.y][player.x]=0;
        return;
	}
	if(player.inv[player.inv[10]][0]==9){
		player.inv[player.inv[10]][1]++;
		pages[cur_page].map[player.y][player.x]=0;
        return;
	}
}
if(standing_on==28){//Carpet
	if(player.inv[player.inv[10]][0]==0){
		player.inv[player.inv[10]]=[13,1];
		pages[cur_page].map[player.y][player.x]=0;
        return;
	}
	if(player.inv[player.inv[10]][0]==13){
		player.inv[player.inv[10]][1]++;
		pages[cur_page].map[player.y][player.x]=0;
        return;
	}
}
if(standing_on==38){//Raygun
	if(player.inv[player.inv[10]][0]==0){
		player.inv[player.inv[10]]=[19,1];
		pages[cur_page].map[player.y][player.x]=0;
        return;
	}
	if(player.inv[player.inv[10]][0]==19){
		player.inv[player.inv[10]][1]++;
		pages[cur_page].map[player.y][player.x]=0;
        return;
	}
}
if(standing_on==40){//Element 115
	if(player.inv[player.inv[10]][0]==0){
		player.inv[player.inv[10]]=[21,1];
		pages[cur_page].map[player.y][player.x]=0;
        return;
	}
	if(player.inv[player.inv[10]][0]==21){
		player.inv[player.inv[10]][1]++;
		pages[cur_page].map[player.y][player.x]=0;
        return;
	}
}
if(standing_on==11){//crafting arrow
    var input=[
    -1,-1,//(35,1),(36,1)
    -1,-1,//(35,2),(36,2)
    -1,-1//(35,3),(36,3)
    ];
    var recipe_id=[0,0,0,0,0,0];
/*    var output=[
    -1,//(38,1)
    -1,//(38,2)
    -1//(38,3)
    ];*/
    //Get input items
    for(var i=0;i<pages[cur_page].entities.length;i++){
        if(pages[cur_page].entities[i].id!=2){//item
            continue;
        }
        if(pages[cur_page].entities[i].x==35 && pages[cur_page].entities[i].y==1){
            input[0]=i;
			recipe_id[0]=pages[cur_page].entities[i].item[0];
        }
        if(pages[cur_page].entities[i].x==36 && pages[cur_page].entities[i].y==1){
            input[1]=i;
			recipe_id[1]=pages[cur_page].entities[i].item[0];
        }
        if(pages[cur_page].entities[i].x==35 && pages[cur_page].entities[i].y==2){
            input[2]=i;
			recipe_id[2]=pages[cur_page].entities[i].item[0];
        }
        if(pages[cur_page].entities[i].x==36 && pages[cur_page].entities[i].y==2){
            input[3]=i;
			recipe_id[3]=pages[cur_page].entities[i].item[0];
        }
        if(pages[cur_page].entities[i].x==35 && pages[cur_page].entities[i].y==3){
            input[4]=i;
			recipe_id[4]=pages[cur_page].entities[i].item[0];
        }
        if(pages[cur_page].entities[i].x==36 && pages[cur_page].entities[i].y==3){
            input[5]=i;
			recipe_id[5]=pages[cur_page].entities[i].item[0];
        }
    }
	document.getElementById("demonic_announcer").textContent=JSON.stringify(recipe_id);
	var selected=-1;
	for(var i=0;i<recipies.length;i++){
		if(compare_array(recipe_id,recipies[i].input_id)){
			selected=i;
			break;
		}
	}
	if(selected==-1){
		return;
	}
	for(var i=0;i<input.length;i++){
		if(input[i]!=-1){
			pages[cur_page].entities[input[i]].item[1]--;
			if(pages[cur_page].entities[input[i]].item[1]<=0){
				pages[cur_page].entities[input[i]].id=-1
			}
		}
	}
	for(var i=0;i<recipies[selected].output.length;i++){
		pages[cur_page].entities.push({id:2, char:item_char[recipies[selected].output[i][0]], x:38, y:1+i, item: recipies[selected].output[i]});
	}
	entity_cleanup();
}
}
function drop_item(x){
if(player.inv[player.inv[10]][0]==0){//Don't want to be creating dropped items with item id of zero...
	return;
}
if(x==0){//drop all
	pages[cur_page].entities.push(
	    {
	    id:2,
	    char:item_char[player.inv[player.inv[10]][0]],
	    x:player.x,
	    y:player.y,
	    item:player.inv[player.inv[10]]
	    });
	    player.inv[player.inv[10]]=[0,0];
}
if(x==1){//drop one
	pages[cur_page].entities.push(
	    {
	    id:2,
	    char:item_char[player.inv[player.inv[10]][0]],
	    x:player.x,
	    y:player.y,
	    item:[player.inv[player.inv[10]][0],1]
	    });
	    player.inv[player.inv[10]]=[player.inv[player.inv[10]][0],player.inv[player.inv[10]][1]-1];
	    if(player.inv[player.inv[10]][1]<1){
		player.inv[player.inv[10]]=[0,0];
	    }
}
if(x=="half"){
	var half_amount=Math.floor(player.inv[player.inv[10]][1]/2);
	if(half_amount<=0){
		return;
	}
	player.inv[player.inv[10]][1]-=half_amount;
	pages[cur_page].entities.push(
	    {
	    id:2,
	    char:item_char[player.inv[player.inv[10]][0]],
	    x:player.x,
	    y:player.y,
	    item:[player.inv[player.inv[10]][0],half_amount]
	    });
	inv_cleanup();
}
}

function entity_player_collide(){
    for(var i=0;i<pages[cur_page].entities.length;i++){
        if(player.x==pages[cur_page].entities[i].x && player.y==pages[cur_page].entities[i].y){
            return i;
        }
    }
    return -1;
}

function entity_collide(ptr){//find if specified entity shares same coords as another one.
    for(var i=0;i<pages[cur_page].entities.length;i++){
        if(i==ptr){continue;}
        if(pages[cur_page].entities[ptr].x==pages[cur_page].entities[i].x && pages[cur_page].entities[ptr].y==pages[cur_page].entities[i].y){
            return i;
        }
    }
    return -1;
}

function entity_collide_xy(x,y){//find if specified entity exists on x y axis
    for(var i=0;i<pages[cur_page].entities.length;i++){
        if(x==pages[cur_page].entities[i].x && y==pages[cur_page].entities[i].y){
            return i;
        }
    }
    return -1;
}

function hit_bounds(x,y){//bounds check for screen edge.
    return (x<0 || x>39 || y<0 || y>24);
}

function char_entity_on(ptr){//what type of character is the selected entity on?
    return pages[cur_page].map[pages[cur_page].entities[ptr].y][pages[cur_page].entities[ptr].x];
}

function char_value(x,y){
    return pages[cur_page].map[y][x];
}

function is_walkable(x){
    for(var i=0;i<properties.walkable.length;i++){
        if(properties.walkable[i]==x){
            return true;
        }
    }
    return false;
}

function can_bang(x){
	for(var i=0;i<properties.bangable.length;i++){
		if(properties.bangable[i]==x){
			return true;
		}
	}
	return false;
}

function do_bang(_x,_y){
	pages[cur_page].entities.push({id:3, x:_x, y:_y, char:19, direction:-1, damage:7, decay:3});//Center Bang
	if(!hit_bounds(_x-1,_y)){
	pages[cur_page].entities.push({id:3, x:_x-1, y:_y, char:19, direction:-1, damage:7, decay:3});//Left
	}
	if(!hit_bounds(_x+1,_y)){
	pages[cur_page].entities.push({id:3, x:_x+1, y:_y, char:19, direction:-1, damage:7, decay:3});//Right
	}
	if(!hit_bounds(_x,_y-1)){
	pages[cur_page].entities.push({id:3, x:_x, y:_y-1, char:19, direction:-1, damage:7, decay:3});//Up
	}
	if(!hit_bounds(_x,_y+1)){
	pages[cur_page].entities.push({id:3, x:_x, y:_y+1, char:19, direction:-1, damage:7, decay:3});//Down
	}
}

function projectile(ptr){//Code for making projectiles move and interact with ThInGs
    switch(pages[cur_page].entities[ptr].direction){
        case -1:
            break;
        case 0://up
            pages[cur_page].entities[ptr].y--;
            break;
        case 1://down
            pages[cur_page].entities[ptr].y++;
            break;
        case 2://left
            pages[cur_page].entities[ptr].x--;
            break;
        case 3://right
            pages[cur_page].entities[ptr].x++;
            break;
    }
    pages[cur_page].entities[ptr].decay--;
    if(pages[cur_page].entities[ptr].decay==0){
		pages[cur_page].entities[ptr].id=-1;
		switch(pages[cur_page].entities[ptr].char){
			case 35://Amber, fire bow
				if(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)==0){
					pages[cur_page].map[pages[cur_page].entities[ptr].y][pages[cur_page].entities[ptr].x]=30
				}
				break;
			default:
				break;
		}
        pages[cur_page].entities[ptr].id=-1;
        entity_cleanup();
        return;
    }
    var collided=entity_collide(ptr);
    if(collided!=-1){
        if(pages[cur_page].entities[collided].health!=undefined){
            pages[cur_page].entities[collided].health-=pages[cur_page].entities[ptr].damage;
            pages[cur_page].entities[ptr].id=-1;
			switch(pages[cur_page].entities[ptr].char){
			case 35://Amber, fire bow
				if(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)==0){
					pages[cur_page].map[pages[cur_page].entities[ptr].y][pages[cur_page].entities[ptr].x]=30;
				}
				break;
			default:
				break;
			}
            if(pages[cur_page].entities[collided].health<=0){
                pages[cur_page].entities[collided].id=-1;
                entity_cleanup();
            }
	    entity_cleanup();
	    return;
        }
    }
    collided=entity_player_collide();
    if(collided==ptr){
        player.health-=pages[cur_page].entities[ptr].damage;
        pages[cur_page].entities[ptr].id=-1;
        entity_cleanup();
	return;
    }
    if(hit_bounds(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)){//hits screen edges
        pages[cur_page].entities[ptr].id=-1;
        entity_cleanup();
        return;
    }
	if(is_walkable(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)) && char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)!=0){//encounters walkable block
        switch(pages[cur_page].entities[ptr].char){
			case 35://Amber, fire bow
				if(!is_burnable(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y))){
					return;
				}
				pages[cur_page].entities[ptr].id=-1;
				pages[cur_page].map[pages[cur_page].entities[ptr].y][pages[cur_page].entities[ptr].x]=30
				break;
			default:
				break;
		}
        entity_cleanup();
        return;
    }
    if(!is_walkable(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y))){//encounters non walkable block
        pages[cur_page].entities[ptr].id=-1;
		switch(pages[cur_page].entities[ptr].char){
			case 20://raygun ring
				do_bang(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y);
				if(can_bang(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y))){
					pages[cur_page].map[pages[cur_page].entities[ptr].y][pages[cur_page].entities[ptr].x]=0;
				}
				break;
			default:
				break;
		}
        entity_cleanup();
        return;
    }
}

var removable=[18];

function remove_char(x,y){
    switch(char_value(x,y)){
        case 18:
            if(player.inv[player.inv[10]][0]==0){
                player.inv[player.inv[10]][0]=6;
                pages[cur_page].map[y][x]=0;
            }
            if(player.inv[player.inv[10]][0]==6){
                player.inv[player.inv[10]][1]++;
                pages[cur_page].map[y][x]=0;
            }
            break
    }
}

function attack(x){
var is_entity=-1;//does an entity exist at that place?
switch(x){
    case "up":
        is_entity=entity_collide_xy(player.x,player.y-1);
        break;
    case "down":
	is_entity=entity_collide_xy(player.x,player.y+1);
        break;
    case "left":
	is_entity=entity_collide_xy(player.x-1,player.y);
        break;
    case "right":
	is_entity=entity_collide_xy(player.x+1,player.y);
        break;
}
switch(player.inv[player.inv[10]][0]){
	case 17://fire bow
	switch(x){
	    case "up":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y-1, char:35, direction:0, damage:player.strength*4, decay:8});
 	       break;
 	   case "down":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y+1, char:35, direction:1, damage:player.strength*4, decay:8});
 	       break;
 	   case "left":
  	       pages[cur_page].entities.push({id:3, x:player.x-1, y:player.y, char:35, direction:2, damage:player.strength*4, decay:8});
  	       break;
  	   case "right":
   	       pages[cur_page].entities.push({id:3, x:player.x+1, y:player.y, char:35, direction:3, damage:player.strength*4, decay:8});
   	       break;
	}
	player.inv[player.inv[10]][1]--;
	if(player.inv[player.inv[10]][1]<=0){
		player.inv[player.inv[10]]=[14,1];
	}
	inv_cleanup();
        break;
	case 18://spear
	switch(x){
	    case "up":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y-1, char:37, direction:-1, damage:player.strength*5, decay:3});
 	       break;
 	   case "down":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y+1, char:37, direction:-1, damage:player.strength*5, decay:3});
 	       break;
 	   case "left":
  	       pages[cur_page].entities.push({id:3, x:player.x-1, y:player.y, char:37, direction:-1, damage:player.strength*5, decay:3});
  	       break;
  	   case "right":
   	       pages[cur_page].entities.push({id:3, x:player.x+1, y:player.y, char:37, direction:-1, damage:player.strength*5, decay:3});
   	       break;
	}
	inv_cleanup();
        break;
	case 19://Raygun
	switch(x){
	    case "up":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y-1, char:20, direction:0, damage:player.strength*1000, decay:-1});
 	       break;
 	   case "down":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y+1, char:20, direction:1, damage:player.strength*1000, decay:-1});
 	       break;
 	   case "left":
  	       pages[cur_page].entities.push({id:3, x:player.x-1, y:player.y, char:20, direction:2, damage:player.strength*1000, decay:-1});
  	       break;
  	   case "right":
   	       pages[cur_page].entities.push({id:3, x:player.x+1, y:player.y, char:20, direction:3, damage:player.strength*1000, decay:-1});
   	       break;
	}
	inv_cleanup();
	break;
	case 20://Poisonous Spear
	switch(x){
	    case "up":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y-1, char:39, direction:-1, damage:player.strength*10, decay:3});
 	       break;
 	   case "down":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y+1, char:39, direction:-1, damage:player.strength*10, decay:3});
 	       break;
 	   case "left":
  	       pages[cur_page].entities.push({id:3, x:player.x-1, y:player.y, char:39, direction:-1, damage:player.strength*10, decay:3});
  	       break;
  	   case "right":
   	       pages[cur_page].entities.push({id:3, x:player.x+1, y:player.y, char:39, direction:-1, damage:player.strength*10, decay:3});
   	       break;
	}
default:
switch(x){
    case "up":
        pages[cur_page].entities.push({id:3, x:player.x, y:player.y-1, char:19, direction:-1, damage:player.strength, decay:3});
        break;
    case "down":
        pages[cur_page].entities.push({id:3, x:player.x, y:player.y+1, char:19, direction:-1, damage:player.strength, decay:3});
        break;
    case "left":
        pages[cur_page].entities.push({id:3, x:player.x-1, y:player.y, char:19, direction:-1, damage:player.strength, decay:3});
        break;
    case "right":
        pages[cur_page].entities.push({id:3, x:player.x+1, y:player.y, char:19, direction:-1, damage:player.strength, decay:3});
        break;
}
}
//}
if(is_entity==-1){//no entity
switch(x){
    case "up":
        remove_char(player.x,player.y-1);
        break;
    case "down":
        remove_char(player.x,player.y+1);
        break;
    case "left":
        remove_char(player.x-1,player.y);
        break;
    case "right":
        remove_char(player.x+1,player.y);
        break;
}
}
}

function use_item(){
if(char_value(player.x,player.y)==0){
switch(player.inv[player.inv[10]][0]){
    case 3://grass
        pages[cur_page].map[player.y][player.x]=13;
        player.inv[player.inv[10]][1]--;
        break;
    case 4://Brown Mushroom
        pages[cur_page].map[player.y][player.x]=16;
        player.inv[player.inv[10]][1]--;
        break;
    case 5://Red Mushroom
        pages[cur_page].map[player.y][player.x]=17;
        player.inv[player.inv[10]][1]--;
        break;
    case 6://Fence
        pages[cur_page].map[player.y][player.x]=18;
        player.inv[player.inv[10]][1]--;
        break;
    case 9://Sapling
        pages[cur_page].map[player.y][player.x]=24;
        player.inv[player.inv[10]][1]--;
        break;
    case 13://grass
        pages[cur_page].map[player.y][player.x]=28;
        player.inv[player.inv[10]][1]--;
        break;
	case 16://Amber (fire)
        pages[cur_page].map[player.y][player.x]=30;
        player.inv[player.inv[10]][1]--;
        break;
	case 21://Amber (fire)
        pages[cur_page].map[player.y][player.x]=40;
        player.inv[player.inv[10]][1]--;
        break;
}
inv_cleanup();
}
switch(player.inv[player.inv[10]][0]){//item id
	case 12: //Mushroom Stew
        if(player.health==20){
            break;
        }
	    player.health+=5;
        if(player.health>20 && player.creative==0){
            player.health=20;
        }
	    player.inv[player.inv[10]][1]--;
}
inv_cleanup();
}

function cheats(){
    var cheat_code=prompt("Cheat?");
    switch(cheat_code){
        case "Max Ammo!":
            player.health=20;
            break;
        case "gamemode c":
            player.creative=1;
            player.health=Infinity;
            break;
        case "Give me what I want!":
            player.inv[player.inv[10]]=JSON.parse(prompt("Item?"));
            break;
        default:
            alert("No cheat for you!");
            break;
    }
}

//keys
function key_manager(key){
//Movement
switch(key){
    case 87://up,w
	if(hit_bounds(player.x,player.y-1)){
		off_edge("up");
	}
	if(!(hit_bounds(player.x,player.y) || hit_bounds(player.x,player.y-1) || !is_walkable(char_value(player.x,player.y-1)))){
        	player.y-=1;
        }
        return;
    case 83://down, s
	if(hit_bounds(player.x,player.y+1)){
		off_edge("down");
	}
        if(!(hit_bounds(player.x,player.y) || hit_bounds(player.x,player.y+1) || !is_walkable(char_value(player.x,player.y+1)))){
        	player.y+=1;
        }
        return;
    case 65://left, a
	if(hit_bounds(player.x-1,player.y)){
		off_edge("left");
	}
        if(!(hit_bounds(player.x,player.y) || hit_bounds(player.x-1,player.y) || !is_walkable(char_value(player.x-1,player.y)))){
        	player.x-=1;
        }
        return;
    case 68://right, d
	if(hit_bounds(player.x+1,player.y)){
		off_edge("right");
	}
        if(!(hit_bounds(player.x,player.y) || hit_bounds(player.x+1,player.y) || !is_walkable(char_value(player.x+1,player.y)))){
        	player.x+=1;
        }
        return;
}
//attack
switch(key){
    case 38:
        attack("up");
        break;
   case 40:
        attack("down");
        break;
   case 37:
        attack("left");
        break;
   case 39:
        attack("right");
        break;
}

//inventory slot select
switch(key){
    case 49://1
        player.inv[10]=0;
        break;
    case 50://2
        player.inv[10]=1;
        break;
    case 51://3
        player.inv[10]=2;
        break;
    case 52://4
        player.inv[10]=3;
        break;
    case 53://5
        player.inv[10]=4;
        break;
    case 54://6
        player.inv[10]=5;
        break;
    case 55://7
        player.inv[10]=6;
        break;
    case 56://8
        player.inv[10]=7;
        break;
    case 57://9
        player.inv[10]=8;
        break;
    case 48://0
        player.inv[10]=9;
        break;
}

//drop item
switch(key){
    case 71://Drop one item
        drop_item(1);
        break;
    case 70://Drop all of the items.
        drop_item(0);
        break;
	case 86://v, Drop have of items
		drop_item("half");
		break;
}

//break/pickup, place/use, other
switch(key){
    case 13://enter
        enter_button();
        break;
    case 32://space
        use_item();
        break;
    case 192://"~" key
        document.getElementById("demonic_announcer").textContent="Stop there criminal!";
        cheats();
        break;
}
}

function death(){
    if(player.creative==1){
        console.log("You live to see another day.");
        return;
    }
    alert("BOOM! You are DEAD!");
    clearInterval(interval);
    key_manager=function(){};
}

function pathfind_step(x1,y1,x2,y2){//This is gonna hurt...
    var delta_x=Math.abs(x1-x2);
    var delta_y=Math.abs(y1-y2);
    if(x1>x2 && is_walkable(char_value(x1-1,y1)) && !hit_bounds(x1-1,y1)){
        return [x1-1,y1];
    }
    if(x1<x2 && is_walkable(char_value(x1+1,y1)) && !hit_bounds(x1+1,y1)){
        return [x1+1,y1];
    }
    if(y1>y2 && is_walkable(char_value(x1,y1-1)) && !hit_bounds(x1,y1-1)){
        return [x1,y1-1];
    }
    if(y1<y2 && is_walkable(char_value(x1,y1+1)) && !hit_bounds(x1,y1+1)){
        return [x1,y1+1];
    }
    
    return [x1,y1];
}

function entity_attack(ptr){
    if(pages[cur_page].entities[ptr].attack_cooldown>0){
        pages[cur_page].entities[ptr].attack_cooldown--;
        return;
    }
    if(pages[cur_page].entities[ptr].x==player.x){
        if(pages[cur_page].entities[ptr].y<player.y){//Attack Down
            pages[cur_page].entities.push({id:3, x:pages[cur_page].entities[ptr].x, y:pages[cur_page].entities[ptr].y+1, char:19, direction:-1, damage:pages[cur_page].entities[ptr].strength, decay:2});
            pages[cur_page].entities[ptr].attack_cooldown=5;
        }
        if(pages[cur_page].entities[ptr].y>player.y){//Attack Up
            pages[cur_page].entities.push({id:3, x:pages[cur_page].entities[ptr].x, y:pages[cur_page].entities[ptr].y-1, char:19, direction:-1, damage:pages[cur_page].entities[ptr].strength, decay:2});
            pages[cur_page].entities[ptr].attack_cooldown=5;
        }
    }
    if(pages[cur_page].entities[ptr].y==player.y){
        if(pages[cur_page].entities[ptr].x<player.x){//Attack Right
            pages[cur_page].entities.push({id:3, x:pages[cur_page].entities[ptr].x+1, y:pages[cur_page].entities[ptr].y, char:19, direction:-1, damage:pages[cur_page].entities[ptr].strength, decay:2});
            pages[cur_page].entities[ptr].attack_cooldown=5;
        }
        if(pages[cur_page].entities[ptr].x>player.x){//Attack Left
            pages[cur_page].entities.push({id:3, x:pages[cur_page].entities[ptr].x-1, y:pages[cur_page].entities[ptr].y, char:19, direction:-1, damage:pages[cur_page].entities[ptr].strength, decay:2});
            pages[cur_page].entities[ptr].attack_cooldown=5;
        }
    }
}

function npc(ptr){//make entity move
    if(pages[cur_page].entities[ptr].brain.no_ai==1){
        return;
    }
    var next_xy;
    switch(pages[cur_page].entities[ptr].brain.hostile){
        case 0://not hostile
            next_xy=pathfind_step(pages[cur_page].entities[ptr].x,
            pages[cur_page].entities[ptr].y,
            pages[cur_page].entities[ptr].dest_x,
            pages[cur_page].entities[ptr].dest_y);
            break;
        case 1://hostile
            next_xy=pathfind_step(pages[cur_page].entities[ptr].x,
            pages[cur_page].entities[ptr].y,
            player.x,
            player.y);
            if(next_xy[0]==player.x && next_xy[1]==player.y){
                entity_attack(ptr);
                return;
            }
            break;
    }
    pages[cur_page].entities[ptr].x=next_xy[0];
    pages[cur_page].entities[ptr].y=next_xy[1];
}

function check_health(ptr){
    if(pages[cur_page].entities[ptr].health<=0){
        pages[cur_page].entities[ptr].id=-1;
        entity_cleanup();
    }
}

function tick(){
    if(player.health<=0){//Player Death
        death();
    }
    for(var i=0;i<pages[cur_page].entities.length;i++){
        switch(pages[cur_page].entities[i].id){
            case 3:
                projectile(i);
                break;
            case 1:
                npc(i);
                check_health(i);
                break;
        }
    }
}

function can_spawn(x){
    for(var i=0;i<properties.not_spawnable.length;i++){
        if(x==properties.not_spawnable[i]){
        return false;
        }
    }
    return true;
}

function is_burnable(x){
	for(var i=0;i<properties.burnable.length;i++){
        if(properties.burnable[i]==x){
            return true;
        }
    }
    return false;
}

//do_fire(player.x,player.y);
function do_fire(x,y){
	//check for flamable objects around.
	var spread=0;
	if(!hit_bounds(x,y-1)){//up
		if(is_burnable(char_value(x,y-1))){
			pages[cur_page].map[y-1][x]=30;
			spread=1;
		}
	}
	if(!hit_bounds(x,y+1)){//down
		if(is_burnable(char_value(x,y+1))){
			pages[cur_page].map[y+1][x]=30;
			spread=1;
		}
	}
	if(!hit_bounds(x-1,y)){//left
		if(is_burnable(char_value(x-1,y))){
			pages[cur_page].map[y][x-1]=30;
			spread=1;
		}
	}
	if(!hit_bounds(x+1,y)){//right
		if(is_burnable(char_value(x+1,y))){
			pages[cur_page].map[y][x+1]=30;
			spread=1;
		}
	}
	if(spread==0){
		pages[cur_page].map[y][x]++;
		if(char_value(x,y)>=33){
			pages[cur_page].map[y][x]=0;
		}
	}
}

//random_tick(player.x,player.y);
function random_tick(random_x=Math.floor((Math.random()*100))%40,random_y=Math.floor((Math.random()*100))%25,action=Math.floor((Math.random()*100))){
if(pages[cur_page].map[random_y][random_x]==13){//grass
    if(action%2==0){//create hay
        pages[cur_page].entities.push({id:2, char:12, x:random_x, y:random_y, item: [2,1]});
    }
    if(action%2==1){//spread
        var direction=Math.floor(Math.random()*100)%4;
        x=random_x;
        y=random_y;
        switch(direction){
            case 0://up
                y--;
                break;
            case 1://down
                y++;
                break;
            case 2://left
                x--;
                break;
            case 3://right
                x++;
                break;
        }
        if(hit_bounds(x,y)){
            return;        
        }
        if(pages[cur_page].map[y][x]==0){
            pages[cur_page].map[y][x]=13;
        }
    }
}
//console.log(action%2);
if(pages[cur_page].map[random_y][random_x]==15){//tree trunk
    //console.log(action%2);
    if(action%2==0){
        pages[cur_page].entities.push({id:2, char:9, x:random_x, y:random_y, item: [1,1]});//branch
    }
    if(action%2==1){
        pages[cur_page].entities.push({id:2, char:24, x:random_x, y:random_y, item: [9,1]});//sapling
    }
}
if(pages[cur_page].map[random_y][random_x]==16){//brown mushroom growth
    var direction=Math.floor(Math.random()*100)%4;
        x=random_x;
        y=random_y;
        switch(direction){
            case 0://up
                y--;
                break;
            case 1://down
                y++;
                break;
            case 2://left
                x--;
                break;
            case 3://right
                x++;
                break;
        }
        if(hit_bounds(x,y)){
            return;        
        }
        if(pages[cur_page].map[y][x]==0){
            pages[cur_page].map[y][x]=16;
        }
}
if(pages[cur_page].map[random_y][random_x]==17){//red mushroom growth
    var direction=Math.floor(Math.random()*100)%4;
        x=random_x;
        y=random_y;
        switch(direction){
            case 0://up
                y--;
                break;
            case 1://down
                y++;
                break;
            case 2://left
                x--;
                break;
            case 3://right
                x++;
                break;
        }
        if(hit_bounds(x,y)){
            return;        
        }
        if(pages[cur_page].map[y][x]==0){
            pages[cur_page].map[y][x]=17;
        }
}
//non hostile entity random destination
if(random_y==3){
for(var i=0;i<pages[cur_page].entities.length;i++){
    if(pages[cur_page].entities[i].id==1){
        if(pages[cur_page].entities[i].brain.hostile==0){
            pages[cur_page].entities[i].dest_x=Math.floor(Math.random()*100)%40;
            pages[cur_page].entities[i].dest_y=Math.floor(Math.random()*100)%25;
        }
    }
}
}
if(char_value(random_x,random_y)==24){//sapling
    if(!hit_bounds(random_x,random_y-1)){
        if(char_value(random_x,random_y-1)==0){
            pages[cur_page].map[random_y][random_x]=15;//trunk
            pages[cur_page].map[random_y-1][random_x]=14;//leaves
        }
    }
}
//night: 0-32767
//day: 32768-65535
if(tick1>=32767){
	//enemy spawning stuff
	if(pages[cur_page].metadata.safety==0){
		if(action<10){
            var cv=char_value(random_x,random_y);
            if(!is_walkable(cv)){
                return;
            }
            if(can_spawn(cv)){
			 pages[cur_page].entities.push({id:1, char:4, x:random_x,y:random_y, brain: {no_ai:0, hostile: 1}, health:20, strength:1, attack_cooldown:0, dest_x:1, dest_y:1});
            }
		}
	}
}
switch(char_value(random_x,random_y)){
	case 30://fire 0
		do_fire(random_x,random_y);
		break;
	case 31://fire 1
		do_fire(random_x,random_y);
		break;
	case 32://fire 2
		do_fire(random_x,random_y);
		break;
}
}

function fireing(){
var limit=5;
for(var x=0;x<40;x++){
	for(var y=0;y<25;y++){
		if(char_value(x,y)==30 || char_value(x,y)==31 || char_value(x,y)==32){
			if(limit==0){
				return;
			}
			do_fire(x,y);
			limit--;
		}
	}
}
}

var tick1=0;//0 to 65535
function refresh(){//Dang it, no multiple setintervals...
draw_map(pages[cur_page]);
//status bar
var player_text="Name: "+player.name+" Health: "+player.health+" X: "+player.x+" Y: "+player.y+ " Text Page: "+cur_page+" Time: "+tick1+" "+pages[cur_page].metadata.x+","+pages[cur_page].metadata.y;
document.getElementById("player").textContent=player_text;
var status_bar="Inventory: ";
for(var i=0;i<10;i++){
    if(player.inv[10]!=i){
    status_bar+=i+": "+item_names[player.inv[i][0]]+" x "+player.inv[i][1]+" ";
    }else{
    status_bar+=i+": ("+item_names[player.inv[i][0]]+" x "+player.inv[i][1]+") ";
    }
}
document.getElementById("status").textContent=status_bar;
tick1++;
if(tick1>=65536){tick1=0;}
//night: 0-32767
//day: 32768-65535
if(tick1==32768){//Day starts
    console.log("Fetch me their souls!");
}
if(tick1==0){//Night starts
    console.log("Ba, da, DAAA");
}
if(tick1%2==0){//projectiles and path finding
tick();
}
if(tick1%10==0){//random tick
random_tick();
}
if(tick1%7==0){//fire
fireing();
}
}
const interval = setInterval(function (){refresh();},67);
window.onload=function(){
	document.getElementsByTagName('body')[0].onkeydown=function (e){
		key_manager(e.keyCode);
	}
};
function _import(){
    var save_file=JSON.parse(prompt("Save?"));
    if(save_file==null){
	return;
    }
    cur_page=save_file[0];
    player=save_file[1];
    pages=save_file[2];
	tick1=save_file[3];
}
function _export(){
    /*var save_file=JSON.stringify([cur_page,player,pages]);
    navigator.clipboard.writeText(save_file);
    alert("Save file copied to clipboard.");*/
	document.write(JSON.stringify([cur_page,player,pages,tick1]));
}
</script>
</html>
