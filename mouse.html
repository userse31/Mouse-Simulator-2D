<!-- Utilizes GNU GENERAL PUBLIC LICENSE 3. See "LICENSE" file for details -->
<html>
<head>
<!-- sound effects -->
<audio id="sfx" oncanplay="sfx_play()"></audio>
<title>Mouse Simulator 2D</title>
</head>
<body>
    <center>
    <canvas id="cga" width="320" height="200" style="border:2px solid #777777;width:320;height:200;image-rendering:pixelated;image-rendering:crisp-edges;"></canvas>
    <p id="player"></p>
    <p id="status"></p>
    <p id="demonic_announcer">Welcome!</p>
    <button onclick="_load()">Load</button><button onclick="_save()">Save</button><button onclick="_delete()">Delete</button><button onclick="_import()">Import</button><button onclick="_export()">Export</button><button onclick="config()">Config</button>
    </br>
	<a href="./help.html">Help</a>
	</br>
    <button onclick="alert(JSON.stringify(eval(prompt('Code?'))))">eval()</button>
    </center>
</body>
<script id="lzutf8" src="./lzutf8.min.js"></script>
<script src="./resources.js"></script>
<script>
//Mouse Simulator 2D v0.47
/*
Bug Fixes.
Days!
Seasons!
Fans act differently now.
*/
//autoconfig
var saves=window.localStorage;
var cga=document.getElementById("cga");
var dem_ann=document.getElementById("demonic_announcer");
function autoconfig(){
	saves.getItem("_bigger")=="t" ? set_scaling(2) : set_scaling(1);
}
autoconfig();
function config(){
	var bigger;
	if(confirm("Increase canvas size? (Hard of sight)")){
		set_scaling(2);
		bigger="t";
	}else{
		set_scaling(1);
		bigger="f";
	}
	saves.setItem("_bigger",bigger);
}
function set_scaling(scale){
	cga.style.width=320*scale+"px";
	cga.style.height=200*scale+"px";
}
var _sfx=document.getElementById("sfx");
function sfx_play(){
	_sfx.play();
}
function sfx(sound){
if(_sfx.paused==false){
	return;
}
	switch(sound){
		case "raygun_bang":
			_sfx.src="./sounds/raygun_bang.wav";
			break;
		case "raygun_cooldown":
			_sfx.src="./sounds/raygun_cooldown.wav";
			break;
		case "player_damaged":
			switch(Math.floor(Math.random()*65535)%2){
				case 0:
					_sfx.src="./sounds/squeak0.wav";
					break;
				case 1:
					_sfx.src="./sounds/squeak1.wav";
					break;
			}
			break;
	}
}

var ctx=cga.getContext("2d");
var char=ctx.getImageData(0,0,8,8);
function write_1bit(pos,val,id){
	char.data[4*pos+3]=255;
	switch(val){
		case 0:
			char.data[4*pos]=font[id][67];
			char.data[4*pos+1]=font[id][68];
			char.data[4*pos+2]=font[id][69];
			break;
		case 1:
			char.data[4*pos]=font[id][64];
			char.data[4*pos+1]=font[id][65];
			char.data[4*pos+2]=font[id][66];
			break;
	}
}
function get_font(val){
	for(var i=0;i<64;i++){
		write_1bit(i,font[val][i],val);
	}
	return val;
}
function draw_map(){
	//block map
	for(var x=0;x<40;x++){
		for(var y=0;y<25;y++){
			get_font(pages[cur_page].map[y][x]);
			ctx.putImageData(char,x*8,y*8);
		}
	}
	//entity map
	//entity drawing priorities.
	var e_item=[];
	var e_npc=[];
	var e_proj=[];
	for(var i=0;i<pages[cur_page].entities.length;i++){
		switch(pages[cur_page].entities[i].id){
			case 1://npc
				e_npc.push(i);
				break;
			case 2://dropped item
				e_item.push(i);
				break;
			case 3://projectile
				e_proj.push(i);
				break;
		}
	}
	var e_ordered=e_item.concat(e_npc,e_proj);
	for(var i=0;i<e_ordered.length;i++){
		get_font(pages[cur_page].entities[e_ordered[i]].char);
		ctx.putImageData(char,pages[cur_page].entities[e_ordered[i]].x*8,pages[cur_page].entities[e_ordered[i]].y*8);
	}
	//player
	get_font(3);
	ctx.putImageData(char,player.x*8,player.y*8);
}

function rtc(days=player.days){
	return {year:Math.floor(days/256),month:Math.floor(days/16)%16,monthlets:days%16};
}

function seasons(){
	switch(rtc().month){
		case 0:
		case 1:
		case 2:
		case 3://summer
			//grass
			font[13][64]=0;
			font[13][65]=255;
			font[13][66]=0;
			//tree leaves
			font[14][64]=0;
			font[14][65]=255;
			font[14][66]=0;
			//walnut leaves
			for(var i=0;i<6;i++){
				font[46+i][64]=0;
				font[46+i][65]=215;
				font[46+i][66]=0;
			}
			break;
		case 4:
		case 5:
		case 6:
		case 7://fall
			//grass
			font[13][64]=224;
			font[13][65]=204;
			font[13][66]=119;
			//tree leaves
			font[14][64]=224;
			font[14][65]=204;
			font[14][66]=119;
			//walnut leaves
			for(var i=0;i<6;i++){
				font[46+i][64]=0x224;
				font[46+i][65]=0x204;
				font[46+i][66]=119;
			}
			break;
		case 8:
		case 9:
		case 10:
		case 11://winter
			//grass
			font[13][64]=160;
			font[13][65]=140;
			font[13][66]=55;
			//tree leaves
			font[14][64]=255;
			font[14][65]=255;
			font[14][66]=255;
			//walnut leaves
			for(var i=0;i<6;i++){
				font[46+i][64]=255;
				font[46+i][65]=255;
				font[46+i][66]=255;
			}
			break;
		case 12:
		case 13:
		case 14:
		case 15://spring
			//grass
			font[13][64]=160;
			font[13][65]=255;
			font[13][66]=160;
			//tree leaves
			font[14][64]=160;
			font[14][65]=255;
			font[14][66]=160;
			//walnut leaves
			for(var i=0;i<6;i++){
				font[46+i][64]=0;
				font[46+i][65]=255;
				font[46+i][66]=0;
			}
			break
	}
}

function map_search(tile){
	var coords=[];
	var cur_index=-1;
	for(var i=0;i<25;i++){//y
		do{
			cur_index=pages[cur_page].map[i].indexOf(tile,cur_index+1);
			cur_index!=-1 ? coords.push({x:cur_index,y:i}) : 0;
		} while(cur_index!=-1)
	}
	return coords;
}

function item_id_from_name(str){
	str=str.toLowerCase();
	for(var i=0;i<item_names.length;i++){
		if(str==item_names[i].toLowerCase()){
			return i;
		}
	}
	return -1;
}

function damage_player(amount){
	player.creative==1 ? 0 : player.health-=amount;
	sfx("player_damaged");
}

function item_roulette(drop_list,_x,_y){
for(var i=0;i<drop_list.length;i++){
	if(Math.random()<=drop_list[i].chance){
		pages[cur_page].entities.push({id:2,x:_x,y:_y,char:item_char[drop_list[i].item_id],item:[drop_list[i].item_id,(Math.floor(Math.random()*65535)%drop_list[i].item_max)+drop_list[i].item_min]});
		combine_items(_x,_y,drop_list[i].item_id);
	}
}
}

function drop_set_selection(set,x,y){
switch(set){
	case "enemy":
		item_roulette(item_drops.enemy,x,y);
		break;
}
}

function npc_drops(ptr){//items to drop after npc death.
//id=1
switch(pages[cur_page].entities[ptr].char){
	case 4://enemy
		drop_set_selection("enemy",pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y);
		break;
	default:
		break;
}
}

function combine_items(_x,_y,item_id){//Reduce memory usage and improve the user experience by combining dropped items of the same type together.
	var ptrs=[];
	for(var i=0;i<pages[cur_page].entities.length;i++){
		if(pages[cur_page].entities[i].id==2){
			if(pages[cur_page].entities[i].x==_x && pages[cur_page].entities[i].y==_y && pages[cur_page].entities[i].item[0]==item_id){
				ptrs.push(i);
			}
		}
	}
	var total_amount=0;
	for(var i=0;i<ptrs.length;i++){
		total_amount+=pages[cur_page].entities[ptrs[i]].item[1];
		pages[cur_page].entities[ptrs[i]].id=-1;
	}
	pages[cur_page].entities.push({id:2, x:_x, y:_y, char:item_char[item_id], item: [item_id,total_amount]});
}

function new_npc(_x,_y,_home_x,_home_y){
	var new_boi={id:1,char:3,x:_x,y:_y,brain:{no_ai:0,hostile:0,identity:{gender:0,dysphoria:0,love_mode:0},home_x:_home_x,home_y:_home_y},health:20,strength:1,attack_cooldown:0,dest_x:_x, dest_y:_y};
new_boi.brain.identity.gender=Math.floor(Math.random()*100)%2;
new_boi.brain.identity.dysphoria=(Math.floor(Math.random()*100)%100)<10;
pages[cur_page].entities.push(new_boi);
return pages[cur_page].entities.length-1;
}

function struct_copy(struct_id,offset_x,offset_y,fill_nonzero=1){
	for(var y=0;y<structures[struct_id].length;y++){
		for(var x=0;x<structures[struct_id][y].length;x++){
			if(hit_bounds(offset_x+x,offset_y+y)){
				continue;
			}
			if(char_value(offset_x+x,offset_y+y)!=0 && fill_nonzero==0){
				continue;
			}
			pages[cur_page].map[offset_y+y][offset_x+x]=structures[struct_id][y][x]==-1 ? pages[cur_page].map[offset_y+y][offset_x+x] : structures[struct_id][y][x];
		}
	}
}

function generate_stuff(){
	var rand_x=0;
	var rand_y=0;
	var rand_action=0;
	//structures
	for(var i=0;i<struct.length;i++){
		for(var j=0;j<struct[i].tries;j++){
		if(struct.weight==-1){
			continue;
		}
		rand_x=Math.floor(Math.random()*100)%(40-struct[i].sub[0]);
		rand_y=Math.floor(Math.random()*100)%(25-struct[i].sub[1]);
		if(char_value(rand_x,rand_y)==0){
			if(Math.random()<struct[i].weight){
				struct_copy(struct[i].id,rand_x,rand_y);
				if(struct[i].entity!=undefined){//entities
					new_npc(rand_x+struct[i].entity.offset_x,rand_y+struct[i].entity.offset_y,rand_x+struct[i].entity.offset_x,rand_y+struct[i].entity.offset_y);
				}
			}
		}
		}
	}
}

//if two pages next to each other, link them.
function check_page_sides(){
	if(pages[cur_page].metadata.underground==true){
		return;
	}
	var x=pages[cur_page].metadata.x;
	var y=pages[cur_page].metadata.y;
	for(var i=2;i<pages.length;i++){
		//Above
		if(pages[i].metadata.x==pages[cur_page].metadata.x && pages[i].metadata.y==pages[cur_page].metadata.y-1){
			pages[cur_page].metadata.north_goto=i;
		}
		//Below
		if(pages[i].metadata.x==pages[cur_page].metadata.x && pages[i].metadata.y==pages[cur_page].metadata.y+1){
			pages[cur_page].metadata.south_goto=i;
		}
		//left
		if(pages[i].metadata.x==pages[cur_page].metadata.x-1 && pages[i].metadata.y==pages[cur_page].metadata.y){
			pages[cur_page].metadata.west_goto=i;
		}
		//right
		if(pages[i].metadata.x==pages[cur_page].metadata.x+1 && pages[i].metadata.y==pages[cur_page].metadata.y){
			pages[cur_page].metadata.east_goto=i;
		}
	}
}

function get_ptr_from_page_xy(x,y){
	for(var i=0;i<pages.length;i++){
		if(pages[i].metadata.x==x && pages[i].metadata.y==y){
			if(pages[i].metadata.underground==true){
				continue;
			}
			return i;
		}
	}
	return -1;
}

function new_page(hole_from=-1,direction="none"){
	var old_cur_page=cur_page;
	var n_page={map:new Array(25),entities:[],holes:[],metadata:{safety:0, north_goto:-2, south_goto:-2, west_goto:-2, east_goto:-2, x:pages[cur_page].metadata.x,y:pages[cur_page].metadata.y,underground:false}};
	for(var i=0;i<25;i++){
		n_page.map[i]=new Array(40);
	}
	for(var j=0;j<25;j++){
		for(var i=0;i<40;i++){
			n_page.map[j][i]=0;
		}
	}
	pages.push(n_page);
	if(hole_from==-1){
		switch(direction){//direction _entering_ new page
		case "none":
		struct_copy(4,18,11);
		pages[cur_page].holes.push({x:19, y:12, dest_page:old_cur_page, next_x: 1, next_y: 0});
		pages[cur_page].metadata.x=0;
		pages[cur_page].metadata.y=0;
			break;
		case "up"://up
			pages[cur_page].metadata.north_goto=pages.length-1;
			break;
		case "down"://down
			pages[cur_page].metadata.south_goto=pages.length-1;
			break;
		case "left"://left
			pages[cur_page].metadata.west_goto=pages.length-1;
			break;
		case "right"://right
			pages[cur_page].metadata.east_goto=pages.length-1;
			break;
		}
	}else{
		pages[cur_page].holes[hole_from].dest_page=pages.length-1;
	}
	cur_page=pages.length-1;
	generate_stuff();
	switch(direction){//direction _entering_ new page
	    case "none":
		struct_copy(4,18,11);
		n_page.holes.push({x:19, y:12, dest_page:old_cur_page, next_x: 1, next_y: 0});
	    	break;
	    case "up"://up
	    	pages[cur_page].metadata.south_goto=old_cur_page;
		pages[cur_page].metadata.x;
		pages[cur_page].metadata.y--;
	    	break;
	    case "down"://down
	    	pages[cur_page].metadata.north_goto=old_cur_page;
		pages[cur_page].metadata.x;
		pages[cur_page].metadata.y++;
	    	break;
	    case "left"://left
	    	pages[cur_page].metadata.east_goto=old_cur_page;
		pages[cur_page].metadata.x--;
		pages[cur_page].metadata.y;
	    	break;
	    case "right"://right
	    	pages[cur_page].metadata.west_goto=old_cur_page;
		pages[cur_page].metadata.x++;
		pages[cur_page].metadata.y;
	    	break;
	}
	check_page_sides();
}

function teleport(){
for(var i=0;i<pages[cur_page].holes.length;i++){
	if(pages[cur_page].holes[i].x==player.x && pages[cur_page].holes[i].y==player.y){
		if(pages[cur_page].holes[i].dest_page==-1){//go nowhere
			return;
		}
		if(pages[cur_page].holes[i].dest_page==-2){//gen new page
			player.x=pages[cur_page].holes[i].next_x;
			player.y=pages[cur_page].holes[i].next_y;
	    		new_page(i);
			return;
		}
		player.x=pages[cur_page].holes[i].next_x;
		player.y=pages[cur_page].holes[i].next_y;
		cur_page=pages[cur_page].holes[i].dest_page;
	    	break;
	}
}
}

function off_edge(direction){//generate new page when walking off map and page edge metadata = -2
check_page_sides();
var edge_action=-3
var next_x=player.x;
var next_y=player.y
switch(direction){
	case "up":
	    edge_action=pages[cur_page].metadata.north_goto;
		next_y=24;
	    	break;
	case "down":
		edge_action=pages[cur_page].metadata.south_goto;
		next_y=0;
	    	break;
	case "left":
		edge_action=pages[cur_page].metadata.west_goto;
		next_x=39;
	    	break;
	case "right":
		edge_action=pages[cur_page].metadata.east_goto;
		next_x=0;
	    	break;
}
if(edge_action==-3 || edge_action==-1){
	return;
}
if(edge_action==-2){
	var tmp2=0;
	switch(direction){
	case "up":
			if(get_ptr_from_page_xy(pages[cur_page].metadata.x,pages[cur_page].metadata.y-1)!=-1){
				tmp2=get_ptr_from_page_xy(pages[cur_page].metadata.x,pages[cur_page].metadata.y-1);
				pages[cur_page].metadata.north_goto=tmp2;
				player.y=24;
				cur_page=tmp2;
				pages[cur_page].metadata.south_goto=tmp2;
				return;
			}
	    	new_page(-1,"up");
			player.y=24;
	    	return;
	case "down":
			if(get_ptr_from_page_xy(pages[cur_page].metadata.x,pages[cur_page].metadata.y+1)!=-1){
				tmp2=get_ptr_from_page_xy(pages[cur_page].metadata.x,pages[cur_page].metadata.y+1);
				pages[cur_page].metadata.north_goto=tmp2;
				player.y=0;
				cur_page=tmp2;
				pages[cur_page].metadata.north_goto=tmp2;
				return;
			}
			new_page(-1,"down");
			player.y=0;
	    	return;
	case "left":
			if(get_ptr_from_page_xy(pages[cur_page].metadata.x-1,pages[cur_page].metadata.y)!=-1){
				tmp2=get_ptr_from_page_xy(pages[cur_page].metadata.x-1,pages[cur_page].metadata.y);
				pages[cur_page].metadata.north_goto=tmp2;
				player.x=39;
				cur_page=tmp2;
				pages[cur_page].metadata.west_goto=tmp2;
				return;
			}
			new_page(-1,"left");
			player.x=39
	    	return;
	case "right":
			if(get_ptr_from_page_xy(pages[cur_page].metadata.x+1,pages[cur_page].metadata.y)!=-1){
				tmp2=get_ptr_from_page_xy(pages[cur_page].metadata.x+1,pages[cur_page].metadata.y);
				pages[cur_page].metadata.north_goto=tmp2;
				player.x=0;
				cur_page=tmp2;
				pages[cur_page].metadata.east_goto=tmp2;
				return;
			}
			new_page(-1,"right");
			player.x=0;
	    	return;
}
}
cur_page=edge_action;
player.x=next_x;
player.y=next_y;
}

function inv_cleanup(){//resolve item slots with count of 0 or less to id 0
    for(var i=0;i<10;i++){
        if(player.inv[i][1]<1){
            player.inv[i][0]=0;
            player.inv[i][1]=0;
        }
    }
}

function entity_cleanup(){
//remove free`ed entities and condense list
var new_entity_list=[];
for(var i=0;i<pages[cur_page].entities.length;i++){
	if(pages[cur_page].entities[i].id!=-1){
	new_entity_list.push(JSON.parse(JSON.stringify(pages[cur_page].entities[i])));
	}
}
pages[cur_page].entities=new_entity_list;
}

function compare_array(x,y){
if(x.length!=y.length){
    return false;
}
for(var i=0;i<x.length;i++){
    if(x[i]!=y[i]){
        return false;
    }
}
return true;
}

function pick_up_tile(item_id){
player.creative==1 ? pages[cur_page].map[player.y][player.x]=0 : 0;
if(player.inv[player.inv[10]][0]==0){
			player.inv[player.inv[10]]=[item_id,1];
			pages[cur_page].map[player.y][player.x]=0;
    	    return;
}
if(player.inv[player.inv[10]][0]==item_id){
	player.inv[player.inv[10]][1]++;
	pages[cur_page].map[player.y][player.x]=0;
    return;
}
}

function enter_button(){
var standing_on=pages[cur_page].map[player.y][player.x];
var on_entity=0;
//check entity
for(var i=0;i<pages[cur_page].entities.length;i++){
	if(pages[cur_page].entities[i].x==player.x && pages[cur_page].entities[i].y==player.y){
		on_entity=pages[cur_page].entities[i];
		if(on_entity.id==2){//Pick items up.
			if(player.creative==1){
				pages[cur_page].entities[i].id=-1;
				return;
			}
			if(on_entity.item[0]==player.inv[player.inv[10]][0] || player.inv[player.inv[10]][0]==0){
				player.inv[player.inv[10]][0]=on_entity.item[0];
				player.inv[player.inv[10]][1]+=on_entity.item[1];
				pages[cur_page].entities[i].id=-1;
			}
		}
	}
}
//check block
switch(standing_on){
	case 6://teleport/goto next map
		teleport();
		break;
	case 7://bedding
	case 8:
		if(!(tick_hour()>=6 && tick_hour()<=17)){
			dem_ann.textContent="You can only sleep at day.";
		}else{
			tick1=49200;
			dem_ann.textContent="Slept and skipped to night."
			player.strength=1;//Player strength reset after sleeping.
		}
		break;
	case 13://grass
		pick_up_tile(3);
		break;
	case 16://brown mushroom
		pick_up_tile(4);
		break;
	case 17://red mushroom
		pick_up_tile(5);
		break;
	case 24://sapling
		pick_up_tile(9);
		break;
	case 28://carpet
		pick_up_tile(13);
		break;
	case 38://raygun
		pick_up_tile(19);
		break;
	case 40://Cyan Thing
		pick_up_tile(21);
		break;
	case 43://Open Door
		pick_up_tile(22);
		break;
	case 2://Dither, Stone
		pick_up_tile(23);
		break;
	case 12://Hay Bail
		pick_up_tile(24);
		break;
	case 52://Walnut Fruit
		pick_up_tile(25);
		break;
	case 54://Walnut peels
		pick_up_tile(27);
		break;
	case 68://Camp Fire
		pick_up_tile(41);
		break;
	case 73://Camp Fire
		pick_up_tile(46);
		break;
	case 77://Copper wire (off)
		pick_up_tile(67);
		break;
	case 78://Copper wire (off)
		pick_up_tile(67);
		break;
	case 79://Copper wire (off)
		pick_up_tile(67);
		break;
	case 80://Copper wire (off)
		pick_up_tile(67);
		break;
	case 81://Copper wire (on)
		pick_up_tile(67);
		break;
	case 82://Copper wire (on)
		pick_up_tile(67);
		break;
	case 83://Copper wire (on)
		pick_up_tile(67);
		break;
	case 84://Copper wire (on)
		pick_up_tile(67);
		break;
	case 86://Switch (off)
		pick_up_tile(68);
		break;
	case 87://switch (on)
		pick_up_tile(68);
		break;
	case 88://Not Gate (off)
		pick_up_tile(69);//nice
		break;
	case 89://Not Gate (on)
		pick_up_tile(69);
		break;
	case 90://Gate (off)
		pick_up_tile(70);
		break;
	case 91://Gate (on)
		pick_up_tile(70);
		break;
	case 92://Wire Jumper
		pick_up_tile(71);
		break;
	case 93://Pump
		pick_up_tile(72);
		break;
	case 29://water
		if(player.inv[player.inv[10]][0]==11){//Bowl
			pages[cur_page].entities.push({
			id:2,
			x:player.x,
			y:player.y,
			char:item_char[39],
			item:[39,1]
			});//Bowl of water.
			combine_items(player.x,player.y,39);
			player.inv[player.inv[10]][1]--;
		}
		if(player.inv[player.inv[10]][1]<=0){
			player.inv[player.inv[10]][0]=0;
			player.inv[player.inv[10]][1]=0;
		}
		break;
	default:
		if(player.creative==1){
			for(var i=0;i<properties.creative_noremove.length;i++){
				if(standing_on==properties.creative_noremove[i]){
					return;
				}
			}
			pages[cur_page].map[player.y][player.x]=0;
		}
		break;
}
if(standing_on==11){//crafting arrow
    var input=[
    -1,-1,//(35,1),(36,1)
    -1,-1,//(35,2),(36,2)
    -1,-1//(35,3),(36,3)
    ];
    var recipe_id=[0,0,0,0,0,0];
    for(var i=0;i<pages[cur_page].entities.length;i++){
        if(pages[cur_page].entities[i].id!=2){//item
            continue;
        }
        if(pages[cur_page].entities[i].x==35 && pages[cur_page].entities[i].y==1){
            input[0]=i;
			recipe_id[0]=pages[cur_page].entities[i].item[0];
        }
        if(pages[cur_page].entities[i].x==36 && pages[cur_page].entities[i].y==1){
            input[1]=i;
			recipe_id[1]=pages[cur_page].entities[i].item[0];
        }
        if(pages[cur_page].entities[i].x==35 && pages[cur_page].entities[i].y==2){
            input[2]=i;
			recipe_id[2]=pages[cur_page].entities[i].item[0];
        }
        if(pages[cur_page].entities[i].x==36 && pages[cur_page].entities[i].y==2){
            input[3]=i;
			recipe_id[3]=pages[cur_page].entities[i].item[0];
        }
        if(pages[cur_page].entities[i].x==35 && pages[cur_page].entities[i].y==3){
            input[4]=i;
			recipe_id[4]=pages[cur_page].entities[i].item[0];
        }
        if(pages[cur_page].entities[i].x==36 && pages[cur_page].entities[i].y==3){
            input[5]=i;
			recipe_id[5]=pages[cur_page].entities[i].item[0];
        }
    }
	var selected=-1;
	for(var i=0;i<recipies.length;i++){
		if(compare_array(recipe_id,recipies[i].input_id)){
			selected=i;
			break;
		}
	}
	if(selected==-1){
		return;
	}
	for(var i=0;i<input.length;i++){
		if(input[i]!=-1){
			pages[cur_page].entities[input[i]].item[1]--;
			if(pages[cur_page].entities[input[i]].item[1]<=0){
				pages[cur_page].entities[input[i]].id=-1
			}
		}
	}
	for(var i=0;i<recipies[selected].output.length;i++){
		pages[cur_page].entities.push({id:2, char:item_char[recipies[selected].output[i][0]], x:38, y:1+i, item: recipies[selected].output[i]});
		combine_items(38,1+i,recipies[selected].output[i][0]);
	}
}
}

function drop_item(x){
if(player.inv[player.inv[10]][0]==0){//Don't want to be creating dropped items with item id of zero...
	return;
}
var _id=player.inv[player.inv[10]][0];
if(x==0){//drop all
	pages[cur_page].entities.push(
	    {
	    id:2,
	    char:item_char[player.inv[player.inv[10]][0]],
	    x:player.x,
	    y:player.y,
	    item:player.inv[player.inv[10]]
	    });
		if(player.creative!=1){
	    player.inv[player.inv[10]]=[0,0];
		}
		combine_items(player.x,player.y,_id);
}
if(x==1){//drop one
	pages[cur_page].entities.push(
	    {
	    id:2,
	    char:item_char[player.inv[player.inv[10]][0]],
	    x:player.x,
	    y:player.y,
	    item:[player.inv[player.inv[10]][0],1]
	    });
		if(player.creative!=1){
	    player.inv[player.inv[10]]=[player.inv[player.inv[10]][0],player.inv[player.inv[10]][1]-1];
	    if(player.inv[player.inv[10]][1]<1){
		player.inv[player.inv[10]]=[0,0];
	    }
		}
		combine_items(player.x,player.y,_id);
}
if(x=="half"){
	var half_amount=Math.floor(player.inv[player.inv[10]][1]/2);
	if(half_amount<=0){
		return;
	}
	if(player.creative!=1){
	player.inv[player.inv[10]][1]-=half_amount;
	pages[cur_page].entities.push(
	    {
	    id:2,
	    char:item_char[player.inv[player.inv[10]][0]],
	    x:player.x,
	    y:player.y,
	    item:[player.inv[player.inv[10]][0],half_amount]
	    });
	inv_cleanup();
	}
	combine_items(player.x,player.y,_id);
}
}

function entity_player_collide(){
    for(var i=0;i<pages[cur_page].entities.length;i++){
        if(player.x==pages[cur_page].entities[i].x && player.y==pages[cur_page].entities[i].y){
            return i;
        }
    }
    return -1;
}

function projectile_entity_collide(ptr){//find if specified entity shares same coords as another one.
    for(var i=0;i<pages[cur_page].entities.length;i++){
        if(i==ptr){continue;}
        if(pages[cur_page].entities[ptr].x==pages[cur_page].entities[i].x && pages[cur_page].entities[ptr].y==pages[cur_page].entities[i].y && pages[cur_page].entities[i].id==1){
            return i;
        }
    }
    return -1;
}

/*function entity_collide(ptr){//find if specified entity shares same coords as another one.
    for(var i=0;i<pages[cur_page].entities.length;i++){
        if(i==ptr){continue;}
        if(pages[cur_page].entities[ptr].x==pages[cur_page].entities[i].x && pages[cur_page].entities[ptr].y==pages[cur_page].entities[i].y && pages[cur_page].entities[i].id!=3){
            return i;
        }
    }
    return -1;
}*/

function entity_collide_xy(x,y){//find if specified entity exists on x y axis
    for(var i=0;i<pages[cur_page].entities.length;i++){
        if(x==pages[cur_page].entities[i].x && y==pages[cur_page].entities[i].y){
            return i;
        }
    }
    return -1;
}

function hit_bounds(x,y){//bounds check for screen edge.
    return (x<0 || x>39 || y<0 || y>24);
}

function char_entity_on(ptr){//what type of character is the selected entity on?
    return pages[cur_page].map[pages[cur_page].entities[ptr].y][pages[cur_page].entities[ptr].x];
}

function char_value(x,y){
	if(hit_bounds(x,y)){
		return -1;
	}
    return pages[cur_page].map[y][x];
}

function is_walkable(x){
    for(var i=0;i<properties.walkable.length;i++){
        if(properties.walkable[i]==x){
            return true;
        }
    }
    return false;
}

function can_bang(x){
	for(var i=0;i<properties.bangable.length;i++){
		if(properties.bangable[i]==x){
			return true;
		}
	}
	return false;
}

function do_bang(_x,_y){
	pages[cur_page].entities.push({id:3, x:_x, y:_y, char:19, direction:-1, damage:7, decay:3});//Center Bang
	if(!hit_bounds(_x-1,_y)){
	pages[cur_page].entities.push({id:3, x:_x-1, y:_y, char:19, direction:-1, damage:7, decay:3});//Left
	}
	if(!hit_bounds(_x+1,_y)){
	pages[cur_page].entities.push({id:3, x:_x+1, y:_y, char:19, direction:-1, damage:7, decay:3});//Right
	}
	if(!hit_bounds(_x,_y-1)){
	pages[cur_page].entities.push({id:3, x:_x, y:_y-1, char:19, direction:-1, damage:7, decay:3});//Up
	}
	if(!hit_bounds(_x,_y+1)){
	pages[cur_page].entities.push({id:3, x:_x, y:_y+1, char:19, direction:-1, damage:7, decay:3});//Down
	}
}

function projectile_effect(ptr){
if(pages[cur_page].entities[ptr]==undefined){
	return;
}
switch(pages[cur_page].entities[ptr].char){
	case 35://Amber, fire bow
		if(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)==0 || is_burnable(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y))){
			pages[cur_page].map[pages[cur_page].entities[ptr].y][pages[cur_page].entities[ptr].x]=30
		}
		break;
	case 20://raygun ring
		do_bang(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y);
		if(can_bang(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y))){
			switch(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)){
				case 5://Black stone?
					pages[cur_page].map[pages[cur_page].entities[ptr].y][pages[cur_page].entities[ptr].x]=2;
					break;
				default:
					pages[cur_page].map[pages[cur_page].entities[ptr].y][pages[cur_page].entities[ptr].x]=0;
			}
		}
		sfx("raygun_bang");
		break;
	default:
		0;
}
}

function projectile_step(ptr){
if(pages[cur_page].entities[ptr]==undefined){
	return;
}
    switch(pages[cur_page].entities[ptr].direction){
        case -1:
            break;
        case 0://up
            pages[cur_page].entities[ptr].y--;
            break;
        case 1://down
            pages[cur_page].entities[ptr].y++;
            break;
        case 2://left
            pages[cur_page].entities[ptr].x--;
            break;
        case 3://right
            pages[cur_page].entities[ptr].x++;
            break;
    }
	if(pages[cur_page].entities[ptr].decay!=-1){
    pages[cur_page].entities[ptr].decay--;
	}
}

function projectile_check(ptr){
if(pages[cur_page].entities[ptr]==undefined){
	return;
}
    if(pages[cur_page].entities[ptr].decay==0){
		projectile_effect(ptr);
		pages[cur_page].entities[ptr].id=-1;
        return;
    }
	if(hit_bounds(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)){//move entity to next page when hit edges if possible
		var next_page=-1;
		var dir="";
		if(pages[cur_page].entities[ptr].x<0){//left edge, west_goto
			next_page=pages[cur_page].metadata.west_goto;
			dir="left";
		}
		if(pages[cur_page].entities[ptr].x>39){//right edge, east_goto
			next_page=pages[cur_page].metadata.east_goto;
			dir="right";
		}
		if(pages[cur_page].entities[ptr].y<0){//top edge, north_goto
			next_page=pages[cur_page].metadata.north_goto;
			dir="up";
		}
		if(pages[cur_page].entities[ptr].y>24){//bottom edge, south_goto
			next_page=pages[cur_page].metadata.south_goto;
			dir="down";
		}
		if(next_page==-1 || next_page==-2){
			projectile_effect(ptr);
        	pages[cur_page].entities[ptr].id=-1;
        	entity_cleanup();
        	return;
		}else{
		switch(dir){
			case "up":
				pages[cur_page].entities[ptr].y=24;
				break;
			case "down":
				pages[cur_page].entities[ptr].y=0;
				break;
			case "left":
				pages[cur_page].entities[ptr].x=39;
				break;
			case "right":
				pages[cur_page].entities[ptr].x=0;
				break;
		}
		move_entity(ptr,next_page);
		return;
		}
	}
    var collided=projectile_entity_collide(ptr);
    if(collided!=-1){//hits entity
        if(pages[cur_page].entities[collided].health!=undefined){
			projectile_effect(ptr);
            pages[cur_page].entities[collided].health-=pages[cur_page].entities[ptr].damage;//inflict damage on target entity
            pages[cur_page].entities[ptr].id=-1;//Mark projectile for deletion.
	    	return;
        }
    }
    collided=entity_player_collide();
    if(collided==ptr){//hits player
		if(pages[cur_page].entities[ptr].from_player==1){//don't inflict damage on oneself.
			return;
		}
		projectile_effect(ptr);
	damage_player(pages[cur_page].entities[ptr].damage);
        pages[cur_page].entities[ptr].id=-1;
		return;
    }
    if(!is_walkable(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y))){//encounters non walkable block
		projectile_effect(ptr);
        pages[cur_page].entities[ptr].id=-1;
        return;
    }
	if(is_burnable(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)) && pages[cur_page].entities[ptr].char==35){//amber encounters burnable block
		projectile_effect(ptr,"burn");
        pages[cur_page].entities[ptr].id=-1;
        return;
    }
}
function projectile(ptr){//Code for making projectiles move and interact with ThInGs
	projectile_check(ptr);
	projectile_step(ptr);
	projectile_check(ptr);
}

function item_pickup_dropoff(item_id,x,y){
	if(player.creative==1){
		pages[cur_page].map[y][x]=0;
		return true;
	}
	if(player.inv[player.inv[10]][0]==0){
            player.inv[player.inv[10]][0]=item_id;
            pages[cur_page].map[y][x]=0;
    }
    if(player.inv[player.inv[10]][0]==item_id){
        player.inv[player.inv[10]][1]++;
        pages[cur_page].map[y][x]=0;
    }
return true;
}

function remove_char(x,y){
if(player.inv[player.inv[10]][0]==67){
	return;
}
switch(char_value(x,y)){
    case 18://fence
		return item_pickup_dropoff(6,x,y);
	case 12://Hay
		return item_pickup_dropoff(24,x,y);
	case 54://peels
		return item_pickup_dropoff(27,x,y);
	case 58://Bookshelf
		return item_pickup_dropoff(31,x,y);
	case 64://Iron wall
		return item_pickup_dropoff(37,x,y);
	case 65://Copper wall
		return item_pickup_dropoff(38,x,y);
	case 72://MDF
		return item_pickup_dropoff(45,x,y);
	case 74://Green Stained MDF
		return item_pickup_dropoff(47,x,y);
	case 75://Red Stained MDF
		return item_pickup_dropoff(48,x,y);
	case 76://Cyan Stained MDF
		return item_pickup_dropoff(49,x,y);
	case 90://Gate, off
		return item_pickup_dropoff(70,x,y);
	case 91://Gate, on
		return item_pickup_dropoff(70,x,y);
	case 93://pump
		return item_pickup_dropoff(72,x,y);
	case 42://closed door
		pages[cur_page].map[y][x]=43;
		return true;
	case 43://open door
		pages[cur_page].map[y][x]=42;
		return true;
	case 30://fire 0
	case 31://fire 1
	case 32://fire 2
		pages[cur_page].map[y][x]=0;
		return true;
	case 86://switch off
		pages[cur_page].map[y][x]=87;
		return true;
	case 87://switch on
		pages[cur_page].map[y][x]=86;
		return true;
	case 94://Fan
		return item_pickup_dropoff(73,x,y);
		return true;
	default:
		if(player.creative==1){
			var _char=char_value(x,y);//Performance optimization.
			for(var i=0;i<properties.creative_noremove.length;i++){
				if(_char==properties.creative_noremove[i]){
					return false;
				}
			}
			pages[cur_page].map[y][x]=0;
			return false;
		}
		break;
}
}

function attack(x){
var is_entity=-1;//does an entity exist at that place?
switch(x){
    case "up":
        is_entity=entity_collide_xy(player.x,player.y-1);
        break;
    case "down":
	is_entity=entity_collide_xy(player.x,player.y+1);
        break;
    case "left":
	is_entity=entity_collide_xy(player.x-1,player.y);
        break;
    case "right":
	is_entity=entity_collide_xy(player.x+1,player.y);
        break;
}
if(is_entity==-1 || pages[cur_page].entities[is_entity].id!=1){//no entity
switch(x){
    case "up":
        if(remove_char(player.x,player.y-1)){return;}
        break;
    case "down":
        if(remove_char(player.x,player.y+1)){return;};
        break;
    case "left":
        if(remove_char(player.x-1,player.y)){return;};
        break;
    case "right":
        if(remove_char(player.x+1,player.y)){return;};
        break;
}
}
switch(player.inv[player.inv[10]][0]){
	case 17://fire bow
	switch(x){
	    case "up":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y-1, char:35, direction:0, damage:player.strength*4, decay:8, from_player:1});
 	       break;
 	   case "down":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y+1, char:35, direction:1, damage:player.strength*4, decay:8, from_player:1});
 	       break;
 	   case "left":
  	       pages[cur_page].entities.push({id:3, x:player.x-1, y:player.y, char:35, direction:2, damage:player.strength*4, decay:8, from_player:1});
  	       break;
  	   case "right":
   	       pages[cur_page].entities.push({id:3, x:player.x+1, y:player.y, char:35, direction:3, damage:player.strength*4, decay:8, from_player:1});
   	       break;
	}
	if(player.creative!=1){
	player.inv[player.inv[10]][1]--;
	if(player.inv[player.inv[10]][1]<=0){
		player.inv[player.inv[10]]=[14,1];
	}
	inv_cleanup();
	}
    break;
	case 18://spear
	switch(x){
	    case "up":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y-1, char:37, direction:-1, damage:player.strength*20, decay:3, from_player:1});
 	       break;
 	   case "down":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y+1, char:37, direction:-1, damage:player.strength*20, decay:3, from_player:1});
 	       break;
 	   case "left":
  	       pages[cur_page].entities.push({id:3, x:player.x-1, y:player.y, char:37, direction:-1, damage:player.strength*20, decay:3, from_player:1});
  	       break;
  	   case "right":
   	       pages[cur_page].entities.push({id:3, x:player.x+1, y:player.y, char:37, direction:-1, damage:player.strength*20, decay:3, from_player:1});
   	       break;
	}
	inv_cleanup();
    break;
	case 19://Raygun
	switch(x){
	    case "up":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y-1, char:20, direction:0, damage:player.strength*1000, decay:50, from_player:1});
		   sfx("raygun_cooldown");
 	       break;
 	   case "down":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y+1, char:20, direction:1, damage:player.strength*1000, decay:50, from_player:1});
		   sfx("raygun_cooldown");
 	       break;
 	   case "left":
  	       pages[cur_page].entities.push({id:3, x:player.x-1, y:player.y, char:20, direction:2, damage:player.strength*1000, decay:50, from_player:1});
		   sfx("raygun_cooldown");
  	       break;
  	   case "right":
   	       pages[cur_page].entities.push({id:3, x:player.x+1, y:player.y, char:20, direction:3, damage:player.strength*1000, decay:50, from_player:1});
		   sfx("raygun_cooldown");
   	       break;
	}
	inv_cleanup();
	break;39
	case 20://Poisonous Spear
	switch(x){
	    case "up":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y-1, char:39, direction:-1, damage:player.strength*30, decay:3, from_player:1});
 	       break;
 	   case "down":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y+1, char:39, direction:-1, damage:player.strength*30, decay:3, from_player:1});
 	       break;
 	   case "left":
  	       pages[cur_page].entities.push({id:3, x:player.x-1, y:player.y, char:39, direction:-1, damage:player.strength*30, decay:3, from_player:1});
  	       break;
  	   case "right":
   	       pages[cur_page].entities.push({id:3, x:player.x+1, y:player.y, char:39, direction:-1, damage:player.strength*30, decay:3, from_player:1});
   	       break;
	}
	break;
	case 67://copper wire
		if(char_value(player.x,player.y)!=0){
			break;
		}
		switch(x){
			case "up":
				pages[cur_page].map[player.y][player.x]=77;
				break;
			case "down":
				pages[cur_page].map[player.y][player.x]=78;
				break;
			case "left":
				pages[cur_page].map[player.y][player.x]=79;
				break;
			case "right":
				pages[cur_page].map[player.y][player.x]=80;
				break;
		}
		player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
		if(player.inv[player.inv[10]][1]<=0){
			player.inv[player.inv[10]][0]=0;
		}
		break;
	default:
		switch(x){
 		 	case "up":
      	  pages[cur_page].entities.push({id:3, x:player.x, y:player.y-1, char:19, direction:-1, damage:player.strength, decay:3, from_player:1});
 	       break;
   		 case "down":
   		     pages[cur_page].entities.push({id:3, x:player.x, y:player.y+1, char:19, direction:-1, damage:player.strength, decay:3, from_player:1});
   		     break;
   		 case "left":
    	    pages[cur_page].entities.push({id:3, x:player.x-1, y:player.y, char:19, direction:-1, damage:player.strength, decay:3, from_player:1});
    	    break;
  		  case "right":
   		     pages[cur_page].entities.push({id:3, x:player.x+1, y:player.y, char:19, direction:-1, damage:player.strength, decay:3, from_player:1});
    	    break;
}
}
}

function is_bonemealable(x){
	for(var i=0;i<properties.bonemealable.length;i++){
		if(properties.bonemealable[i]==x){
			return true;
		}
	}
	return false;
}

function use_item(){
if(char_value(player.x,player.y)==0){
for(var i=0;i<properties.breakable.length;i++){
	if(player.inv[player.inv[10]][0]==properties.breakable[i]){
		pages[cur_page].map[player.y][player.x]=item_char[player.inv[player.inv[10]][0]];
		player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
		inv_cleanup();
		return;
	}
}
}
switch(player.inv[player.inv[10]][0]){//item id
    case 12: //Mushroom Stew
        if(player.health>=20){
            break;
        }
	player.health+=5;
        if(player.health>20 && player.creative==0){
            player.health=20;
        }
		
	player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
	pages[cur_page].entities.push({
		id:2,
		x:player.x,
		y:player.y,
		char:item_char[11],
		item:[11,1]
		});//drop bowl
		combine_items(player.x,player.y,11);
	break;
	case 16://amber
		if(char_value(player.x,player.y)==0){
			pages[cur_page].map[player.y][player.x]=30;
			player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
		}
		break;
	case 23://stone
		if(char_value(player.x,player.y)==0){
			pages[cur_page].map[player.y][player.x]=2;
			player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
		}
		break;
    case 26://walnut stone
        if(player.health>=20){
            break;
        }
		player.health+=10;
        if(player.health>20 && player.creative==0){
            player.health=20;
        }
		player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
		break;
	case 28://bone meal
		if(!is_bonemealable(char_value(player.x,player.y))){
			return;
		}
		random_tick(player.x,player.y,1);
		player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
		inv_cleanup();
		break;
	case 34: //Meat
        if(player.health>=20){
            break;
        }
		player.health+=2;
        if(player.health>20 && player.creative==0){
            player.health=20;
        }
		player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
		break;
	case 36: //Cooked Meat
        if(player.health>=20){
            break;
        }
		player.health+=10;
        if(player.health>20 && player.creative==0){
            player.health=20;
        }
		player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
		break;
	case 40: //Suspicious Stew
		player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
		player.health+=20;
        if(player.health>20 && player.creative==0){
            player.health=20;
        }
		pages[cur_page].entities.push({
		id:2,
		x:player.x,
		y:player.y,
		char:item_char[11],
		item:[11,1]
		});//drop bowl
		combine_items(player.x,player.y,11);
		var choice=Math.floor(Math.random()*65535)%3;
        switch(choice){
			case 0://strength boost
				player.strength=1.5;
				break;
			case 1://Health boost
				player.health=40;
				break;
			case 2://Nothing
				break;
		}
	case 50://black wall
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[50] : 0;
		break;
	case 51://bedding 1
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[51] : 0;
		break;
	case 52://bedding 2
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[52] : 0;
		break;
	case 53://tree leaves
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[53] : 0;
		break;
	case 54://tree trunk
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[54] : 0;
		break;
	case 55://water
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[55] : 0;
		break;
	case 56://fire 0
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[56] : 0;
		break;
	case 57://fire 1
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[57] : 0;
		break;
	case 58://fire 2
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[58] : 0;
		break;
	case 59://NPC Hole
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[59] : 0;
		break;
	case 60://Walnut Trunk
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[60] : 0;
		break;
	case 61://Walnut Leaves 1
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[61] : 0;
		break;
	case 62://Walnut Leaves 2
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[62] : 0;
		break;
	case 63://Walnut Leaves 3
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[63] : 0;
		break;
	case 64://Walnut Leaves 4
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[64] : 0;
		break;
	case 65://Walnut Leaves 5
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[65] : 0;
		break;
	case 66://Walnut Leaves 6
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[66] : 0;
		break;
}
inv_cleanup();
}

function cheats(){
    var cheat_code=prompt("Cheat?");
    switch(cheat_code){
        case "Juggernog":
			player.tainted=1;
            player.health=20;
            break;
        case "gamemode c":
			player.tainted=1;
            player.creative=1;
			player.strength=65535;
            player.health=Infinity;
			player.inv[0]=[item_id_from_name("Grass"),255];
			player.inv[1]=[item_id_from_name("red mushroom"),255];
			player.inv[2]=[item_id_from_name("brown mushroom"),255];
			player.inv[3]=[item_id_from_name("fence"),255];
			player.inv[4]=[item_id_from_name("sapling"),255];
			player.inv[5]=[item_id_from_name("carpet"),255];
			player.inv[6]=[item_id_from_name("door"),255];
			player.inv[7]=[item_id_from_name("stone"),255];
			player.inv[8]=[item_id_from_name("hay bail"),255];
			player.inv[9]=[item_id_from_name("mdf"),255];
            break;
        case "Give me what I want!":
			player.tainted=1;
            player.inv[player.inv[10]]=JSON.parse(prompt("Item?"));
            break;
		case "Let it grow!":
			player.tainted=1;
            random_tick(player.x,player.y);
            break;
        default:
            alert("No cheat for you!");
            break;
    }
}

//keys
function key_manager(key){
//Movement
last_dir="";
if(key==80){//pause, p
	switch(paused){
		case 0:
			paused=1;
			dem_ann.textContent="Paused";
			break;
		case 1:
			paused=0;
			dem_ann.textContent="Unpaused";
			break;
	}
}
if(paused==1){
	return;
}
switch(key){
    case 87://up,w
	last_dir="up";
	if(hit_bounds(player.x,player.y-1)){
		off_edge("up");
	}
	if(!(hit_bounds(player.x,player.y) || hit_bounds(player.x,player.y-1) || !is_walkable(char_value(player.x,player.y-1)))){
        	player.y-=1;
        }
        return;
    case 83://down, s
	last_dir="down";
	if(hit_bounds(player.x,player.y+1)){
		off_edge("down");
	}
        if(!(hit_bounds(player.x,player.y) || hit_bounds(player.x,player.y+1) || !is_walkable(char_value(player.x,player.y+1)))){
        	player.y+=1;
        }
        return;
    case 65://left, a
	last_dir="left";
	if(hit_bounds(player.x-1,player.y)){
		off_edge("left");
	}
        if(!(hit_bounds(player.x,player.y) || hit_bounds(player.x-1,player.y) || !is_walkable(char_value(player.x-1,player.y)))){
        	player.x-=1;
        }
        return;
    case 68://right, d
	last_dir="right";
	if(hit_bounds(player.x+1,player.y)){
		off_edge("right");
	}
        if(!(hit_bounds(player.x,player.y) || hit_bounds(player.x+1,player.y) || !is_walkable(char_value(player.x+1,player.y)))){
        	player.x+=1;
        }
        return;
}
//attack
switch(key){
    case 38:
        attack("up");
        break;
   case 40:
        attack("down");
        break;
   case 37:
        attack("left");
        break;
   case 39:
        attack("right");
        break;
}

if(player.creative==1){
switch(key){//creative stuff
	case 219://[
		player.inv[player.inv[10]][0]--;
		if(player.inv[player.inv[10]][0]<0){
			player.inv[player.inv[10]][0]=0;
		}
		break;
	case 221://]
		player.inv[player.inv[10]][0]++;
		if(player.inv[player.inv[10]][0]>=item_char.length){
			player.inv[player.inv[10]][0]=item_char.length-1;
		}
		break;
	case 220://\
		var _item_id=item_id_from_name(prompt("Item Name?"));
		if(_item_id==-1){
			alert("Invalid Item Name");
			return;
		}
		player.inv[player.inv[10]][0]=_item_id;
		break;
}
}

//inventory slot select
switch(key){
    case 49://1
        player.inv[10]=0;
        break;
    case 50://2
        player.inv[10]=1;
        break;
    case 51://3
        player.inv[10]=2;
        break;
    case 52://4
        player.inv[10]=3;
        break;
    case 53://5
        player.inv[10]=4;
        break;
    case 54://6
        player.inv[10]=5;
        break;
    case 55://7
        player.inv[10]=6;
        break;
    case 56://8
        player.inv[10]=7;
        break;
    case 57://9
        player.inv[10]=8;
        break;
    case 48://0
        player.inv[10]=9;
        break;
}

//drop item
switch(key){
    case 71://Drop one item
        drop_item(1);
        break;
    case 70://Drop all of the items.
        drop_item(0);
        break;
	case 86://v, Drop have of items
		drop_item("half");
		break;
}

//break/pickup, place/use, other
switch(key){
    case 13://enter
        enter_button();
        break;
    case 32://space
        use_item();
        break;
    case 192://"~" key
        dem_ann.textContent="Stop there criminal!";
        cheats();
        break;
}
}

function death(){
    if(player.creative==1){
        console.log("You live to see another day.");
        return;
    }
    alert("BOOM! You are DEAD!");
    clearInterval(interval);
    key_manager=function(){};
}

function pathfind_step(x1,y1,x2,y2,og_x,og_y){//asdf
var nodes=[];
var dir="";
og_x==undefined ? og_x=20 : 0;
og_y==undefined ? og_y=12 : 0;
nodes.push({x:x1,y:y1,h:Math.sqrt((x2-x1)*(x2-x1)+(y2-y1)*(y2-y1))});
if(is_walkable(char_value(x1,y1-1))){//up
	nodes.push({x:x1,y:y1-1,h:Math.sqrt((x2-x1)*(x2-x1)+(y2-(y1-1))*(y2-(y1-1)))});
	dir="up";
}
if(is_walkable(char_value(x1,y1+1))){//down
	nodes.push({x:x1,y:y1+1,h:Math.sqrt((x2-x1)*(x2-x1)+(y2-(y1+1))*(y2-(y1+1)))});
	dir="down";
}
if(is_walkable(char_value(x1-1,y1))){//left
	nodes.push({x:x1-1,y:y1,h:Math.sqrt((x2-(x1-1))*(x2-(x1-1))+(y2-y1)*(y2-y1))});
	dir="left";
}
if(is_walkable(char_value(x1+1,y1))){//right
	nodes.push({x:x1+1,y:y1,h:Math.sqrt((x2-(x1+1))*(x2-(x1+1))+(y2-y1)*(y2-y1))});
	dir="right";
}
if(is_walkable(char_value(x1-1,y1-1)) && (is_walkable(char_value(x1-1,y1)) || is_walkable(char_value(x1,y1-1)))){//up left
	nodes.push({x:x1-1,y:y1-1,h:Math.sqrt((x2-(x1-1))*(x2-(x1-1))+(y2-(y1-1))*(y2-(y1-1)))});
}
if(is_walkable(char_value(x1-1,y1+1)) && (is_walkable(char_value(x1-1,y1)) || is_walkable(char_value(x1,y1+1)))){//down left
	nodes.push({x:x1-1,y:y1+1,h:Math.sqrt((x2-(x1-1))*(x2-(x1-1))+(y2-(y1+1))*(y2-(y1+1)))});
}
if(is_walkable(char_value(x1+1,y1-1)) && (is_walkable(char_value(x1+1,y1)) || is_walkable(char_value(x1,y1-1)))){//up right
	nodes.push({x:x1+1,y:y1-1,h:Math.sqrt((x2-(x1+1))*(x2-(x1+1))+(y2-(y1-1))*(y2-(y1-1)))});
}
if(is_walkable(char_value(x1+1,y1+1)) && (is_walkable(char_value(x1+1,y1)) || is_walkable(char_value(x1,y1+1)))){//down right
	nodes.push({x:x1+1,y:y1+1,h:Math.sqrt((x2-(x1+1))*(x2-(x1+1))+(y2-(y1+1))*(y2-(y1+1)))});
}
var collided;
var new_nodes=[];
new_nodes.push(JSON.parse(JSON.stringify(nodes[0])));
for(var i=1;i<nodes.length;i++){
	collided=entity_collide_xy(nodes[i].x,nodes[i].y);
	if(collided!=-1){
		if(pages[cur_page].entities[collided].id==1){
			continue;
		}
	}
	new_nodes.push(JSON.parse(JSON.stringify(nodes[i])));
}
nodes=new_nodes;
var smallest=nodes[0];
for(var i=1;i<nodes.length;i++){
	if(smallest.h>=nodes[i].h){
		smallest=nodes[i];
	}
}
return [smallest.x,smallest.y,dir];
}
function entity_attack(ptr){
    if(pages[cur_page].entities[ptr].attack_cooldown>0){
        pages[cur_page].entities[ptr].attack_cooldown--;
        return;
    }
    if(pages[cur_page].entities[ptr].x==player.x){
        if(pages[cur_page].entities[ptr].y<player.y){//Attack Down
            pages[cur_page].entities.push({id:3, x:pages[cur_page].entities[ptr].x, y:pages[cur_page].entities[ptr].y+1, char:19, direction:-1, damage:pages[cur_page].entities[ptr].strength, decay:2});
            pages[cur_page].entities[ptr].attack_cooldown=5;
        }
        if(pages[cur_page].entities[ptr].y>player.y){//Attack Up
            pages[cur_page].entities.push({id:3, x:pages[cur_page].entities[ptr].x, y:pages[cur_page].entities[ptr].y-1, char:19, direction:-1, damage:pages[cur_page].entities[ptr].strength, decay:2});
            pages[cur_page].entities[ptr].attack_cooldown=5;
        }
    }
    if(pages[cur_page].entities[ptr].y==player.y){
        if(pages[cur_page].entities[ptr].x<player.x){//Attack Right
            pages[cur_page].entities.push({id:3, x:pages[cur_page].entities[ptr].x+1, y:pages[cur_page].entities[ptr].y, char:19, direction:-1, damage:pages[cur_page].entities[ptr].strength, decay:2});
            pages[cur_page].entities[ptr].attack_cooldown=5;
        }
        if(pages[cur_page].entities[ptr].x>player.x){//Attack Left
            pages[cur_page].entities.push({id:3, x:pages[cur_page].entities[ptr].x-1, y:pages[cur_page].entities[ptr].y, char:19, direction:-1, damage:pages[cur_page].entities[ptr].strength, decay:2});
            pages[cur_page].entities[ptr].attack_cooldown=5;
        }
    }
}

function get_hole_ptr_from_xy(x,y){
	for(var i=0;i<pages[cur_page].holes.length;i++){
		if(pages[cur_page].holes[i].x==x && pages[cur_page].holes[i].y==y){
			return i;
		}
	}
	return -1;
}

function entity_teleport(hole_ptr,entity_ptr){
	if(pages[cur_page].holes[hole_ptr].dest_page==-2 || pages[cur_page].holes[hole_ptr].dest_page==-2){
		return;
	}
	pages[cur_page].entities[entity_ptr].x=pages[cur_page].holes[hole_ptr].next_x;
	pages[cur_page].entities[entity_ptr].y=pages[cur_page].holes[hole_ptr].next_y;
	pages[cur_page].entities[entity_ptr].dest_x=pages[cur_page].holes[hole_ptr].next_x;
	pages[cur_page].entities[entity_ptr].dest_y=pages[cur_page].holes[hole_ptr].next_y;
	move_entity(entity_ptr,pages[cur_page].holes[hole_ptr].dest_page);
}

function entity_slip_edge(ptr,dir){
var next_page=-1;
switch(dir){
	case "up":
		next_page=pages[cur_page].metadata.north_goto;
		break;
	case "down":
		next_page=pages[cur_page].metadata.south_goto;
		break;
	case "left":
		next_page=pages[cur_page].metadata.west_goto;
		break;
	case "right":
		next_page=pages[cur_page].metadata.east_goto;
		break;
}
if(next_page==-1 || next_page==-2){
	return;
}
switch(dir){
	case "left":
		pages[cur_page].entities[ptr].x=39;
		pages[cur_page].entities[ptr].dest_x=39;
		break;
	case "right":
		pages[cur_page].entities[ptr].x=0;
		pages[cur_page].entities[ptr].dest_x=0;
		break;
	case "up":
		pages[cur_page].entities[ptr].y=24;
		pages[cur_page].entities[ptr].dest_y=24;
		break;
	case "down":
		pages[cur_page].entities[ptr].y=0;
		pages[cur_page].entities[ptr].dest_y=0;
		break;
}
move_entity(ptr,next_page);
}

function is_54(x,y){
	return char_value(x,y)==54;
}

function entity_slip(ptr){
switch(pages[cur_page].entities[ptr].last_dir){
	case "up":
		if(is_walkable(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y-1)) && !hit_bounds(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y-1)){
			pages[cur_page].entities[ptr].y--;
			if(!is_54(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)){
				pages[cur_page].entities[ptr].dest_x=pages[cur_page].entities[ptr].x;
				pages[cur_page].entities[ptr].dest_y=pages[cur_page].entities[ptr].y-1;
				}
		}
		if(hit_bounds(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y-1)){
			entity_slip_edge(ptr,"up");
		}
		return;
	case "down":
		if(is_walkable(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y+1)) && !hit_bounds(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y+1)){
			pages[cur_page].entities[ptr].y++;
			if(!is_54(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)){
				pages[cur_page].entities[ptr].dest_x=pages[cur_page].entities[ptr].x;
				pages[cur_page].entities[ptr].dest_y=pages[cur_page].entities[ptr].y+1;
			}
		}
		if(hit_bounds(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y+1)){
			entity_slip_edge(ptr,"down");
		}
		break;
	case "left":
		if(is_walkable(char_value(pages[cur_page].entities[ptr].x-1,pages[cur_page].entities[ptr].y)) && !hit_bounds(pages[cur_page].entities[ptr].x-1,pages[cur_page].entities[ptr].y)){
			pages[cur_page].entities[ptr].x--;
			if(!is_54(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)){
			pages[cur_page].entities[ptr].dest_x=pages[cur_page].entities[ptr].x;
			pages[cur_page].entities[ptr].dest_y=pages[cur_page].entities[ptr].y;
			}
		}
		if(hit_bounds(pages[cur_page].entities[ptr].x-1,pages[cur_page].entities[ptr].y)){
			entity_slip_edge(ptr,"left");
		}
		break;
	case "right":
		if(is_walkable(char_value(pages[cur_page].entities[ptr].x+1,pages[cur_page].entities[ptr].y)) && !hit_bounds(pages[cur_page].entities[ptr].x+1,pages[cur_page].entities[ptr].y)){
			pages[cur_page].entities[ptr].x++;
			if(!is_54(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)){
			pages[cur_page].entities[ptr].dest_x=pages[cur_page].entities[ptr].x;
			pages[cur_page].entities[ptr].dest_y=pages[cur_page].entities[ptr].y;
			}
		}
		if(hit_bounds(pages[cur_page].entities[ptr].x+1,pages[cur_page].entities[ptr].y)){
			entity_slip_edge(ptr,"right");
		}
		break;
	default:
		//pages[cur_page].entities[ptr].last_dir="up";
		return;
}
return 1;
}

function entity_standing_on(ptr){
//pages[cur_page].entities[0].dest_x=19;pages[cur_page].entities[0].dest_y=12;
switch(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)){
	case 6://hole
		if(pages[cur_page].entities[ptr].x!=pages[cur_page].entities[ptr].dest_x || pages[cur_page].entities[ptr].y!=pages[cur_page].entities[ptr].dest_y){
			break;
		}
		entity_teleport(get_hole_ptr_from_xy(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y),ptr);
		break;
	case 54://walnut peel
		entity_slip(ptr);
		return 1;
		break;
	case 30://fire
	case 31:
	case 32:
	case 68://Camp Fire
		pages[cur_page].entities[ptr].health--;
		break;
}
}

function npc_edge(ptr){//(x<0 || x>39 || y<0 || y>24);
var next_page=-1;
var dir="";
if(pages[cur_page].entities[ptr].dest_x<0){//left
	next_page=pages[cur_page].metadata.west_goto;
	dir="left";
}
if(pages[cur_page].entities[ptr].dest_x>39){//right
	next_page=pages[cur_page].metadata.east_goto;
	dir="right";
}
if(pages[cur_page].entities[ptr].dest_y<0){//up
	next_page=pages[cur_page].metadata.north_goto;
	dir="up";
}
if(pages[cur_page].entities[ptr].dest_y>24){//down
	next_page=pages[cur_page].metadata.south_goto;
	dir="down";
}
if(next_page==-1 || next_page==-2){
	return;
}else{
switch(dir){
	case "left":
		pages[cur_page].entities[ptr].x=39;
		pages[cur_page].entities[ptr].dest_x=39;
		break;
	case "right":
		pages[cur_page].entities[ptr].x=0;
		pages[cur_page].entities[ptr].dest_x=0;
		break;
	case "up":
		pages[cur_page].entities[ptr].y=24;
		pages[cur_page].entities[ptr].dest_y=24;
		break;
	case "down":
		pages[cur_page].entities[ptr].y=0;
		pages[cur_page].entities[ptr].dest_y=0;
		break;
}
move_entity(ptr,next_page);
}
}

function entity_edge(ptr){//move entity between pages through edges.
	if(hit_bounds(pages[cur_page].entities[ptr].dest_x,pages[cur_page].entities[ptr].dest_y)){
		if(Math.sqrt(Math.pow(pages[cur_page].entities[ptr].x-pages[cur_page].entities[ptr].dest_x,2)+Math.pow(pages[cur_page].entities[ptr].y-pages[cur_page].entities[ptr].dest_y,2))==1){
			npc_edge(ptr);
		}
	}
}

function friendly_npc(ptr){
	//love
	for(var i=0;i<pages[cur_page].entities.length;i++){
		if(i==ptr){
			continue;
		}
		if(pages[cur_page].entities[i].id==1 && pages[cur_page].entities[i].brain.hostile==0){
			if(pages[cur_page].entities[i].x==pages[cur_page].entities[ptr].x&&
			pages[cur_page].entities[i].y==pages[cur_page].entities[ptr].y&&
			pages[cur_page].entities[i].brain.identity.love_mode==1){
				pages[cur_page].entities[i].brain.identity.love_mode=0;
				pages[cur_page].entities[ptr].brain.identity.love_mode=0;
				new_npc(pages[cur_page].entities[ptr].x,
				pages[cur_page].entities[ptr].y,
				pages[cur_page].entities[ptr].x,
				pages[cur_page].entities[ptr].y);//asdf
				return;
			}
		}
	}
}

function npc(ptr){//make entity move and interact with environment.
	if(entity_standing_on(ptr)==1){return;}
    if(pages[cur_page].entities[ptr].brain.no_ai==1){return;}
    var next_xy;
    switch(pages[cur_page].entities[ptr].brain.hostile){
        case 0://not hostile
            next_xy=pathfind_step(pages[cur_page].entities[ptr].x,
            pages[cur_page].entities[ptr].y,
            pages[cur_page].entities[ptr].dest_x,
            pages[cur_page].entities[ptr].dest_y,
			pages[cur_page].entities[ptr].og_x,
			pages[cur_page].entities[ptr].og_y);
			pages[cur_page].entities[ptr].brain.identity.love_mode==1 ? friendly_npc(ptr) : 0;
            break;
        case 1://hostile
            next_xy=pathfind_step(pages[cur_page].entities[ptr].x,
            pages[cur_page].entities[ptr].y,
            player.x,
            player.y,
            pages[cur_page].entities[ptr].og_x,
            pages[cur_page].entities[ptr].og_y);
            if(next_xy[0]==player.x && next_xy[1]==player.y){
                entity_attack(ptr);
                return;
            }
            break;
    }
	pages[cur_page].entities[ptr].last_dir=next_xy[2];
	var collided=entity_collide_xy(next_xy[0],next_xy[1]);
	if(collided!=-1 && pages[cur_page].entities[collided].id==1 && pages[cur_page].entities[ptr].brain.hostile==1){return;}//prevent multiple npc's from occupying the same char.
    pages[cur_page].entities[ptr].x=next_xy[0];pages[cur_page].entities[ptr].y=next_xy[1];//for slipping.
	entity_standing_on(ptr);
	entity_edge(ptr);
}

function slip(){
switch(last_dir){
	case "up":
		if(is_walkable(char_value(player.x,player.y-1)) && !hit_bounds(player.x,player.y-1)){
			player.y--;
		}
		if(hit_bounds(player.x,player.y-1)){
			off_edge("up");
		}
		return;
	case "down":
		if(is_walkable(char_value(player.x,player.y+1)) && !hit_bounds(player.x,player.y+1)){
			player.y++;
		}
		if(hit_bounds(player.x,player.y+1)){
			off_edge("down");
		}
		break;
	case "left":
		if(is_walkable(char_value(player.x-1,player.y)) && !hit_bounds(player.x-1,player.y)){
			player.x--;
		}
		if(hit_bounds(player.x-1,player.y)){
			off_edge("left");
		}
		break;
	case "right":
		if(is_walkable(char_value(player.x+1,player.y)) && !hit_bounds(player.x+1,player.y)){
			player.x++;
		}
		if(hit_bounds(player.x+1,player.y)){
			off_edge("right");
		}
		break;
	default:
		break;
}
}

function move_entity(ptr,next_page){
pages[next_page].entities.push(JSON.parse(JSON.stringify(pages[cur_page].entities[ptr])));//weird pointer shenanigans
pages[cur_page].entities[ptr].id=-1;
entity_cleanup();
}

function fire_damage(){
	damage_player(1);
}

function tick(){
    if(player.health<=0){//Player Death
        death();
    }
    for(var i=0;i<pages[cur_page].entities.length;i++){
        switch(pages[cur_page].entities[i].id){
            case 3:
                projectile(i);
                break;
            case 1:
                npc(i);
                break;
        }
    }
	switch(char_value(player.x,player.y)){
		case 54://walnut peels
			slip();
			break;
		case 30://fire
		case 31:
		case 32:
			fire_damage();
			break;
	}
}

function can_spawn(x){
    for(var i=0;i<properties.not_spawnable.length;i++){
        if(x==properties.not_spawnable[i]){
        return false;
        }
    }
    return true;
}

function is_burnable(x){
	for(var i=0;i<properties.burnable.length;i++){
        if(properties.burnable[i]==x){
            return true;
        }
    }
    return false;
}

function adj_empty(x,y){
if(char_value(x,y-1)==0){//up
	return [x,y-1];
}
if(char_value(x+1,y)==0){//right
	return [x+1,y];
}
if(char_value(x,y+1)==0){//down
	return [x,y+1];
}
if(char_value(x-1,y)==0){//left
	return [x-1,y];
}
return [x,y];
}

function crisp_item(ptr,x,y){
switch(pages[cur_page].entities[ptr].item[0]){
	case 34://Meat
		pages[cur_page].entities[ptr].item[1]--;
		pages[cur_page].entities.push({
		id:2,
		x:adj_empty(x,y)[0],
		y:adj_empty(x,y)[1],
		char:item_char[36],
		item:[36,1]
		});//cooked meat
		combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],36);
		break;
	case 44://MDF puddy
		pages[cur_page].entities[ptr].item[1]--;
		pages[cur_page].entities.push({
		id:2,
		x:adj_empty(x,y)[0],
		y:adj_empty(x,y)[1],
		char:item_char[45],
		item:[45,1]
		});//MDF
		combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],45);
		break;
	case 36://cooked meat
		break;
	case 45://mdf
		break;
	case 33://iron
		break;
	case 35://Copper
		break;
	case 21://cyan thing
		break;
	default:
		pages[cur_page].entities[ptr].item[1]--;
		break;
}
}

function do_fire(x,y){
	//check for flamable objects around.
	var spread=0;
	if(!hit_bounds(x,y-1)){//up
		if(is_burnable(char_value(x,y-1))){
			pages[cur_page].map[y-1][x]=30;
			spread=1;
		}
	}
	if(!hit_bounds(x,y+1)){//down
		if(is_burnable(char_value(x,y+1))){
			pages[cur_page].map[y+1][x]=30;
			spread=1;
		}
	}
	if(!hit_bounds(x-1,y)){//left
		if(is_burnable(char_value(x-1,y))){
			pages[cur_page].map[y][x-1]=30;
			spread=1;
		}
	}
	if(!hit_bounds(x+1,y)){//right
		if(is_burnable(char_value(x+1,y))){
			pages[cur_page].map[y][x+1]=30;
			spread=1;
		}
	}
	if(spread==0){
		if(char_value(x,y)==68){
			0;
		}else{
		pages[cur_page].map[y][x]++;
		if(char_value(x,y)>=33){
			pages[cur_page].map[y][x]=0;
		}
		}
	}
	//check for entities
	for(var i=0;i<pages[cur_page].entities.length;i++){
		if(pages[cur_page].entities[i].x==x &&pages[cur_page].entities[i].y==y){
		switch(pages[cur_page].entities[i].id){
			case 1://npc
				break;
			case 2://dropped item
				crisp_item(i,x,y);
				break;
			case 3://projectile
				break;
		}
		}
	}
}

function enemy_chance(){return Math.floor(-180+46.66666667*tick_hour()+-1.944444444*tick_hour()*tick_hour());}

function random_tick(random_x=Math.floor((Math.random()*65535))%40,random_y=Math.floor((Math.random()*65535))%25,bone_meal=0,action=Math.floor((Math.random()*65535))%100){
var season=rtc().month;
if(!(season>3 && season<12)){//no growth in winter
if(pages[cur_page].map[random_y][random_x]==13){//grass
    if(action%2==0){//create hay
        pages[cur_page].entities.push({id:2, char:12, x:random_x, y:random_y, item: [2,1]});
		combine_items(random_x,random_y,2);
    }
    if(action%2==1){//spread
        var direction=Math.floor(Math.random()*65535)%4;
        x=random_x;
        y=random_y;
        switch(direction){
            case 0://up
                y--;
                break;
            case 1://down
                y++;
                break;
            case 2://left
                x--;
                break;
            case 3://right
                x++;
                break;
        }
        if(hit_bounds(x,y)){
            return;        
        }
        if(pages[cur_page].map[y][x]==0){
            pages[cur_page].map[y][x]=13;
        }
    }
}

if(pages[cur_page].map[random_y][random_x]==15){//tree trunk
    if(action%2==0){
        pages[cur_page].entities.push({id:2, char:9, x:random_x, y:random_y, item: [1,1]});//branch
		combine_items(random_x,random_y,1);
    }
    if(action%2==1){
        pages[cur_page].entities.push({id:2, char:24, x:random_x, y:random_y, item: [9,1]});//sapling
		combine_items(random_x,random_y,9);
    }
}
}
if(pages[cur_page].map[random_y][random_x]==16){//brown mushroom growth
    var direction=Math.floor(Math.random()*65535)%4;
        x=random_x;
        y=random_y;
        switch(direction){
            case 0://up
                y--;
                break;
            case 1://down
                y++;
                break;
            case 2://left
                x--;
                break;
            case 3://right
                x++;
                break;
        }
        if(hit_bounds(x,y)){
            return;        
        }
        if(pages[cur_page].map[y][x]==0){
            pages[cur_page].map[y][x]=16;
        }
}
if(pages[cur_page].map[random_y][random_x]==17){//red mushroom growth
    var direction=Math.floor(Math.random()*65535)%4;
        x=random_x;
        y=random_y;
        switch(direction){
            case 0://up
                y--;
                break;
            case 1://down
                y++;
                break;
            case 2://left
                x--;
                break;
            case 3://right
                x++;
                break;
        }
        if(hit_bounds(x,y)){
            return;        
        }
        if(pages[cur_page].map[y][x]==0){
            pages[cur_page].map[y][x]=17;
        }
}
if(!(season>3 && season<12)){//no growth in winter
switch(pages[cur_page].map[random_y][random_x]){
	case 46://walnut leaves
	case 47:
	case 48:
	case 49:
	case 50:
	case 51:
		pages[cur_page].entities.push({id:2, char:52, x:random_x, y:random_y, item: [25,1]});
		combine_items(random_x,random_y,25);
		break;
	case 52://walnut fruit
		if(char_value(random_x,random_y-1)==0 && char_value(random_x,random_y-2)==0 && char_value(random_x-1,random_y-1)==0 && char_value(random_x-1,random_y-2)==0 && char_value(random_x+1,random_y-1)==0 && char_value(random_x+1,random_y-2)==0){
			struct_copy(9,random_x-1,random_y-2);
		}
		break;
}
if(char_value(random_x,random_y)==24){//sapling
    if(!hit_bounds(random_x,random_y-1)){
        if(char_value(random_x,random_y-1)==0){
            pages[cur_page].map[random_y][random_x]=15;//trunk
            pages[cur_page].map[random_y-1][random_x]=14;//leaves
        }
    }
}
if(bone_meal==1){
	return;
}
}
//non hostile entity random destination
if(tick_hour()>=6 && tick_hour()<=17){//during day, hide
for(var i=0;i<pages[cur_page].entities.length;i++){
    if(pages[cur_page].entities[i].id==1){
        if(pages[cur_page].entities[i].brain.hostile==0){
            pages[cur_page].entities[i].dest_x=pages[cur_page].entities[i].brain.home_x;
            pages[cur_page].entities[i].dest_y=pages[cur_page].entities[i].brain.home_y;
        }
    }
}
}
if(action<=30 && tick_hour()<=5 || tick_hour()>=18 && action<20){
for(var i=0;i<pages[cur_page].entities.length;i++){
    if(pages[cur_page].entities[i].id==1){
        if(pages[cur_page].entities[i].brain.hostile==0 && Math.random()>0.7){
            pages[cur_page].entities[i].dest_x=(Math.floor(Math.random()*65535)%42)-1;
            pages[cur_page].entities[i].dest_y=(Math.floor(Math.random()*65535)%27)-1;
			pages[cur_page].entities[i].brain.identity.love_mode=1;
        }
    }
}
}
if(tick_hour()>=6 && tick_hour()<=17){
	//enemy spawning stuff
	if(pages[cur_page].metadata.safety==0){
		if(action<enemy_chance()){
            var cv=char_value(random_x,random_y);
            if(!is_walkable(cv)){
                return;
            }
            if(can_spawn(cv)){
			 pages[cur_page].entities.push({id:1, char:4, x:random_x,y:random_y, brain: {no_ai:0, hostile: 1}, health:20, strength:1, attack_cooldown:0, og_x:random_x, og_y:random_y});
            }
		}
	}
}
}

function grind_item(x,y){
var item_ptrs=[];
for(var i=0;i<pages[cur_page].entities.length;i++){
	if(pages[cur_page].entities[i].id==2 && pages[cur_page].entities[i].x==x && pages[cur_page].entities[i].y==y){
		item_ptrs.push(i);
	}
}
for(var i=0;i<item_ptrs.length;i++){
	switch(pages[cur_page].entities[item_ptrs[i]].item[0]){
		case 7://stick
			pages[cur_page].entities[item_ptrs[i]].item[1]--;
			pages[cur_page].entities.push({
			id:2,
			x:adj_empty(x,y)[0],
			y:adj_empty(x,y)[1],
			char:item_char[42],
			item:[42,1]
			});//Sawdust
			combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],42);
			break;
		case 11://bowl
			pages[cur_page].entities[item_ptrs[i]].item[1]--;
			pages[cur_page].entities.push({
			id:2,
			x:adj_empty(x,y)[0],
			y:adj_empty(x,y)[1],
			char:item_char[42],
			item:[42,1]
			});
			combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],42);
			break;
		case 22://door
			pages[cur_page].entities[item_ptrs[i]].item[1]--;
			pages[cur_page].entities.push({
			id:2,
			x:adj_empty(x,y)[0],
			y:adj_empty(x,y)[1],
			char:item_char[42],
			item:[42,1]
			});
			combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],42);
			break;
		case 26://walnut stone
			pages[cur_page].entities[item_ptrs[i]].item[1]--;
			pages[cur_page].entities.push({
			id:2,
			x:adj_empty(x,y)[0],
			y:adj_empty(x,y)[1],
			char:item_char[42],
			item:[42,1]
			});
			combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],42);
			break;
		case 6://fence
			pages[cur_page].entities[item_ptrs[i]].item[1]--;
			pages[cur_page].entities.push({
			id:2,
			x:adj_empty(x,y)[0],
			y:adj_empty(x,y)[1],
			char:item_char[42],
			item:[42,1]
			});
			combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],42);
			break;
		case 10://leaves
			pages[cur_page].entities[item_ptrs[i]].item[1]--;
			pages[cur_page].entities.push({
			id:2,
			x:adj_empty(x,y)[0],
			y:adj_empty(x,y)[1],
			char:item_char[29],
			item:[29,1]
			});//Fibers
			combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],42);
			break;
		case 27://Walnut Peels
			pages[cur_page].entities[item_ptrs[i]].item[1]--;
			pages[cur_page].entities.push({
			id:2,
			x:adj_empty(x,y)[0],
			y:adj_empty(x,y)[1],
			char:item_char[29],
			item:[29,1]
			});
			combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],42);
			break;
	}
}
}

function not_gate(x,y){
	pages[cur_page].map[y][x]=(char_value(x+1,y)==83||char_value(x-1,y)==84||char_value(x,y-1)==82||char_value(x,y+1)==81 ? 88 : 89);
}

function gate(x,y){
	pages[cur_page].map[y][x]=(char_value(x+1,y)==83||char_value(x-1,y)==84||char_value(x,y-1)==82||char_value(x,y+1)==81 ? 91 : 90);
}

function electrodes(x,y){
	pages[cur_page].map[y][x]=(char_value(x+1,y)==29||char_value(x-1,y)==29||char_value(x,y-1)==29||char_value(x,y+1)==29 ? 96 : 95);
}

function wire_jumper(x,y){
	//up, wire down
	if(char_value(x,y-1)==78&&char_value(x,y+1)==82){
		pages[cur_page].map[y+1][x]=78;
	}
	if(char_value(x,y-1)==82&&char_value(x,y+1)==78){
		pages[cur_page].map[y+1][x]=82;
	}
	//down, wire up
	if(char_value(x,y+1)==77&&char_value(x,y-1)==81){
		pages[cur_page].map[y-1][x]=77;
	}
	if(char_value(x,y+1)==81&&char_value(x,y-1)==77){
			pages[cur_page].map[y-1][x]=81;
	}
	//left, wire right
	if(char_value(x-1,y)==80&&char_value(x+1,y)==84){
		pages[cur_page].map[y][x+1]=80;
	}
	if(char_value(x-1,y)==84&&char_value(x+1,y)==80){
		pages[cur_page].map[y][x+1]=84;
	}
	//right, wire left
	if(char_value(x+1,y)==79&&char_value(x-1,y)==83){
		pages[cur_page].map[y][x-1]=79;
	}
	if(char_value(x+1,y)==83&&char_value(x-1,y)==79){
		pages[cur_page].map[y][x-1]=83;
	}
}

function pump(x,y){//water: 29
	if(char_value(x,y-1)==29){
		if(char_value(x,y+1)==0){
			pages[cur_page].map[y-1][x]=0;
			pages[cur_page].map[y+1][x]=29;
			return;
		}
		if(hit_bounds(x,y+1)){//map edge, south
			if(pages[cur_page].metadata.south_goto>=0){
				if(pages[pages[cur_page].metadata.south_goto].map[0][x]==0){
					pages[cur_page].map[y-1][x]=0;
					pages[pages[cur_page].metadata.south_goto].map[0][x]=29;
					return;
				}
			}
		}
	}else{
	if(hit_bounds(x,y-1)){
		if(pages[cur_page].metadata.north_goto>=0){
			if(pages[pages[cur_page].metadata.north_goto].map[24][x]==29&&char_value(x,y+1)==0){
				pages[pages[cur_page].metadata.north_goto].map[24][x]=0;
				pages[cur_page].map[y+1][x]=29;
				return;
			}
		}
	}
	}
	if(char_value(x,y+1)==29){
		if(char_value(x,y-1)==0){
		pages[cur_page].map[y+1][x]=0;
		pages[cur_page].map[y-1][x]=29;
		return;
		}
		if(hit_bounds(x,y-1)){//map edge, north
			if(pages[cur_page].metadata.north_goto>=0){
				if(pages[pages[cur_page].metadata.north_goto].map[24][x]==0){
					pages[cur_page].map[y+1][x]=0;
					pages[pages[cur_page].metadata.north_goto].map[24][x]=29;
					return;
				}
			}
		}
	}else{
	if(hit_bounds(x,y+1)){
		if(pages[cur_page].metadata.south_goto>=0){
			if(pages[pages[cur_page].metadata.south_goto].map[0][x]==29&&char_value(x,y-1)==0){
				pages[pages[cur_page].metadata.south_goto].map[0][x]=0;
				pages[cur_page].map[y-1][x]=29;
				return;
			}
		}
	}
	}
	if(char_value(x-1,y)==29){
		if(char_value(x+1,y)==0){
		pages[cur_page].map[y][x-1]=0;
		pages[cur_page].map[y][x+1]=29;
		return;
		}
		if(hit_bounds(x+1,y)){//map edge, east
			if(pages[cur_page].metadata.east_goto>=0){
				if(pages[pages[cur_page].metadata.east_goto].map[y][0]==0){
					pages[cur_page].map[y][x-1]=0;
					pages[pages[cur_page].metadata.east_goto].map[y][0]=29;
					return;
				}
			}
		}
	}else{
	if(hit_bounds(x-1,y)){
		if(pages[cur_page].metadata.west_goto>=0){
			if(pages[pages[cur_page].metadata.west_goto].map[y][39]==29&&char_value(x+1,y)==0){
				pages[pages[cur_page].metadata.west_goto].map[y][39]=0;
				pages[cur_page].map[y][x+1]=29;
				return;
			}
		}
	}
	}
	if(char_value(x+1,y)==29){
		if(char_value(x-1,y)==0){
		pages[cur_page].map[y][x+1]=0;
		pages[cur_page].map[y][x-1]=29;
		return;
		}
		if(hit_bounds(x-1,y)){//map edge, west
			if(pages[cur_page].metadata.west_goto>=0){
				if(pages[pages[cur_page].metadata.west_goto].map[y][39]==0){
					pages[cur_page].map[y][x+1]=0;
					pages[pages[cur_page].metadata.west_goto].map[y][39]=29;
					return;
				}
			}
		}
	}else{
	if(hit_bounds(x+1,y)){
		if(pages[cur_page].metadata.east_goto>=0){
			if(pages[pages[cur_page].metadata.east_goto].map[y][0]==29&&char_value(x-1,y)==0){
				pages[pages[cur_page].metadata.east_goto].map[y][0]=0;
				pages[cur_page].map[y][x-1]=29;
				return;
			}
		}
	}
	}
}

function fan(x,y){//water: 29
	var j=0;
	if(char_value(x,y-1)==29 && char_value(x,y-2)==0){
		j=y-2;
		while(char_value(x,j)==0){
			j--;
		}
		j++;
		pages[cur_page].map[y-1][x]=0;
		pages[cur_page].map[j][x]=29;
	}
	if(char_value(x,y+1)==29 && char_value(x,y+2)==0){
		j=y+2;
		while(char_value(x,j)==0){
			j++;
		}
		j--;
		pages[cur_page].map[y+1][x]=0;
		pages[cur_page].map[j][x]=29;
	}
	if(char_value(x-1,y)==29 && char_value(x-2,y)==0){
		j=x-2;
		while(char_value(j,y)==0){
			j--;
		}
		j++;
		pages[cur_page].map[y][x-1]=0;
		pages[cur_page].map[y][j]=29;
	}
	if(char_value(x+1,y)==29 && char_value(x+2,y)==0){
		j=x+2;
		while(char_value(j,y)==0){
			j++;
		}
		j--;
		pages[cur_page].map[y][x+1]=0;
		pages[cur_page].map[y][j]=29;
	}
}

function elec_misc(tile,x,y,value){
	switch(tile){
		case 88://not gate (off)
		case 89://not gate (on)
			not_gate(x,y);
			break;
		case 90://Gate (off)
		case 91://Gate (on)
			gate(x,y);
			break;
		case 92://wire jumper
			wire_jumper(x,y);
			break;
		case 42://door closed
		case 43://door open
			pages[cur_page].map[y][x]=(value==1 ? 43 : 42);
			break;
		case 93://pump
			value==1 ? pump(x,y) : 0;
			break;
		case 94://fan
			value==1 ? fan(x,y) : 0;
			break;
		default:
			break;
	}
}

function is_wire(x){
	return properties.wires.indexOf(x)!=-1;
}

function is_on(x){
	return properties.elec_on.indexOf(x)!=-1;
}

function is_off(x){
	return properties.elec_off.indexOf(x)!=-1;
}

function active_tiles(){
	var grind_stones=map_search(73);
	for(var i=0;i<grind_stones.length;i++){
		grind_item(grind_stones[i].x,grind_stones[i].y);
	}
	//wire up
	var wires=map_search(77);//Wire up, off
	var before_tile;
	var j;
	for(var i=0;i<wires.length;i++){
		if(is_on(char_value(wires[i].x,wires[i].y+1))){
			j=wires[i].y;
			while(char_value(wires[i].x,j)==77){
				pages[cur_page].map[j][wires[i].x]=81;
				j--;
			}
			elec_misc(char_value(wires[i].x,j),wires[i].x,j,1);
		}
	}
	wires=map_search(81);//wire up,on
	for(var i=0;i<wires.length;i++){
		if(is_off(char_value(wires[i].x,wires[i].y+1))){
			j=wires[i].y;
			while(char_value(wires[i].x,j)==81){
				pages[cur_page].map[j][wires[i].x]=77;
				j--;
			}
			elec_misc(char_value(wires[i].x,j),wires[i].x,j,0);
		}
	}
	//wire down
	wires=map_search(78);//wire down,off
	for(var i=0;i<wires.length;i++){
		if(is_on(char_value(wires[i].x,wires[i].y-1))){
			j=wires[i].y;
			while(char_value(wires[i].x,j)==78){
				pages[cur_page].map[j][wires[i].x]=82;
				j++;
			}
			elec_misc(char_value(wires[i].x,j),wires[i].x,j,1);
		}
	}
	wires=map_search(82);//wire down,on
	for(var i=0;i<wires.length;i++){
		if(is_off(char_value(wires[i].x,wires[i].y-1))){
			j=wires[i].y;
			while(char_value(wires[i].x,j)==82){
				pages[cur_page].map[j][wires[i].x]=78;
				j++;
			}
			elec_misc(char_value(wires[i].x,j),wires[i].x,j,0);
		}
	}
	//wire left
	wires=map_search(79);//wire left,off
	for(var i=0;i<wires.length;i++){
		if(is_on(char_value(wires[i].x+1,wires[i].y))){
			j=wires[i].x;
			while(char_value(j,wires[i].y)==79){
				pages[cur_page].map[wires[i].y][j]=83;
				j--;
			}
			elec_misc(char_value(j,wires[i].y),j,wires[i].y,1);
		}
	}
	wires=map_search(83);//wire left,on
	for(var i=0;i<wires.length;i++){
		if(is_off(char_value(wires[i].x+1,wires[i].y))){
			j=wires[i].x;
			while(char_value(j,wires[i].y)==83){
				pages[cur_page].map[wires[i].y][j]=79;
				j--;
			}
			elec_misc(char_value(j,wires[i].y),j,wires[i].y,0);
		}
	}
	//wire right
	wires=map_search(80);//wire right,off
	for(var i=0;i<wires.length;i++){
		if(is_on(char_value(wires[i].x-1,wires[i].y))){
			j=wires[i].x;
			while(char_value(j,wires[i].y)==80){
				pages[cur_page].map[wires[i].y][j]=84;
				j++;
			}
			elec_misc(char_value(j,wires[i].y),j,wires[i].y,1);
		}
		
	}
	wires=map_search(84);//wire right,on
	for(var i=0;i<wires.length;i++){
		if(is_off(char_value(wires[i].x-1,wires[i].y))){
			j=wires[i].x;
			while(char_value(j,wires[i].y)==84){
				pages[cur_page].map[wires[i].y][j]=80;
				j++;
			}
			elec_misc(char_value(j,wires[i].y),j,wires[i].y,0);
		}
	}
	var gates=[map_search(90),map_search(91),map_search(88),map_search(89),map_search(92),map_search(95),map_search(96)];//gate off,gate on,not gate off, not gate on, wire jumper,electrode off,electrode on
	var longest=gates[0].length;
	for(var i=0;i<gates.length;i++){
		longest=longest<gates[i].length ? gates[i].length : longest;
	}
	for(var i=0;i<longest;i++){
		i<gates[0].length ? gate(gates[0][i].x,gates[0][i].y) : 0;
		i<gates[1].length ? gate(gates[1][i].x,gates[1][i].y) : 0;
		i<gates[2].length ? not_gate(gates[2][i].x,gates[2][i].y) : 0;
		i<gates[3].length ? not_gate(gates[3][i].x,gates[3][i].y) : 0;
		i<gates[4].length ? wire_jumper(gates[4][i].x,gates[4][i].y) : 0;
		i<gates[5].length ? electrodes(gates[5][i].x,gates[5][i].y) : 0;
		i<gates[6].length ? electrodes(gates[6][i].x,gates[6][i].y) : 0;
	}
}

function fireing(){
var limit=5;
var tmp=0;
for(var x=0;x<40;x++){
	for(var y=0;y<25;y++){
		tmp=char_value(x,y);
		if(tmp==30 || tmp==31 || tmp==32 || tmp==68){//Fire, Camp Fire
			if(limit==0){
				return;
			}
			do_fire(x,y);
			limit--;
		}
	}
}
}

function frac(x){
	return Math.round(x-Math.floor(x));
}

function leading_zeros(x){
	return (""+x).length==1 ? "0"+x : x;
}

function tick_hour(){
	return Math.floor(tick1/(65535/24))%24;
}

function tick_to_time(){//%02i:%02i
	var hour=Math.floor(tick1/2730.625)%24;
	var minute=Math.floor(tick1/45.510416)%60;
	return hour+":"+leading_zeros(minute);
}

var tick1=0;//0 to 65535
function refresh(){//Dang it, no multiple setintervals...
if(paused==1){
	return;
}
//Entity and npc cleanup
for(var i=0;i<pages[cur_page].entities.length;i++){
	switch(pages[cur_page].entities[i].id){
		case 1://npc
			if(pages[cur_page].entities[i].health<=0){//npc death.
				pages[cur_page].entities[i].id=-1;
				npc_drops(i);
			}
			break;
		case 2://dropped item
			if(pages[cur_page].entities[i].item[1]<=0){
				pages[cur_page].entities[i].id=-1;
			}
			if(pages[cur_page].entities[i].item[1]==null){
				pages[cur_page].entities[i].id=-1;
			}
			if(pages[cur_page].entities[i].item[0]<=0){
				pages[cur_page].entities[i].id=-1;
			}
			if(pages[cur_page].entities[i].item[0]>=item_char.length){
				pages[cur_page].entities[i].id=-1;
			}
			break;
		default:
			break;
	}
}
entity_cleanup();
draw_map(pages[cur_page]);
//status bar
var player_text;
switch(player.creative){
	case 0://Survival
		player_text="Name: "+player.name+" Health: "+player.health+" Strength: "+player.strength+" X: "+player.x+" Y: "+player.y+ " Text Page: "+cur_page+" Time: "+tick_to_time()+" "+pages[cur_page].metadata.x+","+pages[cur_page].metadata.y;
		break;
	case 1://Creative
		player_text="Name: "+player.name+" Creative X: "+player.x+" Y: "+player.y+ " Text Page: "+cur_page+" Time: "+tick_to_time()+" "+pages[cur_page].metadata.x+","+pages[cur_page].metadata.y;
		break;
}
document.getElementById("player").textContent=player_text;
var status_bar="Inventory: ";
switch(player.creative){
	case 0://Survival
	for(var i=0;i<10;i++){
		status_bar+=(player.inv[10]!=i ? i+": "+item_names[player.inv[i][0]]+" x "+player.inv[i][1]+" " : i+": ("+item_names[player.inv[i][0]]+" x "+player.inv[i][1]+") ");
	}
	break;
	case 1://creative
	for(var i=0;i<10;i++){
		status_bar+=(player.inv[10]!=i ? i+": "+item_names[player.inv[i][0]]+" " : i+": ("+item_names[player.inv[i][0]]+") ");
	}
	break;
}
document.getElementById("status").textContent=status_bar;
tick1=(tick1>=65536 ? 0:tick1+1);
if(tick1==0){
player.days++;
seasons();
}
tick1%2==0 ? tick():0;
tick1%40==0 ? random_tick():0;
if(tick1%7==0){//fire, Grind Stone
fireing();
active_tiles();
}
}
const interval = setInterval(function (){refresh();},67);
window.onload=function(){
	document.getElementsByTagName('body')[0].onkeydown=function (e){
		key_manager(e.keyCode);
	}
};
function _load(){
	var compressed_save=saves.getItem("_save");
	var save_file=JSON.parse(LZUTF8.decompress(compressed_save,{outputEncoding:"String",inputEncoding:"Base64"}));
	if(save_file==null){
	return;
    }
    cur_page=save_file[0];
    player=save_file[1];
    pages=save_file[2];
	tick1=save_file[3];
	player.days=(player.days===undefined)? 0 : player.days;
	dem_ann.textContent="Loaded. Size:"+compressed_save.length+" bytes.";
}
function _save(){
	if(saves.getItem("_save")!="empty"){
		if(!confirm("Save already exists, overwrite?")){
			return;
		}
	}
	var compressed_save=LZUTF8.compress(JSON.stringify([cur_page,player,pages,tick1]),{outputEncoding:"Base64"});
	saves.setItem("_save",compressed_save);
	dem_ann.textContent="Saved. Size:"+compressed_save.length+" bytes";
}
function _delete(){
	if(confirm("Delete Save?")){
		saves.setItem("_save","empty");
	}
}
function _import(){
	var compressed_save=prompt("Save?");
    var save_file=JSON.parse(LZUTF8.decompress(compressed_save,{outputEncoding:"String",inputEncoding:"Base64"}));
    if(save_file==null){
	return;
    }
    cur_page=save_file[0];
    player=save_file[1];
    pages=save_file[2];
	tick1=save_file[3];
	player.days=(player.days===undefined)? 0 : player.days;
	dem_ann.textContent="Loaded. Size:"+compressed_save.length+" bytes.";
}
function _export(){
	if(confirm("This will end your session.")){
		document.write(LZUTF8.compress(JSON.stringify([cur_page,player,pages,tick1]),{outputEncoding:"Base64"}));
	}
}
</script>
</html>
