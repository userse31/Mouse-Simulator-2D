<!-- Utilizes GNU GENERAL PUBLIC LICENSE 3. See "LICENSE" file for details -->
<html>
<head>
<!-- sound effects -->
<audio id="sfx" oncanplay="sfx_play()" type="audio/wav"></audio>
<title>Mouse Simulator 2D</title>
</head>
<body>
    <center>
    <canvas id="cga" width="320" height="200" style="border:2px solid #777777;width:320;height:200;image-rendering:pixelated;image-rendering:crisp-edges;"></canvas>
    <p id="player"></p>
    <p id="status">This paragraph tag is left intentionally blank.</p>
    <p id="demonic_announcer">Welcome!</p>
    <button onclick="_load()">Load</button><button onclick="_save()">Save</button><button onclick="_delete()">Delete</button><button onclick="_import()">Import</button><button onclick="_export()">Export</button><button onclick="config()">Config</button>
    </br>
	<a href="./help.html">Help</a>
	</br>
    <button onclick="alert(JSON.stringify(eval(prompt('Code?'))))">eval()</button>
    </center>
</body>
<script id="lzutf8" src="./lzutf8.min.js"></script>
<script>
//Mouse Simulator 2D v0.43
/*
creative tweaks
Tweak to how ticks are used and displayed.
Enemy chance stuff.
NPC Love.
*/
if(LZUTF8==undefined){
	alert("Unable to fetch 'lzutf8.min.js'. This is required to compress/decompress saves. Please make sure Mouse Simulator 2D can fetch this file.");
}
//autoconfig
function autoconfig(){
	var saves=window.localStorage;
	switch(saves.getItem("_bigger")){
		case "true":
			set_scaling(2);
			break;
		case "false":
			set_scaling(1);
			break;
	}
}
autoconfig();
function config(){
	var saves=window.localStorage;
	var bigger;
	if(confirm("Increase canvas size? (Hard of sight)")){
		set_scaling(2);
		bigger="true";
	}else{
		set_scaling(1);
		bigger="false";
	}
	saves.setItem("_bigger",bigger);
}
function set_scaling(scale){
	document.getElementById("cga").style.width=320*scale+"px";
	document.getElementById("cga").style.height=200*scale+"px";
}
var _sfx=document.getElementById("sfx");
function sfx_play(){
	_sfx.play();
}
function sfx(sound){
if(_sfx.paused==false){
	return;
}
	switch(sound){
		case "raygun_bang":
			_sfx.src="./sounds/raygun_bang.wav";
			break;
		case "raygun_cooldown":
			_sfx.src="./sounds/raygun_cooldown.wav";
			break;
		case "player_damaged":
			switch(Math.floor(Math.random()*65535)%2){
				case 0:
					_sfx.src="./sounds/squeak0.wav";
					break;
				case 1:
					_sfx.src="./sounds/squeak1.wav";
					break;
			}
			break;
	}
}

var cur_page=0;
var paused=0;
var last_dir="";
var player={brain:{gender:0.0, dysphoria:1, mode:1}, name:"Alex", x:1, y:1, health:20, strength:1, inv:[[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],0], creative:0, tainted:0};
//inventory: [(item id),(item amount)]; player.inv[10]=selected pointer
//maps
var pages=[{
	//home_page
	map:[
	[1,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,10,10,0,10,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,10,10,11,10,1],//craft bench
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,10,10,0,10,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,8,8,8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,7,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,13,0,0,0,0,0,0,7,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,17,0,16,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
	],
	entities:[
        {id:2, char:9, x:4, y:10, item: [1,10]},//branch
        {id:2, char:12, x:5, y:10, item: [2,10]},//hay
        {id:2, char:27, x:5, y:11, item: [12,10]},//stew
	],
	holes:[
		//holes
		{x:1, y:0, dest_page:-2, next_x: 19, next_y: 12},//gen new page
	],
	metadata:{
	safety:1,//Do enemies spawn here at night?
	north_goto:-1,//Next page to go to when leaving via north edge
	south_goto:-1,//Next page to go to when leaving via south edge
	west_goto:-1,//Next page to go to when leaving via west edge
	east_goto:-1,//Next page to go to when leaving via north edge
	x:0,
	y:0,
	underground:true,
	}
},
];

//the font/sprites
var font=[
//0, solid white
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,255,255,255
],
//1, solid black
[
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,0,0,0,255,255,255
],
//2, dither
[
0,1,0,1,0,1,0,1,
1,0,1,0,1,0,1,0,
0,1,0,1,0,1,0,1,
1,0,1,0,1,0,1,0,
0,1,0,1,0,1,0,1,
1,0,1,0,1,0,1,0,
0,1,0,1,0,1,0,1,
1,0,1,0,1,0,1,0,255,255,255,0,0,0
],
//3, Deer mouse/player
[
0,1,1,1,1,1,1,0,
1,1,1,1,1,1,1,1,
1,1,0,1,1,0,1,1,
1,1,1,1,1,1,1,1,
1,1,0,0,0,0,1,1,
1,1,1,0,0,1,1,1,
1,1,1,1,1,1,1,1,
0,1,1,1,1,1,1,0,185,122,87,255,255,255
],
//4	Enemy?
[
0,1,1,1,1,1,1,0,
1,1,1,1,1,1,1,1,
1,1,0,1,1,0,1,1,
1,1,1,1,1,1,1,1,
1,1,1,0,0,1,1,1,
1,1,0,0,0,0,1,1,
1,1,1,1,1,1,1,1,
0,1,1,1,1,1,1,0,185,122,87,255,255,255
],
//5, solid black, not invul
[
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,0,0,0,255,255,255
],
//6, hole	
[
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,0,0,1,1,1,
1,1,0,0,0,0,1,1,
1,1,0,0,0,0,1,1,
1,1,1,0,0,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,0,0,0,128,128,255
],
//7, bedding
[
1,0,1,0,1,0,1,0,
1,0,1,0,1,0,1,0,
0,1,0,1,0,1,0,1,
0,1,0,1,0,1,0,1,
1,0,1,0,1,0,1,0,
1,0,1,0,1,0,1,0,
0,1,0,1,0,1,0,1,
0,1,0,1,0,1,0,1,244,164,96,255,255,255
],
//8, bedding
[
0,0,1,0,0,0,0,0,
0,0,1,0,0,0,0,0,
0,0,0,1,0,0,0,1,
0,0,0,1,0,1,0,0,
0,0,1,0,1,0,1,0,
0,0,1,0,1,0,1,0,
0,1,0,1,0,1,0,1,
0,1,0,1,0,1,0,1,244,164,96,255,255,255
],
//9, Branch
[
0,0,0,0,0,0,0,0,
0,0,0,0,1,0,0,0,
0,0,1,0,1,0,1,0,
0,0,0,1,0,0,1,0,
0,0,0,0,1,1,0,0,
0,0,0,0,1,1,0,0,
0,0,1,1,0,0,1,0,
0,0,0,0,0,0,0,1,244,164,96,255,255,255
],
//10, craft_space
[
1,1,1,1,1,1,1,1,
1,0,0,0,0,0,0,1,
1,0,0,0,0,0,0,1,
1,0,0,0,0,0,0,1,
1,0,0,0,0,0,0,1,
1,0,0,0,0,0,0,1,
1,0,0,0,0,0,0,1,
1,1,1,1,1,1,1,1,0,0,0,255,255,255
],
//11, craft_arrow
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,1,0,0,
0,0,0,0,0,0,1,0,
0,1,1,1,1,1,1,1,
0,1,1,1,1,1,1,1,
0,0,0,0,0,0,1,0,
0,0,0,0,0,1,0,0,
0,0,0,0,0,0,0,0,0,0,0,255,255,255
],
//12, hay
[
0,0,0,1,1,0,0,0,
0,0,1,0,1,1,0,0,
0,1,0,1,0,1,1,0,
1,0,1,0,1,0,1,1,
1,1,0,1,0,1,0,1,
0,1,1,0,1,0,1,0,
0,0,1,0,0,1,0,0,
0,0,0,1,1,0,0,0,244,164,96,255,255,255
],
//13, Grass
[
0,1,0,1,0,1,0,1,
1,0,0,1,0,1,0,1,
1,0,0,1,0,0,1,0,
1,0,0,1,0,0,1,0,
0,1,1,0,0,1,0,1,
0,1,1,0,0,1,0,1,
1,0,0,1,0,1,0,1,
1,1,1,1,1,1,1,1,0,255,0,255,255,255
],
//14, Tree leaves
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,1,1,1,1,0,0,
0,1,1,1,1,1,1,0,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
0,1,1,1,1,1,1,0,0,255,0,255,255,255
],
//15, Tree trunk
[
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,1,1,1,1,0,0,
0,1,1,1,1,1,1,0,185,122,87,255,255,255
],
//16, brown mushroom
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,1,1,0,0,0,
0,0,1,1,1,1,0,0,
0,1,1,1,1,1,1,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,179,170,154,255,255,255
],
//17, red mushroom
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,1,1,0,0,0,
0,0,1,1,1,1,0,0,
0,1,1,1,1,1,1,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,255,0,0,255,255,255
],
//18, Fence
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
1,0,0,0,0,0,0,1,
1,0,0,0,0,0,0,1,
1,1,1,1,1,1,1,1,
1,0,0,0,0,0,0,1,
1,1,1,1,1,1,1,1,
1,0,0,0,0,0,0,1,185,122,87,255,255,255
],
//19, attack indicator/projectile
[
0,0,0,1,1,0,0,0,
0,1,0,1,1,0,1,0,
0,0,1,1,1,1,0,0,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
0,0,1,1,1,1,0,0,
0,1,0,1,1,0,1,0,
0,0,0,1,1,0,0,0,255,0,0,255,255,255
],
//20, raygun ring
[
0,0,0,0,0,0,0,0,
0,0,0,1,1,0,0,0,
0,0,1,0,0,1,0,0,
0,1,0,0,0,0,1,0,
0,1,0,0,0,0,1,0,
0,0,1,0,0,1,0,0,
0,0,0,1,1,0,0,0,
0,0,0,0,0,0,0,0,0,255,0,255,255,255
],
//21, stick
[
0,0,0,0,0,0,0,0,
0,1,1,0,0,0,0,0,
0,1,1,1,0,0,0,0,
0,0,1,1,1,0,0,0,
0,0,0,1,1,1,0,0,
0,0,0,0,1,1,1,0,
0,0,0,0,0,1,1,0,
0,0,0,0,0,0,0,0,185,122,87,255,255,255
],
//22, String
[
0,0,0,0,0,0,0,0,
0,0,0,1,1,0,0,0,
0,0,1,0,0,1,0,0,
0,1,0,0,0,0,0,0,
0,0,1,1,1,0,0,0,
0,0,0,0,0,1,0,0,
0,0,0,0,0,1,1,0,
0,0,0,0,0,0,0,0,0,0,0,255,255,255
],
//23, Bow
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,255,255,255
],
//24, Sapling.
[
0,1,0,0,1,0,1,0,
0,1,0,0,1,0,1,0,
0,0,1,1,1,1,0,0,
1,0,0,1,1,0,0,1,
0,1,1,1,1,1,1,0,
0,0,1,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,0,255,0,255,255,255
],
//25, Leaves
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,1,1,1,0,0,0,
0,0,1,1,1,1,0,0,
0,0,1,1,1,1,0,0,
0,0,0,1,1,1,0,0,
0,0,0,0,0,0,1,0,
0,0,0,0,0,0,0,0,0,255,0,255,255,255
],
//26, Bowl
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,1,0,0,0,0,1,0,
0,1,0,0,0,0,1,0,
0,0,1,0,0,1,0,0,
0,0,0,1,1,0,0,0,0,0,0,255,255,255
],
//27, Mushroom Stew
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,1,1,1,1,1,1,0,
0,1,1,1,1,1,1,0,
0,0,1,1,1,1,0,0,
0,0,0,1,1,0,0,0,0,0,0,255,255,255
],
//28, Carpet
[
1,0,1,0,1,0,1,0,
0,1,0,1,0,1,0,1,
1,0,1,0,1,0,1,0,
0,1,0,1,0,1,0,1,
1,0,1,0,1,0,1,0,
0,1,0,1,0,1,0,1,
1,0,1,0,1,0,1,0,
0,1,0,1,0,1,0,1,193,113,45,255,255,255
],
//29, water
[
1,1,0,0,1,1,1,1,
0,0,1,1,0,0,0,0,
1,1,0,0,1,1,1,1,
0,0,1,1,0,0,0,0,
1,1,0,0,1,1,1,1,
0,0,1,1,0,0,0,0,
1,1,0,0,1,1,1,1,
0,0,1,1,0,0,0,0,0,0,200,0,0,150
],
//30, fire 0
[
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,1,1,1,1,0,0,
0,0,1,1,1,1,0,0,
0,1,1,1,1,1,1,0,
0,1,1,1,1,1,1,0,
0,0,1,1,1,1,0,0,
0,0,0,1,1,0,0,0,200,0,0,255,255,255
],
//31, fire 1
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,1,1,1,1,0,0,
0,0,1,1,1,1,0,0,
0,0,1,1,1,1,0,0,
0,0,0,1,1,0,0,0,200,0,0,255,255,255
],
//32, fire 2
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,1,1,1,1,0,0,
0,0,1,1,1,1,0,0,200,0,0,255,255,255
],
//33, bow
[
0,0,0,0,0,0,0,0,
0,0,0,1,1,1,0,0,
0,0,1,0,1,0,0,0,
0,1,0,1,0,0,0,0,
0,1,1,0,0,0,0,0,
0,1,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,255,255,255
],
//34, bow and spindle
[
0,0,0,0,0,0,0,0,
0,0,0,1,1,1,0,0,
0,0,1,0,1,0,0,0,
0,1,0,1,0,0,1,0,
0,1,1,0,0,1,0,0,
0,1,0,0,1,0,0,0,
0,0,0,1,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,255,255,255
],
//35, Amber
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,1,1,1,0,0,
0,0,1,1,1,1,0,0,
0,0,1,1,1,1,0,0,
0,0,1,1,1,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,200,0,0,255,255,255
],
//36, Fire Bow
[
0,0,0,0,0,0,0,0,
0,0,0,1,1,1,0,0,
0,0,1,0,1,0,0,0,
0,1,0,1,0,0,0,0,
0,1,1,0,0,1,1,0,
0,1,0,0,1,1,1,0,
0,0,0,0,1,1,0,0,
0,0,0,0,0,0,0,0,0,0,0,255,255,255
],
//37, spear
[
0,0,0,0,0,0,0,0,
0,0,0,0,1,1,1,0,
0,0,0,0,0,1,1,0,
0,0,0,0,1,0,1,0,
0,0,0,1,0,0,0,0,
0,0,1,0,0,0,0,0,
0,1,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,185,122,87,255,255,255
],
//38, Raygun
[
0,0,0,0,0,0,0,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,1,1,1,1,0,0,
0,0,1,1,1,1,0,0,
0,0,1,1,1,1,0,0,
0,0,0,0,0,0,0,0,255,0,0,255,255,255
],
//39, Poisonous Spear
[
0,0,0,0,0,0,0,0,
0,0,0,0,1,1,1,0,
0,0,0,0,0,1,1,0,
0,0,0,0,1,0,1,0,
0,0,0,1,0,0,0,0,
0,0,1,0,0,0,0,0,
0,1,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,255,0,0,255,255,255
],
//40, Cyan Thing
[
0,0,0,0,0,0,1,0,
0,1,0,0,0,0,1,0,
0,0,0,1,1,0,0,0,
0,0,0,1,0,0,0,0,
0,1,0,0,0,0,0,0,
1,1,1,0,1,1,0,0,
0,1,0,0,1,1,0,0,
0,0,0,0,0,0,0,0,0,255,255,120,120,120
],
//41, stone
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,1,1,1,0,0,
0,0,1,1,1,1,0,0,
0,0,1,1,1,1,0,0,
0,0,1,1,1,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,120,120,120,255,255,255
],
//42, Door closed
[
0,1,1,1,1,1,1,0,
0,1,1,1,1,1,1,0,
0,1,1,1,1,1,1,0,
0,1,1,1,1,1,1,0,
0,1,1,1,1,1,1,0,
0,1,1,1,1,1,1,0,
0,1,1,1,1,1,1,0,
0,1,1,1,1,1,1,0,185,122,87,255,255,255
],
//43, Door open
[
0,1,1,1,1,1,1,0,
0,1,0,0,0,0,1,0,
0,1,0,0,0,0,1,0,
0,1,0,0,0,0,1,0,
0,1,0,0,0,0,1,0,
0,1,0,0,0,0,1,0,
0,1,0,0,0,0,1,0,
0,1,0,0,0,0,1,0,185,122,87,255,255,255
],
//44, npc hole
[
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,0,0,1,1,1,
1,1,0,0,0,0,1,1,
1,1,0,0,0,0,1,1,
1,1,1,0,0,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,0,0,0,255,255,255
],
//45, Walnut trunk
[
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,1,1,1,1,0,0,
0,1,1,1,1,1,1,0,165,102,67,255,255,255
],
//46, Walnut leaves 1 (middle)
[
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,0,215,0,255,255,255
],
//47, Walnut leaves 2 (left)
[
0,0,1,1,1,1,1,1,
0,0,1,1,1,1,1,1,
0,0,1,1,1,1,1,1,
0,0,1,1,1,1,1,1,
0,0,1,1,1,1,1,1,
0,0,1,1,1,1,1,1,
0,0,1,1,1,1,1,1,
0,0,0,1,1,1,1,1,0,215,0,255,255,255
],
//48, Walnut leaves 3 (right)
[
1,1,1,1,1,1,0,0,
1,1,1,1,1,1,0,0,
1,1,1,1,1,1,0,0,
1,1,1,1,1,1,0,0,
1,1,1,1,1,1,0,0,
1,1,1,1,1,1,0,0,
1,1,1,1,1,1,0,0,
1,1,1,1,1,0,0,0,0,215,0,255,255,255
],
//49, Walnut leaves 4 (top)
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,0,215,0,255,255,255
],
//50, Walnut leaves 5 (top left)
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,1,1,1,1,1,
0,0,1,1,1,1,1,1,
0,0,1,1,1,1,1,1,
0,0,1,1,1,1,1,1,
0,0,1,1,1,1,1,1,0,215,0,255,255,255
],
//51, Walnut leaves 6 (top right)
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
1,1,1,1,1,0,0,0,
1,1,1,1,1,1,0,0,
1,1,1,1,1,1,0,0,
1,1,1,1,1,1,0,0,
1,1,1,1,1,1,0,0,0,215,0,255,255,255
],
//52, walnut fruit
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,1,1,0,0,0,
0,0,1,1,1,1,0,0,
0,0,1,1,1,1,0,0,
0,0,0,1,1,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,160,0,255,255,255
],
//53, walnut stone
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,1,1,0,0,0,
0,0,1,1,1,1,0,0,
0,0,1,1,1,1,0,0,
0,0,0,1,1,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,165,102,67,255,255,255
],
//54, walnut peels
[
0,0,0,0,0,0,0,0,
0,0,0,1,1,0,0,0,
0,0,0,0,0,1,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,1,0,
0,1,0,0,0,0,1,0,
0,0,1,1,0,0,0,0,
0,0,0,0,0,0,0,0,0,160,0,255,255,255
],
//55, Bone meal
[
0,0,0,0,0,0,0,0,
0,1,0,1,0,0,0,0,
0,0,0,0,1,0,0,0,
0,0,0,1,0,1,1,0,
0,0,0,1,0,0,1,0,
0,1,0,0,1,0,1,0,
0,0,1,1,1,0,0,0,
0,0,0,0,0,0,0,0,160,160,160,255,255,255
],
//56, Fibers
[
0,0,0,0,0,0,0,0,
0,1,0,0,1,0,1,0,
0,1,0,0,1,0,1,0,
0,0,1,0,1,0,1,0,
0,0,1,0,0,1,0,0,
1,0,1,1,0,1,0,0,
1,0,0,1,0,1,0,0,
0,0,0,0,0,0,0,0,0,160,0,255,255,255
],
//57, book
[
0,0,0,0,0,0,0,0,
0,0,0,0,1,0,0,0,
0,0,0,1,1,1,0,0,
0,0,1,1,1,1,1,0,
0,1,1,1,1,1,0,0,
0,0,1,1,1,0,0,0,
0,0,0,1,0,0,0,0,
0,0,0,0,0,0,0,0,139,69,19,255,255,255
],
//58, bookshelf
[
1,1,1,1,1,1,1,1,
1,0,1,0,1,0,0,1,
1,0,1,0,1,0,0,1,
1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,
1,0,1,0,0,1,0,1,
1,0,1,0,0,1,0,1,
1,1,1,1,1,1,1,1,165,102,67,255,255,255
],
//59, Paper
[
0,0,0,0,0,0,0,0,
0,0,0,0,1,0,0,0,
0,0,0,1,1,1,0,0,
0,0,1,1,1,1,1,0,
0,1,1,1,1,1,0,0,
0,0,1,1,1,0,0,0,
0,0,0,1,0,0,0,0,
0,0,0,0,0,0,0,0,160,160,160,255,255,255
],
//60, Iron
[
0,0,0,0,0,0,0,0,
0,0,0,0,1,0,0,0,
0,0,0,1,1,1,0,0,
0,0,1,1,1,1,1,0,
0,1,1,1,1,1,0,0,
0,0,1,1,1,0,0,0,
0,0,0,1,0,0,0,0,
0,0,0,0,0,0,0,0,211,211,211,255,255,255
],
//61, Meat
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,1,1,0,
0,0,0,0,1,1,1,1,
0,0,0,0,1,1,1,1,
0,0,1,1,1,1,1,1,
0,1,1,1,1,1,1,0,
0,1,1,1,1,1,0,0,
0,0,1,1,1,0,0,0,249,144,111,255,255,255
],
//62, Copper
[
0,0,0,0,0,0,0,0,
0,0,0,0,1,0,0,0,
0,0,0,1,1,1,0,0,
0,0,1,1,1,1,1,0,
0,1,1,1,1,1,0,0,
0,0,1,1,1,0,0,0,
0,0,0,1,0,0,0,0,
0,0,0,0,0,0,0,0,184,115,51,255,255,255
],
//63, Cooked Meat
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,1,1,0,
0,0,0,0,1,1,1,1,
0,0,0,0,1,1,1,1,
0,0,1,1,1,1,1,1,
0,1,1,1,1,1,1,0,
0,1,1,1,1,1,0,0,
0,0,1,1,1,0,0,0,76,32,5,255,255,255
],
//64, Iron Wall
[
0,0,0,0,0,0,0,0,
0,1,1,1,1,1,1,0,
0,1,1,1,1,1,1,0,
0,1,1,1,1,1,1,0,
0,1,1,1,1,1,1,0,
0,1,1,1,1,1,1,0,
0,1,1,1,1,1,1,0,
0,0,0,0,0,0,0,0,211,211,211,160,160,160
],
//65, Copper Wall
[
0,0,0,0,0,0,0,0,
0,1,1,1,1,1,1,0,
0,1,1,1,1,1,1,0,
0,1,1,1,1,1,1,0,
0,1,1,1,1,1,1,0,
0,1,1,1,1,1,1,0,
0,1,1,1,1,1,1,0,
0,0,0,0,0,0,0,0,184,115,51,169,100,26
],
//66, Bowl of Water
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,1,1,1,1,1,1,0,
0,1,1,1,1,1,1,0,
0,0,1,1,1,1,0,0,
0,0,0,1,1,0,0,0,0,0,255,255,255,255
],
//67, Suspicious Stew
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,1,1,1,1,1,1,0,
0,1,1,1,1,1,1,0,
0,0,1,1,1,1,0,0,
0,0,0,1,1,0,0,0,0,255,255,255,255,255
],
//68, Camp Fire
[
0,0,0,1,1,0,0,0,
0,0,0,1,1,0,0,0,
0,0,1,1,1,1,0,0,
0,0,1,1,1,1,0,0,
0,0,0,0,0,0,0,0,
0,1,1,0,0,1,1,0,
0,0,0,1,1,0,0,0,
0,1,1,0,0,1,1,0,200,0,0,255,255,255
],
//69, Saw Dust
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,1,0,1,0,0,
0,0,1,0,1,0,1,0,
0,1,0,1,0,1,0,0,
0,0,1,0,1,0,1,0,
0,0,0,1,0,1,0,0,185,122,87,255,255,255
],
//70, Bowl of Glue
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,1,1,1,1,1,1,0,
0,1,1,1,1,1,1,0,
0,0,1,1,1,1,0,0,
0,0,0,1,1,0,0,0,200,200,0,255,255,255
],
//71, mdf puddy
[
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,1,1,1,0,0,
0,0,1,1,1,1,1,0,
0,1,1,1,1,1,1,0,
0,1,1,1,1,1,1,0,
0,0,1,1,1,1,0,0,185,122,87,255,255,255
],
//72, mdf
[
1,1,1,1,0,1,1,1,
0,0,0,0,0,0,0,0,
1,1,0,1,1,1,1,1,
0,0,0,0,0,0,0,0,
1,1,1,1,1,0,1,1,
0,0,0,0,0,0,0,0,
1,1,1,0,1,1,1,1,
0,0,0,0,0,0,0,0,185,122,87,200,137,102
],
//73, Grind Stone
[
0,0,0,0,0,0,0,0,
0,0,0,1,1,1,0,0,
0,0,1,1,1,1,0,0,
0,0,1,1,1,1,0,0,
0,0,1,1,1,0,0,0,
0,0,0,0,0,0,0,0,
0,1,1,1,1,1,1,0,
0,1,1,1,1,1,1,0,120,120,120,255,255,255
],
//74, green stained mdf
[
1,1,1,1,0,1,1,1,
0,0,0,0,0,0,0,0,
1,1,0,1,1,1,1,1,
0,0,0,0,0,0,0,0,
1,1,1,1,1,0,1,1,
0,0,0,0,0,0,0,0,
1,1,1,0,1,1,1,1,
0,0,0,0,0,0,0,0,93,141,46,108,156,61
],
//75, Red stained mdf
[
1,1,1,1,0,1,1,1,
0,0,0,0,0,0,0,0,
1,1,0,1,1,1,1,1,
0,0,0,0,0,0,0,0,
1,1,1,1,1,0,1,1,
0,0,0,0,0,0,0,0,
1,1,1,0,1,1,1,1,
0,0,0,0,0,0,0,0,220,61,44,235,76,59
],
//76, Cyan Stained mdf
[
1,1,1,1,0,1,1,1,
0,0,0,0,0,0,0,0,
1,1,0,1,1,1,1,1,
0,0,0,0,0,0,0,0,
1,1,1,1,1,0,1,1,
0,0,0,0,0,0,0,0,
1,1,1,0,1,1,1,1,
0,0,0,0,0,0,0,0,93,189,171,108,204,186
],
];
var properties={
walkable:[0,2,6,7,8,9,10,11,13,14,15,16,17,24,28,29,30,31,32,38,40,43,44,45,46,47,48,49,50,51,52,54,68,73],
not_spawnable:[2,28,29,30,31,32,43,68,73],
burnable:[12,13,14,15,18,24,28,42,43,45,46,47,48,49,50,51,72,74,75,76],
bangable:[18,42,43,12,5],
breakable:[3,4,5,6,9,13,21,22,24,25,27,31,37,38,41,45,46,47,48,49],
bonemealable:[52,51,50,49,48,47,46,24,17,16,15,13],
creative_noremove:[1,6,10,11],
};
var item_drops={
enemy:[
{chance:0.3,item_id:34,item_min:1,item_max:1},//Meat
{chance:0.05,item_id:33,item_min:1,item_max:1},//iron
{chance:0.05,item_id:35,item_min:1,item_max:1},//copper
{chance:0.01,item_id:21,item_min:1,item_max:1},//cyan thing, 115
]};

//items
var item_char=[
0,//Nothing,0
9,//Branch,1
12,//Hay,2
13,//Grass,3
16,//Brown Mushroom,4
17,//Red Mushroom,5
18,//Fence,6
21,//stick,7
22,//string,8
24,//Sapling,9
25,//Leaves,10
26,//Bowl,11
27,//Mushroom Stew,12
28,//Carpet,13
33,//Bow,14
34,//Bow and spindle,15
35,//Amber,16
36,//Fire bow, 17
37,//Spear,18
38,//Raygun,19
39,//Poisonous Spear, 20
40,//cyan thing, 21
42,//Door, 22
41,//Stone, 23
12,//hay bail, 24
52,//walnut fruit, 25
53,//walnut stone, 26
54,//walnut peels, 27
55,//bone meal, 28
56,//Fibers, 29
57,//Book, 30
58,//Bookshelf, 31
59,//Paper, 32
60,//Iron,33
61,//Meat,34
62,//Copper,35
63,//Cooked Meat,36
64,//Iron Wall,37
65,//Copper Wall,38
66,//Bowl of Water,39
67,//Suspicious Stew,40
68,//Camp Fire,41
69,//Saw Dust,42
70,//Bowl of Glue,43
71,//mdf puddy,44
72,//mdf,45
73,//Grind Stone,46
74,//Green Stained MDF,47
75,//Red Stained MDF,48
76,//Cyan Stained MDF,49
5,//Black Wall,50
7,//bedding 1,51
8,//bedding 2,52
14,//Tree leaves,53
15,//Tree Trunk,54
29,//Water,55
30,//Fire 0,56
31,//Fire 1,57
32,//Fire 2,58
44,//NPC Hole,59
45,//Walnut Trunk,60
46,//Walnut Leaves 1,61
47,//Walnut Leaves 2,62
48,//Walnut Leaves 3,63
49,//Walnut Leaves 4,64
50,//Walnut Leaves 5,65
51,//Walnut Leaves 6,66
];

var item_names=[
"Nothing",
"Branch",
"Hay",
"Grass",
"Brown Mushroom",
"Red Mushroom",
"Fence",
"Stick",
"String",
"Sapling",
"Leaves",
"Bowl",
"Mushroom Stew",
"Carpet",
"Bow",
"Bow and Spindle",
"Amber",
"Fire Bow",
"Spear",
"Raygun",
"Poisonous Spear",
"Cyan Thing",
"Door",
"Stone",
"Hay Bail",
"Walnut Fruit",
"Walnut Stone",
"Walnut Peels",
"Bone Meal",
"Fibers",
"Book",
"Bookshelf",
"Paper",
"Iron",
"Meat",
"Copper",
"Cooked Meat",
"Iron Wall",
"Copper Wall",
"Bowl of Water",
"Suspicious Stew",
"Camp Fire",
"Saw Dust",
"Bowl of Glue",
"MDF Puddy",
"MDF",
"Grind Stone",
"Green Stained MDF",
"Red Stained MDF",
"Cyan Stained MDF",
"Black Wall",
"bedding 1",
"bedding 2",
"Tree Leaves",
"Tree Trunk",
"Water",
"Fire 0",
"Fire 1",
"Fire 2",
"NPC Hole",
"Walnut Trunk",
"Walnut Leaves 1",
"Walnut Leaves 2",
"Walnut Leaves 3",
"Walnut Leaves 4",
"Walnut Leaves 5",
"Walnut Leaves 6"
];
//crafting
var recipies=[
{//sapling to stick+leaves
input_id:[9,0,0,0,0,0],
output:[[7,1],[10,1]]
},
{//sapling to stick+leaves
input_id:[0,9,0,0,0,0],
output:[[7,1],[10,1]]
},
{//sapling to stick+leaves
input_id:[0,0,9,0,0,0],
output:[[7,1],[10,1]]
},
{//sapling to stick+leaves
input_id:[0,0,0,9,0,0],
output:[[7,1],[10,1]]
},
{//sapling to stick+leaves
input_id:[0,0,0,0,9,0],
output:[[7,1],[10,1]]
},
{//sapling to stick+leaves
input_id:[0,0,0,0,0,9],
output:[[7,1],[10,1]]
},
{//branch to stick+leaves
input_id:[1,0,0,0,0,0],
output:[[7,1],[10,1]]
},
{//branch to stick+leaves
input_id:[0,1,0,0,0,0],
output:[[7,1],[10,1]]
},
{//branch to stick+leaves
input_id:[0,0,1,0,0,0],
output:[[7,1],[10,1]]
},
{//branch to stick+leaves
input_id:[0,0,0,1,0,0],
output:[[7,1],[10,1]]
},
{//branch to stick+leaves
input_id:[0,0,0,0,1,0],
output:[[7,1],[10,1]]
},
{//branch to stick+leaves
input_id:[0,0,0,0,0,1],
output:[[7,1],[10,1]]
},
{//hay to string
input_id:[2,0,0,0,0,0],
output:[[8,3]]
},
{//hay to string
input_id:[0,2,0,0,0,0],
output:[[8,3]]
},
{//hay to string
input_id:[0,0,2,0,0,0],
output:[[8,3]]
},
{//hay to string
input_id:[0,0,0,2,0,0],
output:[[8,3]]
},
{//hay to string
input_id:[0,0,0,0,2,0],
output:[[8,3]]
},
{//hay to string
input_id:[0,0,0,0,0,2],
output:[[8,3]]
},
{//2 sticks + 1 string to fence
input_id:[7,0,8,0,7,0],
output:[[6,3]]
},
{//2 sticks + 1 string to fence
input_id:[0,7,0,8,0,7],
output:[[6,3]]
},
{//2 string + 1 leaves to bowl
input_id:[8,0,10,0,8,0],
output:[[11,1]]
},
{//2 string + 1 leaves to bowl
input_id:[0,8,0,10,0,8],
output:[[11,1]]
},
{//bowl + brown mushroom to mushroom stew
input_id:[0,0,4,0,11,0],
output:[[11,1]]
},
{//bowl + brown mushroom to mushroom stew
input_id:[4,0,11,0,0,0],
output:[[12,1]]
},
{//4 grass to hay
input_id:[3,3,3,3,0,0],
output:[[2,1]]
},
{//4 grass to hay
input_id:[0,0,3,3,3,3],
output:[[2,1]]
},
{//4 string + 2 hay to carpet
input_id:[8,8,2,2,8,8],
output:[[13,1]]
},
{//bow
input_id:[7,0,8,7,7,0],
output:[[14,1]]
},
{//bow
input_id:[0,7,7,8,0,7],
output:[[14,1]]
},
{//bow+stick to bow and spindle
input_id:[14,7,0,0,0,0],
output:[[15,1]]
},
{//bow and spindle+hay+stick to amber and bow and spindle
input_id:[15,2,1,0,0,0],
output:[[15,1],[16,5]]
},
{//bow + amber to fire bow
input_id:[14,16,16,16,16,16],
output:[[17,5]]
},
{//2 sticks+iron to spear.
input_id:[33,0,7,0,7,0],
output:[[18,1]]
},
{//2 sticks+iron to spear.
input_id:[0,33,0,7,0,7],
output:[[18,1]]
},
{//Spear+Red Mushroom to Poisonous Spear.
input_id:[18,5,0,0,0,0],
output:[[20,1]]
},
{//6 sticks to door.
input_id:[7,7,7,7,7,7],
output:[[22,1]]
},
{//6 hay to hay bail.
input_id:[2,2,2,2,2,2],
output:[[24,1]]
},
{//hay bail to 6 hay.
input_id:[24,0,0,0,0,0],
output:[[2,6]]
},
{//hay bail to 6 hay.
input_id:[0,24,0,0,0,0],
output:[[2,6]]
},
{//hay bail to 6 hay.
input_id:[0,0,24,0,0,0],
output:[[2,6]]
},
{//hay bail to 6 hay.
input_id:[0,0,0,24,0,0],
output:[[2,6]]
},
{//hay bail to 6 hay.
input_id:[0,0,0,0,24,0],
output:[[2,6]]
},
{//hay bail to 6 hay.
input_id:[0,0,0,0,0,24],
output:[[2,6]]
},
{//Walnut fruit to walnut stone and peels
input_id:[25,0,0,0,0,0],
output:[[26,1],[27,1]]
},
{//Walnut fruit to walnut stone and peels
input_id:[0,25,0,0,0,0],
output:[[26,1],[27,1]]
},
{//Walnut fruit to walnut stone and peels
input_id:[0,0,25,0,0,0],
output:[[26,1],[27,1]]
},
{//Walnut fruit to walnut stone and peels
input_id:[0,0,0,25,0,0],
output:[[26,1],[27,1]]
},
{//Walnut fruit to walnut stone and peels
input_id:[0,0,0,0,25,0],
output:[[26,1],[27,1]]
},
{//Walnut fruit to walnut stone and peels
input_id:[0,0,0,0,0,25],
output:[[26,1],[27,1]]
},
{//Brown mushroom+red mushroom to Bone meal
input_id:[4,0,10,0,5,0],
output:[[28,3]]
},
{//Brown mushroom+red mushroom to Bone meal
input_id:[0,4,0,10,0,5],
output:[[28,3]]
},
{//Brown mushroom+red mushroom to Bone meal
input_id:[5,0,10,0,4,0],
output:[[28,3]]
},
{//Brown mushroom+red mushroom to Bone meal
input_id:[0,5,0,10,0,4],
output:[[28,3]]
},
{//stone+5 leaves to 3 Fibers+stone
input_id:[23,10,10,10,10,10],
output:[[23,1],[29,3]]
},
{//6 fibers to paper
input_id:[29,29,29,29,29,29],
output:[[32,1]]
},
{//3 Paper+String to book
input_id:[8,32,32,32,0,0],
output:[[30,1]]
},
{//4 MDF+2 Books to Bookshelf
input_id:[45,45,30,30,45,45],
output:[[31,1]],
},
{//1 meat+amber to cooked meat.
input_id:[34,16,0,0,0,0],
output:[[36,1]],
},
{//6 iron to iron wall
input_id:[33,33,33,33,33,33],
output:[[37,1]],
},
{//iron wall to 6 iron
input_id:[37,0,0,0,0,0],
output:[[33,6]],
},
{//iron wall to 6 iron
input_id:[0,37,0,0,0,0],
output:[[33,6]],
},
{//iron wall to 6 iron
input_id:[0,0,37,0,0,0],
output:[[33,6]],
},
{//iron wall to 6 iron
input_id:[0,0,0,37,0,0],
output:[[33,6]],
},
{//iron wall to 6 iron
input_id:[0,0,0,0,37,0],
output:[[33,6]],
},
{//iron wall to 6 iron
input_id:[0,0,0,0,0,37],
output:[[33,6]],
},
{//6 copper to copper wall
input_id:[35,35,35,35,35,35],
output:[[38,1]],
},
{//copper wall to 6 copper
input_id:[38,0,0,0,0,0],
output:[[35,6]],
},
{//copper wall to 6 copper
input_id:[0,38,0,0,0,0],
output:[[35,6]],
},
{//copper wall to 6 copper
input_id:[0,0,38,0,0,0],
output:[[35,6]],
},
{//copper wall to 6 copper
input_id:[0,0,0,38,0,0],
output:[[35,6]],
},
{//copper wall to 6 copper
input_id:[0,0,0,0,38,0],
output:[[35,6]],
},
{//copper wall to 6 copper
input_id:[0,0,0,0,0,38],
output:[[35,6]],
},
{//Amber+Bowl of Water+Brown Mushroom+Red Mushroom to Suspicious Stew
input_id:[4,5,39,21,16,0],
output:[[40,1]],
},
{//Amber+Bowl of Water+Brown Mushroom+Red Mushroom to Suspicious Stew
input_id:[5,4,39,21,16,0],
output:[[40,1]],
},
{//Amber+2 Sticks to Camp Fire
input_id:[16,7,7,0,0,0],
output:[[41,1]],
},
{//stone+stick to sawdust+stone
input_id:[23,7,0,0,0,0],
output:[[42,3],[23,1]]
},
{//stone+fence to sawdust+stone
input_id:[23,6,0,0,0,0],
output:[[42,3],[23,1]]
},
{//stone+bowl to sawdust+stone
input_id:[23,11,0,0,0,0],
output:[[42,3],[23,1]]
},
{//stone+door to sawdust+stone
input_id:[23,22,0,0,0,0],
output:[[42,3],[23,1]]
},
{//Bowl of Water+fibers to bowl of glue
input_id:[39,29,0,0,0,0],
output:[[43,1]]
},
{//bowl of glue+sawdust to mdf puddy+bowl
input_id:[43,42,0,0,0,0],
output:[[44,1],[11,1]]
},
{//Stone+iron to Grind Stone
input_id:[23,0,33,0,0,0],
output:[[46,1]]
},
{//MDF+walnut peels to Green Stained MDF
input_id:[45,27,0,0,0,0],
output:[[47,1]]
},
{//MDF+walnut peels to Red Stained MDF
input_id:[45,5,0,0,0,0],
output:[[48,1]]
},
{//MDF+Cyan thing to Cyan Stained MDF
input_id:[45,21,0,0,0,0],
output:[[49,1]]
}
];

var struct=[
{weight:0.8,tries:10,sub:[0,1],id:0},//tree
{weight:0.6,tries:1,sub:[2,2],id:9},//walnut tree
{weight:0.8,tries:10,sub:[0,0],id:1},//grass
{weight:0.1,tries:3,sub:[0,0],id:10},//brown mushroom
{weight:0.1,tries:3,sub:[0,0],id:11},//red mushroom
{weight:0.01,tries:1,sub:[1,1],id:2},//115
{weight:0.2,tries:1,sub:[4,4],id:3},//abandoned shed
{weight:-1,tries:2,sub:[0,0],id:4},//hole
{weight:0.1,tries:2,sub:[3,3],id:5},//pond
{weight:0.01,tries:1,sub:[0,0],id:6},//raygun
{weight:0.1,tries:1,sub:[11,5],id:7},//facility
{weight:0.3,tries:1,sub:[2,2],id:8,entity:{offset_x:1,offset_y:1}},//Mouse Nest
];

var structures=[
//tree,0
[
[14],
[15]
],
//grass, 1
[
[13]
],
//115, 2
[
[40]
],
//Human_abandoned_shed, 3
[
[5,5,5,0,5],
[13,28,28,28,5],
[5,28,28,28,13],
[5,28,28,28,5],
[5,2,5,5,5],
],
//hole, 4
[
[0,2,0],
[2,6,2],
[0,2,0]
],
//pond,5
[
[0,29,29,0],
[29,29,29,29],
[29,29,29,29],
[0,29,29,0],
],
//raygun,6
[
[38]
],
//group 935, 7
[
[5,5,5,2,5,5,5,5,5,5,5,5],
[5,13,13,30,13,13,13,13,13,13,13,5],
[5,13,13,13,13,13,13,13,14,13,13,5],
[14,13,13,13,13,13,13,13,15,13,13,5],
[5,13,13,13,13,13,13,13,13,13,13,5],
[5,5,5,5,13,5,5,5,5,5,5,5],
],
//mouse nest (ncp), 8
[
[0,7,0],
[7,44,7],
[0,7,0],
],
//walnut tree, 9
[
[50,49,51],
[47,46,48],
[0,45,0],
],
//brown mushroom, 10
[[16]],
//red mushroom, 11
[[17]],
];

var ctx=document.getElementById("cga").getContext("2d");
var char=ctx.getImageData(0,0,8,8);
function write_1bit(pos,val,r1,g1,b1,r2,g2,b2){
	if(!val){
		char.data[4*pos]=r2;
		char.data[4*pos+1]=g2;
		char.data[4*pos+2]=b2;
		char.data[4*pos+3]=255;
		return 0;
	}
	if(val){
		char.data[4*pos]=r1
		char.data[4*pos+1]=g1;
		char.data[4*pos+2]=b1;
		char.data[4*pos+3]=255;
		return 0;
	}
}
function get_font(val){
for(var i=0;i<64;i++){
write_1bit(i,font[val][i],font[val][64],font[val][65],font[val][66],font[val][67],font[val][68],font[val][69]);
}
return val;
}
function draw_map(){
	//block map
	for(var x=0;x<40;x++){
		for(var y=0;y<25;y++){
			get_font(pages[cur_page].map[y][x]);
			ctx.putImageData(char,x*8,y*8);
		}
	}
	//entity map
	for(var i=0;i<pages[cur_page].entities.length;i++){
	   get_font(pages[cur_page].entities[i].char);
	   ctx.putImageData(char,pages[cur_page].entities[i].x*8,pages[cur_page].entities[i].y*8);
	}
	//player
	get_font(3);
	ctx.putImageData(char,player.x*8,player.y*8);
}

function item_id_from_name(str){
	str=str.toLowerCase();
	for(var i=0;i<item_names.length;i++){
		if(str==item_names[i].toLowerCase()){
			return i;
		}
	}
	return -1;
}

function damage_player(amount){
	player.creative==1 ? 0 : player.health-=amount;
	sfx("player_damaged");
}

function item_roulette(drop_list,_x,_y){
for(var i=0;i<drop_list.length;i++){
	if(Math.random()<=drop_list[i].chance){
		pages[cur_page].entities.push({id:2,x:_x,y:_y,char:item_char[drop_list[i].item_id],item:[drop_list[i].item_id,(Math.floor(Math.random()*65535)%drop_list[i].item_max)+drop_list[i].item_min]});
		combine_items(_x,_y,drop_list[i].item_id);
	}
}
}

function drop_set_selection(set,x,y){
switch(set){
	case "enemy":
		item_roulette(item_drops.enemy,x,y);
		break;
}
}

function npc_drops(ptr){//items to drop after npc death.
//id=1
switch(pages[cur_page].entities[ptr].char){
	case 4://enemy
		drop_set_selection("enemy",pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y);
		break;
	default:
		break;
}
}

function combine_items(_x,_y,item_id){//Reduce memory usage and improve the user experience by combining dropped items of the same type together.
	var ptrs=[];
	for(var i=0;i<pages[cur_page].entities.length;i++){
		if(pages[cur_page].entities[i].id==2){
			if(pages[cur_page].entities[i].x==_x && pages[cur_page].entities[i].y==_y && pages[cur_page].entities[i].item[0]==item_id){
				ptrs.push(i);
			}
		}
	}
	var total_amount=0;
	for(var i=0;i<ptrs.length;i++){
		total_amount+=pages[cur_page].entities[ptrs[i]].item[1];
		pages[cur_page].entities[ptrs[i]].id=-1;
	}
	pages[cur_page].entities.push({id:2, x:_x, y:_y, char:item_char[item_id], item: [item_id,total_amount]});
}

function new_npc(_x,_y,_home_x,_home_y){
//id:1, char:3, x:24,y:5, brain: {no_ai:0, hostile: 0}, health:20, strength:1, attack_cooldown:0, dest_x:24, dest_y:15
var new_boi={id:1, char:3, x:_x,y:_y, brain: {no_ai:0,hostile:0,identity:{gender:0,dysphoria:0,love_mode:0},home_x:_home_x,home_y:_home_y}, health:20, strength:1, attack_cooldown:0, dest_x:_x, dest_y:_y};
new_boi.brain.identity.gender=Math.floor(Math.random()*100)%2;
new_boi.brain.identity.dysphoria=(Math.floor(Math.random()*100)%100)<10;
pages[cur_page].entities.push(new_boi);
return pages[cur_page].entities.length-1;
}

function struct_copy(struct_id,offset_x,offset_y,fill_nonzero=1){
	for(var y=0;y<structures[struct_id].length;y++){
		for(var x=0;x<structures[struct_id][y].length;x++){
			if(hit_bounds(offset_x+x,offset_y+y)){
				continue;
			}
			if(char_value(offset_x+x,offset_y+y)!=0 && fill_nonzero==0){
				continue;
			}
			pages[cur_page].map[offset_y+y][offset_x+x]=structures[struct_id][y][x];
		}
	}
}

function generate_stuff(){
	var rand_x=0;
	var rand_y=0;
	var rand_action=0;
	//structures
	for(var i=0;i<struct.length;i++){
		for(var j=0;j<struct[i].tries;j++){
		if(struct.weight==-1){
			continue;
		}
		rand_x=Math.floor(Math.random()*100)%(40-struct[i].sub[0]);
		rand_y=Math.floor(Math.random()*100)%(25-struct[i].sub[1]);
		if(char_value(rand_x,rand_y)==0){
			if(Math.random()<struct[i].weight){
				struct_copy(struct[i].id,rand_x,rand_y);
				if(struct[i].entity!=undefined){//entities
					new_npc(rand_x+struct[i].entity.offset_x,rand_y+struct[i].entity.offset_y,rand_x+struct[i].entity.offset_x,rand_y+struct[i].entity.offset_y);
				}
			}
		}
		}
	}
}

//if two pages next to each other, link them.
function check_page_sides(){
	if(pages[cur_page].metadata.underground==true){
		return;
	}
	var x=pages[cur_page].metadata.x;
	var y=pages[cur_page].metadata.y;
	for(var i=2;i<pages.length;i++){
		//Above
		if(pages[i].metadata.x==pages[cur_page].metadata.x && pages[i].metadata.y==pages[cur_page].metadata.y-1){
			pages[cur_page].metadata.north_goto=i;
		}
		//Below
		if(pages[i].metadata.x==pages[cur_page].metadata.x && pages[i].metadata.y==pages[cur_page].metadata.y+1){
			pages[cur_page].metadata.south_goto=i;
		}
		//left
		if(pages[i].metadata.x==pages[cur_page].metadata.x-1 && pages[i].metadata.y==pages[cur_page].metadata.y){
			pages[cur_page].metadata.west_goto=i;
		}
		//right
		if(pages[i].metadata.x==pages[cur_page].metadata.x+1 && pages[i].metadata.y==pages[cur_page].metadata.y){
			pages[cur_page].metadata.east_goto=i;
		}
	}
}

function get_ptr_from_page_xy(x,y){
	for(var i=0;i<pages.length;i++){
		if(pages[i].metadata.x==x && pages[i].metadata.y==y){
			if(pages[i].metadata.underground==true){
				continue;
			}
			return i;
		}
	}
	return -1;
}

function new_page(hole_from=-1,direction="none"){
	var old_cur_page=cur_page;
	var n_page={map:new Array(25),entities:[],holes:[],metadata:{safety:0, north_goto:-2, south_goto:-2, west_goto:-2, east_goto:-2, x:pages[cur_page].metadata.x,y:pages[cur_page].metadata.y,underground:false}};
	for(var i=0;i<25;i++){
		n_page.map[i]=new Array(40);
	}
	for(var j=0;j<25;j++){
		for(var i=0;i<40;i++){
			n_page.map[j][i]=0;
		}
	}
	pages.push(n_page);
	if(hole_from==-1){
		switch(direction){//direction _entering_ new page
	    case "none":
		struct_copy(4,18,11);
		pages[cur_page].holes.push({x:19, y:12, dest_page:old_cur_page, next_x: 1, next_y: 0});
		pages[cur_page].metadata.x=0;
		pages[cur_page].metadata.y=0;
	    	break;
	    case "up"://up
	    	pages[cur_page].metadata.north_goto=pages.length-1;
	    	break;
	    case "down"://down
	    	pages[cur_page].metadata.south_goto=pages.length-1;
	    	break;
	    case "left"://left
	    	pages[cur_page].metadata.west_goto=pages.length-1;
	    	break;
	    case "right"://right
	    	pages[cur_page].metadata.east_goto=pages.length-1;
	    	break;
	    }
	}else{
		pages[cur_page].holes[hole_from].dest_page=pages.length-1;
	}
	cur_page=pages.length-1;
	generate_stuff();
	switch(direction){//direction _entering_ new page
	    case "none":
		struct_copy(4,18,11);
		n_page.holes.push({x:19, y:12, dest_page:old_cur_page, next_x: 1, next_y: 0});
	    	break;
	    case "up"://up
	    	pages[cur_page].metadata.south_goto=old_cur_page;
		pages[cur_page].metadata.x;
		pages[cur_page].metadata.y--;
	    	break;
	    case "down"://down
	    	pages[cur_page].metadata.north_goto=old_cur_page;
		pages[cur_page].metadata.x;
		pages[cur_page].metadata.y++;
	    	break;
	    case "left"://left
	    	pages[cur_page].metadata.east_goto=old_cur_page;
		pages[cur_page].metadata.x--;
		pages[cur_page].metadata.y;
	    	break;
	    case "right"://right
	    	pages[cur_page].metadata.west_goto=old_cur_page;
		pages[cur_page].metadata.x++;
		pages[cur_page].metadata.y;
	    	break;
	}
	check_page_sides();
}

function teleport(){
for(var i=0;i<pages[cur_page].holes.length;i++){
	if(pages[cur_page].holes[i].x==player.x && pages[cur_page].holes[i].y==player.y){
		if(pages[cur_page].holes[i].dest_page==-1){//go nowhere
			return;
		}
		if(pages[cur_page].holes[i].dest_page==-2){//gen new page
			player.x=pages[cur_page].holes[i].next_x;
			player.y=pages[cur_page].holes[i].next_y;
	    		new_page(i);
			return;
		}
		player.x=pages[cur_page].holes[i].next_x;
		player.y=pages[cur_page].holes[i].next_y;
		cur_page=pages[cur_page].holes[i].dest_page;
	    	break;
	}
}
}

function off_edge(direction){//generate new page when walking off map and page edge metadata = -2
check_page_sides();
var edge_action=-3
var next_x=player.x;
var next_y=player.y
switch(direction){
	case "up":
	    edge_action=pages[cur_page].metadata.north_goto;
		next_y=24;
	    	break;
	case "down":
		edge_action=pages[cur_page].metadata.south_goto;
		next_y=0;
	    	break;
	case "left":
		edge_action=pages[cur_page].metadata.west_goto;
		next_x=39;
	    	break;
	case "right":
		edge_action=pages[cur_page].metadata.east_goto;
		next_x=0;
	    	break;
}
if(edge_action==-3 || edge_action==-1){
	return;
}
if(edge_action==-2){
	var tmp2=0;
	switch(direction){
	case "up":
			if(get_ptr_from_page_xy(pages[cur_page].metadata.x,pages[cur_page].metadata.y-1)!=-1){
				tmp2=get_ptr_from_page_xy(pages[cur_page].metadata.x,pages[cur_page].metadata.y-1);
				pages[cur_page].metadata.north_goto=tmp2;
				player.y=24;
				cur_page=tmp2;
				pages[cur_page].metadata.south_goto=tmp2;
				return;
			}
	    	new_page(-1,"up");
			player.y=24;
	    	return;
	case "down":
			if(get_ptr_from_page_xy(pages[cur_page].metadata.x,pages[cur_page].metadata.y+1)!=-1){
				tmp2=get_ptr_from_page_xy(pages[cur_page].metadata.x,pages[cur_page].metadata.y+1);
				pages[cur_page].metadata.north_goto=tmp2;
				player.y=0;
				cur_page=tmp2;
				pages[cur_page].metadata.north_goto=tmp2;
				return;
			}
			new_page(-1,"down");
			player.y=0;
	    	return;
	case "left":
			if(get_ptr_from_page_xy(pages[cur_page].metadata.x-1,pages[cur_page].metadata.y)!=-1){
				tmp2=get_ptr_from_page_xy(pages[cur_page].metadata.x-1,pages[cur_page].metadata.y);
				pages[cur_page].metadata.north_goto=tmp2;
				player.x=39;
				cur_page=tmp2;
				pages[cur_page].metadata.west_goto=tmp2;
				return;
			}
			new_page(-1,"left");
			player.x=39
	    	return;
	case "right":
			if(get_ptr_from_page_xy(pages[cur_page].metadata.x+1,pages[cur_page].metadata.y)!=-1){
				tmp2=get_ptr_from_page_xy(pages[cur_page].metadata.x+1,pages[cur_page].metadata.y);
				pages[cur_page].metadata.north_goto=tmp2;
				player.x=0;
				cur_page=tmp2;
				pages[cur_page].metadata.east_goto=tmp2;
				return;
			}
			new_page(-1,"right");
			player.x=0;
	    	return;
}
}
cur_page=edge_action;
player.x=next_x;
player.y=next_y;
}

function inv_cleanup(){//resolve item slots with count of 0 or less to id 0
    for(var i=0;i<10;i++){
        if(player.inv[i][1]<1){
            player.inv[i][0]=0;
            player.inv[i][1]=0;
        }
    }
}

function entity_cleanup(){
//remove free`ed entities and condense list
var new_entity_list=[];
for(var i=0;i<pages[cur_page].entities.length;i++){
	if(pages[cur_page].entities[i].id!=-1){
	new_entity_list.push(JSON.parse(JSON.stringify(pages[cur_page].entities[i])));
	}
}
pages[cur_page].entities=new_entity_list;
}

function compare_array(x,y){
if(x.length!=y.length){
    return false;
}
for(var i=0;i<x.length;i++){
    if(x[i]!=y[i]){
        return false;
    }
}
return true;
}

function pick_up_tile(item_id){
player.creative==1 ? pages[cur_page].map[player.y][player.x]=0 : 0;
if(player.inv[player.inv[10]][0]==0){
			player.inv[player.inv[10]]=[item_id,1];
			pages[cur_page].map[player.y][player.x]=0;
    	    return;
}
if(player.inv[player.inv[10]][0]==item_id){
	player.inv[player.inv[10]][1]++;
	pages[cur_page].map[player.y][player.x]=0;
    return;
}
}

function enter_button(){
var standing_on=pages[cur_page].map[player.y][player.x];
var on_entity=0;
//check entity
for(var i=0;i<pages[cur_page].entities.length;i++){
	if(pages[cur_page].entities[i].x==player.x && pages[cur_page].entities[i].y==player.y){
		on_entity=pages[cur_page].entities[i];
		if(on_entity.id==2){//Pick items up.
			if(player.creative==1){
				pages[cur_page].entities[i].id=-1;
				return;
			}
			if(on_entity.item[0]==player.inv[player.inv[10]][0] || player.inv[player.inv[10]][0]==0){
				player.inv[player.inv[10]][0]=on_entity.item[0];
				player.inv[player.inv[10]][1]+=on_entity.item[1];
				pages[cur_page].entities[i].id=-1;
			}
		}
	}
}
//check block
switch(standing_on){
	case 6://teleport/goto next map
		teleport();
		break;
	case 7://bedding
	case 8:
		if(!(tick_hour()>=6 && tick_hour()<=17)){
			document.getElementById("demonic_announcer").textContent="You can only sleep at day.";
		}else{
			tick1=100;
			document.getElementById("demonic_announcer").textContent="Slept and skipped to night."
			player.strength=1;//Player strength reset after sleeping.
		}
		break;
	case 13://grass
		pick_up_tile(3);
		break;
	case 16://brown mushroom
		pick_up_tile(4);
		break;
	case 17://red mushroom
		pick_up_tile(5);
		break;
	case 24://sapling
		pick_up_tile(9);
		break;
	case 28://carpet
		pick_up_tile(13);
		break;
	case 38://raygun
		pick_up_tile(19);
		break;
	case 40://Cyan Thing
		pick_up_tile(21);
		break;
	case 43://Open Door
		pick_up_tile(22);
		break;
	case 2://Dither, Stone
		pick_up_tile(23);
		break;
	case 12://Hay Bail
		pick_up_tile(24);
		break;
	case 52://Walnut Fruit
		pick_up_tile(25);
		break;
	case 54://Walnut peels
		pick_up_tile(27);
		break;
	case 68://Camp Fire
		pick_up_tile(41);
		break;
	case 73://Camp Fire
		pick_up_tile(46);
		break;
	case 29://water
		if(player.inv[player.inv[10]][0]==11){//Bowl
			pages[cur_page].entities.push({
			id:2,
			x:player.x,
			y:player.y,
			char:item_char[39],
			item:[39,1]
			});//Bowl of water.
			combine_items(player.x,player.y,39);
			player.inv[player.inv[10]][1]--;
		}
		if(player.inv[player.inv[10]][1]<=0){
			player.inv[player.inv[10]][0]=0;
			player.inv[player.inv[10]][1]=0;
		}
		break;
	default:
		if(player.creative==1){
			for(var i=0;i<properties.creative_noremove.length;i++){
				if(standing_on==properties.creative_noremove[i]){
					return;
				}
			}
			pages[cur_page].map[player.y][player.x]=0;
		}
		break;
}
if(standing_on==11){//crafting arrow
    var input=[
    -1,-1,//(35,1),(36,1)
    -1,-1,//(35,2),(36,2)
    -1,-1//(35,3),(36,3)
    ];
    var recipe_id=[0,0,0,0,0,0];
    for(var i=0;i<pages[cur_page].entities.length;i++){
        if(pages[cur_page].entities[i].id!=2){//item
            continue;
        }
        if(pages[cur_page].entities[i].x==35 && pages[cur_page].entities[i].y==1){
            input[0]=i;
			recipe_id[0]=pages[cur_page].entities[i].item[0];
        }
        if(pages[cur_page].entities[i].x==36 && pages[cur_page].entities[i].y==1){
            input[1]=i;
			recipe_id[1]=pages[cur_page].entities[i].item[0];
        }
        if(pages[cur_page].entities[i].x==35 && pages[cur_page].entities[i].y==2){
            input[2]=i;
			recipe_id[2]=pages[cur_page].entities[i].item[0];
        }
        if(pages[cur_page].entities[i].x==36 && pages[cur_page].entities[i].y==2){
            input[3]=i;
			recipe_id[3]=pages[cur_page].entities[i].item[0];
        }
        if(pages[cur_page].entities[i].x==35 && pages[cur_page].entities[i].y==3){
            input[4]=i;
			recipe_id[4]=pages[cur_page].entities[i].item[0];
        }
        if(pages[cur_page].entities[i].x==36 && pages[cur_page].entities[i].y==3){
            input[5]=i;
			recipe_id[5]=pages[cur_page].entities[i].item[0];
        }
    }
	var selected=-1;
	for(var i=0;i<recipies.length;i++){
		if(compare_array(recipe_id,recipies[i].input_id)){
			selected=i;
			break;
		}
	}
	if(selected==-1){
		return;
	}
	for(var i=0;i<input.length;i++){
		if(input[i]!=-1){
			pages[cur_page].entities[input[i]].item[1]--;
			if(pages[cur_page].entities[input[i]].item[1]<=0){
				pages[cur_page].entities[input[i]].id=-1
			}
		}
	}
	for(var i=0;i<recipies[selected].output.length;i++){
		pages[cur_page].entities.push({id:2, char:item_char[recipies[selected].output[i][0]], x:38, y:1+i, item: recipies[selected].output[i]});
		combine_items(38,1+i,recipies[selected].output[i][0]);
	}
}
}

function drop_item(x){
if(player.inv[player.inv[10]][0]==0){//Don't want to be creating dropped items with item id of zero...
	return;
}
var _id=player.inv[player.inv[10]][0];
if(x==0){//drop all
	pages[cur_page].entities.push(
	    {
	    id:2,
	    char:item_char[player.inv[player.inv[10]][0]],
	    x:player.x,
	    y:player.y,
	    item:player.inv[player.inv[10]]
	    });
		if(player.creative!=1){
	    player.inv[player.inv[10]]=[0,0];
		}
		combine_items(player.x,player.y,_id);
}
if(x==1){//drop one
	pages[cur_page].entities.push(
	    {
	    id:2,
	    char:item_char[player.inv[player.inv[10]][0]],
	    x:player.x,
	    y:player.y,
	    item:[player.inv[player.inv[10]][0],1]
	    });
		if(player.creative!=1){
	    player.inv[player.inv[10]]=[player.inv[player.inv[10]][0],player.inv[player.inv[10]][1]-1];
	    if(player.inv[player.inv[10]][1]<1){
		player.inv[player.inv[10]]=[0,0];
	    }
		}
		combine_items(player.x,player.y,_id);
}
if(x=="half"){
	var half_amount=Math.floor(player.inv[player.inv[10]][1]/2);
	if(half_amount<=0){
		return;
	}
	if(player.creative!=1){
	player.inv[player.inv[10]][1]-=half_amount;
	pages[cur_page].entities.push(
	    {
	    id:2,
	    char:item_char[player.inv[player.inv[10]][0]],
	    x:player.x,
	    y:player.y,
	    item:[player.inv[player.inv[10]][0],half_amount]
	    });
	inv_cleanup();
	}
	combine_items(player.x,player.y,_id);
}
}

function entity_player_collide(){
    for(var i=0;i<pages[cur_page].entities.length;i++){
        if(player.x==pages[cur_page].entities[i].x && player.y==pages[cur_page].entities[i].y){
            return i;
        }
    }
    return -1;
}

function projectile_entity_collide(ptr){//find if specified entity shares same coords as another one.
    for(var i=0;i<pages[cur_page].entities.length;i++){
        if(i==ptr){continue;}
        if(pages[cur_page].entities[ptr].x==pages[cur_page].entities[i].x && pages[cur_page].entities[ptr].y==pages[cur_page].entities[i].y && pages[cur_page].entities[i].id==1){
            return i;
        }
    }
    return -1;
}

/*function entity_collide(ptr){//find if specified entity shares same coords as another one.
    for(var i=0;i<pages[cur_page].entities.length;i++){
        if(i==ptr){continue;}
        if(pages[cur_page].entities[ptr].x==pages[cur_page].entities[i].x && pages[cur_page].entities[ptr].y==pages[cur_page].entities[i].y && pages[cur_page].entities[i].id!=3){
            return i;
        }
    }
    return -1;
}*/

function entity_collide_xy(x,y){//find if specified entity exists on x y axis
    for(var i=0;i<pages[cur_page].entities.length;i++){
        if(x==pages[cur_page].entities[i].x && y==pages[cur_page].entities[i].y){
            return i;
        }
    }
    return -1;
}

function hit_bounds(x,y){//bounds check for screen edge.
    return (x<0 || x>39 || y<0 || y>24);
}

function char_entity_on(ptr){//what type of character is the selected entity on?
    return pages[cur_page].map[pages[cur_page].entities[ptr].y][pages[cur_page].entities[ptr].x];
}

function char_value(x,y){
	if(hit_bounds(x,y)){
		return -1;
	}
    return pages[cur_page].map[y][x];
}

function is_walkable(x){
    for(var i=0;i<properties.walkable.length;i++){
        if(properties.walkable[i]==x){
            return true;
        }
    }
    return false;
}

function can_bang(x){
	for(var i=0;i<properties.bangable.length;i++){
		if(properties.bangable[i]==x){
			return true;
		}
	}
	return false;
}

function do_bang(_x,_y){
	pages[cur_page].entities.push({id:3, x:_x, y:_y, char:19, direction:-1, damage:7, decay:3});//Center Bang
	if(!hit_bounds(_x-1,_y)){
	pages[cur_page].entities.push({id:3, x:_x-1, y:_y, char:19, direction:-1, damage:7, decay:3});//Left
	}
	if(!hit_bounds(_x+1,_y)){
	pages[cur_page].entities.push({id:3, x:_x+1, y:_y, char:19, direction:-1, damage:7, decay:3});//Right
	}
	if(!hit_bounds(_x,_y-1)){
	pages[cur_page].entities.push({id:3, x:_x, y:_y-1, char:19, direction:-1, damage:7, decay:3});//Up
	}
	if(!hit_bounds(_x,_y+1)){
	pages[cur_page].entities.push({id:3, x:_x, y:_y+1, char:19, direction:-1, damage:7, decay:3});//Down
	}
}

function projectile_effect(ptr){
if(pages[cur_page].entities[ptr]==undefined){
	return;
}
switch(pages[cur_page].entities[ptr].char){
	case 35://Amber, fire bow
		if(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)==0 || is_burnable(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y))){
			pages[cur_page].map[pages[cur_page].entities[ptr].y][pages[cur_page].entities[ptr].x]=30
		}
		break;
	case 20://raygun ring
		do_bang(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y);
		if(can_bang(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y))){
			switch(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)){
				case 5://Black stone?
					pages[cur_page].map[pages[cur_page].entities[ptr].y][pages[cur_page].entities[ptr].x]=2;
					break;
				default:
					pages[cur_page].map[pages[cur_page].entities[ptr].y][pages[cur_page].entities[ptr].x]=0;
			}
		}
		sfx("raygun_bang");
		break;
	default:
		0;
}
}

function projectile_step(ptr){
if(pages[cur_page].entities[ptr]==undefined){
	return;
}
    switch(pages[cur_page].entities[ptr].direction){
        case -1:
            break;
        case 0://up
            pages[cur_page].entities[ptr].y--;
            break;
        case 1://down
            pages[cur_page].entities[ptr].y++;
            break;
        case 2://left
            pages[cur_page].entities[ptr].x--;
            break;
        case 3://right
            pages[cur_page].entities[ptr].x++;
            break;
    }
	if(pages[cur_page].entities[ptr].decay!=-1){
    pages[cur_page].entities[ptr].decay--;
	}
}

function projectile_check(ptr){
if(pages[cur_page].entities[ptr]==undefined){
	return;
}
    if(pages[cur_page].entities[ptr].decay==0){
		projectile_effect(ptr);
		pages[cur_page].entities[ptr].id=-1;
        return;
    }
	if(hit_bounds(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)){//move entity to next page when hit edges if possible
		var next_page=-1;
		var dir="";
		if(pages[cur_page].entities[ptr].x<0){//left edge, west_goto
			next_page=pages[cur_page].metadata.west_goto;
			dir="left";
		}
		if(pages[cur_page].entities[ptr].x>39){//right edge, east_goto
			next_page=pages[cur_page].metadata.east_goto;
			dir="right";
		}
		if(pages[cur_page].entities[ptr].y<0){//top edge, north_goto
			next_page=pages[cur_page].metadata.north_goto;
			dir="up";
		}
		if(pages[cur_page].entities[ptr].y>24){//bottom edge, south_goto
			next_page=pages[cur_page].metadata.south_goto;
			dir="down";
		}
		if(next_page==-1 || next_page==-2){
			projectile_effect(ptr);
        	pages[cur_page].entities[ptr].id=-1;
        	entity_cleanup();
        	return;
		}else{
		switch(dir){
			case "up":
				pages[cur_page].entities[ptr].y=24;
				break;
			case "down":
				pages[cur_page].entities[ptr].y=0;
				break;
			case "left":
				pages[cur_page].entities[ptr].x=39;
				break;
			case "right":
				pages[cur_page].entities[ptr].x=0;
				break;
		}
		move_entity(ptr,next_page);
		return;
		}
	}
    var collided=projectile_entity_collide(ptr);
    if(collided!=-1){//hits entity
        if(pages[cur_page].entities[collided].health!=undefined){
			projectile_effect(ptr);
            pages[cur_page].entities[collided].health-=pages[cur_page].entities[ptr].damage;//inflict damage on target entity
            pages[cur_page].entities[ptr].id=-1;//Mark projectile for deletion.
	    	return;
        }
    }
    collided=entity_player_collide();
    if(collided==ptr){//hits player
		if(pages[cur_page].entities[ptr].from_player==1){//don't inflict damage on oneself.
			return;
		}
		projectile_effect(ptr);
	damage_player(pages[cur_page].entities[ptr].damage);
        pages[cur_page].entities[ptr].id=-1;
		return;
    }
    if(!is_walkable(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y))){//encounters non walkable block
		projectile_effect(ptr);
        pages[cur_page].entities[ptr].id=-1;
        return;
    }
	if(is_burnable(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)) && pages[cur_page].entities[ptr].char==35){//amber encounters burnable block
		projectile_effect(ptr,"burn");
        pages[cur_page].entities[ptr].id=-1;
        return;
    }
}
function projectile(ptr){//Code for making projectiles move and interact with ThInGs
	projectile_check(ptr);
	projectile_step(ptr);
	projectile_check(ptr);
}

function item_pickup_dropoff(item_id,x,y){
	if(player.creative==1){
		pages[cur_page].map[y][x]=0;
		return true;
	}
	if(player.inv[player.inv[10]][0]==0){
            player.inv[player.inv[10]][0]=item_id;
            pages[cur_page].map[y][x]=0;
    }
    if(player.inv[player.inv[10]][0]==item_id){
        player.inv[player.inv[10]][1]++;
        pages[cur_page].map[y][x]=0;
    }
return true;
}

function remove_char(x,y){
switch(char_value(x,y)){
    case 18://fence
		return item_pickup_dropoff(6,x,y);
	case 12://Hay
		return item_pickup_dropoff(24,x,y);
	case 54://peels
		return item_pickup_dropoff(27,x,y);
	case 58://Bookshelf
		return item_pickup_dropoff(31,x,y);
	case 64://Iron wall
		return item_pickup_dropoff(37,x,y);
	case 65://Copper wall
		return item_pickup_dropoff(38,x,y);
	case 72://MDF
		return item_pickup_dropoff(45,x,y);
	case 74://Green Stained MDF
		return item_pickup_dropoff(47,x,y);
	case 75://Red Stained MDF
		return item_pickup_dropoff(48,x,y);
	case 76://Cyan Stained MDF
		return item_pickup_dropoff(49,x,y);
	case 42://closed door
		pages[cur_page].map[y][x]=43;
		return true;
	case 43://open door
		pages[cur_page].map[y][x]=42;
		return true;
	default:
		if(player.creative==1){
			var _char=char_value(x,y);//Performance optimization.
			for(var i=0;i<properties.creative_noremove.length;i++){
				if(_char==properties.creative_noremove[i]){
					return false;
				}
			}
			pages[cur_page].map[y][x]=0;
			return true;
		}
		break;
}
}

function attack(x){
var is_entity=-1;//does an entity exist at that place?
switch(x){
    case "up":
        is_entity=entity_collide_xy(player.x,player.y-1);
        break;
    case "down":
	is_entity=entity_collide_xy(player.x,player.y+1);
        break;
    case "left":
	is_entity=entity_collide_xy(player.x-1,player.y);
        break;
    case "right":
	is_entity=entity_collide_xy(player.x+1,player.y);
        break;
}
if(is_entity==-1 || pages[cur_page].entities[is_entity].id!=1){//no entity
switch(x){
    case "up":
        if(remove_char(player.x,player.y-1)){return;}
        break;
    case "down":
        if(remove_char(player.x,player.y+1)){return;};
        break;
    case "left":
        if(remove_char(player.x-1,player.y)){return;};
        break;
    case "right":
        if(remove_char(player.x+1,player.y)){return;};
        break;
}
}
switch(player.inv[player.inv[10]][0]){
	case 17://fire bow
	switch(x){
	    case "up":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y-1, char:35, direction:0, damage:player.strength*4, decay:8, from_player:1});
 	       break;
 	   case "down":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y+1, char:35, direction:1, damage:player.strength*4, decay:8, from_player:1});
 	       break;
 	   case "left":
  	       pages[cur_page].entities.push({id:3, x:player.x-1, y:player.y, char:35, direction:2, damage:player.strength*4, decay:8, from_player:1});
  	       break;
  	   case "right":
   	       pages[cur_page].entities.push({id:3, x:player.x+1, y:player.y, char:35, direction:3, damage:player.strength*4, decay:8, from_player:1});
   	       break;
	}
	if(player.creative!=1){
	player.inv[player.inv[10]][1]--;
	if(player.inv[player.inv[10]][1]<=0){
		player.inv[player.inv[10]]=[14,1];
	}
	inv_cleanup();
	}
    break;
	case 18://spear
	switch(x){
	    case "up":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y-1, char:37, direction:-1, damage:player.strength*20, decay:3, from_player:1});
 	       break;
 	   case "down":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y+1, char:37, direction:-1, damage:player.strength*20, decay:3, from_player:1});
 	       break;
 	   case "left":
  	       pages[cur_page].entities.push({id:3, x:player.x-1, y:player.y, char:37, direction:-1, damage:player.strength*20, decay:3, from_player:1});
  	       break;
  	   case "right":
   	       pages[cur_page].entities.push({id:3, x:player.x+1, y:player.y, char:37, direction:-1, damage:player.strength*20, decay:3, from_player:1});
   	       break;
	}
	inv_cleanup();
    break;
	case 19://Raygun
	switch(x){
	    case "up":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y-1, char:20, direction:0, damage:player.strength*1000, decay:50, from_player:1});
		   sfx("raygun_cooldown");
 	       break;
 	   case "down":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y+1, char:20, direction:1, damage:player.strength*1000, decay:50, from_player:1});
		   sfx("raygun_cooldown");
 	       break;
 	   case "left":
  	       pages[cur_page].entities.push({id:3, x:player.x-1, y:player.y, char:20, direction:2, damage:player.strength*1000, decay:50, from_player:1});
		   sfx("raygun_cooldown");
  	       break;
  	   case "right":
   	       pages[cur_page].entities.push({id:3, x:player.x+1, y:player.y, char:20, direction:3, damage:player.strength*1000, decay:50, from_player:1});
		   sfx("raygun_cooldown");
   	       break;
	}
	inv_cleanup();
	break;39
	case 20://Poisonous Spear
	switch(x){
	    case "up":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y-1, char:39, direction:-1, damage:player.strength*30, decay:3, from_player:1});
 	       break;
 	   case "down":
 	       pages[cur_page].entities.push({id:3, x:player.x, y:player.y+1, char:39, direction:-1, damage:player.strength*30, decay:3, from_player:1});
 	       break;
 	   case "left":
  	       pages[cur_page].entities.push({id:3, x:player.x-1, y:player.y, char:39, direction:-1, damage:player.strength*30, decay:3, from_player:1});
  	       break;
  	   case "right":
   	       pages[cur_page].entities.push({id:3, x:player.x+1, y:player.y, char:39, direction:-1, damage:player.strength*30, decay:3, from_player:1});
   	       break;
	}
	break;
	default:
		switch(x){
 		 	case "up":
      	  pages[cur_page].entities.push({id:3, x:player.x, y:player.y-1, char:19, direction:-1, damage:player.strength, decay:3, from_player:1});
 	       break;
   		 case "down":
   		     pages[cur_page].entities.push({id:3, x:player.x, y:player.y+1, char:19, direction:-1, damage:player.strength, decay:3, from_player:1});
   		     break;
   		 case "left":
    	    pages[cur_page].entities.push({id:3, x:player.x-1, y:player.y, char:19, direction:-1, damage:player.strength, decay:3, from_player:1});
    	    break;
  		  case "right":
   		     pages[cur_page].entities.push({id:3, x:player.x+1, y:player.y, char:19, direction:-1, damage:player.strength, decay:3, from_player:1});
    	    break;
}
}
}

function is_bonemealable(x){
	for(var i=0;i<properties.bonemealable.length;i++){
		if(properties.bonemealable[i]==x){
			return true;
		}
	}
	return false;
}

function use_item(){
if(char_value(player.x,player.y)==0){
for(var i=0;i<properties.breakable.length;i++){
	if(player.inv[player.inv[10]][0]==properties.breakable[i]){
		pages[cur_page].map[player.y][player.x]=item_char[player.inv[player.inv[10]][0]];
		player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
		inv_cleanup();
		return;
	}
}
}
switch(player.inv[player.inv[10]][0]){//item id
    case 12: //Mushroom Stew
        if(player.health>=20){
            break;
        }
	player.health+=5;
        if(player.health>20 && player.creative==0){
            player.health=20;
        }
		
	player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
	pages[cur_page].entities.push({
		id:2,
		x:player.x,
		y:player.y,
		char:item_char[11],
		item:[11,1]
		});//drop bowl
		combine_items(player.x,player.y,11);
	break;
	case 16://amber
		if(char_value(player.x,player.y)==0){
			pages[cur_page].map[player.y][player.x]=30;
			player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
		}
		break;
	case 23://stone
		if(char_value(player.x,player.y)==0){
			pages[cur_page].map[player.y][player.x]=2;
			player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
		}
		break;
    case 26://walnut stone
        if(player.health>=20){
            break;
        }
		player.health+=10;
        if(player.health>20 && player.creative==0){
            player.health=20;
        }
		player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
		break;
	case 28://bone meal
		if(!is_bonemealable(char_value(player.x,player.y))){
			return;
		}
		random_tick(player.x,player.y,1);
		player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
		inv_cleanup();
		break;
	case 34: //Meat
        if(player.health>=20){
            break;
        }
		player.health+=2;
        if(player.health>20 && player.creative==0){
            player.health=20;
        }
		player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
		break;
	case 36: //Cooked Meat
        if(player.health>=20){
            break;
        }
		player.health+=10;
        if(player.health>20 && player.creative==0){
            player.health=20;
        }
		player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
		break;
	case 40: //Suspicious Stew
		player.creative==1 ? 0 : player.inv[player.inv[10]][1]--;
		player.health+=20;
        if(player.health>20 && player.creative==0){
            player.health=20;
        }
		pages[cur_page].entities.push({
		id:2,
		x:player.x,
		y:player.y,
		char:item_char[11],
		item:[11,1]
		});//drop bowl
		combine_items(player.x,player.y,11);
		var choice=Math.floor(Math.random()*65535)%3;
        switch(choice){
			case 0://strength boost
				player.strength=1.5;
				break;
			case 1://Health boost
				player.health=40;
				break;
			case 2://Nothing
				break;
		}
	case 50://black wall
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[50] : 0;
		break;
	case 51://bedding 1
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[51] : 0;
		break;
	case 52://bedding 2
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[52] : 0;
		break;
	case 53://tree leaves
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[53] : 0;
		break;
	case 54://tree trunk
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[54] : 0;
		break;
	case 55://water
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[55] : 0;
		break;
	case 56://fire 0
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[56] : 0;
		break;
	case 57://fire 1
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[57] : 0;
		break;
	case 58://fire 2
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[58] : 0;
		break;
	case 59://NPC Hole
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[59] : 0;
		break;
	case 60://Walnut Trunk
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[60] : 0;
		break;
	case 61://Walnut Leaves 1
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[61] : 0;
		break;
	case 62://Walnut Leaves 2
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[62] : 0;
		break;
	case 63://Walnut Leaves 3
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[63] : 0;
		break;
	case 64://Walnut Leaves 4
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[64] : 0;
		break;
	case 65://Walnut Leaves 5
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[65] : 0;
		break;
	case 66://Walnut Leaves 6
		player.creative==1 ? pages[cur_page].map[player.y][player.x]=item_char[66] : 0;
		break;
}
inv_cleanup();
}

function cheats(){
    var cheat_code=prompt("Cheat?");
    switch(cheat_code){
        case "Juggernog":
			player.tainted=1;
            player.health=20;
            break;
        case "gamemode c":
			player.tainted=1;
            player.creative=1;
			player.strength=65535;
            player.health=Infinity;
			player.inv[0]=[item_id_from_name("Grass"),255];
			player.inv[1]=[item_id_from_name("red mushroom"),255];
			player.inv[2]=[item_id_from_name("brown mushroom"),255];
			player.inv[3]=[item_id_from_name("fence"),255];
			player.inv[4]=[item_id_from_name("sapling"),255];
			player.inv[5]=[item_id_from_name("carpet"),255];
			player.inv[6]=[item_id_from_name("door"),255];
			player.inv[7]=[item_id_from_name("stone"),255];
			player.inv[8]=[item_id_from_name("hay bail"),255];
			player.inv[9]=[item_id_from_name("mdf"),255];
            break;
        case "Give me what I want!":
			player.tainted=1;
            player.inv[player.inv[10]]=JSON.parse(prompt("Item?"));
            break;
		case "Let it grow!":
			player.tainted=1;
            random_tick(player.x,player.y);
            break;
        default:
            alert("No cheat for you!");
            break;
    }
}

//keys
function key_manager(key){
//Movement
last_dir="";
if(key==80){//pause, p
	switch(paused){
		case 0:
			paused=1;
			document.getElementById("demonic_announcer").textContent="Paused";
			break;
		case 1:
			paused=0;
			document.getElementById("demonic_announcer").textContent="Unpaused";
			break;
	}
}
if(paused==1){
	return;
}
switch(key){
    case 87://up,w
	last_dir="up";
	if(hit_bounds(player.x,player.y-1)){
		off_edge("up");
	}
	if(!(hit_bounds(player.x,player.y) || hit_bounds(player.x,player.y-1) || !is_walkable(char_value(player.x,player.y-1)))){
        	player.y-=1;
        }
        return;
    case 83://down, s
	last_dir="down";
	if(hit_bounds(player.x,player.y+1)){
		off_edge("down");
	}
        if(!(hit_bounds(player.x,player.y) || hit_bounds(player.x,player.y+1) || !is_walkable(char_value(player.x,player.y+1)))){
        	player.y+=1;
        }
        return;
    case 65://left, a
	last_dir="left";
	if(hit_bounds(player.x-1,player.y)){
		off_edge("left");
	}
        if(!(hit_bounds(player.x,player.y) || hit_bounds(player.x-1,player.y) || !is_walkable(char_value(player.x-1,player.y)))){
        	player.x-=1;
        }
        return;
    case 68://right, d
	last_dir="right";
	if(hit_bounds(player.x+1,player.y)){
		off_edge("right");
	}
        if(!(hit_bounds(player.x,player.y) || hit_bounds(player.x+1,player.y) || !is_walkable(char_value(player.x+1,player.y)))){
        	player.x+=1;
        }
        return;
}
//attack
switch(key){
    case 38:
        attack("up");
        break;
   case 40:
        attack("down");
        break;
   case 37:
        attack("left");
        break;
   case 39:
        attack("right");
        break;
}

if(player.creative==1){
switch(key){//creative stuff
	case 219://[
		player.inv[player.inv[10]][0]--;
		if(player.inv[player.inv[10]][0]<0){
			player.inv[player.inv[10]][0]=0;
		}
		break;
	case 221://]
		player.inv[player.inv[10]][0]++;
		if(player.inv[player.inv[10]][0]>=item_char.length){
			player.inv[player.inv[10]][0]=item_char.length-1;
		}
		break;
	case 220://\
		var _item_id=item_id_from_name(prompt("Item Name?"));
		if(_item_id==-1){
			alert("Invalid Item Name");
			return;
		}
		player.inv[player.inv[10]][0]=_item_id;
		break;
}
}

//inventory slot select
switch(key){
    case 49://1
        player.inv[10]=0;
        break;
    case 50://2
        player.inv[10]=1;
        break;
    case 51://3
        player.inv[10]=2;
        break;
    case 52://4
        player.inv[10]=3;
        break;
    case 53://5
        player.inv[10]=4;
        break;
    case 54://6
        player.inv[10]=5;
        break;
    case 55://7
        player.inv[10]=6;
        break;
    case 56://8
        player.inv[10]=7;
        break;
    case 57://9
        player.inv[10]=8;
        break;
    case 48://0
        player.inv[10]=9;
        break;
}

//drop item
switch(key){
    case 71://Drop one item
        drop_item(1);
        break;
    case 70://Drop all of the items.
        drop_item(0);
        break;
	case 86://v, Drop have of items
		drop_item("half");
		break;
}

//break/pickup, place/use, other
switch(key){
    case 13://enter
        enter_button();
        break;
    case 32://space
        use_item();
        break;
    case 192://"~" key
        document.getElementById("demonic_announcer").textContent="Stop there criminal!";
        cheats();
        break;
}
}

function death(){
    if(player.creative==1){
        console.log("You live to see another day.");
        return;
    }
    alert("BOOM! You are DEAD!");
    clearInterval(interval);
    key_manager=function(){};
}

function pathfind_step(x1,y1,x2,y2,og_x,og_y){
var nodes=[];
var dir="";
if(og_x==undefined){
	og_x=20;
}
if(og_y==undefined){
	og_y=12;
}
nodes.push({x:x1,y:y1,h:Math.sqrt((x2-x1)*(x2-x1)+(y2-y1)*(y2-y1))});
if(is_walkable(char_value(x1,y1-1))){//up
	nodes.push({x:x1,y:y1-1,h:Math.sqrt((x2-x1)*(x2-x1)+(y2-(y1-1))*(y2-(y1-1)))});
	dir="up";
}
if(is_walkable(char_value(x1,y1+1))){//down
	nodes.push({x:x1,y:y1+1,h:Math.sqrt((x2-x1)*(x2-x1)+(y2-(y1+1))*(y2-(y1+1)))});
	dir="down";
}
if(is_walkable(char_value(x1-1,y1))){//left
	nodes.push({x:x1-1,y:y1,h:Math.sqrt((x2-(x1-1))*(x2-(x1-1))+(y2-y1)*(y2-y1))});
	dir="left";
}
if(is_walkable(char_value(x1+1,y1))){//right
	nodes.push({x:x1+1,y:y1,h:Math.sqrt((x2-(x1+1))*(x2-(x1+1))+(y2-y1)*(y2-y1))});
	dir="right";
}
if(is_walkable(char_value(x1-1,y1-1)) && (is_walkable(char_value(x1-1,y1)) || is_walkable(char_value(x1,y1-1)))){//up left
	nodes.push({x:x1-1,y:y1-1,h:Math.sqrt((x2-(x1-1))*(x2-(x1-1))+(y2-(y1-1))*(y2-(y1-1)))});
}
if(is_walkable(char_value(x1-1,y1+1)) && (is_walkable(char_value(x1-1,y1)) || is_walkable(char_value(x1,y1+1)))){//down left
	nodes.push({x:x1-1,y:y1+1,h:Math.sqrt((x2-(x1-1))*(x2-(x1-1))+(y2-(y1+1))*(y2-(y1+1)))});
}
if(is_walkable(char_value(x1+1,y1-1)) && (is_walkable(char_value(x1+1,y1)) || is_walkable(char_value(x1,y1-1)))){//up right
	nodes.push({x:x1+1,y:y1-1,h:Math.sqrt((x2-(x1+1))*(x2-(x1+1))+(y2-(y1-1))*(y2-(y1-1)))});
}
if(is_walkable(char_value(x1+1,y1+1)) && (is_walkable(char_value(x1+1,y1)) || is_walkable(char_value(x1,y1+1)))){//down right
	nodes.push({x:x1+1,y:y1+1,h:Math.sqrt((x2-(x1+1))*(x2-(x1+1))+(y2-(y1+1))*(y2-(y1+1)))});
}
var smallest=nodes[0];
for(var i=1;i<nodes.length;i++){
	if(smallest.h>=nodes[i].h){
		smallest=nodes[i];
	}
}
return [smallest.x,smallest.y,dir];
}
function entity_attack(ptr){
    if(pages[cur_page].entities[ptr].attack_cooldown>0){
        pages[cur_page].entities[ptr].attack_cooldown--;
        return;
    }
    if(pages[cur_page].entities[ptr].x==player.x){
        if(pages[cur_page].entities[ptr].y<player.y){//Attack Down
            pages[cur_page].entities.push({id:3, x:pages[cur_page].entities[ptr].x, y:pages[cur_page].entities[ptr].y+1, char:19, direction:-1, damage:pages[cur_page].entities[ptr].strength, decay:2});
            pages[cur_page].entities[ptr].attack_cooldown=5;
        }
        if(pages[cur_page].entities[ptr].y>player.y){//Attack Up
            pages[cur_page].entities.push({id:3, x:pages[cur_page].entities[ptr].x, y:pages[cur_page].entities[ptr].y-1, char:19, direction:-1, damage:pages[cur_page].entities[ptr].strength, decay:2});
            pages[cur_page].entities[ptr].attack_cooldown=5;
        }
    }
    if(pages[cur_page].entities[ptr].y==player.y){
        if(pages[cur_page].entities[ptr].x<player.x){//Attack Right
            pages[cur_page].entities.push({id:3, x:pages[cur_page].entities[ptr].x+1, y:pages[cur_page].entities[ptr].y, char:19, direction:-1, damage:pages[cur_page].entities[ptr].strength, decay:2});
            pages[cur_page].entities[ptr].attack_cooldown=5;
        }
        if(pages[cur_page].entities[ptr].x>player.x){//Attack Left
            pages[cur_page].entities.push({id:3, x:pages[cur_page].entities[ptr].x-1, y:pages[cur_page].entities[ptr].y, char:19, direction:-1, damage:pages[cur_page].entities[ptr].strength, decay:2});
            pages[cur_page].entities[ptr].attack_cooldown=5;
        }
    }
}

function get_hole_ptr_from_xy(x,y){
	for(var i=0;i<pages[cur_page].holes.length;i++){
		if(pages[cur_page].holes[i].x==x && pages[cur_page].holes[i].y==y){
			return i;
		}
	}
	return -1;
}

function entity_teleport(hole_ptr,entity_ptr){
	if(pages[cur_page].holes[hole_ptr].dest_page==-2 || pages[cur_page].holes[hole_ptr].dest_page==-2){
		return;
	}
	pages[cur_page].entities[entity_ptr].x=pages[cur_page].holes[hole_ptr].next_x;
	pages[cur_page].entities[entity_ptr].y=pages[cur_page].holes[hole_ptr].next_y;
	pages[cur_page].entities[entity_ptr].dest_x=pages[cur_page].holes[hole_ptr].next_x;
	pages[cur_page].entities[entity_ptr].dest_y=pages[cur_page].holes[hole_ptr].next_y;
	move_entity(entity_ptr,pages[cur_page].holes[hole_ptr].dest_page);
}

function entity_slip_edge(ptr,dir){
var next_page=-1;
switch(dir){
	case "up":
		next_page=pages[cur_page].metadata.north_goto;
		break;
	case "down":
		next_page=pages[cur_page].metadata.south_goto;
		break;
	case "left":
		next_page=pages[cur_page].metadata.west_goto;
		break;
	case "right":
		next_page=pages[cur_page].metadata.east_goto;
		break;
}
if(next_page==-1 || next_page==-2){
	return;
}
switch(dir){
	case "left":
		pages[cur_page].entities[ptr].x=39;
		pages[cur_page].entities[ptr].dest_x=39;
		break;
	case "right":
		pages[cur_page].entities[ptr].x=0;
		pages[cur_page].entities[ptr].dest_x=0;
		break;
	case "up":
		pages[cur_page].entities[ptr].y=24;
		pages[cur_page].entities[ptr].dest_y=24;
		break;
	case "down":
		pages[cur_page].entities[ptr].y=0;
		pages[cur_page].entities[ptr].dest_y=0;
		break;
}
move_entity(ptr,next_page);
}

function is_54(x,y){
	return char_value(x,y)==54;
}

//pages[cur_page].entities[0].last_dir="left"

function entity_slip(ptr){//pages[cur_page].entities[0].dest_x=35;pages[cur_page].entities[0].dest_y=10
switch(pages[cur_page].entities[ptr].last_dir){
	case "up":
		if(is_walkable(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y-1)) && !hit_bounds(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y-1)){
			pages[cur_page].entities[ptr].y--;
			if(!is_54(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)){
				pages[cur_page].entities[ptr].dest_x=pages[cur_page].entities[ptr].x;
				pages[cur_page].entities[ptr].dest_y=pages[cur_page].entities[ptr].y-1;
				}
		}
		if(hit_bounds(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y-1)){
			entity_slip_edge(ptr,"up");
		}
		return;
	case "down":
		if(is_walkable(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y+1)) && !hit_bounds(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y+1)){
			pages[cur_page].entities[ptr].y++;
			if(!is_54(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)){
				pages[cur_page].entities[ptr].dest_x=pages[cur_page].entities[ptr].x;
				pages[cur_page].entities[ptr].dest_y=pages[cur_page].entities[ptr].y+1;
			}
		}
		if(hit_bounds(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y+1)){
			entity_slip_edge(ptr,"down");
		}
		break;
	case "left":
		if(is_walkable(char_value(pages[cur_page].entities[ptr].x-1,pages[cur_page].entities[ptr].y)) && !hit_bounds(pages[cur_page].entities[ptr].x-1,pages[cur_page].entities[ptr].y)){
			pages[cur_page].entities[ptr].x--;
			if(!is_54(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)){
			pages[cur_page].entities[ptr].dest_x=pages[cur_page].entities[ptr].x;
			pages[cur_page].entities[ptr].dest_y=pages[cur_page].entities[ptr].y;
			}
		}
		if(hit_bounds(pages[cur_page].entities[ptr].x-1,pages[cur_page].entities[ptr].y)){
			entity_slip_edge(ptr,"left");
		}
		break;
	case "right":
		if(is_walkable(char_value(pages[cur_page].entities[ptr].x+1,pages[cur_page].entities[ptr].y)) && !hit_bounds(pages[cur_page].entities[ptr].x+1,pages[cur_page].entities[ptr].y)){
			pages[cur_page].entities[ptr].x++;
			if(!is_54(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)){
			pages[cur_page].entities[ptr].dest_x=pages[cur_page].entities[ptr].x;
			pages[cur_page].entities[ptr].dest_y=pages[cur_page].entities[ptr].y;
			}
		}
		if(hit_bounds(pages[cur_page].entities[ptr].x+1,pages[cur_page].entities[ptr].y)){
			entity_slip_edge(ptr,"right");
		}
		break;
	default:
		break;
}
return 1;
}

function entity_standing_on(ptr){
//pages[cur_page].entities[0].dest_x=19;pages[cur_page].entities[0].dest_y=12;
switch(char_value(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y)){
	case 6://hole
		if(pages[cur_page].entities[ptr].x!=pages[cur_page].entities[ptr].dest_x || pages[cur_page].entities[ptr].y!=pages[cur_page].entities[ptr].dest_y){
			break;
		}
		entity_teleport(get_hole_ptr_from_xy(pages[cur_page].entities[ptr].x,pages[cur_page].entities[ptr].y),ptr);
		break;
	case 54://walnut peel
		entity_slip(ptr);
		return 1;
		break;
	case 30://fire
		pages[cur_page].entities[ptr].health--;
		break;
	case 31:
		pages[cur_page].entities[ptr].health--;
		break;
	case 32:
		pages[cur_page].entities[ptr].health--;
		break;
	case 68://Camp Fire
		pages[cur_page].entities[ptr].health--;
		break;
}
}

function npc_edge(ptr){//(x<0 || x>39 || y<0 || y>24);
var next_page=-1;
var dir="";
if(pages[cur_page].entities[ptr].dest_x<0){//left
	next_page=pages[cur_page].metadata.west_goto;
	dir="left";
}
if(pages[cur_page].entities[ptr].dest_x>39){//right
	next_page=pages[cur_page].metadata.east_goto;
	dir="right";
}
if(pages[cur_page].entities[ptr].dest_y<0){//up
	next_page=pages[cur_page].metadata.north_goto;
	dir="up";
}
if(pages[cur_page].entities[ptr].dest_y>24){//down
	next_page=pages[cur_page].metadata.south_goto;
	dir="down";
}
if(next_page==-1 || next_page==-2){
	return;
}else{
switch(dir){
	case "left":
		pages[cur_page].entities[ptr].x=39;
		pages[cur_page].entities[ptr].dest_x=39;
		break;
	case "right":
		pages[cur_page].entities[ptr].x=0;
		pages[cur_page].entities[ptr].dest_x=0;
		break;
	case "up":
		pages[cur_page].entities[ptr].y=24;
		pages[cur_page].entities[ptr].dest_y=24;
		break;
	case "down":
		pages[cur_page].entities[ptr].y=0;
		pages[cur_page].entities[ptr].dest_y=0;
		break;
}
move_entity(ptr,next_page);
}
}

function entity_edge(ptr){//move entity between pages through edges.
	if(hit_bounds(pages[cur_page].entities[ptr].dest_x,pages[cur_page].entities[ptr].dest_y)){
		if(Math.sqrt(Math.pow(pages[cur_page].entities[ptr].x-pages[cur_page].entities[ptr].dest_x,2)+Math.pow(pages[cur_page].entities[ptr].y-pages[cur_page].entities[ptr].dest_y,2))==1){
			npc_edge(ptr);
		}
	}
}

function friendly_npc(ptr){
	//love
	for(var i=0;i<pages[cur_page].entities.length;i++){
		if(i==ptr){
			continue;
		}
		if(pages[cur_page].entities[i].id==1 && pages[cur_page].entities[i].brain.hostile==0){
			if(pages[cur_page].entities[i].x==pages[cur_page].entities[ptr].x&&
			pages[cur_page].entities[i].y==pages[cur_page].entities[ptr].y&&
			pages[cur_page].entities[i].brain.identity.love_mode==1){
				pages[cur_page].entities[i].brain.identity.love_mode=0;
				pages[cur_page].entities[ptr].brain.identity.love_mode=0;
				new_npc(pages[cur_page].entities[ptr].x,
				pages[cur_page].entities[ptr].y,
				pages[cur_page].entities[ptr].x,
				pages[cur_page].entities[ptr].y);//asdf
				return;
			}
		}
	}
}

function npc(ptr){//make entity move and interact with environment.
	if(entity_standing_on(ptr)==1){return;}
    if(pages[cur_page].entities[ptr].brain.no_ai==1){return;}
    var next_xy;
    switch(pages[cur_page].entities[ptr].brain.hostile){
        case 0://not hostile
            next_xy=pathfind_step(pages[cur_page].entities[ptr].x,
            pages[cur_page].entities[ptr].y,
            pages[cur_page].entities[ptr].dest_x,
            pages[cur_page].entities[ptr].dest_y,
			pages[cur_page].entities[ptr].og_x,
			pages[cur_page].entities[ptr].og_y);
			pages[cur_page].entities[ptr].brain.identity.love_mode==1 ? friendly_npc(ptr) : 0;
            break;
        case 1://hostile
            next_xy=pathfind_step(pages[cur_page].entities[ptr].x,
            pages[cur_page].entities[ptr].y,
            player.x,
            player.y,
            pages[cur_page].entities[ptr].og_x,
            pages[cur_page].entities[ptr].og_y);
            if(next_xy[0]==player.x && next_xy[1]==player.y){
                entity_attack(ptr);
                return;
            }
            break;
    }
	pages[cur_page].entities[ptr].last_dir=next_xy[2];
	var collided=entity_collide_xy(next_xy[0],next_xy[1]);
	if(collided!=-1 && pages[cur_page].entities[collided].id==1 && pages[cur_page].entities[ptr].brain.hostile==1){return;}//prevent multiple npc's from occupying the same char.
    pages[cur_page].entities[ptr].x=next_xy[0];pages[cur_page].entities[ptr].y=next_xy[1];//for slipping.
	entity_standing_on(ptr);
	entity_edge(ptr);
}

function slip(){
switch(last_dir){
	case "up":
		if(is_walkable(char_value(player.x,player.y-1)) && !hit_bounds(player.x,player.y-1)){
			player.y--;
		}
		if(hit_bounds(player.x,player.y-1)){
			off_edge("up");
		}
		return;
	case "down":
		if(is_walkable(char_value(player.x,player.y+1)) && !hit_bounds(player.x,player.y+1)){
			player.y++;
		}
		if(hit_bounds(player.x,player.y+1)){
			off_edge("down");
		}
		break;
	case "left":
		if(is_walkable(char_value(player.x-1,player.y)) && !hit_bounds(player.x-1,player.y)){
			player.x--;
		}
		if(hit_bounds(player.x-1,player.y)){
			off_edge("left");
		}
		break;
	case "right":
		if(is_walkable(char_value(player.x+1,player.y)) && !hit_bounds(player.x+1,player.y)){
			player.x++;
		}
		if(hit_bounds(player.x+1,player.y)){
			off_edge("right");
		}
		break;
	default:
		break;
}
}

function move_entity(ptr,next_page){
pages[next_page].entities.push(JSON.parse(JSON.stringify(pages[cur_page].entities[ptr])));//weird pointer shenanigans
pages[cur_page].entities[ptr].id=-1;
entity_cleanup();
}

function fire_damage(){
	damage_player(1);
}

function tick(){
    if(player.health<=0){//Player Death
        death();
    }
    for(var i=0;i<pages[cur_page].entities.length;i++){
        switch(pages[cur_page].entities[i].id){
            case 3:
                projectile(i);
                break;
            case 1:
                npc(i);
                break;
        }
    }
	switch(char_value(player.x,player.y)){
		case 54://walnut peels
			slip();
			break;
		case 30://fire
			fire_damage();
			break;
		case 31:
			fire_damage();
			break;
		case 32:
			fire_damage();
			break;
	}
}

function can_spawn(x){
    for(var i=0;i<properties.not_spawnable.length;i++){
        if(x==properties.not_spawnable[i]){
        return false;
        }
    }
    return true;
}

function is_burnable(x){
	for(var i=0;i<properties.burnable.length;i++){
        if(properties.burnable[i]==x){
            return true;
        }
    }
    return false;
}

function adj_empty(x,y){
if(char_value(x,y-1)==0){//up
	return [x,y-1];
}
if(char_value(x+1,y)==0){//right
	return [x+1,y];
}
if(char_value(x,y+1)==0){//down
	return [x,y+1];
}
if(char_value(x-1,y)==0){//left
	return [x-1,y];
}
return [x,y];
}

function crisp_item(ptr,x,y){
switch(pages[cur_page].entities[ptr].item[0]){
	case 34://Meat
		pages[cur_page].entities[ptr].item[1]--;
		pages[cur_page].entities.push({
		id:2,
		x:adj_empty(x,y)[0],
		y:adj_empty(x,y)[1],
		char:item_char[36],
		item:[36,1]
		});//cooked meat
		combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],36);
		break;
	case 44://MDF puddy
		pages[cur_page].entities[ptr].item[1]--;
		pages[cur_page].entities.push({
		id:2,
		x:adj_empty(x,y)[0],
		y:adj_empty(x,y)[1],
		char:item_char[45],
		item:[45,1]
		});//MDF
		combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],45);
		break;
	case 36://cooked meat
		break;
	case 45://mdf
		break;
	case 33://iron
		break;
	case 35://Copper
		break;
	case 21://cyan thing
		break;
	default:
		pages[cur_page].entities[ptr].item[1]--;
		break;
}
}

function do_fire(x,y){
	//check for flamable objects around.
	var spread=0;
	if(!hit_bounds(x,y-1)){//up
		if(is_burnable(char_value(x,y-1))){
			pages[cur_page].map[y-1][x]=30;
			spread=1;
		}
	}
	if(!hit_bounds(x,y+1)){//down
		if(is_burnable(char_value(x,y+1))){
			pages[cur_page].map[y+1][x]=30;
			spread=1;
		}
	}
	if(!hit_bounds(x-1,y)){//left
		if(is_burnable(char_value(x-1,y))){
			pages[cur_page].map[y][x-1]=30;
			spread=1;
		}
	}
	if(!hit_bounds(x+1,y)){//right
		if(is_burnable(char_value(x+1,y))){
			pages[cur_page].map[y][x+1]=30;
			spread=1;
		}
	}
	if(spread==0){
		if(char_value(x,y)==68){
			0;
		}else{
		pages[cur_page].map[y][x]++;
		if(char_value(x,y)>=33){
			pages[cur_page].map[y][x]=0;
		}
		}
	}
	//check for entities
	for(var i=0;i<pages[cur_page].entities.length;i++){
		if(pages[cur_page].entities[i].x==x &&pages[cur_page].entities[i].y==y){
		switch(pages[cur_page].entities[i].id){
			case 1://npc
				break;
			case 2://dropped item
				crisp_item(i,x,y);
				break;
			case 3://projectile
				break;
		}
		}
	}
}

function enemy_chance(){return Math.floor(-180+46.66666667*tick_hour()+-1.944444444*tick_hour()*tick_hour());}

function random_tick(random_x=Math.floor((Math.random()*65535))%40,random_y=Math.floor((Math.random()*65535))%25,bone_meal=0,action=Math.floor((Math.random()*65535))%100){
if(pages[cur_page].map[random_y][random_x]==13){//grass
    if(action%2==0){//create hay
        pages[cur_page].entities.push({id:2, char:12, x:random_x, y:random_y, item: [2,1]});
		combine_items(random_x,random_y,2);
    }
    if(action%2==1){//spread
        var direction=Math.floor(Math.random()*65535)%4;
        x=random_x;
        y=random_y;
        switch(direction){
            case 0://up
                y--;
                break;
            case 1://down
                y++;
                break;
            case 2://left
                x--;
                break;
            case 3://right
                x++;
                break;
        }
        if(hit_bounds(x,y)){
            return;        
        }
        if(pages[cur_page].map[y][x]==0){
            pages[cur_page].map[y][x]=13;
        }
    }
}

if(pages[cur_page].map[random_y][random_x]==15){//tree trunk
    if(action%2==0){
        pages[cur_page].entities.push({id:2, char:9, x:random_x, y:random_y, item: [1,1]});//branch
		combine_items(random_x,random_y,1);
    }
    if(action%2==1){
        pages[cur_page].entities.push({id:2, char:24, x:random_x, y:random_y, item: [9,1]});//sapling
		combine_items(random_x,random_y,9);
    }
}
if(pages[cur_page].map[random_y][random_x]==16){//brown mushroom growth
    var direction=Math.floor(Math.random()*65535)%4;
        x=random_x;
        y=random_y;
        switch(direction){
            case 0://up
                y--;
                break;
            case 1://down
                y++;
                break;
            case 2://left
                x--;
                break;
            case 3://right
                x++;
                break;
        }
        if(hit_bounds(x,y)){
            return;        
        }
        if(pages[cur_page].map[y][x]==0){
            pages[cur_page].map[y][x]=16;
        }
}
if(pages[cur_page].map[random_y][random_x]==17){//red mushroom growth
    var direction=Math.floor(Math.random()*65535)%4;
        x=random_x;
        y=random_y;
        switch(direction){
            case 0://up
                y--;
                break;
            case 1://down
                y++;
                break;
            case 2://left
                x--;
                break;
            case 3://right
                x++;
                break;
        }
        if(hit_bounds(x,y)){
            return;        
        }
        if(pages[cur_page].map[y][x]==0){
            pages[cur_page].map[y][x]=17;
        }
}
switch(pages[cur_page].map[random_y][random_x]){
	case 46://walnut leaves
		pages[cur_page].entities.push({id:2, char:52, x:random_x, y:random_y, item: [25,1]});
		combine_items(random_x,random_y,25);
		break;
	case 47://walnut leaves
		pages[cur_page].entities.push({id:2, char:52, x:random_x, y:random_y, item: [25,1]});
		combine_items(random_x,random_y,25);
		break;
	case 48://walnut leaves
		pages[cur_page].entities.push({id:2, char:52, x:random_x, y:random_y, item: [25,1]});
		combine_items(random_x,random_y,25);
		break;
	case 49://walnut leaves
		pages[cur_page].entities.push({id:2, char:52, x:random_x, y:random_y, item: [25,1]});
		combine_items(random_x,random_y,25);
		break;
	case 50://walnut leaves
		pages[cur_page].entities.push({id:2, char:52, x:random_x, y:random_y, item: [25,1]});
		combine_items(random_x,random_y,25);
		break;
	case 51://walnut leaves
		pages[cur_page].entities.push({id:2, char:52, x:random_x, y:random_y, item: [25,1]});
		combine_items(random_x,random_y,25);
		break;
	case 52://walnut fruit
		if(char_value(random_x,random_y-1)==0 && char_value(random_x,random_y-2)==0 && char_value(random_x-1,random_y-1)==0 && char_value(random_x-1,random_y-2)==0 && char_value(random_x+1,random_y-1)==0 && char_value(random_x+1,random_y-2)==0){
			struct_copy(9,random_x-1,random_y-2);
		}
		break;
}
if(char_value(random_x,random_y)==24){//sapling
    if(!hit_bounds(random_x,random_y-1)){
        if(char_value(random_x,random_y-1)==0){
            pages[cur_page].map[random_y][random_x]=15;//trunk
            pages[cur_page].map[random_y-1][random_x]=14;//leaves
        }
    }
}
if(bone_meal==1){
	return;
}
//non hostile entity random destination
if(tick_hour()>=6 && tick_hour()<=17){//during day, hide
for(var i=0;i<pages[cur_page].entities.length;i++){
    if(pages[cur_page].entities[i].id==1){
        if(pages[cur_page].entities[i].brain.hostile==0){
            pages[cur_page].entities[i].dest_x=pages[cur_page].entities[i].brain.home_x;
            pages[cur_page].entities[i].dest_y=pages[cur_page].entities[i].brain.home_y;
        }
    }
}
}
if(action<=30 && tick_hour()<=5 || tick_hour()>=18){
for(var i=0;i<pages[cur_page].entities.length;i++){
    if(pages[cur_page].entities[i].id==1){
        if(pages[cur_page].entities[i].brain.hostile==0 && Math.random()>0.7){
            pages[cur_page].entities[i].dest_x=(Math.floor(Math.random()*65535)%42)-1;
            pages[cur_page].entities[i].dest_y=(Math.floor(Math.random()*65535)%27)-1;
			pages[cur_page].entities[i].brain.identity.love_mode=1;
        }
    }
}
}
//night: 0-32767
//day: 32768-65535
if(tick_hour()>=6 && tick_hour()<=17){
	//enemy spawning stuff
	if(pages[cur_page].metadata.safety==0){
		if(action<enemy_chance()){
            var cv=char_value(random_x,random_y);
            if(!is_walkable(cv)){
                return;
            }
            if(can_spawn(cv)){
			 pages[cur_page].entities.push({id:1, char:4, x:random_x,y:random_y, brain: {no_ai:0, hostile: 1}, health:20, strength:1, attack_cooldown:0, og_x:random_x, og_y:random_y});
            }
		}
	}
}
switch(char_value(random_x,random_y)){
	case 30://fire 0
		do_fire(random_x,random_y);
		break;
	case 31://fire 1
		do_fire(random_x,random_y);
		break;
	case 32://fire 2
		do_fire(random_x,random_y);
		break;
}
}

function grind_item(x,y){
var item_ptrs=[];
for(var i=0;i<pages[cur_page].entities.length;i++){
	if(pages[cur_page].entities[i].id==2 && pages[cur_page].entities[i].x==x && pages[cur_page].entities[i].y==y){
		item_ptrs.push(i);
	}
}
for(var i=0;i<item_ptrs.length;i++){
	switch(pages[cur_page].entities[item_ptrs[i]].item[0]){
		case 7://stick
			pages[cur_page].entities[item_ptrs[i]].item[1]--;
			pages[cur_page].entities.push({
			id:2,
			x:adj_empty(x,y)[0],
			y:adj_empty(x,y)[1],
			char:item_char[42],
			item:[42,1]
			});//Sawdust
			combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],42);
			break;
		case 11://bowl
			pages[cur_page].entities[item_ptrs[i]].item[1]--;
			pages[cur_page].entities.push({
			id:2,
			x:adj_empty(x,y)[0],
			y:adj_empty(x,y)[1],
			char:item_char[42],
			item:[42,1]
			});
			combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],42);
			break;
		case 22://door
			pages[cur_page].entities[item_ptrs[i]].item[1]--;
			pages[cur_page].entities.push({
			id:2,
			x:adj_empty(x,y)[0],
			y:adj_empty(x,y)[1],
			char:item_char[42],
			item:[42,1]
			});
			combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],42);
			break;
		case 26://walnut stone
			pages[cur_page].entities[item_ptrs[i]].item[1]--;
			pages[cur_page].entities.push({
			id:2,
			x:adj_empty(x,y)[0],
			y:adj_empty(x,y)[1],
			char:item_char[42],
			item:[42,1]
			});
			combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],42);
			break;
		case 6://fence
			pages[cur_page].entities[item_ptrs[i]].item[1]--;
			pages[cur_page].entities.push({
			id:2,
			x:adj_empty(x,y)[0],
			y:adj_empty(x,y)[1],
			char:item_char[42],
			item:[42,1]
			});
			combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],42);
			break;
		case 10://leaves
			pages[cur_page].entities[item_ptrs[i]].item[1]--;
			pages[cur_page].entities.push({
			id:2,
			x:adj_empty(x,y)[0],
			y:adj_empty(x,y)[1],
			char:item_char[29],
			item:[29,1]
			});//Fibers
			combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],42);
			break;
		case 27://Walnut Peels
			pages[cur_page].entities[item_ptrs[i]].item[1]--;
			pages[cur_page].entities.push({
			id:2,
			x:adj_empty(x,y)[0],
			y:adj_empty(x,y)[1],
			char:item_char[29],
			item:[29,1]
			});
			combine_items(adj_empty(x,y)[0],adj_empty(x,y)[1],42);
			break;
	}
}
}

function grinding(){
for(var x=0;x<40;x++){
	for(var y=0;y<25;y++){
		if(char_value(x,y)==73){//grind stone
			grind_item(x,y);
		}
	}
}
}

function fireing(){
var limit=5;
for(var x=0;x<40;x++){
	for(var y=0;y<25;y++){
		if(char_value(x,y)==30 || char_value(x,y)==31 || char_value(x,y)==32 || char_value(x,y)==68){//Fire, Camp Fire
			if(limit==0){
				return;
			}
			do_fire(x,y);
			limit--;
		}
	}
}
}

function frac(x){
	return Math.round(x-Math.floor(x));
}

function leading_zeros(x){
	return (""+x).length==1 ? "0"+x : x;
}

function tick_hour(){
	return Math.floor(tick1/(65535/24))%24;
}

function tick_to_time(){//%02i:%02i
	//65535/24=2730.625
	var hour=Math.floor(tick1/(65535/24))%24;
	var minute=Math.floor(tick1/(65535/(24*60)))%60;
	var second=Math.floor(tick1/(65535/(24*60*60)))%60;
	return leading_zeros(hour)+":"+leading_zeros(minute)+":"+leading_zeros(second);
}

var tick1=0;//0 to 65535
function refresh(){//Dang it, no multiple setintervals...
if(paused==1){
	return;
}
//Entity and npc cleanup
for(var i=0;i<pages[cur_page].entities.length;i++){
	switch(pages[cur_page].entities[i].id){
		case 1://npc
			if(pages[cur_page].entities[i].health<=0){//npc death.
				pages[cur_page].entities[i].id=-1;
				npc_drops(i);
			}
			break;
		case 2://dropped item
			if(pages[cur_page].entities[i].item[1]<=0){
				pages[cur_page].entities[i].id=-1;
			}
			if(pages[cur_page].entities[i].item[1]==null){
				pages[cur_page].entities[i].id=-1;
			}
			if(pages[cur_page].entities[i].item[0]<=0){
				pages[cur_page].entities[i].id=-1;
			}
			if(pages[cur_page].entities[i].item[0]>=item_char.length){
				pages[cur_page].entities[i].id=-1;
			}
			break;
		default:
			break;
	}
}
entity_cleanup();
draw_map(pages[cur_page]);
//status bar
var player_text;
switch(player.creative){
	case 0://Survival
		player_text="Name: "+player.name+" Health: "+player.health+" Strength: "+player.strength+" X: "+player.x+" Y: "+player.y+ " Text Page: "+cur_page+" Time: "+tick_to_time()+" "+pages[cur_page].metadata.x+","+pages[cur_page].metadata.y;
		break;
	case 1://Creative
		player_text="Name: "+player.name+" Creative X: "+player.x+" Y: "+player.y+ " Text Page: "+cur_page+" Time: "+tick_to_time()+" "+pages[cur_page].metadata.x+","+pages[cur_page].metadata.y;
		break;
}
document.getElementById("player").textContent=player_text;
var status_bar="Inventory: ";
switch(player.creative){
	case 0://Survival
	for(var i=0;i<10;i++){
	    if(player.inv[10]!=i){
	    status_bar+=i+": "+item_names[player.inv[i][0]]+" x "+player.inv[i][1]+" ";
	    }else{
	    status_bar+=i+": ("+item_names[player.inv[i][0]]+" x "+player.inv[i][1]+") ";
	    }
	}
	break;
	case 1://creative
	for(var i=0;i<10;i++){
	    if(player.inv[10]!=i){
	    status_bar+=i+": "+item_names[player.inv[i][0]]+" ";
	    }else{
	    status_bar+=i+": ("+item_names[player.inv[i][0]]+") ";
	    }
	}
	break;
}
document.getElementById("status").textContent=status_bar;
tick1++;
if(tick1>=65536){tick1=0;}
//night: 0-32767
//day: 32768-65535
if(tick1%2==0){//projectiles and path finding
tick();
}
if(tick1%40==0){//random tick
random_tick();
}
if(tick1%7==0){//fire, Grind Stone
fireing();
grinding();
}
}
const interval = setInterval(function (){refresh();},67);
window.onload=function(){
	document.getElementsByTagName('body')[0].onkeydown=function (e){
		key_manager(e.keyCode);
	}
};
function _load(){
	var saves=window.localStorage;
	var compressed_save=saves.getItem("_save");
	var save_file=JSON.parse(LZUTF8.decompress(compressed_save,{outputEncoding:"String",inputEncoding:"Base64"}));
	if(save_file==null){
	return;
    }
    cur_page=save_file[0];
    player=save_file[1];
    pages=save_file[2];
	tick1=save_file[3];
	document.getElementById("demonic_announcer").textContent="Loaded. Size:"+compressed_save.length+" bytes.";
}
function _save(){
	var saves=window.localStorage;
	if(saves.getItem("_save")!="empty"){
		if(!confirm("Save already exists, overwrite?")){
			return;
		}
	}
	var compressed_save=LZUTF8.compress(JSON.stringify([cur_page,player,pages,tick1]),{outputEncoding:"Base64"});
	saves.setItem("_save",compressed_save);
	document.getElementById("demonic_announcer").textContent="Saved. Size:"+compressed_save.length+" bytes";
}
function _delete(){
	if(confirm("Delete Save?")){
		var saves=window.localStorage;
		saves.setItem("_save","empty");
	}
}
function _import(){
	var compressed_save=prompt("Save?");
    var save_file=JSON.parse(LZUTF8.decompress(compressed_save,{outputEncoding:"String",inputEncoding:"Base64"}));
    if(save_file==null){
	return;
    }
    cur_page=save_file[0];
    player=save_file[1];
    pages=save_file[2];
	tick1=save_file[3];
	document.getElementById("demonic_announcer").textContent="Loaded. Size:"+compressed_save.length+" bytes.";
}
function _export(){
	if(confirm("This will end your session.")){
		document.write(LZUTF8.compress(JSON.stringify([cur_page,player,pages,tick1]),{outputEncoding:"Base64"}));
	}
}
</script>
</html>
